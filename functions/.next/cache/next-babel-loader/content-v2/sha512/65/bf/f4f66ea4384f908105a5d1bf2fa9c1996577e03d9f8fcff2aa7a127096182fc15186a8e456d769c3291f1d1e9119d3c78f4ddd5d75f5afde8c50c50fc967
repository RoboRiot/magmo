{"ast":null,"code":"var __jsx = React.createElement;\nimport React, { useEffect, useState, useCallback } from \"react\";\nimport { Modal, InputGroup, Dropdown, FormControl, Button, NavDropdown, Form, Table, Pagination } from \"react-bootstrap\";\nimport { fetchPartsWithMachineDataPage, fetchClients, fetchModels, formatDate } from \"../../../utils/fetchAssociations\";\nimport ClientTable from \"../../../utils/ClientTable\";\nimport ModelTable from \"../../../utils/ModelTable\";\nimport styles from \"./ParentModal.module.css\";\nconst CLIENT_WAREHOUSE = \"igor-house\";\nconst CLIENT_UNASSIGNED = \"unassigned\";\nconst PAGE_SIZE = 20;\n\nconst ParentModal = ({\n  show,\n  handleClose,\n  setSelectedParent\n}) => {\n  const {\n    0: info,\n    1: setInfo\n  } = useState([]);\n  const {\n    0: isLoading,\n    1: setIsLoading\n  } = useState(false);\n  const {\n    0: page,\n    1: setPage\n  } = useState(1);\n  const {\n    0: pageCursors,\n    1: setPageCursors\n  } = useState([]);\n  const {\n    0: hasNextPage,\n    1: setHasNextPage\n  } = useState(false);\n  const {\n    0: queryEpoch,\n    1: setQueryEpoch\n  } = useState(0);\n  const {\n    0: loadError,\n    1: setLoadError\n  } = useState(null);\n  const {\n    0: search,\n    1: setSearch\n  } = useState(\"\");\n  const {\n    0: select,\n    1: setSelect\n  } = useState(\"Name\");\n  const {\n    0: showList,\n    1: setShowList\n  } = useState(false);\n  const {\n    0: showListSearch,\n    1: setShowListSearch\n  } = useState(\"text\");\n  const {\n    0: selectedOEM,\n    1: setSelectedOEM\n  } = useState(null);\n  const {\n    0: selectedModality,\n    1: setSelectedModality\n  } = useState(null);\n  const {\n    0: selectedClient,\n    1: setSelectedClient\n  } = useState(null);\n  const {\n    0: clients,\n    1: setClients\n  } = useState([]);\n  const {\n    0: showClientModal,\n    1: setShowClientModal\n  } = useState(false);\n  const {\n    0: clientButtonText,\n    1: setClientButtonText\n  } = useState(\"Select Option\");\n  const {\n    0: selectedModel,\n    1: setSelectedModel\n  } = useState(null);\n  const {\n    0: models,\n    1: setModels\n  } = useState([]);\n  const {\n    0: showModelModal,\n    1: setShowModelModal\n  } = useState(false);\n  const {\n    0: modelButtonText,\n    1: setModelButtonText\n  } = useState(\"Select Option\");\n  const {\n    0: clientSearchTerm,\n    1: setClientSearchTerm\n  } = useState(\"\");\n  const {\n    0: modelSearchTerm,\n    1: setModelSearchTerm\n  } = useState(\"\");\n\n  const normalizeText = value => {\n    if (value == null) return \"\";\n    return String(value).toLowerCase().trim();\n  };\n\n  const fieldMatchesSelection = (value, selected) => {\n    if (!selected) return true;\n\n    if (Array.isArray(value)) {\n      return value.some(entry => fieldMatchesSelection(entry, selected));\n    }\n\n    return normalizeText(value) === normalizeText(selected);\n  };\n\n  const getMachineField = (item, key) => {\n    var _ref, _ref2, _ref3, _ref4, _ref5, _item$machineData$key, _item$machineData, _item$machineData2, _key$toLowerCase, _item$currentMachineD, _item$currentMachineD2, _key$toLowerCase2, _item$TheMachine, _item$TheMachine2, _key$toLowerCase3;\n\n    if (!item) return null;\n    return (_ref = (_ref2 = (_ref3 = (_ref4 = (_ref5 = (_item$machineData$key = item === null || item === void 0 ? void 0 : (_item$machineData = item.machineData) === null || _item$machineData === void 0 ? void 0 : _item$machineData[key]) !== null && _item$machineData$key !== void 0 ? _item$machineData$key : item === null || item === void 0 ? void 0 : (_item$machineData2 = item.machineData) === null || _item$machineData2 === void 0 ? void 0 : _item$machineData2[key === null || key === void 0 ? void 0 : (_key$toLowerCase = key.toLowerCase) === null || _key$toLowerCase === void 0 ? void 0 : _key$toLowerCase.call(key)]) !== null && _ref5 !== void 0 ? _ref5 : item === null || item === void 0 ? void 0 : (_item$currentMachineD = item.currentMachineData) === null || _item$currentMachineD === void 0 ? void 0 : _item$currentMachineD[key]) !== null && _ref4 !== void 0 ? _ref4 : item === null || item === void 0 ? void 0 : (_item$currentMachineD2 = item.currentMachineData) === null || _item$currentMachineD2 === void 0 ? void 0 : _item$currentMachineD2[key === null || key === void 0 ? void 0 : (_key$toLowerCase2 = key.toLowerCase) === null || _key$toLowerCase2 === void 0 ? void 0 : _key$toLowerCase2.call(key)]) !== null && _ref3 !== void 0 ? _ref3 : item === null || item === void 0 ? void 0 : (_item$TheMachine = item.TheMachine) === null || _item$TheMachine === void 0 ? void 0 : _item$TheMachine[key]) !== null && _ref2 !== void 0 ? _ref2 : item === null || item === void 0 ? void 0 : (_item$TheMachine2 = item.TheMachine) === null || _item$TheMachine2 === void 0 ? void 0 : _item$TheMachine2[key === null || key === void 0 ? void 0 : (_key$toLowerCase3 = key.toLowerCase) === null || _key$toLowerCase3 === void 0 ? void 0 : _key$toLowerCase3.call(key)]) !== null && _ref !== void 0 ? _ref : null;\n  };\n\n  const resetPagination = () => {\n    setPage(1);\n    setPageCursors([]);\n    setHasNextPage(false);\n  };\n\n  const searchChangeHandler = event => setSearch(event.target.value);\n\n  const matchesFilters = useCallback(item => {\n    if (!item) return false;\n\n    if (selectedOEM) {\n      const OEM = getMachineField(item, \"OEM\");\n      if (!fieldMatchesSelection(OEM, selectedOEM)) return false;\n    }\n\n    if (selectedModality) {\n      const Modality = getMachineField(item, \"Modality\");\n      if (!fieldMatchesSelection(Modality, selectedModality)) return false;\n    }\n\n    if (selectedModel) {\n      const Model = getMachineField(item, \"Model\");\n      if (!fieldMatchesSelection(Model, selectedModel)) return false;\n    }\n\n    if (selectedClient) {\n      const clientRef = getMachineField(item, \"client\");\n      const clientId = typeof clientRef === \"string\" ? clientRef : (clientRef === null || clientRef === void 0 ? void 0 : clientRef.id) || null;\n      if (clientId !== selectedClient) return false;\n    }\n\n    return true;\n  }, [selectedOEM, selectedModality, selectedModel, selectedClient]);\n  const fetchData = useCallback(async (requestedPage = 1) => {\n    if (!show) return;\n    const startAfterDoc = requestedPage > 1 ? pageCursors[requestedPage - 2] : null;\n\n    if (requestedPage > 1 && !startAfterDoc) {\n      setPage(1);\n      return;\n    }\n\n    setIsLoading(true);\n    setLoadError(null);\n    const searchLower = (search || \"\").toLowerCase().trim();\n\n    try {\n      const {\n        parts: data,\n        lastDoc,\n        hasNextPage: nextPage\n      } = await fetchPartsWithMachineDataPage({\n        pageSize: PAGE_SIZE,\n        startAfterDoc,\n        visibleOnly: true,\n        filterFn: selectedOEM || selectedModality || selectedModel || selectedClient ? matchesFilters : null,\n        search: searchLower ? {\n          type: select,\n          raw: search,\n          lower: searchLower\n        } : null,\n        needsMachineData: Boolean(selectedOEM) || Boolean(selectedModality) || Boolean(selectedModel) || Boolean(selectedClient)\n      });\n      setInfo(data);\n      setHasNextPage(nextPage);\n      setPageCursors(prev => {\n        const next = requestedPage === 1 ? [] : [...prev];\n\n        if (lastDoc) {\n          next[requestedPage - 1] = lastDoc;\n        }\n\n        return next;\n      });\n    } catch (error) {\n      console.error(\"Parent modal load failed:\", error);\n      setLoadError((error === null || error === void 0 ? void 0 : error.message) || \"Failed to load items.\");\n      setInfo([]);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [show, pageCursors, search, select, selectedOEM, selectedModality, selectedModel, selectedClient, matchesFilters]);\n  useEffect(() => {\n    if (!show) return;\n    resetPagination();\n    setQueryEpoch(v => v + 1);\n  }, [show, selectedOEM, selectedModality, selectedModel, selectedClient, search, select]);\n  useEffect(() => {\n    if (!show) return;\n    fetchData(page);\n  }, [show, page, queryEpoch, fetchData]);\n\n  const rowSelect = item => {\n    setSelectedParent({\n      id: item.id,\n      name: item.name,\n      pn: item.pn\n    });\n    handleClose();\n  };\n\n  const {\n    0: dropdown1Text,\n    1: setDropdown1Text\n  } = useState(\"Select Option\");\n  const {\n    0: dropdown2Text,\n    1: setDropdown2Text\n  } = useState(\"Select Option\");\n\n  const handleSelect1 = (eventKey, event) => {\n    if (eventKey === \"unassigned\") {\n      setDropdown1Text(\"Select Option\");\n      setSelectedOEM(null);\n    } else {\n      setDropdown1Text(event.target.textContent);\n      setSelectedOEM(event.target.textContent);\n    }\n  };\n\n  const handleSelect2 = (eventKey, event) => {\n    if (eventKey === \"unassigned\") {\n      setDropdown2Text(\"Select Option\");\n      setSelectedModality(null);\n    } else {\n      setDropdown2Text(event.target.textContent);\n      setSelectedModality(event.target.textContent);\n    }\n  };\n\n  const handleClientClick = async () => {\n    const clientsData = await fetchClients(selectedOEM, selectedModality);\n    setClients(clientsData);\n    setClientSearchTerm(\"\");\n    setShowClientModal(true);\n  };\n\n  const handleClientSelect = clientId => {\n    if (!clientId) {\n      setClientButtonText(\"Select Option\");\n      setSelectedClient(null);\n      setShowClientModal(false);\n      return;\n    }\n\n    const client = clients.find(c => c.id === clientId);\n    setClientButtonText((client === null || client === void 0 ? void 0 : client.name) || \"Select Option\");\n    setSelectedClient(clientId);\n    setShowClientModal(false);\n  };\n\n  const handleClientInfo = (clientId, clientName) => {\n    console.log(`Client ID: ${clientId}, Client Name: ${clientName}`);\n  };\n\n  const handleClearClientSelection = () => {\n    setClientButtonText(\"Select Option\");\n    setSelectedClient(null);\n    setShowClientModal(false);\n  };\n\n  const handleModelClick = async () => {\n    const modelsData = await fetchModels(selectedOEM, selectedModality, selectedClient);\n    setModels(modelsData);\n    setModelSearchTerm(\"\");\n    setShowModelModal(true);\n  };\n\n  const handleModelSelect = modelName => {\n    setModelButtonText(modelName || \"Select Option\");\n    setSelectedModel(modelName || null);\n    setShowModelModal(false);\n  };\n\n  const handleClearModelSelection = () => {\n    setModelButtonText(\"Select Option\");\n    setSelectedModel(null);\n    setShowModelModal(false);\n  };\n\n  const handleWarehouseClick = () => {\n    setClientButtonText(CLIENT_WAREHOUSE);\n    setSelectedClient(CLIENT_WAREHOUSE);\n  };\n\n  const handleUnassignedClick = () => {\n    setClientButtonText(CLIENT_UNASSIGNED);\n    setSelectedClient(CLIENT_UNASSIGNED);\n  };\n\n  const totalKnownPages = Math.max(1, pageCursors.filter(Boolean).length + (hasNextPage ? 1 : 0));\n\n  const pageButtons = (() => {\n    const buttons = [];\n    const maxVisible = 6;\n\n    const pushPage = p => buttons.push(__jsx(Pagination.Item, {\n      key: `page-${p}`,\n      active: p === page,\n      onClick: () => setPage(p)\n    }, p));\n\n    const pushEllipsis = key => buttons.push(__jsx(Pagination.Ellipsis, {\n      key: key,\n      disabled: true\n    }));\n\n    if (totalKnownPages <= maxVisible) {\n      for (let i = 1; i <= totalKnownPages; i += 1) pushPage(i);\n\n      return buttons;\n    }\n\n    let start = Math.max(2, page - 1);\n    let end = Math.min(totalKnownPages - 1, page + 1);\n    const desiredWindow = maxVisible - 2;\n    let currentWindow = end - start + 1;\n    let remaining = desiredWindow - currentWindow;\n\n    while (remaining > 0) {\n      if (start > 2) {\n        start -= 1;\n        remaining -= 1;\n      }\n\n      if (remaining > 0 && end < totalKnownPages - 1) {\n        end += 1;\n        remaining -= 1;\n      }\n\n      if (start === 2 && end === totalKnownPages - 1) break;\n    }\n\n    pushPage(1);\n    if (start > 2) pushEllipsis(\"start-ellipsis\");\n\n    for (let i = start; i <= end; i += 1) pushPage(i);\n\n    if (end < totalKnownPages - 1) pushEllipsis(\"end-ellipsis\");\n    pushPage(totalKnownPages);\n    if (hasNextPage) pushEllipsis(\"more-ellipsis\");\n    return buttons;\n  })();\n\n  return __jsx(Modal, {\n    show: show,\n    onHide: handleClose,\n    size: \"xl\",\n    centered: true,\n    dialogClassName: styles.modalDialog,\n    contentClassName: styles.modalContent\n  }, __jsx(Modal.Header, {\n    closeButton: true,\n    className: styles.modalHeader\n  }, __jsx(\"div\", null, __jsx(\"div\", {\n    className: styles.modalTitle\n  }, \"Select Parent\"), __jsx(\"div\", {\n    className: styles.modalSubtitle\n  }, \"Search and choose a parent item for this part.\"))), __jsx(Modal.Body, {\n    className: styles.modalBody\n  }, __jsx(\"div\", {\n    className: styles.modalGrid\n  }, __jsx(\"aside\", {\n    className: styles.filtersPanel\n  }, __jsx(\"div\", {\n    className: styles.panelTitle\n  }, \"Filters\"), __jsx(\"div\", {\n    className: styles.panelHint\n  }, \"Narrow results with machine and client filters.\"), __jsx(InputGroup, {\n    className: styles.inputGroup\n  }, __jsx(InputGroup.Text, null, \"OEM\"), __jsx(Dropdown, {\n    onSelect: handleSelect1,\n    className: \"w-100\"\n  }, __jsx(Dropdown.Toggle, {\n    variant: \"outline-secondary\",\n    id: \"dropdown-button-1\",\n    className: \"w-100\"\n  }, dropdown1Text), __jsx(Dropdown.Menu, {\n    className: \"w-100\"\n  }, __jsx(Dropdown.Item, {\n    eventKey: \"unassigned\"\n  }, \"Select Option\"), __jsx(Dropdown.Item, {\n    eventKey: \"GE\"\n  }, \"GE\"), __jsx(Dropdown.Item, {\n    eventKey: \"Toshiba\"\n  }, \"Toshiba\"), __jsx(Dropdown.Item, {\n    eventKey: \"Siemens\"\n  }, \"Siemens\"), __jsx(Dropdown.Item, {\n    eventKey: \"Philips\"\n  }, \"Philips\")))), __jsx(InputGroup, {\n    className: styles.inputGroup\n  }, __jsx(InputGroup.Text, null, \"Modality\"), __jsx(Dropdown, {\n    onSelect: handleSelect2,\n    className: \"w-100\"\n  }, __jsx(Dropdown.Toggle, {\n    variant: \"outline-secondary\",\n    id: \"dropdown-button-2\",\n    className: \"w-100\"\n  }, dropdown2Text), __jsx(Dropdown.Menu, {\n    className: \"w-100\"\n  }, __jsx(Dropdown.Item, {\n    eventKey: \"unassigned\"\n  }, \"Select Option\"), __jsx(Dropdown.Item, {\n    eventKey: \"CT\"\n  }, \"CT\"), __jsx(Dropdown.Item, {\n    eventKey: \"MRI\"\n  }, \"MRI\")))), __jsx(InputGroup, {\n    className: styles.inputGroup\n  }, __jsx(InputGroup.Text, null, \"Client\"), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: \"w-100\",\n    onClick: handleClientClick\n  }, clientButtonText)), __jsx(InputGroup, {\n    className: styles.inputGroup\n  }, __jsx(InputGroup.Text, null, \"Model\"), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: \"w-100\",\n    onClick: handleModelClick\n  }, modelButtonText)), __jsx(\"div\", {\n    className: styles.panelDivider\n  }), __jsx(\"div\", {\n    className: styles.panelTitle\n  }, \"Quick\"), __jsx(\"div\", {\n    className: styles.quickButtons\n  }, __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: styles.quickButton,\n    onClick: handleWarehouseClick\n  }, \"Warehouse\"), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: styles.quickButton,\n    onClick: handleUnassignedClick\n  }, \"Unassigned\"))), __jsx(\"section\", {\n    className: styles.resultsPanel\n  }, __jsx(\"div\", {\n    className: styles.resultsHeader\n  }, __jsx(\"div\", null, __jsx(\"div\", {\n    className: styles.resultsTitle\n  }, \"Results\"), __jsx(\"div\", {\n    className: styles.resultsSubtitle\n  }, isLoading ? \"Loading items\" : `${info.length} items`)), __jsx(Pagination, {\n    size: \"sm\",\n    className: styles.pagination\n  }, __jsx(Pagination.Prev, {\n    onClick: () => setPage(p => Math.max(1, p - 1)),\n    disabled: page <= 1\n  }), pageButtons, __jsx(Pagination.Next, {\n    onClick: () => setPage(p => p + 1),\n    disabled: !hasNextPage\n  }))), __jsx(\"div\", {\n    className: styles.searchRow\n  }, __jsx(FormControl, {\n    type: showListSearch,\n    placeholder: \"Search\",\n    className: styles.searchInput,\n    \"aria-label\": \"Search\",\n    value: search,\n    onChange: searchChangeHandler\n  }), __jsx(NavDropdown, {\n    title: select,\n    id: \"parent-search-dropdown\",\n    show: showList,\n    onMouseEnter: () => setShowList(true),\n    onMouseLeave: () => setShowList(false)\n  }, __jsx(NavDropdown.Item, {\n    onClick: () => {\n      setSelect(\"Name\");\n      setShowListSearch(\"text\");\n    }\n  }, \"Name\"), __jsx(NavDropdown.Item, {\n    onClick: () => {\n      setSelect(\"Date\");\n      setShowListSearch(\"date\");\n    }\n  }, \"Date\"), __jsx(NavDropdown.Item, {\n    onClick: () => {\n      setSelect(\"Work Order\");\n      setShowListSearch(\"text\");\n    }\n  }, \"Work Order\"), __jsx(NavDropdown.Item, {\n    onClick: () => {\n      setSelect(\"Product Number\");\n      setShowListSearch(\"text\");\n    }\n  }, \"Product Number\"), __jsx(NavDropdown.Item, {\n    onClick: () => {\n      setSelect(\"Serial Number\");\n      setShowListSearch(\"text\");\n    }\n  }, \"Serial Number\"), __jsx(NavDropdown.Item, {\n    onClick: () => {\n      setSelect(\"Description\");\n      setShowListSearch(\"text\");\n    }\n  }, \"Description\"))), __jsx(\"div\", {\n    className: styles.tableWrap\n  }, isLoading ? __jsx(\"div\", {\n    className: styles.loadingState\n  }, __jsx(\"img\", {\n    src: \"/magmo-logo.png\",\n    alt: \"Loading\",\n    className: styles.loadingLogo\n  })) : loadError ? __jsx(\"div\", {\n    className: styles.errorState\n  }, loadError) : __jsx(Table, {\n    striped: true,\n    bordered: true,\n    hover: true,\n    size: \"sm\",\n    className: styles.table\n  }, __jsx(\"thead\", {\n    className: styles.stickyHeader\n  }, __jsx(\"tr\", null, __jsx(\"th\", null, \"Name\"), __jsx(\"th\", null, \"Date\"), __jsx(\"th\", null, \"Work Order\"), __jsx(\"th\", null, \"Product Number\"), __jsx(\"th\", null, \"Serial Number\"), __jsx(\"th\", null, \"Select\"))), __jsx(\"tbody\", null, info.length === 0 && __jsx(\"tr\", null, __jsx(\"td\", {\n    colSpan: 6,\n    className: styles.emptyState\n  }, \"No items found.\")), info.map(item => __jsx(\"tr\", {\n    key: item.id\n  }, __jsx(\"td\", null, item.name), __jsx(\"td\", null, formatDate(item.date)), __jsx(\"td\", null, item.workOrders && item.workOrders.length > 0 ? item.workOrders[item.workOrders.length - 1].workOrder : \"N/A\"), __jsx(\"td\", null, item.pn), __jsx(\"td\", null, item.sn), __jsx(\"td\", null, __jsx(Button, {\n    variant: \"primary\",\n    size: \"sm\",\n    onClick: () => rowSelect(item)\n  }, \"Select\")))))))))), __jsx(Modal.Footer, {\n    className: styles.modalFooter\n  }, __jsx(Button, {\n    variant: \"secondary\",\n    onClick: handleClose\n  }, \"Cancel\"), __jsx(Button, {\n    variant: \"warning\",\n    onClick: () => {\n      setSelectedParent(null);\n      handleClose();\n    }\n  }, \"Clear Selection\")), __jsx(Modal, {\n    show: showClientModal,\n    onHide: () => setShowClientModal(false)\n  }, __jsx(Modal.Header, {\n    closeButton: true\n  }, __jsx(Modal.Title, null, \"Select Client\")), __jsx(Modal.Body, null, __jsx(FormControl, {\n    type: \"text\",\n    placeholder: \"Search by name\",\n    className: \"mb-3\",\n    value: clientSearchTerm,\n    onChange: e => setClientSearchTerm(e.target.value)\n  }), __jsx(ClientTable, {\n    clients: clients.filter(client => (client.name || \"\").toLowerCase().includes(clientSearchTerm.toLowerCase())),\n    disableInfo: true,\n    onSelectClient: handleClientSelect,\n    onInfoClick: handleClientInfo,\n    clearSelection: handleClearClientSelection\n  }))), __jsx(Modal, {\n    show: showModelModal,\n    onHide: () => setShowModelModal(false)\n  }, __jsx(Modal.Header, {\n    closeButton: true\n  }, __jsx(Modal.Title, null, \"Select Model\")), __jsx(Modal.Body, null, __jsx(FormControl, {\n    type: \"text\",\n    placeholder: \"Search by name\",\n    className: \"mb-3\",\n    value: modelSearchTerm,\n    onChange: e => setModelSearchTerm(e.target.value)\n  }), __jsx(ModelTable, {\n    models: models.filter(model => typeof model === \"string\" ? model.toLowerCase().includes(modelSearchTerm.toLowerCase()) : false),\n    onSelectModel: handleModelSelect,\n    clearSelection: handleClearModelSelection\n  }))));\n};\n\nexport default ParentModal;","map":null,"metadata":{},"sourceType":"module"}