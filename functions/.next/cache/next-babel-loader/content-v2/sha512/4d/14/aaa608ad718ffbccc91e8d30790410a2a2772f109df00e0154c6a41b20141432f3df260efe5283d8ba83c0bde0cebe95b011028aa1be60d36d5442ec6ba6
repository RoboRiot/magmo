{"ast":null,"code":"import _defineProperty from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _regeneratorRuntime from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _toConsumableArray from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _slicedToArray from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it[\"return\"] != null) it[\"return\"](); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nimport firebase from \"../context/Firebase\";\nvar OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nvar MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nvar DEFAULT_OEM_FIELD = \"oems\";\n\nvar isPlainObject = function isPlainObject(value) {\n  return value != null && typeof value === \"object\" && !Array.isArray(value) && !(value instanceof Date);\n};\n\nvar normalizeArray = function normalizeArray(value) {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nvar normalizeList = function normalizeList(values) {\n  var out = [];\n  (values || []).forEach(function (value) {\n    if (value == null) return;\n    var normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nvar pickModelField = function pickModelField(obj) {\n  if (!isPlainObject(obj)) return null;\n\n  var _iterator = _createForOfIteratorHelper(MODEL_FIELD_CANDIDATES),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var key = _step.value;\n      if (Array.isArray(obj[key])) return key;\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  var arrayKey = Object.keys(obj).find(function (key) {\n    return Array.isArray(obj[key]);\n  });\n  return arrayKey || null;\n};\n\nvar extractModels = function extractModels(value) {\n  if (Array.isArray(value)) {\n    return {\n      models: normalizeList(value),\n      modelField: null\n    };\n  }\n\n  if (isPlainObject(value)) {\n    var modelField = pickModelField(value);\n    var models = modelField ? normalizeList(value[modelField]) : [];\n    return {\n      models: models,\n      modelField: modelField\n    };\n  }\n\n  if (value != null && value !== \"\") {\n    return {\n      models: normalizeList([value]),\n      modelField: null\n    };\n  }\n\n  return {\n    models: [],\n    modelField: null\n  };\n};\n\nvar extractOemMap = function extractOemMap(data) {\n  var oemMap = {};\n  var modelFieldByOem = {};\n  var oemField = null;\n\n  var _iterator2 = _createForOfIteratorHelper(OEM_FIELD_CANDIDATES),\n      _step2;\n\n  try {\n    for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n      var key = _step2.value;\n\n      if (isPlainObject(data === null || data === void 0 ? void 0 : data[key])) {\n        oemField = key;\n        Object.entries(data[key]).forEach(function (_ref3) {\n          var _ref4 = _slicedToArray(_ref3, 2),\n              oem = _ref4[0],\n              value = _ref4[1];\n\n          var _extractModels2 = extractModels(value),\n              models = _extractModels2.models,\n              modelField = _extractModels2.modelField;\n\n          oemMap[oem] = normalizeList([].concat(_toConsumableArray(oemMap[oem] || []), _toConsumableArray(models)));\n\n          if (modelField) {\n            modelFieldByOem[oem] = modelField;\n          }\n        });\n      }\n    }\n  } catch (err) {\n    _iterator2.e(err);\n  } finally {\n    _iterator2.f();\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(function (_ref) {\n      var _ref2 = _slicedToArray(_ref, 2),\n          key = _ref2[0],\n          value = _ref2[1];\n\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n\n      if (isPlainObject(value) || Array.isArray(value)) {\n        var _extractModels = extractModels(value),\n            models = _extractModels.models,\n            modelField = _extractModels.modelField;\n\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([].concat(_toConsumableArray(oemMap[key] || []), _toConsumableArray(models)));\n\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return {\n    oemMap: oemMap,\n    oemField: oemField,\n    modelFieldByOem: modelFieldByOem\n  };\n};\n\nexport function fetchTrackerCatalog() {\n  return _fetchTrackerCatalog.apply(this, arguments);\n}\n\nfunction _fetchTrackerCatalog() {\n  _fetchTrackerCatalog = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n    var db, snap, modalities, oemsByModality, modelsByModalityOem, meta;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            db = firebase.firestore();\n            _context.next = 3;\n            return db.collection(\"Tracker\").get();\n\n          case 3:\n            snap = _context.sent;\n            modalities = [];\n            oemsByModality = {};\n            modelsByModalityOem = {};\n            meta = {\n              oemFieldByModality: {},\n              modelFieldByModalityOem: {}\n            };\n            snap.forEach(function (doc) {\n              var modality = doc.id;\n              var data = doc.data() || {};\n\n              var _extractOemMap = extractOemMap(data),\n                  oemMap = _extractOemMap.oemMap,\n                  oemField = _extractOemMap.oemField,\n                  modelFieldByOem = _extractOemMap.modelFieldByOem;\n\n              modalities.push(modality);\n              meta.oemFieldByModality[modality] = oemField;\n              meta.modelFieldByModalityOem[modality] = modelFieldByOem || {};\n              var oems = Object.keys(oemMap);\n              oemsByModality[modality] = oems;\n              modelsByModalityOem[modality] = {};\n              oems.forEach(function (oem) {\n                modelsByModalityOem[modality][oem] = normalizeList(oemMap[oem]);\n              });\n            });\n            return _context.abrupt(\"return\", {\n              modalities: normalizeList(modalities),\n              oemsByModality: oemsByModality,\n              modelsByModalityOem: modelsByModalityOem,\n              meta: meta\n            });\n\n          case 10:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n  return _fetchTrackerCatalog.apply(this, arguments);\n}\n\nexport function buildAllOems(catalog) {\n  var set = new Set();\n  Object.values((catalog === null || catalog === void 0 ? void 0 : catalog.oemsByModality) || {}).forEach(function (oems) {\n    (oems || []).forEach(function (oem) {\n      return set.add(oem);\n    });\n  });\n  return Array.from(set);\n}\nexport function buildModelsForSelection(catalog) {\n  var modalities = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n  var oems = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  var modelSet = new Set();\n  var modals = normalizeList(modalities);\n  var oemList = normalizeList(oems);\n  modals.forEach(function (modality) {\n    var _catalog$modelsByModa;\n\n    var oemMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa = catalog.modelsByModalityOem) === null || _catalog$modelsByModa === void 0 ? void 0 : _catalog$modelsByModa[modality]) || {};\n    oemList.forEach(function (oem) {\n      var models = (oemMap === null || oemMap === void 0 ? void 0 : oemMap[oem]) || [];\n      models.forEach(function (model) {\n        return modelSet.add(model);\n      });\n    });\n  });\n  return Array.from(modelSet);\n}\nexport function syncTrackerFromSelections(_x) {\n  return _syncTrackerFromSelections.apply(this, arguments);\n}\n\nfunction _syncTrackerFromSelections() {\n  _syncTrackerFromSelections = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref5) {\n    var selections, catalog, db, trackerRef, selectedModalities, selectedOems, selectedModels, ops, _iterator3, _step3, _catalog$oemsByModali, _catalog$meta, _catalog$meta$oemFiel, _catalog$modalities, _catalog$modalities$i, modality, docRef, existingOems, oemField, _iterator4, _step4, oem, _iterator5, _step5, _catalog$modelsByModa2, _catalog$modelsByModa3, _catalog$meta2, _catalog$meta2$modelF, _catalog$meta2$modelF2, _oem, knownModels, knownSet, modelField, _iterator6, _step6, model, path;\n\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            selections = _ref5.selections, catalog = _ref5.catalog;\n            db = firebase.firestore();\n            trackerRef = db.collection(\"Tracker\");\n            selectedModalities = normalizeList((selections === null || selections === void 0 ? void 0 : selections.modalities) || []);\n            selectedOems = normalizeList((selections === null || selections === void 0 ? void 0 : selections.oems) || []);\n            selectedModels = normalizeList((selections === null || selections === void 0 ? void 0 : selections.models) || []);\n\n            if (selectedModalities.length) {\n              _context2.next = 8;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", false);\n\n          case 8:\n            ops = [];\n            _iterator3 = _createForOfIteratorHelper(selectedModalities);\n            _context2.prev = 10;\n\n            _iterator3.s();\n\n          case 12:\n            if ((_step3 = _iterator3.n()).done) {\n              _context2.next = 59;\n              break;\n            }\n\n            modality = _step3.value;\n            docRef = trackerRef.doc(modality);\n            existingOems = new Set((catalog === null || catalog === void 0 ? void 0 : (_catalog$oemsByModali = catalog.oemsByModality) === null || _catalog$oemsByModali === void 0 ? void 0 : _catalog$oemsByModali[modality]) || []);\n            oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta = catalog.meta) === null || _catalog$meta === void 0 ? void 0 : (_catalog$meta$oemFiel = _catalog$meta.oemFieldByModality) === null || _catalog$meta$oemFiel === void 0 ? void 0 : _catalog$meta$oemFiel[modality]) || DEFAULT_OEM_FIELD;\n\n            if (!(catalog !== null && catalog !== void 0 && (_catalog$modalities = catalog.modalities) !== null && _catalog$modalities !== void 0 && (_catalog$modalities$i = _catalog$modalities.includes) !== null && _catalog$modalities$i !== void 0 && _catalog$modalities$i.call(_catalog$modalities, modality))) {\n              ops.push(docRef.set(_defineProperty({}, DEFAULT_OEM_FIELD, {}), {\n                merge: true\n              }));\n            }\n\n            _iterator4 = _createForOfIteratorHelper(selectedOems);\n\n            try {\n              for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n                oem = _step4.value;\n\n                if (!existingOems.has(oem)) {\n                  ops.push(docRef.set(_defineProperty({}, oemField, _defineProperty({}, oem, [])), {\n                    merge: true\n                  }));\n                }\n              }\n            } catch (err) {\n              _iterator4.e(err);\n            } finally {\n              _iterator4.f();\n            }\n\n            _iterator5 = _createForOfIteratorHelper(selectedOems);\n            _context2.prev = 21;\n\n            _iterator5.s();\n\n          case 23:\n            if ((_step5 = _iterator5.n()).done) {\n              _context2.next = 49;\n              break;\n            }\n\n            _oem = _step5.value;\n            knownModels = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa2 = catalog.modelsByModalityOem) === null || _catalog$modelsByModa2 === void 0 ? void 0 : (_catalog$modelsByModa3 = _catalog$modelsByModa2[modality]) === null || _catalog$modelsByModa3 === void 0 ? void 0 : _catalog$modelsByModa3[_oem]) || [];\n            knownSet = new Set(knownModels);\n            modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta2 = catalog.meta) === null || _catalog$meta2 === void 0 ? void 0 : (_catalog$meta2$modelF = _catalog$meta2.modelFieldByModalityOem) === null || _catalog$meta2$modelF === void 0 ? void 0 : (_catalog$meta2$modelF2 = _catalog$meta2$modelF[modality]) === null || _catalog$meta2$modelF2 === void 0 ? void 0 : _catalog$meta2$modelF2[_oem]) || null;\n            _iterator6 = _createForOfIteratorHelper(selectedModels);\n            _context2.prev = 29;\n\n            _iterator6.s();\n\n          case 31:\n            if ((_step6 = _iterator6.n()).done) {\n              _context2.next = 39;\n              break;\n            }\n\n            model = _step6.value;\n\n            if (!knownSet.has(model)) {\n              _context2.next = 35;\n              break;\n            }\n\n            return _context2.abrupt(\"continue\", 37);\n\n          case 35:\n            path = modelField ? \"\".concat(oemField, \".\").concat(_oem, \".\").concat(modelField) : \"\".concat(oemField, \".\").concat(_oem);\n            ops.push(docRef.update(_defineProperty({}, path, firebase.firestore.FieldValue.arrayUnion(model))));\n\n          case 37:\n            _context2.next = 31;\n            break;\n\n          case 39:\n            _context2.next = 44;\n            break;\n\n          case 41:\n            _context2.prev = 41;\n            _context2.t0 = _context2[\"catch\"](29);\n\n            _iterator6.e(_context2.t0);\n\n          case 44:\n            _context2.prev = 44;\n\n            _iterator6.f();\n\n            return _context2.finish(44);\n\n          case 47:\n            _context2.next = 23;\n            break;\n\n          case 49:\n            _context2.next = 54;\n            break;\n\n          case 51:\n            _context2.prev = 51;\n            _context2.t1 = _context2[\"catch\"](21);\n\n            _iterator5.e(_context2.t1);\n\n          case 54:\n            _context2.prev = 54;\n\n            _iterator5.f();\n\n            return _context2.finish(54);\n\n          case 57:\n            _context2.next = 12;\n            break;\n\n          case 59:\n            _context2.next = 64;\n            break;\n\n          case 61:\n            _context2.prev = 61;\n            _context2.t2 = _context2[\"catch\"](10);\n\n            _iterator3.e(_context2.t2);\n\n          case 64:\n            _context2.prev = 64;\n\n            _iterator3.f();\n\n            return _context2.finish(64);\n\n          case 67:\n            if (!ops.length) {\n              _context2.next = 71;\n              break;\n            }\n\n            _context2.next = 70;\n            return Promise.allSettled(ops);\n\n          case 70:\n            return _context2.abrupt(\"return\", true);\n\n          case 71:\n            return _context2.abrupt(\"return\", false);\n\n          case 72:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[10, 61, 64, 67], [21, 51, 54, 57], [29, 41, 44, 47]]);\n  }));\n  return _syncTrackerFromSelections.apply(this, arguments);\n}\n\nexport function deleteTrackerOem(_x2) {\n  return _deleteTrackerOem.apply(this, arguments);\n}\n\nfunction _deleteTrackerOem() {\n  _deleteTrackerOem = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(_ref6) {\n    var oem, catalog, db, trackerRef, modalities, ops;\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            oem = _ref6.oem, catalog = _ref6.catalog;\n\n            if (oem) {\n              _context3.next = 3;\n              break;\n            }\n\n            return _context3.abrupt(\"return\");\n\n          case 3:\n            db = firebase.firestore();\n            trackerRef = db.collection(\"Tracker\");\n            modalities = (catalog === null || catalog === void 0 ? void 0 : catalog.modalities) || [];\n            ops = modalities.map(function (modality) {\n              var _catalog$meta3, _catalog$meta3$oemFie, _catalog$meta4, _catalog$meta4$oemFie;\n\n              var oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta3 = catalog.meta) === null || _catalog$meta3 === void 0 ? void 0 : (_catalog$meta3$oemFie = _catalog$meta3.oemFieldByModality) === null || _catalog$meta3$oemFie === void 0 ? void 0 : _catalog$meta3$oemFie[modality]) || DEFAULT_OEM_FIELD;\n              var docRef = trackerRef.doc(modality);\n\n              var update = _defineProperty({}, \"\".concat(oemField, \".\").concat(oem), firebase.firestore.FieldValue[\"delete\"]());\n\n              if (!(catalog !== null && catalog !== void 0 && (_catalog$meta4 = catalog.meta) !== null && _catalog$meta4 !== void 0 && (_catalog$meta4$oemFie = _catalog$meta4.oemFieldByModality) !== null && _catalog$meta4$oemFie !== void 0 && _catalog$meta4$oemFie[modality])) {\n                update[oem] = firebase.firestore.FieldValue[\"delete\"]();\n              }\n\n              return docRef.update(update)[\"catch\"](function () {\n                return null;\n              });\n            });\n            _context3.next = 9;\n            return Promise.allSettled(ops);\n\n          case 9:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3);\n  }));\n  return _deleteTrackerOem.apply(this, arguments);\n}\n\nexport function deleteTrackerModel(_x3) {\n  return _deleteTrackerModel.apply(this, arguments);\n}\n\nfunction _deleteTrackerModel() {\n  _deleteTrackerModel = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(_ref7) {\n    var _catalog$meta5, _catalog$meta5$oemFie, _catalog$meta6, _catalog$meta6$modelF, _catalog$meta6$modelF2;\n\n    var modality, oem, model, catalog, db, docRef, oemField, modelField, path;\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            modality = _ref7.modality, oem = _ref7.oem, model = _ref7.model, catalog = _ref7.catalog;\n\n            if (!(!modality || !oem || !model)) {\n              _context4.next = 3;\n              break;\n            }\n\n            return _context4.abrupt(\"return\");\n\n          case 3:\n            db = firebase.firestore();\n            docRef = db.collection(\"Tracker\").doc(modality);\n            oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta5 = catalog.meta) === null || _catalog$meta5 === void 0 ? void 0 : (_catalog$meta5$oemFie = _catalog$meta5.oemFieldByModality) === null || _catalog$meta5$oemFie === void 0 ? void 0 : _catalog$meta5$oemFie[modality]) || DEFAULT_OEM_FIELD;\n            modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta6 = catalog.meta) === null || _catalog$meta6 === void 0 ? void 0 : (_catalog$meta6$modelF = _catalog$meta6.modelFieldByModalityOem) === null || _catalog$meta6$modelF === void 0 ? void 0 : (_catalog$meta6$modelF2 = _catalog$meta6$modelF[modality]) === null || _catalog$meta6$modelF2 === void 0 ? void 0 : _catalog$meta6$modelF2[oem]) || null;\n            path = modelField ? \"\".concat(oemField, \".\").concat(oem, \".\").concat(modelField) : \"\".concat(oemField, \".\").concat(oem);\n            _context4.next = 10;\n            return docRef.update(_defineProperty({}, path, firebase.firestore.FieldValue.arrayRemove(model)));\n\n          case 10:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n  return _deleteTrackerModel.apply(this, arguments);\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/utils/trackerCatalog.js"],"names":["firebase","OEM_FIELD_CANDIDATES","MODEL_FIELD_CANDIDATES","DEFAULT_OEM_FIELD","isPlainObject","value","Array","isArray","Date","normalizeArray","normalizeList","values","out","forEach","normalized","String","trim","push","from","Set","pickModelField","obj","key","arrayKey","Object","keys","find","extractModels","models","modelField","extractOemMap","data","oemMap","modelFieldByOem","oemField","entries","oem","startsWith","length","fetchTrackerCatalog","db","firestore","collection","get","snap","modalities","oemsByModality","modelsByModalityOem","meta","oemFieldByModality","modelFieldByModalityOem","doc","modality","id","oems","buildAllOems","catalog","set","add","buildModelsForSelection","modelSet","modals","oemList","model","syncTrackerFromSelections","selections","trackerRef","selectedModalities","selectedOems","selectedModels","ops","docRef","existingOems","includes","merge","has","knownModels","knownSet","path","update","FieldValue","arrayUnion","Promise","allSettled","deleteTrackerOem","map","deleteTrackerModel","arrayRemove"],"mappings":"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","sourcesContent":["import firebase from \"../context/Firebase\";\n\nconst OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nconst MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nconst DEFAULT_OEM_FIELD = \"oems\";\n\nconst isPlainObject = (value) =>\n  value != null &&\n  typeof value === \"object\" &&\n  !Array.isArray(value) &&\n  !(value instanceof Date);\n\nconst normalizeArray = (value) => {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nconst normalizeList = (values) => {\n  const out = [];\n  (values || []).forEach((value) => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst pickModelField = (obj) => {\n  if (!isPlainObject(obj)) return null;\n  for (const key of MODEL_FIELD_CANDIDATES) {\n    if (Array.isArray(obj[key])) return key;\n  }\n  const arrayKey = Object.keys(obj).find((key) => Array.isArray(obj[key]));\n  return arrayKey || null;\n};\n\nconst extractModels = (value) => {\n  if (Array.isArray(value)) {\n    return { models: normalizeList(value), modelField: null };\n  }\n  if (isPlainObject(value)) {\n    const modelField = pickModelField(value);\n    const models = modelField ? normalizeList(value[modelField]) : [];\n    return { models, modelField };\n  }\n  if (value != null && value !== \"\") {\n    return { models: normalizeList([value]), modelField: null };\n  }\n  return { models: [], modelField: null };\n};\n\nconst extractOemMap = (data) => {\n  const oemMap = {};\n  const modelFieldByOem = {};\n  let oemField = null;\n\n  for (const key of OEM_FIELD_CANDIDATES) {\n    if (isPlainObject(data?.[key])) {\n      oemField = key;\n      Object.entries(data[key]).forEach(([oem, value]) => {\n        const { models, modelField } = extractModels(value);\n        oemMap[oem] = normalizeList([...(oemMap[oem] || []), ...models]);\n        if (modelField) {\n          modelFieldByOem[oem] = modelField;\n        }\n      });\n    }\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(([key, value]) => {\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n      if (isPlainObject(value) || Array.isArray(value)) {\n        const { models, modelField } = extractModels(value);\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([...(oemMap[key] || []), ...models]);\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return { oemMap, oemField, modelFieldByOem };\n};\n\nexport async function fetchTrackerCatalog() {\n  const db = firebase.firestore();\n  const snap = await db.collection(\"Tracker\").get();\n\n  const modalities = [];\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n  const meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n  };\n\n  snap.forEach((doc) => {\n    const modality = doc.id;\n    const data = doc.data() || {};\n    const { oemMap, oemField, modelFieldByOem } = extractOemMap(data);\n\n    modalities.push(modality);\n    meta.oemFieldByModality[modality] = oemField;\n    meta.modelFieldByModalityOem[modality] = modelFieldByOem || {};\n\n    const oems = Object.keys(oemMap);\n    oemsByModality[modality] = oems;\n    modelsByModalityOem[modality] = {};\n    oems.forEach((oem) => {\n      modelsByModalityOem[modality][oem] = normalizeList(oemMap[oem]);\n    });\n  });\n\n  return {\n    modalities: normalizeList(modalities),\n    oemsByModality,\n    modelsByModalityOem,\n    meta,\n  };\n}\n\nexport function buildAllOems(catalog) {\n  const set = new Set();\n  Object.values(catalog?.oemsByModality || {}).forEach((oems) => {\n    (oems || []).forEach((oem) => set.add(oem));\n  });\n  return Array.from(set);\n}\n\nexport function buildModelsForSelection(catalog, modalities = [], oems = []) {\n  const modelSet = new Set();\n  const modals = normalizeList(modalities);\n  const oemList = normalizeList(oems);\n  modals.forEach((modality) => {\n    const oemMap = catalog?.modelsByModalityOem?.[modality] || {};\n    oemList.forEach((oem) => {\n      const models = oemMap?.[oem] || [];\n      models.forEach((model) => modelSet.add(model));\n    });\n  });\n  return Array.from(modelSet);\n}\n\nexport async function syncTrackerFromSelections({\n  selections,\n  catalog,\n}) {\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const selectedModalities = normalizeList(selections?.modalities || []);\n  const selectedOems = normalizeList(selections?.oems || []);\n  const selectedModels = normalizeList(selections?.models || []);\n\n  if (!selectedModalities.length) return false;\n\n  const ops = [];\n\n  for (const modality of selectedModalities) {\n    const docRef = trackerRef.doc(modality);\n    const existingOems = new Set(catalog?.oemsByModality?.[modality] || []);\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[modality] || DEFAULT_OEM_FIELD;\n\n    if (!catalog?.modalities?.includes?.(modality)) {\n      ops.push(docRef.set({ [DEFAULT_OEM_FIELD]: {} }, { merge: true }));\n    }\n\n    for (const oem of selectedOems) {\n      if (!existingOems.has(oem)) {\n        ops.push(\n          docRef.set({ [oemField]: { [oem]: [] } }, { merge: true })\n        );\n      }\n    }\n\n    for (const oem of selectedOems) {\n      const knownModels =\n        catalog?.modelsByModalityOem?.[modality]?.[oem] || [];\n      const knownSet = new Set(knownModels);\n      const modelField =\n        catalog?.meta?.modelFieldByModalityOem?.[modality]?.[oem] || null;\n      for (const model of selectedModels) {\n        if (knownSet.has(model)) continue;\n        const path = modelField\n          ? `${oemField}.${oem}.${modelField}`\n          : `${oemField}.${oem}`;\n        ops.push(\n          docRef.update({\n            [path]: firebase.firestore.FieldValue.arrayUnion(model),\n          })\n        );\n      }\n    }\n  }\n\n  if (ops.length) {\n    await Promise.allSettled(ops);\n    return true;\n  }\n  return false;\n}\n\nexport async function deleteTrackerOem({ oem, catalog }) {\n  if (!oem) return;\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const modalities = catalog?.modalities || [];\n  const ops = modalities.map((modality) => {\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[modality] || DEFAULT_OEM_FIELD;\n    const docRef = trackerRef.doc(modality);\n    const update = {\n      [`${oemField}.${oem}`]: firebase.firestore.FieldValue.delete(),\n    };\n    if (!catalog?.meta?.oemFieldByModality?.[modality]) {\n      update[oem] = firebase.firestore.FieldValue.delete();\n    }\n    return docRef.update(update).catch(() => null);\n  });\n  await Promise.allSettled(ops);\n}\n\nexport async function deleteTrackerModel({\n  modality,\n  oem,\n  model,\n  catalog,\n}) {\n  if (!modality || !oem || !model) return;\n  const db = firebase.firestore();\n  const docRef = db.collection(\"Tracker\").doc(modality);\n  const oemField =\n    catalog?.meta?.oemFieldByModality?.[modality] || DEFAULT_OEM_FIELD;\n  const modelField =\n    catalog?.meta?.modelFieldByModalityOem?.[modality]?.[oem] || null;\n  const path = modelField\n    ? `${oemField}.${oem}.${modelField}`\n    : `${oemField}.${oem}`;\n  await docRef.update({\n    [path]: firebase.firestore.FieldValue.arrayRemove(model),\n  });\n}\n"]},"metadata":{},"sourceType":"module"}