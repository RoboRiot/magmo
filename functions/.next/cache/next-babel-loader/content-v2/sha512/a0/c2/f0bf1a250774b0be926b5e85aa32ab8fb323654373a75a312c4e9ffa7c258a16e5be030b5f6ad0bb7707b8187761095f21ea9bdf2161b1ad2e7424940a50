{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\n// pages/api/slack/add-to-list.js\nexport default async function handler(req, res) {\n  if (req.method !== \"POST\") return res.status(405).json({\n    error: \"Method not allowed\"\n  });\n\n  try {\n    const {\n      listKey,\n      // \"tasks\" | \"shipping\" | \"receiving\"\n      // common\n      title,\n      linkUrl,\n      bodyText,\n      // shipping/receiving specific (all optional)\n      date,\n      // \"YYYY-MM-DD\"\n      pn,\n      sn,\n      dom,\n      trackingNumber,\n      poNumber,\n      workOrder,\n      localSN,\n      description,\n      photoUrls = []\n    } = req.body;\n    console.log(\"listKey from client:\", req.body.listKey);\n    console.log(\"env present?\", {\n      RECEIVING: !!process.env.SLACK_LIST_RECEIVING_ID,\n      SHIPPING: !!process.env.SLACK_LIST_SHIPPING_ID,\n      TASKS: !!process.env.SLACK_LIST_TASKS_ID\n    }); // Map to CHANNEL ids now (not Lists)\n\n    const CHANNEL_IDS = {\n      receiving: process.env.SLACK_CHANNEL_RECEIVING_ID,\n      shipping: process.env.SLACK_CHANNEL_SHIPPING_ID,\n      tasks: process.env.SLACK_CHANNEL_TASKS_ID\n    };\n    const channel = CHANNEL_IDS[listKey];\n    if (!channel) return res.status(400).json({\n      error: \"Unknown listKey (channel not configured)\"\n    });\n    const token = process.env.SLACK_BOT_TOKEN;\n    if (!token) return res.status(500).json({\n      error: \"Missing bot token\"\n    });\n\n    const slack = async (method, body, headers = {}) => {\n      const resp = await fetch(`https://slack.com/api/${method}`, {\n        method: \"POST\",\n        headers: _objectSpread({\n          Authorization: `Bearer ${token}`\n        }, headers),\n        body\n      });\n      return resp.json();\n    }; // Build a message for the channel\n\n\n    const lines = [];\n    if (title) lines.push(`*${title}*`);\n\n    if (Array.isArray(pn) || pn) {\n      const pnStr = Array.isArray(pn) ? pn.filter(Boolean).join(\", \") : pn;\n      if (pnStr) lines.push(`PN: ${pnStr}`);\n    }\n\n    if (Array.isArray(sn) || sn) {\n      const snStr = Array.isArray(sn) ? sn.filter(Boolean).join(\", \") : sn;\n      if (snStr) lines.push(`SN: ${snStr}`);\n    }\n\n    if (workOrder) lines.push(`WO: ${workOrder}`);\n    if (poNumber) lines.push(`PO: ${poNumber}`);\n    if (trackingNumber) lines.push(`RL: ${trackingNumber}`);\n    if (dom) lines.push(`DOM: ${dom}`);\n    if (localSN) lines.push(`Local SN: ${localSN}`);\n    if (date) lines.push(`Date: ${date}`);\n    if (description) lines.push(description);\n    if (bodyText && listKey === \"tasks\") lines.push(bodyText);\n    if (linkUrl) lines.push(`<${linkUrl}|Open in Magmo>`);\n    const text = lines.filter(Boolean).join(\"\\n\"); // 1) Post the main message\n\n    const postResp = await slack(\"chat.postMessage\", JSON.stringify({\n      channel,\n      text\n    }), {\n      \"Content-Type\": \"application/json; charset=utf-8\"\n    });\n\n    if (!(postResp !== null && postResp !== void 0 && postResp.ok)) {\n      return res.status(400).json({\n        error: (postResp === null || postResp === void 0 ? void 0 : postResp.error) || \"Slack API error (chat.postMessage)\",\n        raw: postResp\n      });\n    } // 2) Optionally upload photos and share to the same channel/thread\n    //    (Requires files:write scope on your bot)\n\n\n    if (Array.isArray(photoUrls) && photoUrls.length) {\n      // Upload via external URLs to avoid proxying the bytes through your server\n      const fileIds = [];\n\n      for (const url of photoUrls) {\n        var _complete$files, _complete$files$;\n\n        // Ask Slack for an external upload URL\n        const up = await slack(\"files.getUploadURLExternal\", new URLSearchParams({\n          filename: url.split(\"/\").pop() || \"image.jpg\"\n        }), {\n          \"Content-Type\": \"application/x-www-form-urlencoded\"\n        });\n        if (!(up !== null && up !== void 0 && up.ok) || !(up !== null && up !== void 0 && up.upload_url)) continue;\n\n        try {\n          const img = await fetch(url);\n          const buf = await img.arrayBuffer();\n          await fetch(up.upload_url, {\n            method: \"PUT\",\n            body: Buffer.from(buf)\n          });\n        } catch (_) {\n          /* ignore upload errors per-file */\n        }\n\n        const complete = await slack(\"files.completeUploadExternal\", JSON.stringify({\n          files: [{\n            id: up.file_id,\n            title: \"photo\"\n          }]\n        }), {\n          \"Content-Type\": \"application/json\"\n        });\n\n        if (complete !== null && complete !== void 0 && complete.ok && complete !== null && complete !== void 0 && (_complete$files = complete.files) !== null && _complete$files !== void 0 && (_complete$files$ = _complete$files[0]) !== null && _complete$files$ !== void 0 && _complete$files$.id) {\n          fileIds.push(complete.files[0].id);\n        }\n      } // Share uploaded files to channel (in a thread under the message)\n\n\n      if (fileIds.length) {\n        await slack(\"files.share\", JSON.stringify({\n          channel_id: channel,\n          file_ids: fileIds,\n          thread_ts: postResp.ts\n        }), {\n          \"Content-Type\": \"application/json\"\n        });\n      }\n    }\n\n    return res.status(200).json({\n      ok: true,\n      channel,\n      ts: postResp.ts\n    });\n  } catch (e) {\n    console.error(e);\n    return res.status(500).json({\n      error: \"Server error\"\n    });\n  }\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/pages/api/slack/add-to-list.js"],"names":["handler","req","res","method","status","json","error","listKey","title","linkUrl","bodyText","date","pn","sn","dom","trackingNumber","poNumber","workOrder","localSN","description","photoUrls","body","console","log","RECEIVING","process","env","SLACK_LIST_RECEIVING_ID","SHIPPING","SLACK_LIST_SHIPPING_ID","TASKS","SLACK_LIST_TASKS_ID","CHANNEL_IDS","receiving","SLACK_CHANNEL_RECEIVING_ID","shipping","SLACK_CHANNEL_SHIPPING_ID","tasks","SLACK_CHANNEL_TASKS_ID","channel","token","SLACK_BOT_TOKEN","slack","headers","resp","fetch","Authorization","lines","push","Array","isArray","pnStr","filter","Boolean","join","snStr","text","postResp","JSON","stringify","ok","raw","length","fileIds","url","up","URLSearchParams","filename","split","pop","upload_url","img","buf","arrayBuffer","Buffer","from","_","complete","files","id","file_id","channel_id","file_ids","thread_ts","ts","e"],"mappings":"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","sourcesContent":["// pages/api/slack/add-to-list.js\r\nexport default async function handler(req, res) {\r\n  if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\r\n\r\n  try {\r\n    const {\r\n      listKey,                // \"tasks\" | \"shipping\" | \"receiving\"\r\n      // common\r\n      title,\r\n      linkUrl,\r\n      bodyText,\r\n\r\n      // shipping/receiving specific (all optional)\r\n      date,                   // \"YYYY-MM-DD\"\r\n      pn,\r\n      sn,\r\n      dom,\r\n      trackingNumber,\r\n      poNumber,\r\n          workOrder,\r\n          localSN,\r\n          description,\r\n          photoUrls = [],\r\n      } = req.body;\r\n\r\n      console.log(\"listKey from client:\", req.body.listKey);\r\n      console.log(\"env present?\", {\r\n          RECEIVING: !!process.env.SLACK_LIST_RECEIVING_ID,\r\n          SHIPPING: !!process.env.SLACK_LIST_SHIPPING_ID,\r\n          TASKS: !!process.env.SLACK_LIST_TASKS_ID,\r\n      });\r\n\r\n\r\n\r\n    // Map to CHANNEL ids now (not Lists)\r\n    const CHANNEL_IDS = {\r\n      receiving: process.env.SLACK_CHANNEL_RECEIVING_ID,\r\n      shipping:  process.env.SLACK_CHANNEL_SHIPPING_ID,\r\n      tasks:     process.env.SLACK_CHANNEL_TASKS_ID,\r\n    };\r\n    const channel = CHANNEL_IDS[listKey];\r\n    if (!channel) return res.status(400).json({ error: \"Unknown listKey (channel not configured)\" });\r\n\r\n    const token = process.env.SLACK_BOT_TOKEN;\r\n    if (!token) return res.status(500).json({ error: \"Missing bot token\" });\r\n\r\n    const slack = async (method, body, headers = {}) => {\r\n      const resp = await fetch(`https://slack.com/api/${method}`, {\r\n        method: \"POST\",\r\n        headers: { Authorization: `Bearer ${token}`, ...headers },\r\n        body\r\n      });\r\n      return resp.json();\r\n    };\r\n\r\n    // Build a message for the channel\r\n    const lines = [];\r\n    if (title) lines.push(`*${title}*`);\r\n    if (Array.isArray(pn) || pn) {\r\n      const pnStr = Array.isArray(pn) ? pn.filter(Boolean).join(\", \") : pn;\r\n      if (pnStr) lines.push(`PN: ${pnStr}`);\r\n    }\r\n    if (Array.isArray(sn) || sn) {\r\n      const snStr = Array.isArray(sn) ? sn.filter(Boolean).join(\", \") : sn;\r\n      if (snStr) lines.push(`SN: ${snStr}`);\r\n    }\r\n    if (workOrder)      lines.push(`WO: ${workOrder}`);\r\n    if (poNumber)       lines.push(`PO: ${poNumber}`);\r\n    if (trackingNumber) lines.push(`RL: ${trackingNumber}`);\r\n    if (dom)            lines.push(`DOM: ${dom}`);\r\n    if (localSN)        lines.push(`Local SN: ${localSN}`);\r\n    if (date)           lines.push(`Date: ${date}`);\r\n    if (description)    lines.push(description);\r\n    if (bodyText && listKey === \"tasks\") lines.push(bodyText);\r\n    if (linkUrl)        lines.push(`<${linkUrl}|Open in Magmo>`);\r\n\r\n    const text = lines.filter(Boolean).join(\"\\n\");\r\n\r\n    // 1) Post the main message\r\n    const postResp = await slack(\r\n      \"chat.postMessage\",\r\n      JSON.stringify({ channel, text }),\r\n      { \"Content-Type\": \"application/json; charset=utf-8\" }\r\n    );\r\n    if (!postResp?.ok) {\r\n      return res.status(400).json({ error: postResp?.error || \"Slack API error (chat.postMessage)\", raw: postResp });\r\n    }\r\n\r\n    // 2) Optionally upload photos and share to the same channel/thread\r\n    //    (Requires files:write scope on your bot)\r\n    if (Array.isArray(photoUrls) && photoUrls.length) {\r\n      // Upload via external URLs to avoid proxying the bytes through your server\r\n      const fileIds = [];\r\n      for (const url of photoUrls) {\r\n        // Ask Slack for an external upload URL\r\n        const up = await slack(\r\n          \"files.getUploadURLExternal\",\r\n          new URLSearchParams({ filename: url.split(\"/\").pop() || \"image.jpg\" }),\r\n          { \"Content-Type\": \"application/x-www-form-urlencoded\" }\r\n        );\r\n        if (!up?.ok || !up?.upload_url) continue;\r\n\r\n        try {\r\n          const img = await fetch(url);\r\n          const buf = await img.arrayBuffer();\r\n          await fetch(up.upload_url, { method: \"PUT\", body: Buffer.from(buf) });\r\n        } catch (_) { /* ignore upload errors per-file */ }\r\n\r\n        const complete = await slack(\r\n          \"files.completeUploadExternal\",\r\n          JSON.stringify({ files: [{ id: up.file_id, title: \"photo\" }] }),\r\n          { \"Content-Type\": \"application/json\" }\r\n        );\r\n        if (complete?.ok && complete?.files?.[0]?.id) {\r\n          fileIds.push(complete.files[0].id);\r\n        }\r\n      }\r\n\r\n      // Share uploaded files to channel (in a thread under the message)\r\n      if (fileIds.length) {\r\n        await slack(\r\n          \"files.share\",\r\n          JSON.stringify({ channel_id: channel, file_ids: fileIds, thread_ts: postResp.ts }),\r\n          { \"Content-Type\": \"application/json\" }\r\n        );\r\n      }\r\n    }\r\n\r\n    return res.status(200).json({ ok: true, channel, ts: postResp.ts });\r\n  } catch (e) {\r\n    console.error(e);\r\n    return res.status(500).json({ error: \"Server error\" });\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}