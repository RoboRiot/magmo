{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\mack2\\\\Desktop\\\\code\\\\pages\\\\NewSearch\\\\client\\\\[id]\\\\index.js\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/router\";\nimport { Table, Button, Alert, Spinner } from \"react-bootstrap\";\nimport firebase from \"../../../../context/Firebase\";\nimport ClientInfoModal from \"../../ClientInfoModal\";\nimport MachineCreationModal from \"../../MachineCreationModal\";\nimport styles from \"../Client.module.css\"; // Import for SSR\n\nimport { adminDb } from \"../../../../context/FirebaseAdmin\";\n\nconst Client = ({\n  initialClient,\n  initialMachines,\n  error: initialError\n}) => {\n  const router = useRouter();\n  const {\n    0: selectedClient,\n    1: setSelectedClient\n  } = useState(initialClient || null);\n  const {\n    0: machineOptions,\n    1: setMachineOptions\n  } = useState(Array.isArray(initialMachines) ? initialMachines : []);\n  const {\n    0: error,\n    1: setError\n  } = useState(initialError || null);\n  const {\n    0: isLoading,\n    1: setIsLoading\n  } = useState(!initialClient && !initialError); // State for machine addition modals\n\n  const {\n    0: showAddMachineModal,\n    1: setShowAddMachineModal\n  } = useState(false);\n  const {\n    0: showCreateMachineModal,\n    1: setShowCreateMachineModal\n  } = useState(false);\n  const {\n    0: availableMachines,\n    1: setAvailableMachines\n  } = useState([]);\n  useEffect(() => {\n    if (!router.isReady) return;\n    const activeId = router.query.id || router.asPath.split(\"/\").pop();\n    if (!activeId) return;\n    const hasInitial = initialClient && initialClient.id === activeId;\n    fetchClientData(activeId, {\n      silent: hasInitial\n    });\n  }, [router.isReady, router.query.id, initialClient]);\n\n  const fetchClientData = async (clientId, {\n    silent = false\n  } = {}) => {\n    if (!silent) {\n      setIsLoading(true);\n    }\n\n    setError(null);\n\n    try {\n      const db = firebase.firestore();\n      const clientDoc = await db.collection(\"Client\").doc(clientId).get();\n\n      if (clientDoc.exists) {\n        const clientData = clientDoc.data();\n        setSelectedClient(_objectSpread({\n          id: clientId\n        }, clientData));\n        const machineRefs = Array.isArray(clientData.machines) ? clientData.machines : [];\n        const machinePromises = machineRefs.map(machineRef => machineRef.get());\n        const machineDocs = await Promise.all(machinePromises);\n        const machines = machineDocs.map(machineDoc => _objectSpread({\n          id: machineDoc.id\n        }, machineDoc.data()));\n        setMachineOptions(machines);\n      } else {\n        setError(\"Client not found\");\n      }\n    } catch (error) {\n      console.error(\"Error fetching client data:\", error);\n      setError(\"Error fetching client data\");\n    } finally {\n      if (!silent) {\n        setIsLoading(false);\n      }\n    }\n  }; // Fetch available machines (those not yet assigned to a client)\n\n\n  const fetchAvailableMachines = async () => {\n    try {\n      const db = firebase.firestore();\n      const snapshot = await db.collection(\"Machine\").where(\"client\", \"==\", null).get();\n      const machines = snapshot.docs.map(doc => _objectSpread({\n        id: doc.id\n      }, doc.data()));\n      setAvailableMachines(machines);\n    } catch (error) {\n      console.error(\"Error fetching available machines:\", error);\n      setError(\"Failed to fetch available machines.\");\n    }\n  };\n\n  const handleSelectMachine = (id, name) => {\n    // Navigate to the machine details page if needed\n    router.push(\"../machine/\" + id);\n  }; // When adding an existing machine\n\n\n  const handleAddMachine = async machine => {\n    try {\n      const db = firebase.firestore();\n      const clientId = router.query.clientId || router.asPath.split(\"/\").pop(); // Update client's \"machines\" array with the machine reference\n\n      await db.collection(\"Client\").doc(clientId).update({\n        machines: firebase.firestore.FieldValue.arrayUnion(db.collection(\"Machine\").doc(machine.id))\n      }); // Update local state to include the newly added machine\n\n      setMachineOptions(prev => [...prev, machine]);\n      setShowAddMachineModal(false);\n    } catch (error) {\n      console.error(\"Error adding machine to client:\", error);\n      setError(\"Failed to add machine to client.\");\n    }\n  }; // When creating a new machine for the client\n\n\n  const handleCreateMachine = async newMachine => {\n    try {\n      const db = firebase.firestore();\n      const clientId = router.query.clientId || router.asPath.split(\"/\").pop();\n      const machineId = `AIS${Math.floor(10000 + Math.random() * 90000)}`;\n\n      const machineWithId = _objectSpread(_objectSpread({}, newMachine), {}, {\n        id: machineId,\n        client: db.collection(\"Client\").doc(clientId)\n      }); // Create the machine document\n\n\n      await db.collection(\"Machine\").doc(machineId).set(machineWithId); // Add the machine reference to the client\n\n      await db.collection(\"Client\").doc(clientId).update({\n        machines: firebase.firestore.FieldValue.arrayUnion(db.collection(\"Machine\").doc(machineId))\n      }); // Update local state\n\n      setMachineOptions(prev => [...prev, _objectSpread({\n        id: machineId\n      }, newMachine)]);\n      setShowCreateMachineModal(false);\n    } catch (error) {\n      console.error(\"Error creating and adding machine:\", error);\n      setError(\"Failed to create and add machine.\");\n    }\n  }; // Open the modal to add an existing machine; fetch available machines first\n\n\n  const openAddMachineModal = async () => {\n    await fetchAvailableMachines();\n    setShowAddMachineModal(true);\n  };\n\n  return __jsx(\"div\", {\n    className: styles.page,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 165,\n      columnNumber: 5\n    }\n  }, __jsx(\"div\", {\n    className: styles.shell,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 166,\n      columnNumber: 7\n    }\n  }, __jsx(\"header\", {\n    className: styles.header,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 167,\n      columnNumber: 9\n    }\n  }, __jsx(\"div\", {\n    className: styles.brand,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 168,\n      columnNumber: 11\n    }\n  }, __jsx(\"img\", {\n    src: \"/magmo-logo.png\",\n    alt: \"Magmo\",\n    className: styles.brandLogo,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 169,\n      columnNumber: 13\n    }\n  }), __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 170,\n      columnNumber: 13\n    }\n  }, __jsx(\"div\", {\n    className: styles.brandName,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 171,\n      columnNumber: 15\n    }\n  }, \"Magmo\"), __jsx(\"div\", {\n    className: styles.brandSub,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 172,\n      columnNumber: 15\n    }\n  }, \"Client Detail\"))), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: styles.backButton,\n    onClick: () => router.back(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 175,\n      columnNumber: 11\n    }\n  }, \"Back\")), __jsx(\"section\", {\n    className: styles.card,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 9\n    }\n  }, __jsx(\"div\", {\n    className: styles.cardHeader,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 185,\n      columnNumber: 11\n    }\n  }, __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 186,\n      columnNumber: 13\n    }\n  }, __jsx(\"div\", {\n    className: styles.cardTitle,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 187,\n      columnNumber: 15\n    }\n  }, \"Client Machines\"), __jsx(\"div\", {\n    className: styles.cardSubtitle,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 188,\n      columnNumber: 15\n    }\n  }, \"Manage machines linked to this client.\")), __jsx(\"div\", {\n    className: styles.cardMeta,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 192,\n      columnNumber: 13\n    }\n  }, machineOptions.length, \" machines\")), __jsx(\"div\", {\n    className: styles.cardBody,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 197,\n      columnNumber: 11\n    }\n  }, error && __jsx(Alert, {\n    variant: \"danger\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 198,\n      columnNumber: 23\n    }\n  }, error), isLoading && __jsx(\"div\", {\n    className: styles.loadingWrap,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 200,\n      columnNumber: 15\n    }\n  }, __jsx(Spinner, {\n    animation: \"border\",\n    role: \"status\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 201,\n      columnNumber: 17\n    }\n  }, __jsx(\"span\", {\n    className: \"sr-only\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 202,\n      columnNumber: 19\n    }\n  }, \"Loading...\"))), !isLoading && selectedClient && __jsx(React.Fragment, null, __jsx(\"div\", {\n    className: styles.clientSummary,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 209,\n      columnNumber: 17\n    }\n  }, __jsx(\"div\", {\n    className: styles.clientName,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 210,\n      columnNumber: 19\n    }\n  }, selectedClient.name), __jsx(\"div\", {\n    className: styles.clientMetaRow,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 211,\n      columnNumber: 19\n    }\n  }, __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 212,\n      columnNumber: 21\n    }\n  }, \"Location: \", selectedClient.local || \"Unknown\"), __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 215,\n      columnNumber: 21\n    }\n  }, \"Client ID: \", selectedClient.id))), __jsx(\"div\", {\n    className: styles.actionRow,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 219,\n      columnNumber: 17\n    }\n  }, __jsx(Button, {\n    variant: \"primary\",\n    onClick: openAddMachineModal,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 220,\n      columnNumber: 19\n    }\n  }, \"Add Existing Machine\"), __jsx(Button, {\n    variant: \"outline-secondary\",\n    onClick: () => setShowCreateMachineModal(true),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 223,\n      columnNumber: 19\n    }\n  }, \"Create New Machine\")), __jsx(\"div\", {\n    className: styles.tableCard,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 231,\n      columnNumber: 17\n    }\n  }, __jsx(\"div\", {\n    className: styles.tableHeader,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 232,\n      columnNumber: 19\n    }\n  }, __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 233,\n      columnNumber: 21\n    }\n  }, \"Machines\"), __jsx(\"span\", {\n    className: styles.tableHint,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 234,\n      columnNumber: 21\n    }\n  }, \"Select a machine to view details.\")), __jsx(\"div\", {\n    className: styles.tableWrap,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 238,\n      columnNumber: 19\n    }\n  }, __jsx(Table, {\n    striped: true,\n    bordered: true,\n    hover: true,\n    size: \"sm\",\n    className: styles.table,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 239,\n      columnNumber: 21\n    }\n  }, __jsx(\"thead\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 240,\n      columnNumber: 23\n    }\n  }, __jsx(\"tr\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 241,\n      columnNumber: 25\n    }\n  }, __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 242,\n      columnNumber: 27\n    }\n  }, \"Name\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 243,\n      columnNumber: 27\n    }\n  }, \"Location\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 244,\n      columnNumber: 27\n    }\n  }, \"OEM\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 245,\n      columnNumber: 27\n    }\n  }, \"Modality\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 246,\n      columnNumber: 27\n    }\n  }, \"Select\"))), __jsx(\"tbody\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 249,\n      columnNumber: 23\n    }\n  }, machineOptions.length === 0 ? __jsx(\"tr\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 251,\n      columnNumber: 27\n    }\n  }, __jsx(\"td\", {\n    colSpan: 5,\n    className: styles.emptyState,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 252,\n      columnNumber: 29\n    }\n  }, \"No machines assigned yet.\")) : machineOptions.map(machine => __jsx(\"tr\", {\n    key: machine.id,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 258,\n      columnNumber: 29\n    }\n  }, __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 259,\n      columnNumber: 31\n    }\n  }, machine.name), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 260,\n      columnNumber: 31\n    }\n  }, machine.local), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 261,\n      columnNumber: 31\n    }\n  }, machine.OEM), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 262,\n      columnNumber: 31\n    }\n  }, machine.Modality), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 263,\n      columnNumber: 31\n    }\n  }, __jsx(Button, {\n    variant: \"primary\",\n    size: \"sm\",\n    onClick: () => handleSelectMachine(machine.id, machine.name),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 264,\n      columnNumber: 33\n    }\n  }, \"Select\")))))))))))), __jsx(ClientInfoModal, {\n    show: showAddMachineModal,\n    handleClose: () => setShowAddMachineModal(false),\n    machineOptions: availableMachines,\n    setSelectedMachine: handleAddMachine,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 288,\n      columnNumber: 7\n    }\n  }), __jsx(MachineCreationModal, {\n    show: showCreateMachineModal,\n    handleClose: () => setShowCreateMachineModal(false),\n    onCreateMachine: handleCreateMachine,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 296,\n      columnNumber: 7\n    }\n  }));\n};\n\nexport default Client; // Server-side rendering function\n\nexport async function getServerSideProps(context) {\n  const {\n    id\n  } = context.params;\n\n  try {\n    // Fetch client data from Firestore using Admin SDK\n    const clientDoc = await adminDb.collection(\"Client\").doc(id).get();\n\n    if (!clientDoc.exists) {\n      return {\n        notFound: true // This will show a 404 page\n\n      };\n    }\n\n    const clientData = clientDoc.data(); // Fetch machine documents referenced in the client's machines array\n\n    let machines = [];\n\n    if (clientData.machines && Array.isArray(clientData.machines)) {\n      try {\n        const machinePromises = clientData.machines.map(machineRef => {\n          if (machineRef.path) {\n            return adminDb.doc(machineRef.path).get();\n          }\n\n          return null;\n        }).filter(Boolean);\n        const machineDocs = await Promise.all(machinePromises);\n        machines = machineDocs.map(machineDoc => {\n          const machineData = machineDoc.data(); // Extract only serializable data, remove any Firestore references\n\n          const serializedMachine = {\n            id: machineDoc.id,\n            name: machineData.name || \"\",\n            local: machineData.local || \"\",\n            OEM: machineData.OEM || \"\",\n            Modality: machineData.Modality || \"\",\n            Model: machineData.Model || \"\" // Add other fields as needed, but ensure they're serializable\n\n          }; // If there's a client reference, extract just the client name\n\n          if (machineData.client && machineData.client.path) {\n            try {\n              const clientDoc = adminDb.doc(machineData.client.path).get();\n\n              if (clientDoc.exists) {\n                serializedMachine.clientName = clientDoc.data().name || \"\";\n              }\n            } catch (error) {\n              console.error(\"Error fetching client name:\", error);\n            }\n          }\n\n          return serializedMachine;\n        });\n      } catch (error) {\n        console.error(\"Error fetching machine data:\", error);\n      }\n    } // Serialize the client data, removing any non-serializable fields\n\n\n    const serializedClient = {\n      id,\n      name: clientData.name || \"\",\n      local: clientData.local || \"\" // Add other client fields as needed, but ensure they're serializable\n\n    };\n    return {\n      props: {\n        initialClient: serializedClient,\n        initialMachines: machines\n      }\n    };\n  } catch (error) {\n    console.error(\"Error in getServerSideProps:\", error);\n    return {\n      props: {\n        error: \"Failed to load client data\"\n      }\n    };\n  }\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/pages/NewSearch/client/[id]/index.js"],"names":["React","useEffect","useState","useRouter","Table","Button","Alert","Spinner","firebase","ClientInfoModal","MachineCreationModal","styles","adminDb","Client","initialClient","initialMachines","error","initialError","router","selectedClient","setSelectedClient","machineOptions","setMachineOptions","Array","isArray","setError","isLoading","setIsLoading","showAddMachineModal","setShowAddMachineModal","showCreateMachineModal","setShowCreateMachineModal","availableMachines","setAvailableMachines","isReady","activeId","query","id","asPath","split","pop","hasInitial","fetchClientData","silent","clientId","db","firestore","clientDoc","collection","doc","get","exists","clientData","data","machineRefs","machines","machinePromises","map","machineRef","machineDocs","Promise","all","machineDoc","console","fetchAvailableMachines","snapshot","where","docs","handleSelectMachine","name","push","handleAddMachine","machine","update","FieldValue","arrayUnion","prev","handleCreateMachine","newMachine","machineId","Math","floor","random","machineWithId","client","set","openAddMachineModal","page","shell","header","brand","brandLogo","brandName","brandSub","backButton","back","card","cardHeader","cardTitle","cardSubtitle","cardMeta","length","cardBody","loadingWrap","clientSummary","clientName","clientMetaRow","local","actionRow","tableCard","tableHeader","tableHint","tableWrap","table","emptyState","OEM","Modality","getServerSideProps","context","params","notFound","path","filter","Boolean","machineData","serializedMachine","Model","serializedClient","props"],"mappings":";;;;;;;;;AAAA,OAAOA,KAAP,IAAgBC,SAAhB,EAA2BC,QAA3B,QAA2C,OAA3C;AACA,SAASC,SAAT,QAA0B,aAA1B;AACA,SACEC,KADF,EAEEC,MAFF,EAGEC,KAHF,EAIEC,OAJF,QAKO,iBALP;AAMA,OAAOC,QAAP,MAAqB,8BAArB;AACA,OAAOC,eAAP,MAA4B,uBAA5B;AACA,OAAOC,oBAAP,MAAiC,4BAAjC;AACA,OAAOC,MAAP,MAAmB,sBAAnB,C,CAEA;;AACA,SAASC,OAAT,QAAwB,mCAAxB;;AAEA,MAAMC,MAAM,GAAG,CAAC;AAAEC,EAAAA,aAAF;AAAiBC,EAAAA,eAAjB;AAAkCC,EAAAA,KAAK,EAAEC;AAAzC,CAAD,KAA6D;AAC1E,QAAMC,MAAM,GAAGf,SAAS,EAAxB;AACA,QAAM;AAAA,OAACgB,cAAD;AAAA,OAAiBC;AAAjB,MAAsClB,QAAQ,CAACY,aAAa,IAAI,IAAlB,CAApD;AACA,QAAM;AAAA,OAACO,cAAD;AAAA,OAAiBC;AAAjB,MAAsCpB,QAAQ,CAClDqB,KAAK,CAACC,OAAN,CAAcT,eAAd,IAAiCA,eAAjC,GAAmD,EADD,CAApD;AAGA,QAAM;AAAA,OAACC,KAAD;AAAA,OAAQS;AAAR,MAAoBvB,QAAQ,CAACe,YAAY,IAAI,IAAjB,CAAlC;AACA,QAAM;AAAA,OAACS,SAAD;AAAA,OAAYC;AAAZ,MAA4BzB,QAAQ,CACxC,CAACY,aAAD,IAAkB,CAACG,YADqB,CAA1C,CAP0E,CAW1E;;AACA,QAAM;AAAA,OAACW,mBAAD;AAAA,OAAsBC;AAAtB,MAAgD3B,QAAQ,CAAC,KAAD,CAA9D;AACA,QAAM;AAAA,OAAC4B,sBAAD;AAAA,OAAyBC;AAAzB,MAAsD7B,QAAQ,CAAC,KAAD,CAApE;AACA,QAAM;AAAA,OAAC8B,iBAAD;AAAA,OAAoBC;AAApB,MAA4C/B,QAAQ,CAAC,EAAD,CAA1D;AAEAD,EAAAA,SAAS,CAAC,MAAM;AACd,QAAI,CAACiB,MAAM,CAACgB,OAAZ,EAAqB;AACrB,UAAMC,QAAQ,GAAGjB,MAAM,CAACkB,KAAP,CAAaC,EAAb,IAAmBnB,MAAM,CAACoB,MAAP,CAAcC,KAAd,CAAoB,GAApB,EAAyBC,GAAzB,EAApC;AACA,QAAI,CAACL,QAAL,EAAe;AACf,UAAMM,UAAU,GAAG3B,aAAa,IAAIA,aAAa,CAACuB,EAAd,KAAqBF,QAAzD;AACAO,IAAAA,eAAe,CAACP,QAAD,EAAW;AAAEQ,MAAAA,MAAM,EAAEF;AAAV,KAAX,CAAf;AACD,GANQ,EAMN,CAACvB,MAAM,CAACgB,OAAR,EAAiBhB,MAAM,CAACkB,KAAP,CAAaC,EAA9B,EAAkCvB,aAAlC,CANM,CAAT;;AAQA,QAAM4B,eAAe,GAAG,OAAOE,QAAP,EAAiB;AAAED,IAAAA,MAAM,GAAG;AAAX,MAAqB,EAAtC,KAA6C;AACnE,QAAI,CAACA,MAAL,EAAa;AACXhB,MAAAA,YAAY,CAAC,IAAD,CAAZ;AACD;;AACDF,IAAAA,QAAQ,CAAC,IAAD,CAAR;;AACA,QAAI;AACF,YAAMoB,EAAE,GAAGrC,QAAQ,CAACsC,SAAT,EAAX;AACA,YAAMC,SAAS,GAAG,MAAMF,EAAE,CAACG,UAAH,CAAc,QAAd,EAAwBC,GAAxB,CAA4BL,QAA5B,EAAsCM,GAAtC,EAAxB;;AACA,UAAIH,SAAS,CAACI,MAAd,EAAsB;AACpB,cAAMC,UAAU,GAAGL,SAAS,CAACM,IAAV,EAAnB;AACAjC,QAAAA,iBAAiB;AAAGiB,UAAAA,EAAE,EAAEO;AAAP,WAAoBQ,UAApB,EAAjB;AAEA,cAAME,WAAW,GAAG/B,KAAK,CAACC,OAAN,CAAc4B,UAAU,CAACG,QAAzB,IAChBH,UAAU,CAACG,QADK,GAEhB,EAFJ;AAGA,cAAMC,eAAe,GAAGF,WAAW,CAACG,GAAZ,CAAiBC,UAAD,IACtCA,UAAU,CAACR,GAAX,EADsB,CAAxB;AAGA,cAAMS,WAAW,GAAG,MAAMC,OAAO,CAACC,GAAR,CAAYL,eAAZ,CAA1B;AACA,cAAMD,QAAQ,GAAGI,WAAW,CAACF,GAAZ,CAAiBK,UAAD;AAC/BzB,UAAAA,EAAE,EAAEyB,UAAU,CAACzB;AADgB,WAE5ByB,UAAU,CAACT,IAAX,EAF4B,CAAhB,CAAjB;AAIA/B,QAAAA,iBAAiB,CAACiC,QAAD,CAAjB;AACD,OAhBD,MAgBO;AACL9B,QAAAA,QAAQ,CAAC,kBAAD,CAAR;AACD;AACF,KAtBD,CAsBE,OAAOT,KAAP,EAAc;AACd+C,MAAAA,OAAO,CAAC/C,KAAR,CAAc,6BAAd,EAA6CA,KAA7C;AACAS,MAAAA,QAAQ,CAAC,4BAAD,CAAR;AACD,KAzBD,SAyBU;AACR,UAAI,CAACkB,MAAL,EAAa;AACXhB,QAAAA,YAAY,CAAC,KAAD,CAAZ;AACD;AACF;AACF,GAnCD,CAxB0E,CA6D1E;;;AACA,QAAMqC,sBAAsB,GAAG,YAAY;AACzC,QAAI;AACF,YAAMnB,EAAE,GAAGrC,QAAQ,CAACsC,SAAT,EAAX;AACA,YAAMmB,QAAQ,GAAG,MAAMpB,EAAE,CACtBG,UADoB,CACT,SADS,EAEpBkB,KAFoB,CAEd,QAFc,EAEJ,IAFI,EAEE,IAFF,EAGpBhB,GAHoB,EAAvB;AAIA,YAAMK,QAAQ,GAAGU,QAAQ,CAACE,IAAT,CAAcV,GAAd,CAAmBR,GAAD;AACjCZ,QAAAA,EAAE,EAAEY,GAAG,CAACZ;AADyB,SAE9BY,GAAG,CAACI,IAAJ,EAF8B,CAAlB,CAAjB;AAIApB,MAAAA,oBAAoB,CAACsB,QAAD,CAApB;AACD,KAXD,CAWE,OAAOvC,KAAP,EAAc;AACd+C,MAAAA,OAAO,CAAC/C,KAAR,CAAc,oCAAd,EAAoDA,KAApD;AACAS,MAAAA,QAAQ,CAAC,qCAAD,CAAR;AACD;AACF,GAhBD;;AAkBA,QAAM2C,mBAAmB,GAAG,CAAC/B,EAAD,EAAKgC,IAAL,KAAc;AACxC;AACAnD,IAAAA,MAAM,CAACoD,IAAP,CAAY,gBAAgBjC,EAA5B;AACD,GAHD,CAhF0E,CAqF1E;;;AACA,QAAMkC,gBAAgB,GAAG,MAAOC,OAAP,IAAmB;AAC1C,QAAI;AACF,YAAM3B,EAAE,GAAGrC,QAAQ,CAACsC,SAAT,EAAX;AACA,YAAMF,QAAQ,GAAG1B,MAAM,CAACkB,KAAP,CAAaQ,QAAb,IAAyB1B,MAAM,CAACoB,MAAP,CAAcC,KAAd,CAAoB,GAApB,EAAyBC,GAAzB,EAA1C,CAFE,CAIF;;AACA,YAAMK,EAAE,CACLG,UADG,CACQ,QADR,EAEHC,GAFG,CAECL,QAFD,EAGH6B,MAHG,CAGI;AACNlB,QAAAA,QAAQ,EAAE/C,QAAQ,CAACsC,SAAT,CAAmB4B,UAAnB,CAA8BC,UAA9B,CACR9B,EAAE,CAACG,UAAH,CAAc,SAAd,EAAyBC,GAAzB,CAA6BuB,OAAO,CAACnC,EAArC,CADQ;AADJ,OAHJ,CAAN,CALE,CAcF;;AACAf,MAAAA,iBAAiB,CAAEsD,IAAD,IAAU,CAAC,GAAGA,IAAJ,EAAUJ,OAAV,CAAX,CAAjB;AACA3C,MAAAA,sBAAsB,CAAC,KAAD,CAAtB;AACD,KAjBD,CAiBE,OAAOb,KAAP,EAAc;AACd+C,MAAAA,OAAO,CAAC/C,KAAR,CAAc,iCAAd,EAAiDA,KAAjD;AACAS,MAAAA,QAAQ,CAAC,kCAAD,CAAR;AACD;AACF,GAtBD,CAtF0E,CA8G1E;;;AACA,QAAMoD,mBAAmB,GAAG,MAAOC,UAAP,IAAsB;AAChD,QAAI;AACF,YAAMjC,EAAE,GAAGrC,QAAQ,CAACsC,SAAT,EAAX;AACA,YAAMF,QAAQ,GAAG1B,MAAM,CAACkB,KAAP,CAAaQ,QAAb,IAAyB1B,MAAM,CAACoB,MAAP,CAAcC,KAAd,CAAoB,GAApB,EAAyBC,GAAzB,EAA1C;AACA,YAAMuC,SAAS,GAAI,MAAKC,IAAI,CAACC,KAAL,CAAW,QAAQD,IAAI,CAACE,MAAL,KAAgB,KAAnC,CAA0C,EAAlE;;AACA,YAAMC,aAAa,mCACdL,UADc;AAEjBzC,QAAAA,EAAE,EAAE0C,SAFa;AAGjBK,QAAAA,MAAM,EAAEvC,EAAE,CAACG,UAAH,CAAc,QAAd,EAAwBC,GAAxB,CAA4BL,QAA5B;AAHS,QAAnB,CAJE,CASF;;;AACA,YAAMC,EAAE,CAACG,UAAH,CAAc,SAAd,EAAyBC,GAAzB,CAA6B8B,SAA7B,EAAwCM,GAAxC,CAA4CF,aAA5C,CAAN,CAVE,CAWF;;AACA,YAAMtC,EAAE,CACLG,UADG,CACQ,QADR,EAEHC,GAFG,CAECL,QAFD,EAGH6B,MAHG,CAGI;AACNlB,QAAAA,QAAQ,EAAE/C,QAAQ,CAACsC,SAAT,CAAmB4B,UAAnB,CAA8BC,UAA9B,CACR9B,EAAE,CAACG,UAAH,CAAc,SAAd,EAAyBC,GAAzB,CAA6B8B,SAA7B,CADQ;AADJ,OAHJ,CAAN,CAZE,CAoBF;;AACAzD,MAAAA,iBAAiB,CAAEsD,IAAD,IAAU,CAAC,GAAGA,IAAJ;AAAYvC,QAAAA,EAAE,EAAE0C;AAAhB,SAA8BD,UAA9B,EAAX,CAAjB;AACA/C,MAAAA,yBAAyB,CAAC,KAAD,CAAzB;AACD,KAvBD,CAuBE,OAAOf,KAAP,EAAc;AACd+C,MAAAA,OAAO,CAAC/C,KAAR,CAAc,oCAAd,EAAoDA,KAApD;AACAS,MAAAA,QAAQ,CAAC,mCAAD,CAAR;AACD;AACF,GA5BD,CA/G0E,CA6I1E;;;AACA,QAAM6D,mBAAmB,GAAG,YAAY;AACtC,UAAMtB,sBAAsB,EAA5B;AACAnC,IAAAA,sBAAsB,CAAC,IAAD,CAAtB;AACD,GAHD;;AAKA,SACE;AAAK,IAAA,SAAS,EAAElB,MAAM,CAAC4E,IAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,SAAS,EAAE5E,MAAM,CAAC6E,KAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAQ,IAAA,SAAS,EAAE7E,MAAM,CAAC8E,MAA1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,SAAS,EAAE9E,MAAM,CAAC+E,KAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,GAAG,EAAC,iBAAT;AAA2B,IAAA,GAAG,EAAC,OAA/B;AAAuC,IAAA,SAAS,EAAE/E,MAAM,CAACgF,SAAzD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IADF,EAEE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,SAAS,EAAEhF,MAAM,CAACiF,SAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aADF,EAEE;AAAK,IAAA,SAAS,EAAEjF,MAAM,CAACkF,QAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAFF,CAFF,CADF,EAQE,MAAC,MAAD;AACE,IAAA,OAAO,EAAC,mBADV;AAEE,IAAA,SAAS,EAAElF,MAAM,CAACmF,UAFpB;AAGE,IAAA,OAAO,EAAE,MAAM5E,MAAM,CAAC6E,IAAP,EAHjB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YARF,CADF,EAkBE;AAAS,IAAA,SAAS,EAAEpF,MAAM,CAACqF,IAA3B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,SAAS,EAAErF,MAAM,CAACsF,UAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,SAAS,EAAEtF,MAAM,CAACuF,SAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBADF,EAEE;AAAK,IAAA,SAAS,EAAEvF,MAAM,CAACwF,YAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8CAFF,CADF,EAOE;AAAK,IAAA,SAAS,EAAExF,MAAM,CAACyF,QAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACG/E,cAAc,CAACgF,MADlB,cAPF,CADF,EAaE;AAAK,IAAA,SAAS,EAAE1F,MAAM,CAAC2F,QAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACGtF,KAAK,IAAI,MAAC,KAAD;AAAO,IAAA,OAAO,EAAC,QAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAyBA,KAAzB,CADZ,EAEGU,SAAS,IACR;AAAK,IAAA,SAAS,EAAEf,MAAM,CAAC4F,WAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,MAAC,OAAD;AAAS,IAAA,SAAS,EAAC,QAAnB;AAA4B,IAAA,IAAI,EAAC,QAAjC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAM,IAAA,SAAS,EAAC,SAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBADF,CADF,CAHJ,EAUG,CAAC7E,SAAD,IAAcP,cAAd,IACC,4BACE;AAAK,IAAA,SAAS,EAAER,MAAM,CAAC6F,aAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,SAAS,EAAE7F,MAAM,CAAC8F,UAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAoCtF,cAAc,CAACkD,IAAnD,CADF,EAEE;AAAK,IAAA,SAAS,EAAE1D,MAAM,CAAC+F,aAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBACavF,cAAc,CAACwF,KAAf,IAAwB,SADrC,CADF,EAIE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAkBxF,cAAc,CAACkB,EAAjC,CAJF,CAFF,CADF,EAWE;AAAK,IAAA,SAAS,EAAE1B,MAAM,CAACiG,SAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,MAAC,MAAD;AAAQ,IAAA,OAAO,EAAC,SAAhB;AAA0B,IAAA,OAAO,EAAEtB,mBAAnC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BADF,EAIE,MAAC,MAAD;AACE,IAAA,OAAO,EAAC,mBADV;AAEE,IAAA,OAAO,EAAE,MAAMvD,yBAAyB,CAAC,IAAD,CAF1C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0BAJF,CAXF,EAuBE;AAAK,IAAA,SAAS,EAAEpB,MAAM,CAACkG,SAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAK,IAAA,SAAS,EAAElG,MAAM,CAACmG,WAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBADF,EAEE;AAAM,IAAA,SAAS,EAAEnG,MAAM,CAACoG,SAAxB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yCAFF,CADF,EAOE;AAAK,IAAA,SAAS,EAAEpG,MAAM,CAACqG,SAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,MAAC,KAAD;AAAO,IAAA,OAAO,MAAd;AAAe,IAAA,QAAQ,MAAvB;AAAwB,IAAA,KAAK,MAA7B;AAA8B,IAAA,IAAI,EAAC,IAAnC;AAAwC,IAAA,SAAS,EAAErG,MAAM,CAACsG,KAA1D;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YADF,EAEE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAFF,EAGE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAHF,EAIE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAJF,EAKE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cALF,CADF,CADF,EAUE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACG5F,cAAc,CAACgF,MAAf,KAA0B,CAA1B,GACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAI,IAAA,OAAO,EAAE,CAAb;AAAgB,IAAA,SAAS,EAAE1F,MAAM,CAACuG,UAAlC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCADF,CADD,GAOC7F,cAAc,CAACoC,GAAf,CAAoBe,OAAD,IACjB;AAAI,IAAA,GAAG,EAAEA,OAAO,CAACnC,EAAjB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAKmC,OAAO,CAACH,IAAb,CADF,EAEE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAKG,OAAO,CAACmC,KAAb,CAFF,EAGE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAKnC,OAAO,CAAC2C,GAAb,CAHF,EAIE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAK3C,OAAO,CAAC4C,QAAb,CAJF,EAKE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,MAAC,MAAD;AACE,IAAA,OAAO,EAAC,SADV;AAEE,IAAA,IAAI,EAAC,IAFP;AAGE,IAAA,OAAO,EAAE,MACPhD,mBAAmB,CAACI,OAAO,CAACnC,EAAT,EAAamC,OAAO,CAACH,IAArB,CAJvB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cADF,CALF,CADF,CARJ,CAVF,CADF,CAPF,CAvBF,CAXJ,CAbF,CAlBF,CADF,EA2HE,MAAC,eAAD;AACE,IAAA,IAAI,EAAEzC,mBADR;AAEE,IAAA,WAAW,EAAE,MAAMC,sBAAsB,CAAC,KAAD,CAF3C;AAGE,IAAA,cAAc,EAAEG,iBAHlB;AAIE,IAAA,kBAAkB,EAAEuC,gBAJtB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IA3HF,EAmIE,MAAC,oBAAD;AACE,IAAA,IAAI,EAAEzC,sBADR;AAEE,IAAA,WAAW,EAAE,MAAMC,yBAAyB,CAAC,KAAD,CAF9C;AAGE,IAAA,eAAe,EAAE8C,mBAHnB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAnIF,CADF;AA2ID,CA9RD;;AAgSA,eAAehE,MAAf,C,CAEA;;AACA,OAAO,eAAewG,kBAAf,CAAkCC,OAAlC,EAA2C;AAChD,QAAM;AAAEjF,IAAAA;AAAF,MAASiF,OAAO,CAACC,MAAvB;;AAEA,MAAI;AACF;AACA,UAAMxE,SAAS,GAAG,MAAMnC,OAAO,CAACoC,UAAR,CAAmB,QAAnB,EAA6BC,GAA7B,CAAiCZ,EAAjC,EAAqCa,GAArC,EAAxB;;AAEA,QAAI,CAACH,SAAS,CAACI,MAAf,EAAuB;AACrB,aAAO;AACLqE,QAAAA,QAAQ,EAAE,IADL,CACW;;AADX,OAAP;AAGD;;AAED,UAAMpE,UAAU,GAAGL,SAAS,CAACM,IAAV,EAAnB,CAVE,CAYF;;AACA,QAAIE,QAAQ,GAAG,EAAf;;AACA,QAAIH,UAAU,CAACG,QAAX,IAAuBhC,KAAK,CAACC,OAAN,CAAc4B,UAAU,CAACG,QAAzB,CAA3B,EAA+D;AAC7D,UAAI;AACF,cAAMC,eAAe,GAAGJ,UAAU,CAACG,QAAX,CACrBE,GADqB,CAChBC,UAAD,IAAgB;AACnB,cAAIA,UAAU,CAAC+D,IAAf,EAAqB;AACnB,mBAAO7G,OAAO,CAACqC,GAAR,CAAYS,UAAU,CAAC+D,IAAvB,EAA6BvE,GAA7B,EAAP;AACD;;AACD,iBAAO,IAAP;AACD,SANqB,EAOrBwE,MAPqB,CAOdC,OAPc,CAAxB;AASA,cAAMhE,WAAW,GAAG,MAAMC,OAAO,CAACC,GAAR,CAAYL,eAAZ,CAA1B;AACAD,QAAAA,QAAQ,GAAGI,WAAW,CAACF,GAAZ,CAAiBK,UAAD,IAAgB;AACzC,gBAAM8D,WAAW,GAAG9D,UAAU,CAACT,IAAX,EAApB,CADyC,CAEzC;;AACA,gBAAMwE,iBAAiB,GAAG;AACxBxF,YAAAA,EAAE,EAAEyB,UAAU,CAACzB,EADS;AAExBgC,YAAAA,IAAI,EAAEuD,WAAW,CAACvD,IAAZ,IAAoB,EAFF;AAGxBsC,YAAAA,KAAK,EAAEiB,WAAW,CAACjB,KAAZ,IAAqB,EAHJ;AAIxBQ,YAAAA,GAAG,EAAES,WAAW,CAACT,GAAZ,IAAmB,EAJA;AAKxBC,YAAAA,QAAQ,EAAEQ,WAAW,CAACR,QAAZ,IAAwB,EALV;AAMxBU,YAAAA,KAAK,EAAEF,WAAW,CAACE,KAAZ,IAAqB,EANJ,CAOxB;;AAPwB,WAA1B,CAHyC,CAazC;;AACA,cAAIF,WAAW,CAACxC,MAAZ,IAAsBwC,WAAW,CAACxC,MAAZ,CAAmBqC,IAA7C,EAAmD;AACjD,gBAAI;AACF,oBAAM1E,SAAS,GAAGnC,OAAO,CAACqC,GAAR,CAAY2E,WAAW,CAACxC,MAAZ,CAAmBqC,IAA/B,EAAqCvE,GAArC,EAAlB;;AACA,kBAAIH,SAAS,CAACI,MAAd,EAAsB;AACpB0E,gBAAAA,iBAAiB,CAACpB,UAAlB,GAA+B1D,SAAS,CAACM,IAAV,GAAiBgB,IAAjB,IAAyB,EAAxD;AACD;AACF,aALD,CAKE,OAAOrD,KAAP,EAAc;AACd+C,cAAAA,OAAO,CAAC/C,KAAR,CAAc,6BAAd,EAA6CA,KAA7C;AACD;AACF;;AAED,iBAAO6G,iBAAP;AACD,SA1BU,CAAX;AA2BD,OAtCD,CAsCE,OAAO7G,KAAP,EAAc;AACd+C,QAAAA,OAAO,CAAC/C,KAAR,CAAc,8BAAd,EAA8CA,KAA9C;AACD;AACF,KAxDC,CA0DF;;;AACA,UAAM+G,gBAAgB,GAAG;AACvB1F,MAAAA,EADuB;AAEvBgC,MAAAA,IAAI,EAAEjB,UAAU,CAACiB,IAAX,IAAmB,EAFF;AAGvBsC,MAAAA,KAAK,EAAEvD,UAAU,CAACuD,KAAX,IAAoB,EAHJ,CAIvB;;AAJuB,KAAzB;AAOA,WAAO;AACLqB,MAAAA,KAAK,EAAE;AACLlH,QAAAA,aAAa,EAAEiH,gBADV;AAELhH,QAAAA,eAAe,EAAEwC;AAFZ;AADF,KAAP;AAMD,GAxED,CAwEE,OAAOvC,KAAP,EAAc;AACd+C,IAAAA,OAAO,CAAC/C,KAAR,CAAc,8BAAd,EAA8CA,KAA9C;AACA,WAAO;AACLgH,MAAAA,KAAK,EAAE;AACLhH,QAAAA,KAAK,EAAE;AADF;AADF,KAAP;AAKD;AACF","sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/router\";\nimport {\n  Table,\n  Button,\n  Alert,\n  Spinner,\n} from \"react-bootstrap\";\nimport firebase from \"../../../../context/Firebase\";\nimport ClientInfoModal from \"../../ClientInfoModal\";\nimport MachineCreationModal from \"../../MachineCreationModal\";\nimport styles from \"../Client.module.css\";\n\n// Import for SSR\nimport { adminDb } from \"../../../../context/FirebaseAdmin\";\n\nconst Client = ({ initialClient, initialMachines, error: initialError }) => {\n  const router = useRouter();\n  const [selectedClient, setSelectedClient] = useState(initialClient || null);\n  const [machineOptions, setMachineOptions] = useState(\n    Array.isArray(initialMachines) ? initialMachines : []\n  );\n  const [error, setError] = useState(initialError || null);\n  const [isLoading, setIsLoading] = useState(\n    !initialClient && !initialError\n  );\n\n  // State for machine addition modals\n  const [showAddMachineModal, setShowAddMachineModal] = useState(false);\n  const [showCreateMachineModal, setShowCreateMachineModal] = useState(false);\n  const [availableMachines, setAvailableMachines] = useState([]);\n\n  useEffect(() => {\n    if (!router.isReady) return;\n    const activeId = router.query.id || router.asPath.split(\"/\").pop();\n    if (!activeId) return;\n    const hasInitial = initialClient && initialClient.id === activeId;\n    fetchClientData(activeId, { silent: hasInitial });\n  }, [router.isReady, router.query.id, initialClient]);\n\n  const fetchClientData = async (clientId, { silent = false } = {}) => {\n    if (!silent) {\n      setIsLoading(true);\n    }\n    setError(null);\n    try {\n      const db = firebase.firestore();\n      const clientDoc = await db.collection(\"Client\").doc(clientId).get();\n      if (clientDoc.exists) {\n        const clientData = clientDoc.data();\n        setSelectedClient({ id: clientId, ...clientData });\n\n        const machineRefs = Array.isArray(clientData.machines)\n          ? clientData.machines\n          : [];\n        const machinePromises = machineRefs.map((machineRef) =>\n          machineRef.get()\n        );\n        const machineDocs = await Promise.all(machinePromises);\n        const machines = machineDocs.map((machineDoc) => ({\n          id: machineDoc.id,\n          ...machineDoc.data(),\n        }));\n        setMachineOptions(machines);\n      } else {\n        setError(\"Client not found\");\n      }\n    } catch (error) {\n      console.error(\"Error fetching client data:\", error);\n      setError(\"Error fetching client data\");\n    } finally {\n      if (!silent) {\n        setIsLoading(false);\n      }\n    }\n  };\n\n  // Fetch available machines (those not yet assigned to a client)\n  const fetchAvailableMachines = async () => {\n    try {\n      const db = firebase.firestore();\n      const snapshot = await db\n        .collection(\"Machine\")\n        .where(\"client\", \"==\", null)\n        .get();\n      const machines = snapshot.docs.map((doc) => ({\n        id: doc.id,\n        ...doc.data(),\n      }));\n      setAvailableMachines(machines);\n    } catch (error) {\n      console.error(\"Error fetching available machines:\", error);\n      setError(\"Failed to fetch available machines.\");\n    }\n  };\n\n  const handleSelectMachine = (id, name) => {\n    // Navigate to the machine details page if needed\n    router.push(\"../machine/\" + id);\n  };\n\n  // When adding an existing machine\n  const handleAddMachine = async (machine) => {\n    try {\n      const db = firebase.firestore();\n      const clientId = router.query.clientId || router.asPath.split(\"/\").pop();\n\n      // Update client's \"machines\" array with the machine reference\n      await db\n        .collection(\"Client\")\n        .doc(clientId)\n        .update({\n          machines: firebase.firestore.FieldValue.arrayUnion(\n            db.collection(\"Machine\").doc(machine.id)\n          ),\n        });\n\n      // Update local state to include the newly added machine\n      setMachineOptions((prev) => [...prev, machine]);\n      setShowAddMachineModal(false);\n    } catch (error) {\n      console.error(\"Error adding machine to client:\", error);\n      setError(\"Failed to add machine to client.\");\n    }\n  };\n\n  // When creating a new machine for the client\n  const handleCreateMachine = async (newMachine) => {\n    try {\n      const db = firebase.firestore();\n      const clientId = router.query.clientId || router.asPath.split(\"/\").pop();\n      const machineId = `AIS${Math.floor(10000 + Math.random() * 90000)}`;\n      const machineWithId = {\n        ...newMachine,\n        id: machineId,\n        client: db.collection(\"Client\").doc(clientId),\n      };\n      // Create the machine document\n      await db.collection(\"Machine\").doc(machineId).set(machineWithId);\n      // Add the machine reference to the client\n      await db\n        .collection(\"Client\")\n        .doc(clientId)\n        .update({\n          machines: firebase.firestore.FieldValue.arrayUnion(\n            db.collection(\"Machine\").doc(machineId)\n          ),\n        });\n      // Update local state\n      setMachineOptions((prev) => [...prev, { id: machineId, ...newMachine }]);\n      setShowCreateMachineModal(false);\n    } catch (error) {\n      console.error(\"Error creating and adding machine:\", error);\n      setError(\"Failed to create and add machine.\");\n    }\n  };\n\n  // Open the modal to add an existing machine; fetch available machines first\n  const openAddMachineModal = async () => {\n    await fetchAvailableMachines();\n    setShowAddMachineModal(true);\n  };\n\n  return (\n    <div className={styles.page}>\n      <div className={styles.shell}>\n        <header className={styles.header}>\n          <div className={styles.brand}>\n            <img src=\"/magmo-logo.png\" alt=\"Magmo\" className={styles.brandLogo} />\n            <div>\n              <div className={styles.brandName}>Magmo</div>\n              <div className={styles.brandSub}>Client Detail</div>\n            </div>\n          </div>\n          <Button\n            variant=\"outline-secondary\"\n            className={styles.backButton}\n            onClick={() => router.back()}\n          >\n            Back\n          </Button>\n        </header>\n\n        <section className={styles.card}>\n          <div className={styles.cardHeader}>\n            <div>\n              <div className={styles.cardTitle}>Client Machines</div>\n              <div className={styles.cardSubtitle}>\n                Manage machines linked to this client.\n              </div>\n            </div>\n            <div className={styles.cardMeta}>\n              {machineOptions.length} machines\n            </div>\n          </div>\n\n          <div className={styles.cardBody}>\n            {error && <Alert variant=\"danger\">{error}</Alert>}\n            {isLoading && (\n              <div className={styles.loadingWrap}>\n                <Spinner animation=\"border\" role=\"status\">\n                  <span className=\"sr-only\">Loading...</span>\n                </Spinner>\n              </div>\n            )}\n\n            {!isLoading && selectedClient && (\n              <>\n                <div className={styles.clientSummary}>\n                  <div className={styles.clientName}>{selectedClient.name}</div>\n                  <div className={styles.clientMetaRow}>\n                    <span>\n                      Location: {selectedClient.local || \"Unknown\"}\n                    </span>\n                    <span>Client ID: {selectedClient.id}</span>\n                  </div>\n                </div>\n\n                <div className={styles.actionRow}>\n                  <Button variant=\"primary\" onClick={openAddMachineModal}>\n                    Add Existing Machine\n                  </Button>\n                  <Button\n                    variant=\"outline-secondary\"\n                    onClick={() => setShowCreateMachineModal(true)}\n                  >\n                    Create New Machine\n                  </Button>\n                </div>\n\n                <div className={styles.tableCard}>\n                  <div className={styles.tableHeader}>\n                    <span>Machines</span>\n                    <span className={styles.tableHint}>\n                      Select a machine to view details.\n                    </span>\n                  </div>\n                  <div className={styles.tableWrap}>\n                    <Table striped bordered hover size=\"sm\" className={styles.table}>\n                      <thead>\n                        <tr>\n                          <th>Name</th>\n                          <th>Location</th>\n                          <th>OEM</th>\n                          <th>Modality</th>\n                          <th>Select</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {machineOptions.length === 0 ? (\n                          <tr>\n                            <td colSpan={5} className={styles.emptyState}>\n                              No machines assigned yet.\n                            </td>\n                          </tr>\n                        ) : (\n                          machineOptions.map((machine) => (\n                            <tr key={machine.id}>\n                              <td>{machine.name}</td>\n                              <td>{machine.local}</td>\n                              <td>{machine.OEM}</td>\n                              <td>{machine.Modality}</td>\n                              <td>\n                                <Button\n                                  variant=\"primary\"\n                                  size=\"sm\"\n                                  onClick={() =>\n                                    handleSelectMachine(machine.id, machine.name)\n                                  }\n                                >\n                                  Select\n                                </Button>\n                              </td>\n                            </tr>\n                          ))\n                        )}\n                      </tbody>\n                    </Table>\n                  </div>\n                </div>\n              </>\n            )}\n          </div>\n        </section>\n      </div>\n\n      {/* Modal to add an existing machine to the client */}\n      <ClientInfoModal\n        show={showAddMachineModal}\n        handleClose={() => setShowAddMachineModal(false)}\n        machineOptions={availableMachines}\n        setSelectedMachine={handleAddMachine}\n      />\n\n      {/* Modal to create a new machine and attach it to the client */}\n      <MachineCreationModal\n        show={showCreateMachineModal}\n        handleClose={() => setShowCreateMachineModal(false)}\n        onCreateMachine={handleCreateMachine}\n      />\n    </div>\n  );\n};\n\nexport default Client;\n\n// Server-side rendering function\nexport async function getServerSideProps(context) {\n  const { id } = context.params;\n\n  try {\n    // Fetch client data from Firestore using Admin SDK\n    const clientDoc = await adminDb.collection(\"Client\").doc(id).get();\n\n    if (!clientDoc.exists) {\n      return {\n        notFound: true, // This will show a 404 page\n      };\n    }\n\n    const clientData = clientDoc.data();\n\n    // Fetch machine documents referenced in the client's machines array\n    let machines = [];\n    if (clientData.machines && Array.isArray(clientData.machines)) {\n      try {\n        const machinePromises = clientData.machines\n          .map((machineRef) => {\n            if (machineRef.path) {\n              return adminDb.doc(machineRef.path).get();\n            }\n            return null;\n          })\n          .filter(Boolean);\n\n        const machineDocs = await Promise.all(machinePromises);\n        machines = machineDocs.map((machineDoc) => {\n          const machineData = machineDoc.data();\n          // Extract only serializable data, remove any Firestore references\n          const serializedMachine = {\n            id: machineDoc.id,\n            name: machineData.name || \"\",\n            local: machineData.local || \"\",\n            OEM: machineData.OEM || \"\",\n            Modality: machineData.Modality || \"\",\n            Model: machineData.Model || \"\",\n            // Add other fields as needed, but ensure they're serializable\n          };\n\n          // If there's a client reference, extract just the client name\n          if (machineData.client && machineData.client.path) {\n            try {\n              const clientDoc = adminDb.doc(machineData.client.path).get();\n              if (clientDoc.exists) {\n                serializedMachine.clientName = clientDoc.data().name || \"\";\n              }\n            } catch (error) {\n              console.error(\"Error fetching client name:\", error);\n            }\n          }\n\n          return serializedMachine;\n        });\n      } catch (error) {\n        console.error(\"Error fetching machine data:\", error);\n      }\n    }\n\n    // Serialize the client data, removing any non-serializable fields\n    const serializedClient = {\n      id,\n      name: clientData.name || \"\",\n      local: clientData.local || \"\",\n      // Add other client fields as needed, but ensure they're serializable\n    };\n\n    return {\n      props: {\n        initialClient: serializedClient,\n        initialMachines: machines,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error in getServerSideProps:\", error);\n    return {\n      props: {\n        error: \"Failed to load client data\",\n      },\n    };\n  }\n}\n"]},"metadata":{},"sourceType":"module"}