{"ast":null,"code":"import _regeneratorRuntime from \"C:/Users/isavc/OneDrive/Documents/AIS/Apps/magmo/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _defineProperty from \"C:/Users/isavc/OneDrive/Documents/AIS/Apps/magmo/node_modules/next/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _asyncToGenerator from \"C:/Users/isavc/OneDrive/Documents/AIS/Apps/magmo/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _toConsumableArray from \"C:/Users/isavc/OneDrive/Documents/AIS/Apps/magmo/node_modules/next/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _slicedToArray from \"C:/Users/isavc/OneDrive/Documents/AIS/Apps/magmo/node_modules/next/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it[\"return\"] != null) it[\"return\"](); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nimport firebase from \"../context/Firebase\";\nvar OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nvar MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nvar DEFAULT_OEM_FIELD = \"oems\";\n\nvar isPlainObject = function isPlainObject(value) {\n  return value != null && typeof value === \"object\" && !Array.isArray(value) && !(value instanceof Date);\n};\n\nvar normalizeKey = function normalizeKey(value) {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nvar hasUpper = function hasUpper(value) {\n  return /[A-Z]/.test(String(value || \"\"));\n};\n\nvar pickPreferredCase = function pickPreferredCase(current, incoming) {\n  if (!current) return incoming;\n  if (!incoming) return current;\n  var currentUpper = hasUpper(current);\n  var incomingUpper = hasUpper(incoming);\n  if (incomingUpper && !currentUpper) return incoming;\n  if (currentUpper && !incomingUpper) return current;\n  return current;\n};\n\nvar normalizeArray = function normalizeArray(value) {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nvar normalizeList = function normalizeList(values) {\n  var out = [];\n  (values || []).forEach(function (value) {\n    if (value == null) return;\n    var normalized = String(value).trim();\n    if (!normalized) return;\n    if (normalizeKey(normalized) === \"nan\") return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nvar normalizeListCaseInsensitive = function normalizeListCaseInsensitive(values) {\n  var map = new Map();\n  (values || []).forEach(function (value) {\n    if (value == null) return;\n    var normalized = String(value).trim();\n    if (!normalized) return;\n    var key = normalizeKey(normalized);\n    if (!key || key === \"nan\") return;\n    var current = map.get(key);\n    map.set(key, pickPreferredCase(current, normalized));\n  });\n  return Array.from(map.values());\n};\n\nvar pickModelField = function pickModelField(obj) {\n  if (!isPlainObject(obj)) return null;\n\n  var _iterator = _createForOfIteratorHelper(MODEL_FIELD_CANDIDATES),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var key = _step.value;\n      if (Array.isArray(obj[key])) return key;\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  var arrayKey = Object.keys(obj).find(function (key) {\n    return Array.isArray(obj[key]);\n  });\n  return arrayKey || null;\n};\n\nvar extractModels = function extractModels(value) {\n  if (Array.isArray(value)) {\n    return {\n      models: normalizeList(value),\n      modelField: null\n    };\n  }\n\n  if (isPlainObject(value)) {\n    var modelField = pickModelField(value);\n    var models = modelField ? normalizeList(value[modelField]) : [];\n    return {\n      models: models,\n      modelField: modelField\n    };\n  }\n\n  if (value != null && value !== \"\") {\n    return {\n      models: normalizeList([value]),\n      modelField: null\n    };\n  }\n\n  return {\n    models: [],\n    modelField: null\n  };\n};\n\nvar extractOemMap = function extractOemMap(data) {\n  var oemMap = {};\n  var modelFieldByOem = {};\n  var oemField = null;\n\n  var _iterator2 = _createForOfIteratorHelper(OEM_FIELD_CANDIDATES),\n      _step2;\n\n  try {\n    for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n      var key = _step2.value;\n\n      if (Array.isArray(data === null || data === void 0 ? void 0 : data[key])) {\n        oemField = key;\n        data[key].forEach(function (entry) {\n          if (entry == null) return;\n\n          if (isPlainObject(entry)) {\n            var name = entry.name || entry.oem || entry.OEM || entry.label || entry.value;\n            if (!name) return;\n            var normalizedName = String(name).trim();\n            if (!normalizedName) return;\n\n            var _extractModels2 = extractModels(entry.models || entry.list || entry.items),\n                models = _extractModels2.models;\n\n            oemMap[normalizedName] = normalizeList([].concat(_toConsumableArray(oemMap[normalizedName] || []), _toConsumableArray(models)));\n            return;\n          }\n\n          var normalized = String(entry || \"\").trim();\n          if (!normalized) return;\n          oemMap[normalized] = normalizeList(_toConsumableArray(oemMap[normalized] || []));\n        });\n      } else if (isPlainObject(data === null || data === void 0 ? void 0 : data[key])) {\n        oemField = key;\n        Object.entries(data[key]).forEach(function (_ref3) {\n          var _ref4 = _slicedToArray(_ref3, 2),\n              oem = _ref4[0],\n              value = _ref4[1];\n\n          var _extractModels3 = extractModels(value),\n              models = _extractModels3.models,\n              modelField = _extractModels3.modelField;\n\n          oemMap[oem] = normalizeList([].concat(_toConsumableArray(oemMap[oem] || []), _toConsumableArray(models)));\n\n          if (modelField) {\n            modelFieldByOem[oem] = modelField;\n          }\n        });\n      }\n    }\n  } catch (err) {\n    _iterator2.e(err);\n  } finally {\n    _iterator2.f();\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(function (_ref) {\n      var _ref2 = _slicedToArray(_ref, 2),\n          key = _ref2[0],\n          value = _ref2[1];\n\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n\n      if (isPlainObject(value) || Array.isArray(value)) {\n        var _extractModels = extractModels(value),\n            models = _extractModels.models,\n            modelField = _extractModels.modelField;\n\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([].concat(_toConsumableArray(oemMap[key] || []), _toConsumableArray(models)));\n\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return {\n    oemMap: oemMap,\n    oemField: oemField,\n    modelFieldByOem: modelFieldByOem\n  };\n};\n\nvar buildCatalogMetaFromMaps = function buildCatalogMetaFromMaps(_ref5) {\n  var _ref5$modalities = _ref5.modalities,\n      modalities = _ref5$modalities === void 0 ? [] : _ref5$modalities,\n      _ref5$oemsByModality = _ref5.oemsByModality,\n      oemsByModality = _ref5$oemsByModality === void 0 ? {} : _ref5$oemsByModality,\n      _ref5$modelsByModalit = _ref5.modelsByModalityOem,\n      modelsByModalityOem = _ref5$modelsByModalit === void 0 ? {} : _ref5$modelsByModalit,\n      _ref5$usesSubcollecti = _ref5.usesSubcollections,\n      usesSubcollections = _ref5$usesSubcollecti === void 0 ? false : _ref5$usesSubcollecti,\n      _ref5$syncDisabled = _ref5.syncDisabled,\n      syncDisabled = _ref5$syncDisabled === void 0 ? false : _ref5$syncDisabled,\n      _ref5$source = _ref5.source,\n      source = _ref5$source === void 0 ? \"client\" : _ref5$source;\n  var meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n    modalityKeyByLower: {},\n    oemKeyByModalityLower: {},\n    modelKeyByModalityOemLower: {},\n    usesSubcollections: usesSubcollections,\n    syncDisabled: syncDisabled,\n    source: source\n  };\n  var normalizedModalities = normalizeListCaseInsensitive(modalities);\n  normalizedModalities.forEach(function (modality) {\n    var modalityLower = normalizeKey(modality);\n    meta.modalityKeyByLower[modalityLower] = pickPreferredCase(meta.modalityKeyByLower[modalityLower], modality);\n    var oems = (oemsByModality === null || oemsByModality === void 0 ? void 0 : oemsByModality[modality]) || [];\n    var oemLowerMap = meta.oemKeyByModalityLower[modalityLower] || {};\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n    var modelLowerMap = meta.modelKeyByModalityOemLower[modalityLower] || {};\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n    oems.forEach(function (oem) {\n      var _modelsByModalityOem$;\n\n      var oemLower = normalizeKey(oem);\n      oemLowerMap[oemLower] = pickPreferredCase(oemLowerMap[oemLower], oem);\n      var models = (modelsByModalityOem === null || modelsByModalityOem === void 0 ? void 0 : (_modelsByModalityOem$ = modelsByModalityOem[modality]) === null || _modelsByModalityOem$ === void 0 ? void 0 : _modelsByModalityOem$[oem]) || [];\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n      models.forEach(function (model) {\n        var modelLower = normalizeKey(model);\n        if (!modelLower) return;\n        modelLowerMap[oemLower][modelLower] = pickPreferredCase(modelLowerMap[oemLower][modelLower], model);\n      });\n    });\n  });\n  return {\n    modalities: normalizedModalities,\n    oemsByModality: oemsByModality,\n    modelsByModalityOem: modelsByModalityOem,\n    meta: meta\n  };\n};\n\nexport function fetchTrackerCatalog() {\n  return _fetchTrackerCatalog.apply(this, arguments);\n}\n\nfunction _fetchTrackerCatalog() {\n  _fetchTrackerCatalog = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n    var response, payload, db, snap, modalities, oemsByModality, modelsByModalityOem, meta;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (!true) {\n              _context.next = 16;\n              break;\n            }\n\n            _context.prev = 1;\n            _context.next = 4;\n            return fetch(\"/api/tracker/catalog?ts=\".concat(Date.now()), {\n              cache: \"no-store\"\n            });\n\n          case 4:\n            response = _context.sent;\n\n            if (!response.ok) {\n              _context.next = 11;\n              break;\n            }\n\n            _context.next = 8;\n            return response.json();\n\n          case 8:\n            payload = _context.sent;\n\n            if (!(payload !== null && payload !== void 0 && payload.modalities)) {\n              _context.next = 11;\n              break;\n            }\n\n            return _context.abrupt(\"return\", buildCatalogMetaFromMaps({\n              modalities: payload.modalities || [],\n              oemsByModality: payload.oemsByModality || {},\n              modelsByModalityOem: payload.modelsByModalityOem || {},\n              usesSubcollections: Boolean(payload.usesSubcollections),\n              syncDisabled: false,\n              source: \"server\"\n            }));\n\n          case 11:\n            _context.next = 16;\n            break;\n\n          case 13:\n            _context.prev = 13;\n            _context.t0 = _context[\"catch\"](1);\n            console.warn(\"Tracker catalog API fallback:\", _context.t0);\n\n          case 16:\n            db = firebase.firestore();\n            _context.prev = 17;\n            _context.next = 20;\n            return db.collection(\"Tracker\").get({\n              source: \"server\"\n            });\n\n          case 20:\n            snap = _context.sent;\n            _context.next = 28;\n            break;\n\n          case 23:\n            _context.prev = 23;\n            _context.t1 = _context[\"catch\"](17);\n            _context.next = 27;\n            return db.collection(\"Tracker\").get();\n\n          case 27:\n            snap = _context.sent;\n\n          case 28:\n            console.log(\"Tracker catalog client docs:\", snap.docs.map(function (doc) {\n              return doc.id;\n            }));\n            modalities = [];\n            oemsByModality = {};\n            modelsByModalityOem = {};\n            meta = {\n              oemFieldByModality: {},\n              modelFieldByModalityOem: {},\n              modalityKeyByLower: {},\n              oemKeyByModalityLower: {},\n              modelKeyByModalityOemLower: {}\n            };\n            snap.forEach(function (doc) {\n              var modality = doc.id;\n              var modalityLower = normalizeKey(modality);\n              var existingModality = meta.modalityKeyByLower[modalityLower];\n              var canonicalModality = pickPreferredCase(existingModality, modality);\n              meta.modalityKeyByLower[modalityLower] = canonicalModality;\n              var data = doc.data() || {};\n\n              var _extractOemMap = extractOemMap(data),\n                  oemMap = _extractOemMap.oemMap,\n                  oemField = _extractOemMap.oemField,\n                  modelFieldByOem = _extractOemMap.modelFieldByOem;\n\n              if (existingModality && existingModality !== canonicalModality) {\n                oemsByModality[canonicalModality] = normalizeListCaseInsensitive([].concat(_toConsumableArray(oemsByModality[existingModality] || []), _toConsumableArray(oemsByModality[canonicalModality] || [])));\n                modelsByModalityOem[canonicalModality] = _objectSpread(_objectSpread({}, modelsByModalityOem[existingModality] || {}), modelsByModalityOem[canonicalModality] || {});\n                meta.modelFieldByModalityOem[canonicalModality] = _objectSpread(_objectSpread({}, meta.modelFieldByModalityOem[existingModality] || {}), meta.modelFieldByModalityOem[canonicalModality] || {});\n\n                if (!meta.oemFieldByModality[canonicalModality]) {\n                  meta.oemFieldByModality[canonicalModality] = meta.oemFieldByModality[existingModality] || oemField;\n                }\n\n                delete oemsByModality[existingModality];\n                delete modelsByModalityOem[existingModality];\n                delete meta.oemFieldByModality[existingModality];\n                delete meta.modelFieldByModalityOem[existingModality];\n              }\n\n              modalities.push(canonicalModality);\n\n              if (!meta.oemFieldByModality[canonicalModality]) {\n                meta.oemFieldByModality[canonicalModality] = oemField;\n              }\n\n              meta.modelFieldByModalityOem[canonicalModality] = _objectSpread(_objectSpread({}, meta.modelFieldByModalityOem[canonicalModality] || {}), modelFieldByOem || {});\n              var oems = Object.keys(oemMap);\n              var mergedOems = normalizeListCaseInsensitive([].concat(_toConsumableArray(oemsByModality[canonicalModality] || []), _toConsumableArray(oems)));\n              oemsByModality[canonicalModality] = mergedOems;\n              modelsByModalityOem[canonicalModality] = modelsByModalityOem[canonicalModality] || {};\n              var oemLowerMap = meta.oemKeyByModalityLower[modalityLower] || {};\n              meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n              var modelLowerMap = meta.modelKeyByModalityOemLower[modalityLower] || {};\n              meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n              oems.forEach(function (oem) {\n                var oemLower = normalizeKey(oem);\n                var existingOem = oemLowerMap[oemLower];\n                var canonicalOem = pickPreferredCase(existingOem, oem);\n                oemLowerMap[oemLower] = canonicalOem;\n\n                if (existingOem && existingOem !== canonicalOem) {\n                  modelsByModalityOem[canonicalModality][canonicalOem] = normalizeListCaseInsensitive([].concat(_toConsumableArray(modelsByModalityOem[canonicalModality][existingOem] || []), _toConsumableArray(modelsByModalityOem[canonicalModality][canonicalOem] || [])));\n                  delete modelsByModalityOem[canonicalModality][existingOem];\n                }\n\n                var existingModels = modelsByModalityOem[canonicalModality][canonicalOem] || [];\n                var mergedModels = normalizeListCaseInsensitive([].concat(_toConsumableArray(existingModels), _toConsumableArray(oemMap[oem] || [])));\n                modelsByModalityOem[canonicalModality][canonicalOem] = mergedModels;\n                modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n                mergedModels.forEach(function (model) {\n                  modelLowerMap[oemLower][normalizeKey(model)] = model;\n                });\n              });\n            });\n            return _context.abrupt(\"return\", buildCatalogMetaFromMaps({\n              modalities: modalities,\n              oemsByModality: oemsByModality,\n              modelsByModalityOem: modelsByModalityOem,\n              usesSubcollections: true,\n              syncDisabled: false,\n              source: \"client\"\n            }));\n\n          case 35:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[1, 13], [17, 23]]);\n  }));\n  return _fetchTrackerCatalog.apply(this, arguments);\n}\n\nexport function buildAllOems(catalog) {\n  var map = new Map();\n  Object.values((catalog === null || catalog === void 0 ? void 0 : catalog.oemsByModality) || {}).forEach(function (oems) {\n    (oems || []).forEach(function (oem) {\n      var key = normalizeKey(oem);\n      if (!key) return;\n      var current = map.get(key);\n      map.set(key, pickPreferredCase(current, oem));\n    });\n  });\n  return Array.from(map.values());\n}\nexport function buildModelsForSelection(catalog) {\n  var modalities = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n  var oems = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  var modelSet = new Set();\n  var modals = normalizeList(modalities);\n  var oemList = normalizeList(oems);\n  modals.forEach(function (modality) {\n    var _catalog$meta, _catalog$meta$modalit, _catalog$modelsByModa;\n\n    var modalityLower = normalizeKey(modality);\n    var canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta = catalog.meta) === null || _catalog$meta === void 0 ? void 0 : (_catalog$meta$modalit = _catalog$meta.modalityKeyByLower) === null || _catalog$meta$modalit === void 0 ? void 0 : _catalog$meta$modalit[modalityLower]) || modality;\n    var oemMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa = catalog.modelsByModalityOem) === null || _catalog$modelsByModa === void 0 ? void 0 : _catalog$modelsByModa[canonicalModality]) || {};\n    oemList.forEach(function (oem) {\n      var _catalog$meta2, _catalog$meta2$oemKey, _catalog$meta2$oemKey2;\n\n      var oemLower = normalizeKey(oem);\n      var canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta2 = catalog.meta) === null || _catalog$meta2 === void 0 ? void 0 : (_catalog$meta2$oemKey = _catalog$meta2.oemKeyByModalityLower) === null || _catalog$meta2$oemKey === void 0 ? void 0 : (_catalog$meta2$oemKey2 = _catalog$meta2$oemKey[modalityLower]) === null || _catalog$meta2$oemKey2 === void 0 ? void 0 : _catalog$meta2$oemKey2[oemLower]) || oem;\n      var models = (oemMap === null || oemMap === void 0 ? void 0 : oemMap[canonicalOem]) || [];\n      models.forEach(function (model) {\n        return modelSet.add(model);\n      });\n    });\n  });\n  return Array.from(modelSet);\n}\nexport function syncTrackerFromSelections(_x) {\n  return _syncTrackerFromSelections.apply(this, arguments);\n}\n\nfunction _syncTrackerFromSelections() {\n  _syncTrackerFromSelections = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref6) {\n    var _catalog$meta3;\n\n    var selections, catalog, db, trackerRef, selectedModalities, selectedOems, selectedModels, ops, _iterator3, _step3, _loop;\n\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            selections = _ref6.selections, catalog = _ref6.catalog;\n            db = firebase.firestore();\n            trackerRef = db.collection(\"Tracker\");\n            selectedModalities = normalizeList((selections === null || selections === void 0 ? void 0 : selections.modalities) || []);\n            selectedOems = normalizeList((selections === null || selections === void 0 ? void 0 : selections.oems) || []);\n            selectedModels = normalizeList((selections === null || selections === void 0 ? void 0 : selections.models) || []);\n\n            if (selectedModalities.length) {\n              _context2.next = 8;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", false);\n\n          case 8:\n            if (!(catalog !== null && catalog !== void 0 && (_catalog$meta3 = catalog.meta) !== null && _catalog$meta3 !== void 0 && _catalog$meta3.syncDisabled)) {\n              _context2.next = 10;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", false);\n\n          case 10:\n            ops = [];\n            _iterator3 = _createForOfIteratorHelper(selectedModalities);\n\n            try {\n              _loop = function _loop() {\n                var _catalog$meta4, _catalog$meta4$modali, _catalog$oemsByModali, _catalog$meta5, _catalog$meta5$oemFie, _catalog$modalities;\n\n                var modality = _step3.value;\n                var modalityLower = normalizeKey(modality);\n                var canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta4 = catalog.meta) === null || _catalog$meta4 === void 0 ? void 0 : (_catalog$meta4$modali = _catalog$meta4.modalityKeyByLower) === null || _catalog$meta4$modali === void 0 ? void 0 : _catalog$meta4$modali[modalityLower]) || modalityLower;\n                var docRef = trackerRef.doc(canonicalModality);\n                var existingOemsRaw = (catalog === null || catalog === void 0 ? void 0 : (_catalog$oemsByModali = catalog.oemsByModality) === null || _catalog$oemsByModali === void 0 ? void 0 : _catalog$oemsByModali[canonicalModality]) || [];\n                var existingOemsLower = new Set(existingOemsRaw.map(function (value) {\n                  return normalizeKey(value);\n                }));\n                var oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta5 = catalog.meta) === null || _catalog$meta5 === void 0 ? void 0 : (_catalog$meta5$oemFie = _catalog$meta5.oemFieldByModality) === null || _catalog$meta5$oemFie === void 0 ? void 0 : _catalog$meta5$oemFie[canonicalModality]) || DEFAULT_OEM_FIELD;\n\n                if (!(catalog !== null && catalog !== void 0 && (_catalog$modalities = catalog.modalities) !== null && _catalog$modalities !== void 0 && _catalog$modalities.some(function (existing) {\n                  return normalizeKey(existing) === modalityLower;\n                }))) {\n                  ops.push(docRef.set(_defineProperty({}, DEFAULT_OEM_FIELD, {}), {\n                    merge: true\n                  }));\n                }\n\n                var _iterator4 = _createForOfIteratorHelper(selectedOems),\n                    _step4;\n\n                try {\n                  for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n                    var _catalog$meta6, _catalog$meta6$oemKey, _catalog$meta6$oemKey2;\n\n                    var oem = _step4.value;\n                    var oemLower = normalizeKey(oem);\n                    var canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta6 = catalog.meta) === null || _catalog$meta6 === void 0 ? void 0 : (_catalog$meta6$oemKey = _catalog$meta6.oemKeyByModalityLower) === null || _catalog$meta6$oemKey === void 0 ? void 0 : (_catalog$meta6$oemKey2 = _catalog$meta6$oemKey[modalityLower]) === null || _catalog$meta6$oemKey2 === void 0 ? void 0 : _catalog$meta6$oemKey2[oemLower]) || oemLower;\n\n                    if (!existingOemsLower.has(oemLower)) {\n                      ops.push(docRef.set(_defineProperty({}, oemField, _defineProperty({}, canonicalOem, [])), {\n                        merge: true\n                      }));\n                    }\n                  }\n                } catch (err) {\n                  _iterator4.e(err);\n                } finally {\n                  _iterator4.f();\n                }\n\n                var _iterator5 = _createForOfIteratorHelper(selectedOems),\n                    _step5;\n\n                try {\n                  for (_iterator5.s(); !(_step5 = _iterator5.n()).done;) {\n                    var _catalog$meta7, _catalog$meta7$oemKey, _catalog$meta7$oemKey2, _catalog$modelsByModa2, _catalog$modelsByModa3, _catalog$meta8, _catalog$meta8$modelK, _catalog$meta8$modelK2, _catalog$meta9, _catalog$meta9$modelF, _catalog$meta9$modelF2;\n\n                    var _oem = _step5.value;\n\n                    var _oemLower = normalizeKey(_oem);\n\n                    var _canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta7 = catalog.meta) === null || _catalog$meta7 === void 0 ? void 0 : (_catalog$meta7$oemKey = _catalog$meta7.oemKeyByModalityLower) === null || _catalog$meta7$oemKey === void 0 ? void 0 : (_catalog$meta7$oemKey2 = _catalog$meta7$oemKey[modalityLower]) === null || _catalog$meta7$oemKey2 === void 0 ? void 0 : _catalog$meta7$oemKey2[_oemLower]) || _oemLower;\n\n                    var knownModels = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa2 = catalog.modelsByModalityOem) === null || _catalog$modelsByModa2 === void 0 ? void 0 : (_catalog$modelsByModa3 = _catalog$modelsByModa2[canonicalModality]) === null || _catalog$modelsByModa3 === void 0 ? void 0 : _catalog$modelsByModa3[_canonicalOem]) || [];\n                    var knownLower = new Set(knownModels.map(function (value) {\n                      return normalizeKey(value);\n                    }));\n                    var modelCaseMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta8 = catalog.meta) === null || _catalog$meta8 === void 0 ? void 0 : (_catalog$meta8$modelK = _catalog$meta8.modelKeyByModalityOemLower) === null || _catalog$meta8$modelK === void 0 ? void 0 : (_catalog$meta8$modelK2 = _catalog$meta8$modelK[modalityLower]) === null || _catalog$meta8$modelK2 === void 0 ? void 0 : _catalog$meta8$modelK2[_oemLower]) || {};\n                    var modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta9 = catalog.meta) === null || _catalog$meta9 === void 0 ? void 0 : (_catalog$meta9$modelF = _catalog$meta9.modelFieldByModalityOem) === null || _catalog$meta9$modelF === void 0 ? void 0 : (_catalog$meta9$modelF2 = _catalog$meta9$modelF[canonicalModality]) === null || _catalog$meta9$modelF2 === void 0 ? void 0 : _catalog$meta9$modelF2[_canonicalOem]) || null;\n\n                    var _iterator6 = _createForOfIteratorHelper(selectedModels),\n                        _step6;\n\n                    try {\n                      for (_iterator6.s(); !(_step6 = _iterator6.n()).done;) {\n                        var model = _step6.value;\n                        var modelLower = normalizeKey(model);\n                        if (!modelLower || knownLower.has(modelLower)) continue;\n                        var canonicalModel = modelCaseMap[modelLower] || model;\n                        var path = modelField ? \"\".concat(oemField, \".\").concat(_canonicalOem, \".\").concat(modelField) : \"\".concat(oemField, \".\").concat(_canonicalOem);\n                        ops.push(docRef.update(_defineProperty({}, path, firebase.firestore.FieldValue.arrayUnion(canonicalModel))));\n                      }\n                    } catch (err) {\n                      _iterator6.e(err);\n                    } finally {\n                      _iterator6.f();\n                    }\n                  }\n                } catch (err) {\n                  _iterator5.e(err);\n                } finally {\n                  _iterator5.f();\n                }\n              };\n\n              for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n                _loop();\n              }\n            } catch (err) {\n              _iterator3.e(err);\n            } finally {\n              _iterator3.f();\n            }\n\n            if (!ops.length) {\n              _context2.next = 17;\n              break;\n            }\n\n            _context2.next = 16;\n            return Promise.allSettled(ops);\n\n          case 16:\n            return _context2.abrupt(\"return\", true);\n\n          case 17:\n            return _context2.abrupt(\"return\", false);\n\n          case 18:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n  return _syncTrackerFromSelections.apply(this, arguments);\n}\n\nexport function deleteTrackerOem(_x2) {\n  return _deleteTrackerOem.apply(this, arguments);\n}\n\nfunction _deleteTrackerOem() {\n  _deleteTrackerOem = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(_ref7) {\n    var _catalog$meta10;\n\n    var oem, catalog, db, trackerRef, modalities, usesSubcollections, ops;\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            oem = _ref7.oem, catalog = _ref7.catalog;\n\n            if (oem) {\n              _context3.next = 3;\n              break;\n            }\n\n            return _context3.abrupt(\"return\");\n\n          case 3:\n            db = firebase.firestore();\n            trackerRef = db.collection(\"Tracker\");\n            modalities = (catalog === null || catalog === void 0 ? void 0 : catalog.modalities) || [];\n            usesSubcollections = Boolean(catalog === null || catalog === void 0 ? void 0 : (_catalog$meta10 = catalog.meta) === null || _catalog$meta10 === void 0 ? void 0 : _catalog$meta10.usesSubcollections);\n            ops = modalities.map(function (modality) {\n              var _catalog$meta11, _catalog$meta11$modal, _catalog$meta12, _catalog$meta12$oemKe, _catalog$meta12$oemKe2, _catalog$meta13, _catalog$meta13$oemFi, _catalog$meta14, _catalog$meta14$oemFi;\n\n              var modalityLower = normalizeKey(modality);\n              var canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta11 = catalog.meta) === null || _catalog$meta11 === void 0 ? void 0 : (_catalog$meta11$modal = _catalog$meta11.modalityKeyByLower) === null || _catalog$meta11$modal === void 0 ? void 0 : _catalog$meta11$modal[modalityLower]) || modality;\n              var docRef = trackerRef.doc(canonicalModality);\n              var canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta12 = catalog.meta) === null || _catalog$meta12 === void 0 ? void 0 : (_catalog$meta12$oemKe = _catalog$meta12.oemKeyByModalityLower) === null || _catalog$meta12$oemKe === void 0 ? void 0 : (_catalog$meta12$oemKe2 = _catalog$meta12$oemKe[modalityLower]) === null || _catalog$meta12$oemKe2 === void 0 ? void 0 : _catalog$meta12$oemKe2[normalizeKey(oem)]) || oem;\n\n              if (usesSubcollections) {\n                return docRef.collection(canonicalOem).get().then(function (snap) {\n                  var deletions = [];\n                  snap.forEach(function (doc) {\n                    deletions.push(doc.ref[\"delete\"]());\n                  });\n                  return Promise.allSettled(deletions);\n                })[\"catch\"](function () {\n                  return null;\n                });\n              }\n\n              var oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta13 = catalog.meta) === null || _catalog$meta13 === void 0 ? void 0 : (_catalog$meta13$oemFi = _catalog$meta13.oemFieldByModality) === null || _catalog$meta13$oemFi === void 0 ? void 0 : _catalog$meta13$oemFi[canonicalModality]) || DEFAULT_OEM_FIELD;\n\n              var update = _defineProperty({}, \"\".concat(oemField, \".\").concat(canonicalOem), firebase.firestore.FieldValue[\"delete\"]());\n\n              if (!(catalog !== null && catalog !== void 0 && (_catalog$meta14 = catalog.meta) !== null && _catalog$meta14 !== void 0 && (_catalog$meta14$oemFi = _catalog$meta14.oemFieldByModality) !== null && _catalog$meta14$oemFi !== void 0 && _catalog$meta14$oemFi[canonicalModality])) {\n                update[canonicalOem] = firebase.firestore.FieldValue[\"delete\"]();\n              }\n\n              return docRef.update(update)[\"catch\"](function () {\n                return null;\n              });\n            });\n            _context3.next = 10;\n            return Promise.allSettled(ops);\n\n          case 10:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3);\n  }));\n  return _deleteTrackerOem.apply(this, arguments);\n}\n\nexport function deleteTrackerModel(_x3) {\n  return _deleteTrackerModel.apply(this, arguments);\n}\n\nfunction _deleteTrackerModel() {\n  _deleteTrackerModel = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(_ref8) {\n    var _catalog$meta15, _catalog$meta15$modal, _catalog$meta16, _catalog$meta16$oemKe, _catalog$meta16$oemKe2, _catalog$meta17, _catalog$meta18, _catalog$meta18$oemFi, _catalog$meta19, _catalog$meta19$model, _catalog$meta19$model2;\n\n    var modality, oem, model, catalog, db, modalityLower, canonicalModality, docRef, canonicalOem, modelKey, oemField, modelField, path;\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            modality = _ref8.modality, oem = _ref8.oem, model = _ref8.model, catalog = _ref8.catalog;\n\n            if (!(!modality || !oem || !model)) {\n              _context4.next = 3;\n              break;\n            }\n\n            return _context4.abrupt(\"return\");\n\n          case 3:\n            db = firebase.firestore();\n            modalityLower = normalizeKey(modality);\n            canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta15 = catalog.meta) === null || _catalog$meta15 === void 0 ? void 0 : (_catalog$meta15$modal = _catalog$meta15.modalityKeyByLower) === null || _catalog$meta15$modal === void 0 ? void 0 : _catalog$meta15$modal[modalityLower]) || modality;\n            docRef = db.collection(\"Tracker\").doc(canonicalModality);\n            canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta16 = catalog.meta) === null || _catalog$meta16 === void 0 ? void 0 : (_catalog$meta16$oemKe = _catalog$meta16.oemKeyByModalityLower) === null || _catalog$meta16$oemKe === void 0 ? void 0 : (_catalog$meta16$oemKe2 = _catalog$meta16$oemKe[modalityLower]) === null || _catalog$meta16$oemKe2 === void 0 ? void 0 : _catalog$meta16$oemKe2[normalizeKey(oem)]) || oem;\n\n            if (!(catalog !== null && catalog !== void 0 && (_catalog$meta17 = catalog.meta) !== null && _catalog$meta17 !== void 0 && _catalog$meta17.usesSubcollections)) {\n              _context4.next = 13;\n              break;\n            }\n\n            modelKey = normalizeKey(model);\n            _context4.next = 12;\n            return docRef.collection(canonicalOem).doc(modelKey)[\"delete\"]()[\"catch\"](function () {\n              return null;\n            });\n\n          case 12:\n            return _context4.abrupt(\"return\");\n\n          case 13:\n            oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta18 = catalog.meta) === null || _catalog$meta18 === void 0 ? void 0 : (_catalog$meta18$oemFi = _catalog$meta18.oemFieldByModality) === null || _catalog$meta18$oemFi === void 0 ? void 0 : _catalog$meta18$oemFi[canonicalModality]) || DEFAULT_OEM_FIELD;\n            modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta19 = catalog.meta) === null || _catalog$meta19 === void 0 ? void 0 : (_catalog$meta19$model = _catalog$meta19.modelFieldByModalityOem) === null || _catalog$meta19$model === void 0 ? void 0 : (_catalog$meta19$model2 = _catalog$meta19$model[canonicalModality]) === null || _catalog$meta19$model2 === void 0 ? void 0 : _catalog$meta19$model2[canonicalOem]) || null;\n            path = modelField ? \"\".concat(oemField, \".\").concat(canonicalOem, \".\").concat(modelField) : \"\".concat(oemField, \".\").concat(canonicalOem);\n            _context4.next = 18;\n            return docRef.update(_defineProperty({}, path, firebase.firestore.FieldValue.arrayRemove(model)));\n\n          case 18:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n  return _deleteTrackerModel.apply(this, arguments);\n}","map":{"version":3,"sources":["C:/Users/isavc/OneDrive/Documents/AIS/Apps/magmo/utils/trackerCatalog.js"],"names":["firebase","OEM_FIELD_CANDIDATES","MODEL_FIELD_CANDIDATES","DEFAULT_OEM_FIELD","isPlainObject","value","Array","isArray","Date","normalizeKey","String","trim","toLowerCase","hasUpper","test","pickPreferredCase","current","incoming","currentUpper","incomingUpper","normalizeArray","normalizeList","values","out","forEach","normalized","push","from","Set","normalizeListCaseInsensitive","map","Map","key","get","set","pickModelField","obj","arrayKey","Object","keys","find","extractModels","models","modelField","extractOemMap","data","oemMap","modelFieldByOem","oemField","entry","name","oem","OEM","label","normalizedName","list","items","entries","startsWith","length","buildCatalogMetaFromMaps","modalities","oemsByModality","modelsByModalityOem","usesSubcollections","syncDisabled","source","meta","oemFieldByModality","modelFieldByModalityOem","modalityKeyByLower","oemKeyByModalityLower","modelKeyByModalityOemLower","normalizedModalities","modality","modalityLower","oems","oemLowerMap","modelLowerMap","oemLower","model","modelLower","fetchTrackerCatalog","fetch","now","cache","response","ok","json","payload","Boolean","console","warn","db","firestore","collection","snap","log","docs","doc","id","existingModality","canonicalModality","mergedOems","existingOem","canonicalOem","existingModels","mergedModels","buildAllOems","catalog","buildModelsForSelection","modelSet","modals","oemList","add","syncTrackerFromSelections","selections","trackerRef","selectedModalities","selectedOems","selectedModels","ops","docRef","existingOemsRaw","existingOemsLower","some","existing","merge","has","knownModels","knownLower","modelCaseMap","canonicalModel","path","update","FieldValue","arrayUnion","Promise","allSettled","deleteTrackerOem","then","deletions","ref","deleteTrackerModel","modelKey","arrayRemove"],"mappings":";;;;;;;;;;;;;;;;AAAA,OAAOA,QAAP,MAAqB,qBAArB;AAEA,IAAMC,oBAAoB,GAAG,CAAC,MAAD,EAAS,MAAT,EAAiB,KAAjB,EAAwB,KAAxB,CAA7B;AACA,IAAMC,sBAAsB,GAAG,CAAC,QAAD,EAAW,QAAX,EAAqB,OAArB,EAA8B,OAA9B,EAAuC,MAAvC,EAA+C,OAA/C,CAA/B;AACA,IAAMC,iBAAiB,GAAG,MAA1B;;AAEA,IAAMC,aAAa,GAAG,SAAhBA,aAAgB,CAACC,KAAD;AAAA,SACpBA,KAAK,IAAI,IAAT,IACA,OAAOA,KAAP,KAAiB,QADjB,IAEA,CAACC,KAAK,CAACC,OAAN,CAAcF,KAAd,CAFD,IAGA,EAAEA,KAAK,YAAYG,IAAnB,CAJoB;AAAA,CAAtB;;AAMA,IAAMC,YAAY,GAAG,SAAfA,YAAe,CAACJ,KAAD,EAAW;AAC9B,MAAIA,KAAK,IAAI,IAAb,EAAmB,OAAO,EAAP;AACnB,SAAOK,MAAM,CAACL,KAAD,CAAN,CAAcM,IAAd,GAAqBC,WAArB,EAAP;AACD,CAHD;;AAKA,IAAMC,QAAQ,GAAG,SAAXA,QAAW,CAACR,KAAD;AAAA,SAAW,QAAQS,IAAR,CAAaJ,MAAM,CAACL,KAAK,IAAI,EAAV,CAAnB,CAAX;AAAA,CAAjB;;AAEA,IAAMU,iBAAiB,GAAG,SAApBA,iBAAoB,CAACC,OAAD,EAAUC,QAAV,EAAuB;AAC/C,MAAI,CAACD,OAAL,EAAc,OAAOC,QAAP;AACd,MAAI,CAACA,QAAL,EAAe,OAAOD,OAAP;AACf,MAAME,YAAY,GAAGL,QAAQ,CAACG,OAAD,CAA7B;AACA,MAAMG,aAAa,GAAGN,QAAQ,CAACI,QAAD,CAA9B;AACA,MAAIE,aAAa,IAAI,CAACD,YAAtB,EAAoC,OAAOD,QAAP;AACpC,MAAIC,YAAY,IAAI,CAACC,aAArB,EAAoC,OAAOH,OAAP;AACpC,SAAOA,OAAP;AACD,CARD;;AAUA,IAAMI,cAAc,GAAG,SAAjBA,cAAiB,CAACf,KAAD,EAAW;AAChC,MAAIC,KAAK,CAACC,OAAN,CAAcF,KAAd,CAAJ,EAA0B,OAAOA,KAAP;AAC1B,MAAIA,KAAK,IAAI,IAAT,IAAiBA,KAAK,KAAK,EAA/B,EAAmC,OAAO,EAAP;AACnC,SAAO,CAACA,KAAD,CAAP;AACD,CAJD;;AAMA,IAAMgB,aAAa,GAAG,SAAhBA,aAAgB,CAACC,MAAD,EAAY;AAChC,MAAMC,GAAG,GAAG,EAAZ;AACA,GAACD,MAAM,IAAI,EAAX,EAAeE,OAAf,CAAuB,UAACnB,KAAD,EAAW;AAChC,QAAIA,KAAK,IAAI,IAAb,EAAmB;AACnB,QAAMoB,UAAU,GAAGf,MAAM,CAACL,KAAD,CAAN,CAAcM,IAAd,EAAnB;AACA,QAAI,CAACc,UAAL,EAAiB;AACjB,QAAIhB,YAAY,CAACgB,UAAD,CAAZ,KAA6B,KAAjC,EAAwC;AACxCF,IAAAA,GAAG,CAACG,IAAJ,CAASD,UAAT;AACD,GAND;AAOA,SAAOnB,KAAK,CAACqB,IAAN,CAAW,IAAIC,GAAJ,CAAQL,GAAR,CAAX,CAAP;AACD,CAVD;;AAYA,IAAMM,4BAA4B,GAAG,SAA/BA,4BAA+B,CAACP,MAAD,EAAY;AAC/C,MAAMQ,GAAG,GAAG,IAAIC,GAAJ,EAAZ;AACA,GAACT,MAAM,IAAI,EAAX,EAAeE,OAAf,CAAuB,UAACnB,KAAD,EAAW;AAChC,QAAIA,KAAK,IAAI,IAAb,EAAmB;AACnB,QAAMoB,UAAU,GAAGf,MAAM,CAACL,KAAD,CAAN,CAAcM,IAAd,EAAnB;AACA,QAAI,CAACc,UAAL,EAAiB;AACjB,QAAMO,GAAG,GAAGvB,YAAY,CAACgB,UAAD,CAAxB;AACA,QAAI,CAACO,GAAD,IAAQA,GAAG,KAAK,KAApB,EAA2B;AAC3B,QAAMhB,OAAO,GAAGc,GAAG,CAACG,GAAJ,CAAQD,GAAR,CAAhB;AACAF,IAAAA,GAAG,CAACI,GAAJ,CAAQF,GAAR,EAAajB,iBAAiB,CAACC,OAAD,EAAUS,UAAV,CAA9B;AACD,GARD;AASA,SAAOnB,KAAK,CAACqB,IAAN,CAAWG,GAAG,CAACR,MAAJ,EAAX,CAAP;AACD,CAZD;;AAeA,IAAMa,cAAc,GAAG,SAAjBA,cAAiB,CAACC,GAAD,EAAS;AAC9B,MAAI,CAAChC,aAAa,CAACgC,GAAD,CAAlB,EAAyB,OAAO,IAAP;;AADK,6CAEZlC,sBAFY;AAAA;;AAAA;AAE9B,wDAA0C;AAAA,UAA/B8B,GAA+B;AACxC,UAAI1B,KAAK,CAACC,OAAN,CAAc6B,GAAG,CAACJ,GAAD,CAAjB,CAAJ,EAA6B,OAAOA,GAAP;AAC9B;AAJ6B;AAAA;AAAA;AAAA;AAAA;;AAK9B,MAAMK,QAAQ,GAAGC,MAAM,CAACC,IAAP,CAAYH,GAAZ,EAAiBI,IAAjB,CAAsB,UAACR,GAAD;AAAA,WAAS1B,KAAK,CAACC,OAAN,CAAc6B,GAAG,CAACJ,GAAD,CAAjB,CAAT;AAAA,GAAtB,CAAjB;AACA,SAAOK,QAAQ,IAAI,IAAnB;AACD,CAPD;;AASA,IAAMI,aAAa,GAAG,SAAhBA,aAAgB,CAACpC,KAAD,EAAW;AAC/B,MAAIC,KAAK,CAACC,OAAN,CAAcF,KAAd,CAAJ,EAA0B;AACxB,WAAO;AAAEqC,MAAAA,MAAM,EAAErB,aAAa,CAAChB,KAAD,CAAvB;AAAgCsC,MAAAA,UAAU,EAAE;AAA5C,KAAP;AACD;;AACD,MAAIvC,aAAa,CAACC,KAAD,CAAjB,EAA0B;AACxB,QAAMsC,UAAU,GAAGR,cAAc,CAAC9B,KAAD,CAAjC;AACA,QAAMqC,MAAM,GAAGC,UAAU,GAAGtB,aAAa,CAAChB,KAAK,CAACsC,UAAD,CAAN,CAAhB,GAAsC,EAA/D;AACA,WAAO;AAAED,MAAAA,MAAM,EAANA,MAAF;AAAUC,MAAAA,UAAU,EAAVA;AAAV,KAAP;AACD;;AACD,MAAItC,KAAK,IAAI,IAAT,IAAiBA,KAAK,KAAK,EAA/B,EAAmC;AACjC,WAAO;AAAEqC,MAAAA,MAAM,EAAErB,aAAa,CAAC,CAAChB,KAAD,CAAD,CAAvB;AAAkCsC,MAAAA,UAAU,EAAE;AAA9C,KAAP;AACD;;AACD,SAAO;AAAED,IAAAA,MAAM,EAAE,EAAV;AAAcC,IAAAA,UAAU,EAAE;AAA1B,GAAP;AACD,CAbD;;AAeA,IAAMC,aAAa,GAAG,SAAhBA,aAAgB,CAACC,IAAD,EAAU;AAC9B,MAAMC,MAAM,GAAG,EAAf;AACA,MAAMC,eAAe,GAAG,EAAxB;AACA,MAAIC,QAAQ,GAAG,IAAf;;AAH8B,8CAKZ/C,oBALY;AAAA;;AAAA;AAK9B,2DAAwC;AAAA,UAA7B+B,GAA6B;;AACtC,UAAI1B,KAAK,CAACC,OAAN,CAAcsC,IAAd,aAAcA,IAAd,uBAAcA,IAAI,CAAGb,GAAH,CAAlB,CAAJ,EAAgC;AAC9BgB,QAAAA,QAAQ,GAAGhB,GAAX;AACAa,QAAAA,IAAI,CAACb,GAAD,CAAJ,CAAUR,OAAV,CAAkB,UAACyB,KAAD,EAAW;AAC3B,cAAIA,KAAK,IAAI,IAAb,EAAmB;;AACnB,cAAI7C,aAAa,CAAC6C,KAAD,CAAjB,EAA0B;AACxB,gBAAMC,IAAI,GACRD,KAAK,CAACC,IAAN,IACAD,KAAK,CAACE,GADN,IAEAF,KAAK,CAACG,GAFN,IAGAH,KAAK,CAACI,KAHN,IAIAJ,KAAK,CAAC5C,KALR;AAMA,gBAAI,CAAC6C,IAAL,EAAW;AACX,gBAAMI,cAAc,GAAG5C,MAAM,CAACwC,IAAD,CAAN,CAAavC,IAAb,EAAvB;AACA,gBAAI,CAAC2C,cAAL,EAAqB;;AATG,kCAULb,aAAa,CAACQ,KAAK,CAACP,MAAN,IAAgBO,KAAK,CAACM,IAAtB,IAA8BN,KAAK,CAACO,KAArC,CAVR;AAAA,gBAUhBd,MAVgB,mBAUhBA,MAVgB;;AAWxBI,YAAAA,MAAM,CAACQ,cAAD,CAAN,GAAyBjC,aAAa,8BAChCyB,MAAM,CAACQ,cAAD,CAAN,IAA0B,EADM,sBAEjCZ,MAFiC,GAAtC;AAIA;AACD;;AACD,cAAMjB,UAAU,GAAGf,MAAM,CAACuC,KAAK,IAAI,EAAV,CAAN,CAAoBtC,IAApB,EAAnB;AACA,cAAI,CAACc,UAAL,EAAiB;AACjBqB,UAAAA,MAAM,CAACrB,UAAD,CAAN,GAAqBJ,aAAa,oBAAMyB,MAAM,CAACrB,UAAD,CAAN,IAAsB,EAA5B,EAAlC;AACD,SAtBD;AAuBD,OAzBD,MAyBO,IAAIrB,aAAa,CAACyC,IAAD,aAACA,IAAD,uBAACA,IAAI,CAAGb,GAAH,CAAL,CAAjB,EAAgC;AACrCgB,QAAAA,QAAQ,GAAGhB,GAAX;AACAM,QAAAA,MAAM,CAACmB,OAAP,CAAeZ,IAAI,CAACb,GAAD,CAAnB,EAA0BR,OAA1B,CAAkC,iBAAkB;AAAA;AAAA,cAAhB2B,GAAgB;AAAA,cAAX9C,KAAW;;AAAA,gCACnBoC,aAAa,CAACpC,KAAD,CADM;AAAA,cAC1CqC,MAD0C,mBAC1CA,MAD0C;AAAA,cAClCC,UADkC,mBAClCA,UADkC;;AAElDG,UAAAA,MAAM,CAACK,GAAD,CAAN,GAAc9B,aAAa,8BAAMyB,MAAM,CAACK,GAAD,CAAN,IAAe,EAArB,sBAA6BT,MAA7B,GAA3B;;AACA,cAAIC,UAAJ,EAAgB;AACdI,YAAAA,eAAe,CAACI,GAAD,CAAf,GAAuBR,UAAvB;AACD;AACF,SAND;AAOD;AACF;AAzC6B;AAAA;AAAA;AAAA;AAAA;;AA2C9B,MAAI,CAACK,QAAL,EAAe;AACbV,IAAAA,MAAM,CAACmB,OAAP,CAAeZ,IAAI,IAAI,EAAvB,EAA2BrB,OAA3B,CAAmC,gBAAkB;AAAA;AAAA,UAAhBQ,GAAgB;AAAA,UAAX3B,KAAW;;AACnD,UAAI,CAACA,KAAL,EAAY;AACZ,UAAI2B,GAAG,CAAC0B,UAAJ,CAAe,GAAf,CAAJ,EAAyB;;AACzB,UAAItD,aAAa,CAACC,KAAD,CAAb,IAAwBC,KAAK,CAACC,OAAN,CAAcF,KAAd,CAA5B,EAAkD;AAAA,6BACjBoC,aAAa,CAACpC,KAAD,CADI;AAAA,YACxCqC,MADwC,kBACxCA,MADwC;AAAA,YAChCC,UADgC,kBAChCA,UADgC;;AAEhD,YAAID,MAAM,CAACiB,MAAP,IAAiBhB,UAArB,EAAiC;AAC/BG,UAAAA,MAAM,CAACd,GAAD,CAAN,GAAcX,aAAa,8BAAMyB,MAAM,CAACd,GAAD,CAAN,IAAe,EAArB,sBAA6BU,MAA7B,GAA3B;;AACA,cAAIC,UAAJ,EAAgB;AACdI,YAAAA,eAAe,CAACf,GAAD,CAAf,GAAuBW,UAAvB;AACD;AACF;AACF;AACF,KAZD;AAaD;;AAED,SAAO;AAAEG,IAAAA,MAAM,EAANA,MAAF;AAAUE,IAAAA,QAAQ,EAARA,QAAV;AAAoBD,IAAAA,eAAe,EAAfA;AAApB,GAAP;AACD,CA5DD;;AA+DA,IAAMa,wBAAwB,GAAG,SAA3BA,wBAA2B,QAO3B;AAAA,+BANJC,UAMI;AAAA,MANJA,UAMI,iCANS,EAMT;AAAA,mCALJC,cAKI;AAAA,MALJA,cAKI,qCALa,EAKb;AAAA,oCAJJC,mBAII;AAAA,MAJJA,mBAII,sCAJkB,EAIlB;AAAA,oCAHJC,kBAGI;AAAA,MAHJA,kBAGI,sCAHiB,KAGjB;AAAA,iCAFJC,YAEI;AAAA,MAFJA,YAEI,mCAFW,KAEX;AAAA,2BADJC,MACI;AAAA,MADJA,MACI,6BADK,QACL;AACJ,MAAMC,IAAI,GAAG;AACXC,IAAAA,kBAAkB,EAAE,EADT;AAEXC,IAAAA,uBAAuB,EAAE,EAFd;AAGXC,IAAAA,kBAAkB,EAAE,EAHT;AAIXC,IAAAA,qBAAqB,EAAE,EAJZ;AAKXC,IAAAA,0BAA0B,EAAE,EALjB;AAMXR,IAAAA,kBAAkB,EAAlBA,kBANW;AAOXC,IAAAA,YAAY,EAAZA,YAPW;AAQXC,IAAAA,MAAM,EAANA;AARW,GAAb;AAWA,MAAMO,oBAAoB,GAAG5C,4BAA4B,CAACgC,UAAD,CAAzD;AACAY,EAAAA,oBAAoB,CAACjD,OAArB,CAA6B,UAACkD,QAAD,EAAc;AACzC,QAAMC,aAAa,GAAGlE,YAAY,CAACiE,QAAD,CAAlC;AACAP,IAAAA,IAAI,CAACG,kBAAL,CAAwBK,aAAxB,IAAyC5D,iBAAiB,CACxDoD,IAAI,CAACG,kBAAL,CAAwBK,aAAxB,CADwD,EAExDD,QAFwD,CAA1D;AAIA,QAAME,IAAI,GAAG,CAAAd,cAAc,SAAd,IAAAA,cAAc,WAAd,YAAAA,cAAc,CAAGY,QAAH,CAAd,KAA8B,EAA3C;AACA,QAAMG,WAAW,GACfV,IAAI,CAACI,qBAAL,CAA2BI,aAA3B,KAA6C,EAD/C;AAEAR,IAAAA,IAAI,CAACI,qBAAL,CAA2BI,aAA3B,IAA4CE,WAA5C;AACA,QAAMC,aAAa,GACjBX,IAAI,CAACK,0BAAL,CAAgCG,aAAhC,KAAkD,EADpD;AAEAR,IAAAA,IAAI,CAACK,0BAAL,CAAgCG,aAAhC,IAAiDG,aAAjD;AAEAF,IAAAA,IAAI,CAACpD,OAAL,CAAa,UAAC2B,GAAD,EAAS;AAAA;;AACpB,UAAM4B,QAAQ,GAAGtE,YAAY,CAAC0C,GAAD,CAA7B;AACA0B,MAAAA,WAAW,CAACE,QAAD,CAAX,GAAwBhE,iBAAiB,CAAC8D,WAAW,CAACE,QAAD,CAAZ,EAAwB5B,GAAxB,CAAzC;AACA,UAAMT,MAAM,GAAG,CAAAqB,mBAAmB,SAAnB,IAAAA,mBAAmB,WAAnB,qCAAAA,mBAAmB,CAAGW,QAAH,CAAnB,gFAAkCvB,GAAlC,MAA0C,EAAzD;AACA2B,MAAAA,aAAa,CAACC,QAAD,CAAb,GAA0BD,aAAa,CAACC,QAAD,CAAb,IAA2B,EAArD;AACArC,MAAAA,MAAM,CAAClB,OAAP,CAAe,UAACwD,KAAD,EAAW;AACxB,YAAMC,UAAU,GAAGxE,YAAY,CAACuE,KAAD,CAA/B;AACA,YAAI,CAACC,UAAL,EAAiB;AACjBH,QAAAA,aAAa,CAACC,QAAD,CAAb,CAAwBE,UAAxB,IAAsClE,iBAAiB,CACrD+D,aAAa,CAACC,QAAD,CAAb,CAAwBE,UAAxB,CADqD,EAErDD,KAFqD,CAAvD;AAID,OAPD;AAQD,KAbD;AAcD,GA5BD;AA8BA,SAAO;AACLnB,IAAAA,UAAU,EAAEY,oBADP;AAELX,IAAAA,cAAc,EAAdA,cAFK;AAGLC,IAAAA,mBAAmB,EAAnBA,mBAHK;AAILI,IAAAA,IAAI,EAAJA;AAJK,GAAP;AAMD,CAxDD;;AA0DA,gBAAsBe,mBAAtB;AAAA;AAAA;;;kFAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,mBAGsBC,KAAK,mCACC3E,IAAI,CAAC4E,GAAL,EADD,GAE1B;AAAEC,cAAAA,KAAK,EAAE;AAAT,aAF0B,CAH3B;;AAAA;AAGKC,YAAAA,QAHL;;AAAA,iBAOGA,QAAQ,CAACC,EAPZ;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAQuBD,QAAQ,CAACE,IAAT,EARvB;;AAAA;AAQOC,YAAAA,OARP;;AAAA,kBASKA,OATL,aASKA,OATL,eASKA,OAAO,CAAE5B,UATd;AAAA;AAAA;AAAA;;AAAA,6CAUUD,wBAAwB,CAAC;AAC9BC,cAAAA,UAAU,EAAE4B,OAAO,CAAC5B,UAAR,IAAsB,EADJ;AAE9BC,cAAAA,cAAc,EAAE2B,OAAO,CAAC3B,cAAR,IAA0B,EAFZ;AAG9BC,cAAAA,mBAAmB,EAAE0B,OAAO,CAAC1B,mBAAR,IAA+B,EAHtB;AAI9BC,cAAAA,kBAAkB,EAAE0B,OAAO,CAACD,OAAO,CAACzB,kBAAT,CAJG;AAK9BC,cAAAA,YAAY,EAAE,KALgB;AAM9BC,cAAAA,MAAM,EAAE;AANsB,aAAD,CAVlC;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAqBDyB,YAAAA,OAAO,CAACC,IAAR,CAAa,+BAAb;;AArBC;AAyBCC,YAAAA,EAzBD,GAyBM7F,QAAQ,CAAC8F,SAAT,EAzBN;AAAA;AAAA;AAAA,mBA4BUD,EAAE,CAACE,UAAH,CAAc,SAAd,EAAyB9D,GAAzB,CAA6B;AAAEiC,cAAAA,MAAM,EAAE;AAAV,aAA7B,CA5BV;;AAAA;AA4BH8B,YAAAA,IA5BG;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,mBA8BUH,EAAE,CAACE,UAAH,CAAc,SAAd,EAAyB9D,GAAzB,EA9BV;;AAAA;AA8BH+D,YAAAA,IA9BG;;AAAA;AAgCLL,YAAAA,OAAO,CAACM,GAAR,CACE,8BADF,EAEED,IAAI,CAACE,IAAL,CAAUpE,GAAV,CAAc,UAACqE,GAAD;AAAA,qBAASA,GAAG,CAACC,EAAb;AAAA,aAAd,CAFF;AAKMvC,YAAAA,UArCD,GAqCc,EArCd;AAsCCC,YAAAA,cAtCD,GAsCkB,EAtClB;AAuCCC,YAAAA,mBAvCD,GAuCuB,EAvCvB;AAwCCI,YAAAA,IAxCD,GAwCQ;AACXC,cAAAA,kBAAkB,EAAE,EADT;AAEXC,cAAAA,uBAAuB,EAAE,EAFd;AAGXC,cAAAA,kBAAkB,EAAE,EAHT;AAIXC,cAAAA,qBAAqB,EAAE,EAJZ;AAKXC,cAAAA,0BAA0B,EAAE;AALjB,aAxCR;AAgDLwB,YAAAA,IAAI,CAACxE,OAAL,CAAa,UAAC2E,GAAD,EAAS;AACpB,kBAAMzB,QAAQ,GAAGyB,GAAG,CAACC,EAArB;AACA,kBAAMzB,aAAa,GAAGlE,YAAY,CAACiE,QAAD,CAAlC;AACA,kBAAM2B,gBAAgB,GAAGlC,IAAI,CAACG,kBAAL,CAAwBK,aAAxB,CAAzB;AACA,kBAAM2B,iBAAiB,GAAGvF,iBAAiB,CAACsF,gBAAD,EAAmB3B,QAAnB,CAA3C;AACAP,cAAAA,IAAI,CAACG,kBAAL,CAAwBK,aAAxB,IAAyC2B,iBAAzC;AACA,kBAAMzD,IAAI,GAAGsD,GAAG,CAACtD,IAAJ,MAAc,EAA3B;;AANoB,mCAO0BD,aAAa,CAACC,IAAD,CAPvC;AAAA,kBAOZC,MAPY,kBAOZA,MAPY;AAAA,kBAOJE,QAPI,kBAOJA,QAPI;AAAA,kBAOMD,eAPN,kBAOMA,eAPN;;AASpB,kBAAIsD,gBAAgB,IAAIA,gBAAgB,KAAKC,iBAA7C,EAAgE;AAC9DxC,gBAAAA,cAAc,CAACwC,iBAAD,CAAd,GAAoCzE,4BAA4B,8BAC1DiC,cAAc,CAACuC,gBAAD,CAAd,IAAoC,EADsB,sBAE1DvC,cAAc,CAACwC,iBAAD,CAAd,IAAqC,EAFqB,GAAhE;AAIAvC,gBAAAA,mBAAmB,CAACuC,iBAAD,CAAnB,mCACMvC,mBAAmB,CAACsC,gBAAD,CAAnB,IAAyC,EAD/C,GAEMtC,mBAAmB,CAACuC,iBAAD,CAAnB,IAA0C,EAFhD;AAIAnC,gBAAAA,IAAI,CAACE,uBAAL,CAA6BiC,iBAA7B,oCACMnC,IAAI,CAACE,uBAAL,CAA6BgC,gBAA7B,KAAkD,EADxD,GAEMlC,IAAI,CAACE,uBAAL,CAA6BiC,iBAA7B,KAAmD,EAFzD;;AAIA,oBAAI,CAACnC,IAAI,CAACC,kBAAL,CAAwBkC,iBAAxB,CAAL,EAAiD;AAC/CnC,kBAAAA,IAAI,CAACC,kBAAL,CAAwBkC,iBAAxB,IACEnC,IAAI,CAACC,kBAAL,CAAwBiC,gBAAxB,KAA6CrD,QAD/C;AAED;;AACD,uBAAOc,cAAc,CAACuC,gBAAD,CAArB;AACA,uBAAOtC,mBAAmB,CAACsC,gBAAD,CAA1B;AACA,uBAAOlC,IAAI,CAACC,kBAAL,CAAwBiC,gBAAxB,CAAP;AACA,uBAAOlC,IAAI,CAACE,uBAAL,CAA6BgC,gBAA7B,CAAP;AACD;;AAEDxC,cAAAA,UAAU,CAACnC,IAAX,CAAgB4E,iBAAhB;;AACA,kBAAI,CAACnC,IAAI,CAACC,kBAAL,CAAwBkC,iBAAxB,CAAL,EAAiD;AAC/CnC,gBAAAA,IAAI,CAACC,kBAAL,CAAwBkC,iBAAxB,IAA6CtD,QAA7C;AACD;;AACDmB,cAAAA,IAAI,CAACE,uBAAL,CAA6BiC,iBAA7B,oCACMnC,IAAI,CAACE,uBAAL,CAA6BiC,iBAA7B,KAAmD,EADzD,GAEMvD,eAAe,IAAI,EAFzB;AAKA,kBAAM6B,IAAI,GAAGtC,MAAM,CAACC,IAAP,CAAYO,MAAZ,CAAb;AACA,kBAAMyD,UAAU,GAAG1E,4BAA4B,8BACzCiC,cAAc,CAACwC,iBAAD,CAAd,IAAqC,EADI,sBAE1C1B,IAF0C,GAA/C;AAIAd,cAAAA,cAAc,CAACwC,iBAAD,CAAd,GAAoCC,UAApC;AACAxC,cAAAA,mBAAmB,CAACuC,iBAAD,CAAnB,GACEvC,mBAAmB,CAACuC,iBAAD,CAAnB,IAA0C,EAD5C;AAEA,kBAAMzB,WAAW,GACfV,IAAI,CAACI,qBAAL,CAA2BI,aAA3B,KAA6C,EAD/C;AAEAR,cAAAA,IAAI,CAACI,qBAAL,CAA2BI,aAA3B,IAA4CE,WAA5C;AACA,kBAAMC,aAAa,GACjBX,IAAI,CAACK,0BAAL,CAAgCG,aAAhC,KAAkD,EADpD;AAEAR,cAAAA,IAAI,CAACK,0BAAL,CAAgCG,aAAhC,IAAiDG,aAAjD;AACAF,cAAAA,IAAI,CAACpD,OAAL,CAAa,UAAC2B,GAAD,EAAS;AACpB,oBAAM4B,QAAQ,GAAGtE,YAAY,CAAC0C,GAAD,CAA7B;AACA,oBAAMqD,WAAW,GAAG3B,WAAW,CAACE,QAAD,CAA/B;AACA,oBAAM0B,YAAY,GAAG1F,iBAAiB,CAACyF,WAAD,EAAcrD,GAAd,CAAtC;AACA0B,gBAAAA,WAAW,CAACE,QAAD,CAAX,GAAwB0B,YAAxB;;AACA,oBAAID,WAAW,IAAIA,WAAW,KAAKC,YAAnC,EAAiD;AAC/C1C,kBAAAA,mBAAmB,CAACuC,iBAAD,CAAnB,CAAuCG,YAAvC,IAAuD5E,4BAA4B,8BAC7EkC,mBAAmB,CAACuC,iBAAD,CAAnB,CAAuCE,WAAvC,KAAuD,EADsB,sBAE7EzC,mBAAmB,CAACuC,iBAAD,CAAnB,CAAuCG,YAAvC,KAAwD,EAFqB,GAAnF;AAIA,yBAAO1C,mBAAmB,CAACuC,iBAAD,CAAnB,CAAuCE,WAAvC,CAAP;AACD;;AACD,oBAAME,cAAc,GAClB3C,mBAAmB,CAACuC,iBAAD,CAAnB,CAAuCG,YAAvC,KAAwD,EAD1D;AAEA,oBAAME,YAAY,GAAG9E,4BAA4B,8BAC5C6E,cAD4C,sBAE3C5D,MAAM,CAACK,GAAD,CAAN,IAAe,EAF4B,GAAjD;AAIAY,gBAAAA,mBAAmB,CAACuC,iBAAD,CAAnB,CAAuCG,YAAvC,IAAuDE,YAAvD;AACA7B,gBAAAA,aAAa,CAACC,QAAD,CAAb,GAA0BD,aAAa,CAACC,QAAD,CAAb,IAA2B,EAArD;AACA4B,gBAAAA,YAAY,CAACnF,OAAb,CAAqB,UAACwD,KAAD,EAAW;AAC9BF,kBAAAA,aAAa,CAACC,QAAD,CAAb,CAAwBtE,YAAY,CAACuE,KAAD,CAApC,IAA+CA,KAA/C;AACD,iBAFD;AAGD,eAvBD;AAwBD,aA/ED;AAhDK,6CAiIEpB,wBAAwB,CAAC;AAC9BC,cAAAA,UAAU,EAAVA,UAD8B;AAE9BC,cAAAA,cAAc,EAAdA,cAF8B;AAG9BC,cAAAA,mBAAmB,EAAnBA,mBAH8B;AAI9BC,cAAAA,kBAAkB,EAAE,IAJU;AAK9BC,cAAAA,YAAY,EAAE,KALgB;AAM9BC,cAAAA,MAAM,EAAE;AANsB,aAAD,CAjI1B;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AA2IP,OAAO,SAAS0C,YAAT,CAAsBC,OAAtB,EAA+B;AACpC,MAAM/E,GAAG,GAAG,IAAIC,GAAJ,EAAZ;AACAO,EAAAA,MAAM,CAAChB,MAAP,CAAc,CAAAuF,OAAO,SAAP,IAAAA,OAAO,WAAP,YAAAA,OAAO,CAAE/C,cAAT,KAA2B,EAAzC,EAA6CtC,OAA7C,CAAqD,UAACoD,IAAD,EAAU;AAC7D,KAACA,IAAI,IAAI,EAAT,EAAapD,OAAb,CAAqB,UAAC2B,GAAD,EAAS;AAC5B,UAAMnB,GAAG,GAAGvB,YAAY,CAAC0C,GAAD,CAAxB;AACA,UAAI,CAACnB,GAAL,EAAU;AACV,UAAMhB,OAAO,GAAGc,GAAG,CAACG,GAAJ,CAAQD,GAAR,CAAhB;AACAF,MAAAA,GAAG,CAACI,GAAJ,CAAQF,GAAR,EAAajB,iBAAiB,CAACC,OAAD,EAAUmC,GAAV,CAA9B;AACD,KALD;AAMD,GAPD;AAQA,SAAO7C,KAAK,CAACqB,IAAN,CAAWG,GAAG,CAACR,MAAJ,EAAX,CAAP;AACD;AAED,OAAO,SAASwF,uBAAT,CAAiCD,OAAjC,EAAsE;AAAA,MAA5BhD,UAA4B,uEAAf,EAAe;AAAA,MAAXe,IAAW,uEAAJ,EAAI;AAC3E,MAAMmC,QAAQ,GAAG,IAAInF,GAAJ,EAAjB;AACA,MAAMoF,MAAM,GAAG3F,aAAa,CAACwC,UAAD,CAA5B;AACA,MAAMoD,OAAO,GAAG5F,aAAa,CAACuD,IAAD,CAA7B;AACAoC,EAAAA,MAAM,CAACxF,OAAP,CAAe,UAACkD,QAAD,EAAc;AAAA;;AAC3B,QAAMC,aAAa,GAAGlE,YAAY,CAACiE,QAAD,CAAlC;AACA,QAAM4B,iBAAiB,GACrB,CAAAO,OAAO,SAAP,IAAAA,OAAO,WAAP,6BAAAA,OAAO,CAAE1C,IAAT,yFAAeG,kBAAf,gFAAoCK,aAApC,MAAsDD,QADxD;AAEA,QAAM5B,MAAM,GAAG,CAAA+D,OAAO,SAAP,IAAAA,OAAO,WAAP,qCAAAA,OAAO,CAAE9C,mBAAT,gFAA+BuC,iBAA/B,MAAqD,EAApE;AACAW,IAAAA,OAAO,CAACzF,OAAR,CAAgB,UAAC2B,GAAD,EAAS;AAAA;;AACvB,UAAM4B,QAAQ,GAAGtE,YAAY,CAAC0C,GAAD,CAA7B;AACA,UAAMsD,YAAY,GAChB,CAAAI,OAAO,SAAP,IAAAA,OAAO,WAAP,8BAAAA,OAAO,CAAE1C,IAAT,2FAAeI,qBAAf,0GAAuCI,aAAvC,mFAAwDI,QAAxD,MAAqE5B,GADvE;AAEA,UAAMT,MAAM,GAAG,CAAAI,MAAM,SAAN,IAAAA,MAAM,WAAN,YAAAA,MAAM,CAAG2D,YAAH,CAAN,KAA0B,EAAzC;AACA/D,MAAAA,MAAM,CAAClB,OAAP,CAAe,UAACwD,KAAD;AAAA,eAAW+B,QAAQ,CAACG,GAAT,CAAalC,KAAb,CAAX;AAAA,OAAf;AACD,KAND;AAOD,GAZD;AAaA,SAAO1E,KAAK,CAACqB,IAAN,CAAWoF,QAAX,CAAP;AACD;AAED,gBAAsBI,yBAAtB;AAAA;AAAA;;;wFAAO;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;AACLC,YAAAA,UADK,SACLA,UADK,EAELP,OAFK,SAELA,OAFK;AAIChB,YAAAA,EAJD,GAIM7F,QAAQ,CAAC8F,SAAT,EAJN;AAKCuB,YAAAA,UALD,GAKcxB,EAAE,CAACE,UAAH,CAAc,SAAd,CALd;AAMCuB,YAAAA,kBAND,GAMsBjG,aAAa,CAAC,CAAA+F,UAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAEvD,UAAZ,KAA0B,EAA3B,CANnC;AAOC0D,YAAAA,YAPD,GAOgBlG,aAAa,CAAC,CAAA+F,UAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAExC,IAAZ,KAAoB,EAArB,CAP7B;AAQC4C,YAAAA,cARD,GAQkBnG,aAAa,CAAC,CAAA+F,UAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAE1E,MAAZ,KAAsB,EAAvB,CAR/B;;AAAA,gBAUA4E,kBAAkB,CAAC3D,MAVnB;AAAA;AAAA;AAAA;;AAAA,8CAUkC,KAVlC;;AAAA;AAAA,kBAWDkD,OAXC,aAWDA,OAXC,iCAWDA,OAAO,CAAE1C,IAXR,2CAWD,eAAeF,YAXd;AAAA;AAAA;AAAA;;AAAA,8CAWmC,KAXnC;;AAAA;AAaCwD,YAAAA,GAbD,GAaO,EAbP;AAAA,oDAekBH,kBAflB;;AAAA;AAAA;AAAA;;AAAA,oBAeM5C,QAfN;AAgBH,oBAAMC,aAAa,GAAGlE,YAAY,CAACiE,QAAD,CAAlC;AACA,oBAAM4B,iBAAiB,GACrB,CAAAO,OAAO,SAAP,IAAAA,OAAO,WAAP,8BAAAA,OAAO,CAAE1C,IAAT,2FAAeG,kBAAf,gFAAoCK,aAApC,MAAsDA,aADxD;AAEA,oBAAM+C,MAAM,GAAGL,UAAU,CAAClB,GAAX,CAAeG,iBAAf,CAAf;AACA,oBAAMqB,eAAe,GAAG,CAAAd,OAAO,SAAP,IAAAA,OAAO,WAAP,qCAAAA,OAAO,CAAE/C,cAAT,gFAA0BwC,iBAA1B,MAAgD,EAAxE;AACA,oBAAMsB,iBAAiB,GAAG,IAAIhG,GAAJ,CACxB+F,eAAe,CAAC7F,GAAhB,CAAoB,UAACzB,KAAD;AAAA,yBAAWI,YAAY,CAACJ,KAAD,CAAvB;AAAA,iBAApB,CADwB,CAA1B;AAIA,oBAAM2C,QAAQ,GACZ,CAAA6D,OAAO,SAAP,IAAAA,OAAO,WAAP,8BAAAA,OAAO,CAAE1C,IAAT,2FAAeC,kBAAf,gFAAoCkC,iBAApC,MACAnG,iBAFF;;AAIA,oBACE,EAAC0G,OAAD,aAACA,OAAD,sCAACA,OAAO,CAAEhD,UAAV,gDAAC,oBAAqBgE,IAArB,CACC,UAACC,QAAD;AAAA,yBAAcrH,YAAY,CAACqH,QAAD,CAAZ,KAA2BnD,aAAzC;AAAA,iBADD,CAAD,CADF,EAIE;AACA8C,kBAAAA,GAAG,CAAC/F,IAAJ,CAASgG,MAAM,CAACxF,GAAP,qBAAc/B,iBAAd,EAAkC,EAAlC,GAAwC;AAAE4H,oBAAAA,KAAK,EAAE;AAAT,mBAAxC,CAAT;AACD;;AAnCE,4DAqCeR,YArCf;AAAA;;AAAA;AAqCH,yEAAgC;AAAA;;AAAA,wBAArBpE,GAAqB;AAC9B,wBAAM4B,QAAQ,GAAGtE,YAAY,CAAC0C,GAAD,CAA7B;AACA,wBAAMsD,YAAY,GAChB,CAAAI,OAAO,SAAP,IAAAA,OAAO,WAAP,8BAAAA,OAAO,CAAE1C,IAAT,2FAAeI,qBAAf,0GAAuCI,aAAvC,mFAAwDI,QAAxD,MACAA,QAFF;;AAGA,wBAAI,CAAC6C,iBAAiB,CAACI,GAAlB,CAAsBjD,QAAtB,CAAL,EAAsC;AACpC0C,sBAAAA,GAAG,CAAC/F,IAAJ,CACEgG,MAAM,CAACxF,GAAP,qBAAcc,QAAd,sBAA4ByD,YAA5B,EAA2C,EAA3C,IAAmD;AAAEsB,wBAAAA,KAAK,EAAE;AAAT,uBAAnD,CADF;AAGD;AACF;AA/CE;AAAA;AAAA;AAAA;AAAA;;AAAA,4DAiDeR,YAjDf;AAAA;;AAAA;AAiDH,yEAAgC;AAAA;;AAAA,wBAArBpE,IAAqB;;AAC9B,wBAAM4B,SAAQ,GAAGtE,YAAY,CAAC0C,IAAD,CAA7B;;AACA,wBAAMsD,aAAY,GAChB,CAAAI,OAAO,SAAP,IAAAA,OAAO,WAAP,8BAAAA,OAAO,CAAE1C,IAAT,2FAAeI,qBAAf,0GAAuCI,aAAvC,mFAAwDI,SAAxD,MACAA,SAFF;;AAGA,wBAAMkD,WAAW,GACf,CAAApB,OAAO,SAAP,IAAAA,OAAO,WAAP,sCAAAA,OAAO,CAAE9C,mBAAT,4GAA+BuC,iBAA/B,mFAAoDG,aAApD,MAAqE,EADvE;AAEA,wBAAMyB,UAAU,GAAG,IAAItG,GAAJ,CACjBqG,WAAW,CAACnG,GAAZ,CAAgB,UAACzB,KAAD;AAAA,6BAAWI,YAAY,CAACJ,KAAD,CAAvB;AAAA,qBAAhB,CADiB,CAAnB;AAGA,wBAAM8H,YAAY,GAChB,CAAAtB,OAAO,SAAP,IAAAA,OAAO,WAAP,8BAAAA,OAAO,CAAE1C,IAAT,2FAAeK,0BAAf,0GAA4CG,aAA5C,mFAA6DI,SAA7D,MACA,EAFF;AAGA,wBAAMpC,UAAU,GACd,CAAAkE,OAAO,SAAP,IAAAA,OAAO,WAAP,8BAAAA,OAAO,CAAE1C,IAAT,2FAAeE,uBAAf,0GAAyCiC,iBAAzC,mFACEG,aADF,MAEK,IAHP;;AAb8B,gEAiBVe,cAjBU;AAAA;;AAAA;AAiB9B,6EAAoC;AAAA,4BAAzBxC,KAAyB;AAClC,4BAAMC,UAAU,GAAGxE,YAAY,CAACuE,KAAD,CAA/B;AACA,4BAAI,CAACC,UAAD,IAAeiD,UAAU,CAACF,GAAX,CAAe/C,UAAf,CAAnB,EAA+C;AAC/C,4BAAMmD,cAAc,GAAGD,YAAY,CAAClD,UAAD,CAAZ,IAA4BD,KAAnD;AACA,4BAAMqD,IAAI,GAAG1F,UAAU,aAChBK,QADgB,cACJyD,aADI,cACY9D,UADZ,cAEhBK,QAFgB,cAEJyD,aAFI,CAAvB;AAGAgB,wBAAAA,GAAG,CAAC/F,IAAJ,CACEgG,MAAM,CAACY,MAAP,qBACGD,IADH,EACUrI,QAAQ,CAAC8F,SAAT,CAAmByC,UAAnB,CAA8BC,UAA9B,CAAyCJ,cAAzC,CADV,EADF;AAKD;AA7B6B;AAAA;AAAA;AAAA;AAAA;AA8B/B;AA/EE;AAAA;AAAA;AAAA;AAAA;AAAA;;AAeL,qEAA2C;AAAA;AAiE1C;AAhFI;AAAA;AAAA;AAAA;AAAA;;AAAA,iBAkFDX,GAAG,CAAC9D,MAlFH;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAmFG8E,OAAO,CAACC,UAAR,CAAmBjB,GAAnB,CAnFH;;AAAA;AAAA,8CAoFI,IApFJ;;AAAA;AAAA,8CAsFE,KAtFF;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AAyFP,gBAAsBkB,gBAAtB;AAAA;AAAA;;;+EAAO;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAkCxF,YAAAA,GAAlC,SAAkCA,GAAlC,EAAuC0D,OAAvC,SAAuCA,OAAvC;;AAAA,gBACA1D,GADA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAEC0C,YAAAA,EAFD,GAEM7F,QAAQ,CAAC8F,SAAT,EAFN;AAGCuB,YAAAA,UAHD,GAGcxB,EAAE,CAACE,UAAH,CAAc,SAAd,CAHd;AAIClC,YAAAA,UAJD,GAIc,CAAAgD,OAAO,SAAP,IAAAA,OAAO,WAAP,YAAAA,OAAO,CAAEhD,UAAT,KAAuB,EAJrC;AAKCG,YAAAA,kBALD,GAKsB0B,OAAO,CAACmB,OAAD,aAACA,OAAD,0CAACA,OAAO,CAAE1C,IAAV,oDAAC,gBAAeH,kBAAhB,CAL7B;AAMCyD,YAAAA,GAND,GAMO5D,UAAU,CAAC/B,GAAX,CAAe,UAAC4C,QAAD,EAAc;AAAA;;AACvC,kBAAMC,aAAa,GAAGlE,YAAY,CAACiE,QAAD,CAAlC;AACA,kBAAM4B,iBAAiB,GACrB,CAAAO,OAAO,SAAP,IAAAA,OAAO,WAAP,+BAAAA,OAAO,CAAE1C,IAAT,6FAAeG,kBAAf,gFAAoCK,aAApC,MAAsDD,QADxD;AAEA,kBAAMgD,MAAM,GAAGL,UAAU,CAAClB,GAAX,CAAeG,iBAAf,CAAf;AACA,kBAAMG,YAAY,GAChB,CAAAI,OAAO,SAAP,IAAAA,OAAO,WAAP,+BAAAA,OAAO,CAAE1C,IAAT,6FAAeI,qBAAf,0GAAuCI,aAAvC,mFACElE,YAAY,CAAC0C,GAAD,CADd,MAEKA,GAHP;;AAIA,kBAAIa,kBAAJ,EAAwB;AACtB,uBAAO0D,MAAM,CACV3B,UADI,CACOU,YADP,EAEJxE,GAFI,GAGJ2G,IAHI,CAGC,UAAC5C,IAAD,EAAU;AACd,sBAAM6C,SAAS,GAAG,EAAlB;AACA7C,kBAAAA,IAAI,CAACxE,OAAL,CAAa,UAAC2E,GAAD,EAAS;AACpB0C,oBAAAA,SAAS,CAACnH,IAAV,CAAeyE,GAAG,CAAC2C,GAAJ,YAAf;AACD,mBAFD;AAGA,yBAAOL,OAAO,CAACC,UAAR,CAAmBG,SAAnB,CAAP;AACD,iBATI,WAUE;AAAA,yBAAM,IAAN;AAAA,iBAVF,CAAP;AAWD;;AACD,kBAAM7F,QAAQ,GACZ,CAAA6D,OAAO,SAAP,IAAAA,OAAO,WAAP,+BAAAA,OAAO,CAAE1C,IAAT,6FAAeC,kBAAf,gFAAoCkC,iBAApC,MACAnG,iBAFF;;AAGA,kBAAMmI,MAAM,iCACNtF,QADM,cACMyD,YADN,GACuBzG,QAAQ,CAAC8F,SAAT,CAAmByC,UAAnB,YADvB,CAAZ;;AAGA,kBAAI,EAAC1B,OAAD,aAACA,OAAD,kCAACA,OAAO,CAAE1C,IAAV,qEAAC,gBAAeC,kBAAhB,kDAAC,sBAAoCkC,iBAApC,CAAD,CAAJ,EAA6D;AAC3DgC,gBAAAA,MAAM,CAAC7B,YAAD,CAAN,GAAuBzG,QAAQ,CAAC8F,SAAT,CAAmByC,UAAnB,YAAvB;AACD;;AACD,qBAAOb,MAAM,CAACY,MAAP,CAAcA,MAAd,WAA4B;AAAA,uBAAM,IAAN;AAAA,eAA5B,CAAP;AACD,aAhCW,CANP;AAAA;AAAA,mBAuCCG,OAAO,CAACC,UAAR,CAAmBjB,GAAnB,CAvCD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AA0CP,gBAAsBsB,kBAAtB;AAAA;AAAA;;;iFAAO;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AACLrE,YAAAA,QADK,SACLA,QADK,EAELvB,GAFK,SAELA,GAFK,EAGL6B,KAHK,SAGLA,KAHK,EAIL6B,OAJK,SAILA,OAJK;;AAAA,kBAMD,CAACnC,QAAD,IAAa,CAACvB,GAAd,IAAqB,CAAC6B,KANrB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAOCa,YAAAA,EAPD,GAOM7F,QAAQ,CAAC8F,SAAT,EAPN;AAQCnB,YAAAA,aARD,GAQiBlE,YAAY,CAACiE,QAAD,CAR7B;AASC4B,YAAAA,iBATD,GAUH,CAAAO,OAAO,SAAP,IAAAA,OAAO,WAAP,+BAAAA,OAAO,CAAE1C,IAAT,6FAAeG,kBAAf,gFAAoCK,aAApC,MAAsDD,QAVnD;AAWCgD,YAAAA,MAXD,GAWU7B,EAAE,CAACE,UAAH,CAAc,SAAd,EAAyBI,GAAzB,CAA6BG,iBAA7B,CAXV;AAYCG,YAAAA,YAZD,GAaH,CAAAI,OAAO,SAAP,IAAAA,OAAO,WAAP,+BAAAA,OAAO,CAAE1C,IAAT,6FAAeI,qBAAf,0GAAuCI,aAAvC,mFACElE,YAAY,CAAC0C,GAAD,CADd,MAEKA,GAfF;;AAAA,kBAgBD0D,OAhBC,aAgBDA,OAhBC,kCAgBDA,OAAO,CAAE1C,IAhBR,4CAgBD,gBAAeH,kBAhBd;AAAA;AAAA;AAAA;;AAiBGgF,YAAAA,QAjBH,GAiBcvI,YAAY,CAACuE,KAAD,CAjB1B;AAAA;AAAA,mBAkBG0C,MAAM,CACT3B,UADG,CACQU,YADR,EAEHN,GAFG,CAEC6C,QAFD,uBAIG;AAAA,qBAAM,IAAN;AAAA,aAJH,CAlBH;;AAAA;AAAA;;AAAA;AAyBChG,YAAAA,QAzBD,GA0BH,CAAA6D,OAAO,SAAP,IAAAA,OAAO,WAAP,+BAAAA,OAAO,CAAE1C,IAAT,6FAAeC,kBAAf,gFAAoCkC,iBAApC,MACAnG,iBA3BG;AA4BCwC,YAAAA,UA5BD,GA6BH,CAAAkE,OAAO,SAAP,IAAAA,OAAO,WAAP,+BAAAA,OAAO,CAAE1C,IAAT,6FAAeE,uBAAf,0GAAyCiC,iBAAzC,mFACEG,YADF,MAEK,IA/BF;AAgCC4B,YAAAA,IAhCD,GAgCQ1F,UAAU,aAChBK,QADgB,cACJyD,YADI,cACY9D,UADZ,cAEhBK,QAFgB,cAEJyD,YAFI,CAhClB;AAAA;AAAA,mBAmCCiB,MAAM,CAACY,MAAP,qBACHD,IADG,EACIrI,QAAQ,CAAC8F,SAAT,CAAmByC,UAAnB,CAA8BU,WAA9B,CAA0CjE,KAA1C,CADJ,EAnCD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["import firebase from \"../context/Firebase\";\r\n\r\nconst OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\r\nconst MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\r\nconst DEFAULT_OEM_FIELD = \"oems\";\r\n\r\nconst isPlainObject = (value) =>\r\n  value != null &&\r\n  typeof value === \"object\" &&\r\n  !Array.isArray(value) &&\r\n  !(value instanceof Date);\r\n\r\nconst normalizeKey = (value) => {\r\n  if (value == null) return \"\";\r\n  return String(value).trim().toLowerCase();\r\n};\r\n\r\nconst hasUpper = (value) => /[A-Z]/.test(String(value || \"\"));\r\n\r\nconst pickPreferredCase = (current, incoming) => {\r\n  if (!current) return incoming;\r\n  if (!incoming) return current;\r\n  const currentUpper = hasUpper(current);\r\n  const incomingUpper = hasUpper(incoming);\r\n  if (incomingUpper && !currentUpper) return incoming;\r\n  if (currentUpper && !incomingUpper) return current;\r\n  return current;\r\n};\r\n\r\nconst normalizeArray = (value) => {\r\n  if (Array.isArray(value)) return value;\r\n  if (value == null || value === \"\") return [];\r\n  return [value];\r\n};\r\n\r\nconst normalizeList = (values) => {\r\n  const out = [];\r\n  (values || []).forEach((value) => {\r\n    if (value == null) return;\r\n    const normalized = String(value).trim();\r\n    if (!normalized) return;\r\n    if (normalizeKey(normalized) === \"nan\") return;\r\n    out.push(normalized);\r\n  });\r\n  return Array.from(new Set(out));\r\n};\r\n\r\nconst normalizeListCaseInsensitive = (values) => {\r\n  const map = new Map();\r\n  (values || []).forEach((value) => {\r\n    if (value == null) return;\r\n    const normalized = String(value).trim();\r\n    if (!normalized) return;\r\n    const key = normalizeKey(normalized);\r\n    if (!key || key === \"nan\") return;\r\n    const current = map.get(key);\r\n    map.set(key, pickPreferredCase(current, normalized));\r\n  });\r\n  return Array.from(map.values());\r\n};\r\n\r\n\r\nconst pickModelField = (obj) => {\r\n  if (!isPlainObject(obj)) return null;\r\n  for (const key of MODEL_FIELD_CANDIDATES) {\r\n    if (Array.isArray(obj[key])) return key;\r\n  }\r\n  const arrayKey = Object.keys(obj).find((key) => Array.isArray(obj[key]));\r\n  return arrayKey || null;\r\n};\r\n\r\nconst extractModels = (value) => {\r\n  if (Array.isArray(value)) {\r\n    return { models: normalizeList(value), modelField: null };\r\n  }\r\n  if (isPlainObject(value)) {\r\n    const modelField = pickModelField(value);\r\n    const models = modelField ? normalizeList(value[modelField]) : [];\r\n    return { models, modelField };\r\n  }\r\n  if (value != null && value !== \"\") {\r\n    return { models: normalizeList([value]), modelField: null };\r\n  }\r\n  return { models: [], modelField: null };\r\n};\r\n\r\nconst extractOemMap = (data) => {\r\n  const oemMap = {};\r\n  const modelFieldByOem = {};\r\n  let oemField = null;\r\n\r\n  for (const key of OEM_FIELD_CANDIDATES) {\r\n    if (Array.isArray(data?.[key])) {\r\n      oemField = key;\r\n      data[key].forEach((entry) => {\r\n        if (entry == null) return;\r\n        if (isPlainObject(entry)) {\r\n          const name =\r\n            entry.name ||\r\n            entry.oem ||\r\n            entry.OEM ||\r\n            entry.label ||\r\n            entry.value;\r\n          if (!name) return;\r\n          const normalizedName = String(name).trim();\r\n          if (!normalizedName) return;\r\n          const { models } = extractModels(entry.models || entry.list || entry.items);\r\n          oemMap[normalizedName] = normalizeList([\r\n            ...(oemMap[normalizedName] || []),\r\n            ...models,\r\n          ]);\r\n          return;\r\n        }\r\n        const normalized = String(entry || \"\").trim();\r\n        if (!normalized) return;\r\n        oemMap[normalized] = normalizeList([...(oemMap[normalized] || [])]);\r\n      });\r\n    } else if (isPlainObject(data?.[key])) {\r\n      oemField = key;\r\n      Object.entries(data[key]).forEach(([oem, value]) => {\r\n        const { models, modelField } = extractModels(value);\r\n        oemMap[oem] = normalizeList([...(oemMap[oem] || []), ...models]);\r\n        if (modelField) {\r\n          modelFieldByOem[oem] = modelField;\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  if (!oemField) {\r\n    Object.entries(data || {}).forEach(([key, value]) => {\r\n      if (!value) return;\r\n      if (key.startsWith(\"_\")) return;\r\n      if (isPlainObject(value) || Array.isArray(value)) {\r\n        const { models, modelField } = extractModels(value);\r\n        if (models.length || modelField) {\r\n          oemMap[key] = normalizeList([...(oemMap[key] || []), ...models]);\r\n          if (modelField) {\r\n            modelFieldByOem[key] = modelField;\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  return { oemMap, oemField, modelFieldByOem };\r\n};\r\n\r\n\r\nconst buildCatalogMetaFromMaps = ({\r\n  modalities = [],\r\n  oemsByModality = {},\r\n  modelsByModalityOem = {},\r\n  usesSubcollections = false,\r\n  syncDisabled = false,\r\n  source = \"client\",\r\n}) => {\r\n  const meta = {\r\n    oemFieldByModality: {},\r\n    modelFieldByModalityOem: {},\r\n    modalityKeyByLower: {},\r\n    oemKeyByModalityLower: {},\r\n    modelKeyByModalityOemLower: {},\r\n    usesSubcollections,\r\n    syncDisabled,\r\n    source,\r\n  };\r\n\r\n  const normalizedModalities = normalizeListCaseInsensitive(modalities);\r\n  normalizedModalities.forEach((modality) => {\r\n    const modalityLower = normalizeKey(modality);\r\n    meta.modalityKeyByLower[modalityLower] = pickPreferredCase(\r\n      meta.modalityKeyByLower[modalityLower],\r\n      modality\r\n    );\r\n    const oems = oemsByModality?.[modality] || [];\r\n    const oemLowerMap =\r\n      meta.oemKeyByModalityLower[modalityLower] || {};\r\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\r\n    const modelLowerMap =\r\n      meta.modelKeyByModalityOemLower[modalityLower] || {};\r\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\r\n\r\n    oems.forEach((oem) => {\r\n      const oemLower = normalizeKey(oem);\r\n      oemLowerMap[oemLower] = pickPreferredCase(oemLowerMap[oemLower], oem);\r\n      const models = modelsByModalityOem?.[modality]?.[oem] || [];\r\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\r\n      models.forEach((model) => {\r\n        const modelLower = normalizeKey(model);\r\n        if (!modelLower) return;\r\n        modelLowerMap[oemLower][modelLower] = pickPreferredCase(\r\n          modelLowerMap[oemLower][modelLower],\r\n          model\r\n        );\r\n      });\r\n    });\r\n  });\r\n\r\n  return {\r\n    modalities: normalizedModalities,\r\n    oemsByModality,\r\n    modelsByModalityOem,\r\n    meta,\r\n  };\r\n};\r\n\r\nexport async function fetchTrackerCatalog() {\r\n  if (typeof window !== \"undefined\") {\r\n    try {\r\n      const response = await fetch(\r\n        `/api/tracker/catalog?ts=${Date.now()}`,\r\n        { cache: \"no-store\" }\r\n      );\r\n      if (response.ok) {\r\n        const payload = await response.json();\r\n        if (payload?.modalities) {\r\n          return buildCatalogMetaFromMaps({\r\n            modalities: payload.modalities || [],\r\n            oemsByModality: payload.oemsByModality || {},\r\n            modelsByModalityOem: payload.modelsByModalityOem || {},\r\n            usesSubcollections: Boolean(payload.usesSubcollections),\r\n            syncDisabled: false,\r\n            source: \"server\",\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn(\"Tracker catalog API fallback:\", error);\r\n    }\r\n  }\r\n\r\n  const db = firebase.firestore();\r\n  let snap;\r\n  try {\r\n    snap = await db.collection(\"Tracker\").get({ source: \"server\" });\r\n  } catch (error) {\r\n    snap = await db.collection(\"Tracker\").get();\r\n  }\r\n  console.log(\r\n    \"Tracker catalog client docs:\",\r\n    snap.docs.map((doc) => doc.id)\r\n  );\r\n\r\n  const modalities = [];\r\n  const oemsByModality = {};\r\n  const modelsByModalityOem = {};\r\n  const meta = {\r\n    oemFieldByModality: {},\r\n    modelFieldByModalityOem: {},\r\n    modalityKeyByLower: {},\r\n    oemKeyByModalityLower: {},\r\n    modelKeyByModalityOemLower: {},\r\n  };\r\n\r\n  snap.forEach((doc) => {\r\n    const modality = doc.id;\r\n    const modalityLower = normalizeKey(modality);\r\n    const existingModality = meta.modalityKeyByLower[modalityLower];\r\n    const canonicalModality = pickPreferredCase(existingModality, modality);\r\n    meta.modalityKeyByLower[modalityLower] = canonicalModality;\r\n    const data = doc.data() || {};\r\n    const { oemMap, oemField, modelFieldByOem } = extractOemMap(data);\r\n\r\n    if (existingModality && existingModality !== canonicalModality) {\r\n      oemsByModality[canonicalModality] = normalizeListCaseInsensitive([\r\n        ...(oemsByModality[existingModality] || []),\r\n        ...(oemsByModality[canonicalModality] || []),\r\n      ]);\r\n      modelsByModalityOem[canonicalModality] = {\r\n        ...(modelsByModalityOem[existingModality] || {}),\r\n        ...(modelsByModalityOem[canonicalModality] || {}),\r\n      };\r\n      meta.modelFieldByModalityOem[canonicalModality] = {\r\n        ...(meta.modelFieldByModalityOem[existingModality] || {}),\r\n        ...(meta.modelFieldByModalityOem[canonicalModality] || {}),\r\n      };\r\n      if (!meta.oemFieldByModality[canonicalModality]) {\r\n        meta.oemFieldByModality[canonicalModality] =\r\n          meta.oemFieldByModality[existingModality] || oemField;\r\n      }\r\n      delete oemsByModality[existingModality];\r\n      delete modelsByModalityOem[existingModality];\r\n      delete meta.oemFieldByModality[existingModality];\r\n      delete meta.modelFieldByModalityOem[existingModality];\r\n    }\r\n\r\n    modalities.push(canonicalModality);\r\n    if (!meta.oemFieldByModality[canonicalModality]) {\r\n      meta.oemFieldByModality[canonicalModality] = oemField;\r\n    }\r\n    meta.modelFieldByModalityOem[canonicalModality] = {\r\n      ...(meta.modelFieldByModalityOem[canonicalModality] || {}),\r\n      ...(modelFieldByOem || {}),\r\n    };\r\n\r\n    const oems = Object.keys(oemMap);\r\n    const mergedOems = normalizeListCaseInsensitive([\r\n      ...(oemsByModality[canonicalModality] || []),\r\n      ...oems,\r\n    ]);\r\n    oemsByModality[canonicalModality] = mergedOems;\r\n    modelsByModalityOem[canonicalModality] =\r\n      modelsByModalityOem[canonicalModality] || {};\r\n    const oemLowerMap =\r\n      meta.oemKeyByModalityLower[modalityLower] || {};\r\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\r\n    const modelLowerMap =\r\n      meta.modelKeyByModalityOemLower[modalityLower] || {};\r\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\r\n    oems.forEach((oem) => {\r\n      const oemLower = normalizeKey(oem);\r\n      const existingOem = oemLowerMap[oemLower];\r\n      const canonicalOem = pickPreferredCase(existingOem, oem);\r\n      oemLowerMap[oemLower] = canonicalOem;\r\n      if (existingOem && existingOem !== canonicalOem) {\r\n        modelsByModalityOem[canonicalModality][canonicalOem] = normalizeListCaseInsensitive([\r\n          ...(modelsByModalityOem[canonicalModality][existingOem] || []),\r\n          ...(modelsByModalityOem[canonicalModality][canonicalOem] || []),\r\n        ]);\r\n        delete modelsByModalityOem[canonicalModality][existingOem];\r\n      }\r\n      const existingModels =\r\n        modelsByModalityOem[canonicalModality][canonicalOem] || [];\r\n      const mergedModels = normalizeListCaseInsensitive([\r\n        ...existingModels,\r\n        ...(oemMap[oem] || []),\r\n      ]);\r\n      modelsByModalityOem[canonicalModality][canonicalOem] = mergedModels;\r\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\r\n      mergedModels.forEach((model) => {\r\n        modelLowerMap[oemLower][normalizeKey(model)] = model;\r\n      });\r\n    });\r\n  });\r\n\r\n  return buildCatalogMetaFromMaps({\r\n    modalities,\r\n    oemsByModality,\r\n    modelsByModalityOem,\r\n    usesSubcollections: true,\r\n    syncDisabled: false,\r\n    source: \"client\",\r\n  });\r\n}\r\n\r\nexport function buildAllOems(catalog) {\r\n  const map = new Map();\r\n  Object.values(catalog?.oemsByModality || {}).forEach((oems) => {\r\n    (oems || []).forEach((oem) => {\r\n      const key = normalizeKey(oem);\r\n      if (!key) return;\r\n      const current = map.get(key);\r\n      map.set(key, pickPreferredCase(current, oem));\r\n    });\r\n  });\r\n  return Array.from(map.values());\r\n}\r\n\r\nexport function buildModelsForSelection(catalog, modalities = [], oems = []) {\r\n  const modelSet = new Set();\r\n  const modals = normalizeList(modalities);\r\n  const oemList = normalizeList(oems);\r\n  modals.forEach((modality) => {\r\n    const modalityLower = normalizeKey(modality);\r\n    const canonicalModality =\r\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\r\n    const oemMap = catalog?.modelsByModalityOem?.[canonicalModality] || {};\r\n    oemList.forEach((oem) => {\r\n      const oemLower = normalizeKey(oem);\r\n      const canonicalOem =\r\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] || oem;\r\n      const models = oemMap?.[canonicalOem] || [];\r\n      models.forEach((model) => modelSet.add(model));\r\n    });\r\n  });\r\n  return Array.from(modelSet);\r\n}\r\n\r\nexport async function syncTrackerFromSelections({\r\n  selections,\r\n  catalog,\r\n}) {\r\n  const db = firebase.firestore();\r\n  const trackerRef = db.collection(\"Tracker\");\r\n  const selectedModalities = normalizeList(selections?.modalities || []);\r\n  const selectedOems = normalizeList(selections?.oems || []);\r\n  const selectedModels = normalizeList(selections?.models || []);\r\n\r\n  if (!selectedModalities.length) return false;\r\n  if (catalog?.meta?.syncDisabled) return false;\r\n\r\n  const ops = [];\r\n\r\n  for (const modality of selectedModalities) {\r\n    const modalityLower = normalizeKey(modality);\r\n    const canonicalModality =\r\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modalityLower;\r\n    const docRef = trackerRef.doc(canonicalModality);\r\n    const existingOemsRaw = catalog?.oemsByModality?.[canonicalModality] || [];\r\n    const existingOemsLower = new Set(\r\n      existingOemsRaw.map((value) => normalizeKey(value))\r\n    );\r\n\r\n    const oemField =\r\n      catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\r\n      DEFAULT_OEM_FIELD;\r\n\r\n    if (\r\n      !catalog?.modalities?.some(\r\n        (existing) => normalizeKey(existing) === modalityLower\r\n      )\r\n    ) {\r\n      ops.push(docRef.set({ [DEFAULT_OEM_FIELD]: {} }, { merge: true }));\r\n    }\r\n\r\n    for (const oem of selectedOems) {\r\n      const oemLower = normalizeKey(oem);\r\n      const canonicalOem =\r\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] ||\r\n        oemLower;\r\n      if (!existingOemsLower.has(oemLower)) {\r\n        ops.push(\r\n          docRef.set({ [oemField]: { [canonicalOem]: [] } }, { merge: true })\r\n        );\r\n      }\r\n    }\r\n\r\n    for (const oem of selectedOems) {\r\n      const oemLower = normalizeKey(oem);\r\n      const canonicalOem =\r\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] ||\r\n        oemLower;\r\n      const knownModels =\r\n        catalog?.modelsByModalityOem?.[canonicalModality]?.[canonicalOem] || [];\r\n      const knownLower = new Set(\r\n        knownModels.map((value) => normalizeKey(value))\r\n      );\r\n      const modelCaseMap =\r\n        catalog?.meta?.modelKeyByModalityOemLower?.[modalityLower]?.[oemLower] ||\r\n        {};\r\n      const modelField =\r\n        catalog?.meta?.modelFieldByModalityOem?.[canonicalModality]?.[\r\n          canonicalOem\r\n        ] || null;\r\n      for (const model of selectedModels) {\r\n        const modelLower = normalizeKey(model);\r\n        if (!modelLower || knownLower.has(modelLower)) continue;\r\n        const canonicalModel = modelCaseMap[modelLower] || model;\r\n        const path = modelField\r\n          ? `${oemField}.${canonicalOem}.${modelField}`\r\n          : `${oemField}.${canonicalOem}`;\r\n        ops.push(\r\n          docRef.update({\r\n            [path]: firebase.firestore.FieldValue.arrayUnion(canonicalModel),\r\n          })\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  if (ops.length) {\r\n    await Promise.allSettled(ops);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport async function deleteTrackerOem({ oem, catalog }) {\r\n  if (!oem) return;\r\n  const db = firebase.firestore();\r\n  const trackerRef = db.collection(\"Tracker\");\r\n  const modalities = catalog?.modalities || [];\r\n  const usesSubcollections = Boolean(catalog?.meta?.usesSubcollections);\r\n  const ops = modalities.map((modality) => {\r\n    const modalityLower = normalizeKey(modality);\r\n    const canonicalModality =\r\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\r\n    const docRef = trackerRef.doc(canonicalModality);\r\n    const canonicalOem =\r\n      catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[\r\n        normalizeKey(oem)\r\n      ] || oem;\r\n    if (usesSubcollections) {\r\n      return docRef\r\n        .collection(canonicalOem)\r\n        .get()\r\n        .then((snap) => {\r\n          const deletions = [];\r\n          snap.forEach((doc) => {\r\n            deletions.push(doc.ref.delete());\r\n          });\r\n          return Promise.allSettled(deletions);\r\n        })\r\n        .catch(() => null);\r\n    }\r\n    const oemField =\r\n      catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\r\n      DEFAULT_OEM_FIELD;\r\n    const update = {\r\n      [`${oemField}.${canonicalOem}`]: firebase.firestore.FieldValue.delete(),\r\n    };\r\n    if (!catalog?.meta?.oemFieldByModality?.[canonicalModality]) {\r\n      update[canonicalOem] = firebase.firestore.FieldValue.delete();\r\n    }\r\n    return docRef.update(update).catch(() => null);\r\n  });\r\n  await Promise.allSettled(ops);\r\n}\r\n\r\nexport async function deleteTrackerModel({\r\n  modality,\r\n  oem,\r\n  model,\r\n  catalog,\r\n}) {\r\n  if (!modality || !oem || !model) return;\r\n  const db = firebase.firestore();\r\n  const modalityLower = normalizeKey(modality);\r\n  const canonicalModality =\r\n    catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\r\n  const docRef = db.collection(\"Tracker\").doc(canonicalModality);\r\n  const canonicalOem =\r\n    catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[\r\n      normalizeKey(oem)\r\n    ] || oem;\r\n  if (catalog?.meta?.usesSubcollections) {\r\n    const modelKey = normalizeKey(model);\r\n    await docRef\r\n      .collection(canonicalOem)\r\n      .doc(modelKey)\r\n      .delete()\r\n      .catch(() => null);\r\n    return;\r\n  }\r\n  const oemField =\r\n    catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\r\n    DEFAULT_OEM_FIELD;\r\n  const modelField =\r\n    catalog?.meta?.modelFieldByModalityOem?.[canonicalModality]?.[\r\n      canonicalOem\r\n    ] || null;\r\n  const path = modelField\r\n    ? `${oemField}.${canonicalOem}.${modelField}`\r\n    : `${oemField}.${canonicalOem}`;\r\n  await docRef.update({\r\n    [path]: firebase.firestore.FieldValue.arrayRemove(model),\r\n  });\r\n}\r\n"]},"metadata":{},"sourceType":"module"}