{"ast":null,"code":"import { adminDb } from \"../../../context/FirebaseAdmin\";\n\nconst normalizeKey = value => {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nconst normalizeList = values => {\n  const out = [];\n  (values || []).forEach(value => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst extractModelsFromDoc = (data, docId) => {\n  if (!data) return docId ? [docId] : [];\n  if (Array.isArray(data.models)) return normalizeList(data.models);\n  if (Array.isArray(data.model)) return normalizeList(data.model);\n  if (Array.isArray(data.items)) return normalizeList(data.items);\n  if (typeof data.model === \"string\") return normalizeList([data.model]);\n  if (typeof data.name === \"string\") return normalizeList([data.name]);\n  if (docId) return normalizeList([docId]);\n  return [];\n};\n\nconst extractOemsFromFields = data => {\n  const out = {};\n  if (!data) return out;\n  const oemsField = data.oems || data.OEMs || data.oem || data.OEM;\n\n  if (Array.isArray(oemsField)) {\n    oemsField.forEach(entry => {\n      if (entry == null) return;\n\n      if (typeof entry === \"string\") {\n        out[entry] = out[entry] || [];\n        return;\n      }\n\n      if (typeof entry === \"object\") {\n        const name = entry.name || entry.oem || entry.OEM || entry.label || entry.value;\n        if (!name) return;\n        const models = extractModelsFromDoc(entry);\n        out[name] = normalizeList([...(out[name] || []), ...models]);\n      }\n    });\n    return out;\n  }\n\n  if (oemsField && typeof oemsField === \"object\") {\n    Object.entries(oemsField).forEach(([oem, value]) => {\n      if (value == null) return;\n\n      if (Array.isArray(value)) {\n        out[oem] = normalizeList(value);\n        return;\n      }\n\n      if (typeof value === \"object\") {\n        const models = extractModelsFromDoc(value);\n        out[oem] = normalizeList([...(out[oem] || []), ...models]);\n        return;\n      }\n\n      out[oem] = normalizeList([...(out[oem] || []), String(value).trim()]);\n    });\n  }\n\n  return out;\n};\n\nexport default async function handler(req, res) {\n  if (!adminDb) {\n    res.status(503).json({\n      error: \"Firebase Admin not available.\"\n    });\n    return;\n  }\n\n  try {\n    const snap = await adminDb.collection(\"Tracker\").get();\n    const modalities = [];\n    const oemsByModality = {};\n    const modelsByModalityOem = {};\n\n    for (const doc of snap.docs) {\n      const modality = doc.id;\n      modalities.push(modality);\n      const data = doc.data() || {};\n      const oems = new Set();\n      const modelsByOem = {};\n      const fieldOems = extractOemsFromFields(data);\n      Object.entries(fieldOems).forEach(([oem, models]) => {\n        oems.add(oem);\n        modelsByOem[oem] = normalizeList([...(modelsByOem[oem] || []), ...models]);\n      });\n      const subcollections = await doc.ref.listCollections();\n\n      for (const sub of subcollections) {\n        const oem = sub.id;\n        oems.add(oem);\n        const modelSet = new Set(modelsByOem[oem] || []);\n        const subSnap = await sub.get();\n        subSnap.forEach(subDoc => {\n          const models = extractModelsFromDoc(subDoc.data(), subDoc.id);\n          models.forEach(model => modelSet.add(model));\n        });\n        modelsByOem[oem] = Array.from(modelSet);\n      }\n\n      oemsByModality[modality] = Array.from(oems);\n      modelsByModalityOem[modality] = modelsByOem;\n    }\n\n    res.status(200).json({\n      modalities,\n      oemsByModality,\n      modelsByModalityOem,\n      usesSubcollections: true\n    });\n  } catch (error) {\n    console.error(\"Tracker catalog API failed:\", error);\n    res.status(500).json({\n      error: \"Failed to build tracker catalog.\"\n    });\n  }\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/pages/api/tracker/catalog.js"],"names":["adminDb","normalizeKey","value","String","trim","toLowerCase","normalizeList","values","out","forEach","normalized","push","Array","from","Set","extractModelsFromDoc","data","docId","isArray","models","model","items","name","extractOemsFromFields","oemsField","oems","OEMs","oem","OEM","entry","label","Object","entries","handler","req","res","status","json","error","snap","collection","get","modalities","oemsByModality","modelsByModalityOem","doc","docs","modality","id","modelsByOem","fieldOems","add","subcollections","ref","listCollections","sub","modelSet","subSnap","subDoc","usesSubcollections","console"],"mappings":"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","sourcesContent":["import { adminDb } from \"../../../context/FirebaseAdmin\";\n\nconst normalizeKey = (value) => {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nconst normalizeList = (values) => {\n  const out = [];\n  (values || []).forEach((value) => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst extractModelsFromDoc = (data, docId) => {\n  if (!data) return docId ? [docId] : [];\n  if (Array.isArray(data.models)) return normalizeList(data.models);\n  if (Array.isArray(data.model)) return normalizeList(data.model);\n  if (Array.isArray(data.items)) return normalizeList(data.items);\n  if (typeof data.model === \"string\") return normalizeList([data.model]);\n  if (typeof data.name === \"string\") return normalizeList([data.name]);\n  if (docId) return normalizeList([docId]);\n  return [];\n};\n\nconst extractOemsFromFields = (data) => {\n  const out = {};\n  if (!data) return out;\n  const oemsField = data.oems || data.OEMs || data.oem || data.OEM;\n\n  if (Array.isArray(oemsField)) {\n    oemsField.forEach((entry) => {\n      if (entry == null) return;\n      if (typeof entry === \"string\") {\n        out[entry] = out[entry] || [];\n        return;\n      }\n      if (typeof entry === \"object\") {\n        const name =\n          entry.name ||\n          entry.oem ||\n          entry.OEM ||\n          entry.label ||\n          entry.value;\n        if (!name) return;\n        const models = extractModelsFromDoc(entry);\n        out[name] = normalizeList([...(out[name] || []), ...models]);\n      }\n    });\n    return out;\n  }\n\n  if (oemsField && typeof oemsField === \"object\") {\n    Object.entries(oemsField).forEach(([oem, value]) => {\n      if (value == null) return;\n      if (Array.isArray(value)) {\n        out[oem] = normalizeList(value);\n        return;\n      }\n      if (typeof value === \"object\") {\n        const models = extractModelsFromDoc(value);\n        out[oem] = normalizeList([...(out[oem] || []), ...models]);\n        return;\n      }\n      out[oem] = normalizeList([...(out[oem] || []), String(value).trim()]);\n    });\n  }\n\n  return out;\n};\n\nexport default async function handler(req, res) {\n  if (!adminDb) {\n    res.status(503).json({ error: \"Firebase Admin not available.\" });\n    return;\n  }\n\n  try {\n    const snap = await adminDb.collection(\"Tracker\").get();\n    const modalities = [];\n    const oemsByModality = {};\n    const modelsByModalityOem = {};\n\n    for (const doc of snap.docs) {\n      const modality = doc.id;\n      modalities.push(modality);\n      const data = doc.data() || {};\n\n      const oems = new Set();\n      const modelsByOem = {};\n\n      const fieldOems = extractOemsFromFields(data);\n      Object.entries(fieldOems).forEach(([oem, models]) => {\n        oems.add(oem);\n        modelsByOem[oem] = normalizeList([\n          ...(modelsByOem[oem] || []),\n          ...models,\n        ]);\n      });\n\n      const subcollections = await doc.ref.listCollections();\n      for (const sub of subcollections) {\n        const oem = sub.id;\n        oems.add(oem);\n        const modelSet = new Set(modelsByOem[oem] || []);\n        const subSnap = await sub.get();\n        subSnap.forEach((subDoc) => {\n          const models = extractModelsFromDoc(subDoc.data(), subDoc.id);\n          models.forEach((model) => modelSet.add(model));\n        });\n        modelsByOem[oem] = Array.from(modelSet);\n      }\n\n      oemsByModality[modality] = Array.from(oems);\n      modelsByModalityOem[modality] = modelsByOem;\n    }\n\n    res.status(200).json({\n      modalities,\n      oemsByModality,\n      modelsByModalityOem,\n      usesSubcollections: true,\n    });\n  } catch (error) {\n    console.error(\"Tracker catalog API failed:\", error);\n    res.status(500).json({ error: \"Failed to build tracker catalog.\" });\n  }\n}\n"]},"metadata":{},"sourceType":"module"}