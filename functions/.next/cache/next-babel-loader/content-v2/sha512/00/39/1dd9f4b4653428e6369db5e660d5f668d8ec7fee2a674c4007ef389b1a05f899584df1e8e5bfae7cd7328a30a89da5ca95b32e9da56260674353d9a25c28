{"ast":null,"code":"import _slicedToArray from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _regeneratorRuntime from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nvar __jsx = React.createElement;\nimport React, { useCallback, useEffect, useRef, useState } from \"react\";\nimport { Modal, Button, Spinner } from \"react-bootstrap\";\nimport firebase from \"../context/Firebase\";\nimport styles from \"./WarehouseMapModal.module.css\";\nvar REGION_ORDER = [\"E\", \"F\", \"G\", \"H\", \"I\", \"A\", \"D\", \"C\", \"B\"];\nvar NO_PALLET = \"NoPallet\";\nvar LETTERS = Array.from({\n  length: 26\n}, function (_, i) {\n  return String.fromCharCode(65 + i);\n});\nvar NUMBERS = Array.from({\n  length: 50\n}, function (_, i) {\n  return i + 1;\n});\nexport default function WarehouseMapModal(_ref) {\n  var _ref$show = _ref.show,\n      show = _ref$show === void 0 ? false : _ref$show,\n      _ref$onHide = _ref.onHide,\n      onHide = _ref$onHide === void 0 ? function () {} : _ref$onHide,\n      onView = _ref.onView,\n      onSelectionChange = _ref.onSelectionChange,\n      _ref$initialSelection = _ref.initialSelection,\n      initialSelection = _ref$initialSelection === void 0 ? {} : _ref$initialSelection;\n\n  var _useState = useState([]),\n      regionOptions = _useState[0],\n      setRegionOptions = _useState[1];\n\n  var _useState2 = useState({}),\n      sectionMap = _useState2[0],\n      setSectionMap = _useState2[1];\n\n  var _useState3 = useState(\"regions\"),\n      mapStep = _useState3[0],\n      setMapStep = _useState3[1];\n\n  var _useState4 = useState(\"\"),\n      mapRegion = _useState4[0],\n      setMapRegion = _useState4[1];\n\n  var _useState5 = useState(\"\"),\n      mapRow = _useState5[0],\n      setMapRow = _useState5[1];\n\n  var _useState6 = useState(\"\"),\n      mapCol = _useState6[0],\n      setMapCol = _useState6[1];\n\n  var _useState7 = useState(\"\"),\n      mapPallet = _useState7[0],\n      setMapPallet = _useState7[1];\n\n  var _useState8 = useState(\"\"),\n      mapBin = _useState8[0],\n      setMapBin = _useState8[1];\n\n  var _useState9 = useState({}),\n      mapCellPallets = _useState9[0],\n      setMapCellPallets = _useState9[1];\n\n  var _useState10 = useState({}),\n      mapPalletBins = _useState10[0],\n      setMapPalletBins = _useState10[1];\n\n  var _useState11 = useState(false),\n      mapLoading = _useState11[0],\n      setMapLoading = _useState11[1];\n\n  var _useState12 = useState(\"\"),\n      mapError = _useState12[0],\n      setMapError = _useState12[1];\n\n  var _useState13 = useState(false),\n      directoryLoaded = _useState13[0],\n      setDirectoryLoaded = _useState13[1];\n\n  var lastShowRef = useRef(false);\n  var notifySelectionChange = useCallback(function (selection) {\n    if (typeof onSelectionChange === \"function\") {\n      onSelectionChange(selection);\n    }\n  }, [onSelectionChange]);\n  var loadDirectory = useCallback( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n    var doc, data;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (!directoryLoaded) {\n              _context.next = 2;\n              break;\n            }\n\n            return _context.abrupt(\"return\");\n\n          case 2:\n            _context.prev = 2;\n            _context.next = 5;\n            return firebase.firestore().collection(\"Warehouse\").doc(\"directory\").get();\n\n          case 5:\n            doc = _context.sent;\n            data = doc.data() || {};\n            setRegionOptions(data.Region || []);\n            setSectionMap(data.Section || {});\n            setDirectoryLoaded(true);\n            _context.next = 16;\n            break;\n\n          case 12:\n            _context.prev = 12;\n            _context.t0 = _context[\"catch\"](2);\n            console.error(\"Failed to load map directory\", _context.t0);\n            setMapError(\"Failed to load warehouse directory.\");\n\n          case 16:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[2, 12]]);\n  })), [directoryLoaded]);\n  var loadRegionInventory = useCallback( /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(regionId) {\n      var snap, cellPallets, palletBins, cellObj, palletObj;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (regionId) {\n                _context2.next = 2;\n                break;\n              }\n\n              return _context2.abrupt(\"return\");\n\n            case 2:\n              setMapLoading(true);\n              setMapError(\"\");\n              _context2.prev = 4;\n              _context2.next = 7;\n              return firebase.firestore().collection(\"Test\").where(\"newLocalCurrent.region\", \"==\", regionId).get();\n\n            case 7:\n              snap = _context2.sent;\n              cellPallets = {};\n              palletBins = {};\n              snap.forEach(function (doc) {\n                var _doc$data, _loc$section, _loc$section2;\n\n                var loc = ((_doc$data = doc.data()) === null || _doc$data === void 0 ? void 0 : _doc$data.newLocalCurrent) || {};\n                var row = (_loc$section = loc.section) === null || _loc$section === void 0 ? void 0 : _loc$section.letter;\n                var col = (_loc$section2 = loc.section) === null || _loc$section2 === void 0 ? void 0 : _loc$section2.number;\n\n                if ((!row || !col) && typeof loc.section === \"string\") {\n                  var trimmed = loc.section.trim();\n                  row = trimmed.slice(0, 1);\n                  col = trimmed.slice(1);\n                }\n\n                if (col !== undefined && col !== null) {\n                  col = String(col);\n                }\n\n                var pallet = loc.pallet;\n                var bin = loc.bin;\n                if (!row || !col) return;\n                var cellKey = \"\".concat(row, \"-\").concat(col);\n                var hasBin = bin !== undefined && bin !== null && \"\".concat(bin) !== \"\";\n                var hasPallet = pallet !== undefined && pallet !== null && \"\".concat(pallet) !== \"\";\n                if (!hasPallet && !hasBin) return;\n                var palletId = hasPallet ? String(pallet) : NO_PALLET;\n                if (!cellPallets[cellKey]) cellPallets[cellKey] = new Set();\n                cellPallets[cellKey].add(palletId);\n\n                if (hasBin) {\n                  var palletKey = \"\".concat(cellKey, \"-P\").concat(palletId);\n                  if (!palletBins[palletKey]) palletBins[palletKey] = new Set();\n                  palletBins[palletKey].add(String(bin));\n                }\n              });\n              cellObj = {};\n              Object.keys(cellPallets).forEach(function (key) {\n                cellObj[key] = Array.from(cellPallets[key]).sort(function (a, b) {\n                  if (a === NO_PALLET) return 1;\n                  if (b === NO_PALLET) return -1;\n                  var na = Number(a);\n                  var nb = Number(b);\n                  if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;\n                  return String(a).localeCompare(String(b));\n                });\n              });\n              palletObj = {};\n              Object.keys(palletBins).forEach(function (key) {\n                palletObj[key] = Array.from(palletBins[key]).sort(function (a, b) {\n                  return Number(a) - Number(b);\n                });\n              });\n              setMapCellPallets(cellObj);\n              setMapPalletBins(palletObj);\n              _context2.next = 23;\n              break;\n\n            case 19:\n              _context2.prev = 19;\n              _context2.t0 = _context2[\"catch\"](4);\n              console.error(\"Failed to load map inventory\", _context2.t0);\n              setMapError(\"Failed to load map inventory.\");\n\n            case 23:\n              _context2.prev = 23;\n              setMapLoading(false);\n              return _context2.finish(23);\n\n            case 26:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[4, 19, 23, 26]]);\n    }));\n\n    return function (_x) {\n      return _ref3.apply(this, arguments);\n    };\n  }(), []);\n  var getRegionDimensions = useCallback(function (regionId) {\n    var entry = sectionMap === null || sectionMap === void 0 ? void 0 : sectionMap[regionId];\n\n    if (Array.isArray(entry) && entry.length >= 2) {\n      var cols = parseInt(entry[0], 10);\n      var rows = parseInt(entry[1], 10);\n      return {\n        cols: Number.isFinite(cols) ? cols : 0,\n        rows: Number.isFinite(rows) ? rows : 0\n      };\n    }\n\n    return {\n      cols: 0,\n      rows: 0\n    };\n  }, [sectionMap]);\n  useEffect(function () {\n    var wasOpen = lastShowRef.current;\n    lastShowRef.current = show;\n    if (!show || wasOpen) return;\n    loadDirectory();\n    setMapError(\"\");\n\n    var _ref4 = initialSelection || {},\n        region = _ref4.region,\n        sectionLetter = _ref4.sectionLetter,\n        sectionNumber = _ref4.sectionNumber,\n        pallet = _ref4.pallet,\n        bin = _ref4.bin;\n\n    setMapRegion(region || \"\");\n    setMapRow(sectionLetter || \"\");\n    setMapCol(sectionNumber ? String(sectionNumber) : \"\");\n    setMapPallet(pallet ? String(pallet) : \"\");\n    setMapBin(bin ? String(bin) : \"\");\n    setMapStep(region ? \"grid\" : \"regions\");\n    if (region) loadRegionInventory(region);\n  }, [show, initialSelection, loadDirectory, loadRegionInventory]);\n\n  var handleSelectRegion = function handleSelectRegion(regionId) {\n    var selection = {\n      region: regionId,\n      sectionLetter: \"\",\n      sectionNumber: \"\",\n      pallet: \"\",\n      bin: \"\"\n    };\n    setMapRegion(regionId);\n    setMapRow(\"\");\n    setMapCol(\"\");\n    setMapPallet(\"\");\n    setMapBin(\"\");\n    setMapStep(\"grid\");\n    notifySelectionChange(selection);\n    loadRegionInventory(regionId);\n  };\n\n  var handleSelectCell = function handleSelectCell(rowLetter, colNumber) {\n    var colValue = String(colNumber);\n    var selection = {\n      region: mapRegion,\n      sectionLetter: rowLetter,\n      sectionNumber: colValue,\n      pallet: \"\",\n      bin: \"\"\n    };\n    setMapRow(rowLetter);\n    setMapCol(colValue);\n    setMapPallet(\"\");\n    setMapBin(\"\");\n    setMapStep(\"pallets\");\n    notifySelectionChange(selection);\n  };\n\n  var handleSelectPallet = function handleSelectPallet(palletId) {\n    var palletValue = String(palletId);\n    var normalizedPallet = palletValue === NO_PALLET ? \"\" : palletValue;\n    var selection = {\n      region: mapRegion,\n      sectionLetter: mapRow,\n      sectionNumber: mapCol,\n      pallet: normalizedPallet,\n      bin: \"\"\n    };\n    setMapPallet(palletValue);\n    setMapBin(\"\");\n    setMapStep(\"bins\");\n    notifySelectionChange(selection);\n  };\n\n  var handleSelectBin = function handleSelectBin(binId) {\n    var binValue = String(binId);\n    var normalizedPallet = mapPallet === NO_PALLET ? \"\" : mapPallet;\n    var selection = {\n      region: mapRegion,\n      sectionLetter: mapRow,\n      sectionNumber: mapCol,\n      pallet: normalizedPallet,\n      bin: binValue\n    };\n    setMapBin(binValue);\n    notifySelectionChange(selection);\n  };\n\n  var handleBack = function handleBack() {\n    if (mapStep === \"bins\") setMapStep(\"pallets\");else if (mapStep === \"pallets\") setMapStep(\"grid\");else if (mapStep === \"grid\") setMapStep(\"regions\");\n  };\n\n  var handleView = function handleView() {\n    if (typeof onView !== \"function\") return;\n    var normalizedPallet = mapPallet === NO_PALLET ? \"\" : mapPallet;\n    onView({\n      region: mapRegion,\n      sectionLetter: mapRow,\n      sectionNumber: mapCol,\n      pallet: normalizedPallet,\n      bin: mapBin\n    });\n  };\n\n  return __jsx(Modal, {\n    show: show,\n    onHide: onHide,\n    centered: true,\n    size: \"lg\"\n  }, __jsx(Modal.Header, {\n    closeButton: true\n  }, __jsx(Modal.Title, null, \"Warehouse Map\")), __jsx(Modal.Body, null, mapLoading && __jsx(\"div\", {\n    className: styles.mapLoading\n  }, __jsx(Spinner, {\n    animation: \"border\"\n  }), __jsx(\"span\", null, \"Loading map data...\")), mapError && __jsx(\"div\", {\n    className: styles.mapError\n  }, mapError), !mapLoading && mapStep === \"regions\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Select a region\"), __jsx(\"div\", {\n    className: styles.mapCanvas\n  }, REGION_ORDER.map(function (regionId) {\n    return __jsx(\"button\", {\n      key: regionId,\n      type: \"button\",\n      className: \"\".concat(styles.regionBlock, \" \").concat(styles[\"region\".concat(regionId)]),\n      onClick: function onClick() {\n        return handleSelectRegion(regionId);\n      },\n      disabled: Array.isArray(regionOptions) && regionOptions.length > 0 && !regionOptions.includes(regionId)\n    }, regionId);\n  }))), !mapLoading && mapStep === \"grid\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Region \", mapRegion, \": choose a row and column\"), function () {\n    var dims = getRegionDimensions(mapRegion);\n    var rows = LETTERS.slice(0, dims.rows || 0).reverse();\n    var cols = NUMBERS.slice(0, dims.cols || 0);\n\n    if (!rows.length || !cols.length) {\n      var sectionKeys = Object.keys(mapCellPallets || {}).filter(Boolean).map(function (key) {\n        var _key$split = key.split(\"-\"),\n            _key$split2 = _slicedToArray(_key$split, 2),\n            row = _key$split2[0],\n            col = _key$split2[1];\n\n        return {\n          key: key,\n          row: row,\n          col: col\n        };\n      }).sort(function (a, b) {\n        if (a.row === b.row) {\n          return Number(a.col) - Number(b.col);\n        }\n\n        return b.row.localeCompare(a.row);\n      });\n\n      if (!sectionKeys.length) {\n        return __jsx(\"div\", {\n          className: styles.mapEmpty\n        }, \"No grid data for this region.\");\n      }\n\n      return __jsx(\"div\", {\n        className: styles.gridWrapper\n      }, __jsx(\"div\", {\n        className: styles.mapHint\n      }, \"Grid not available. Select an available section below.\"), __jsx(\"div\", {\n        className: styles.palletGrid\n      }, sectionKeys.map(function (_ref5) {\n        var key = _ref5.key,\n            row = _ref5.row,\n            col = _ref5.col;\n        return __jsx(\"button\", {\n          key: key,\n          type: \"button\",\n          className: styles.palletButton,\n          onClick: function onClick() {\n            return handleSelectCell(row, col);\n          }\n        }, row, col);\n      })));\n    }\n\n    return __jsx(\"div\", {\n      className: styles.gridWrapper\n    }, __jsx(\"div\", {\n      className: styles.grid,\n      style: {\n        \"--grid-cols\": cols.length\n      }\n    }, rows.map(function (row) {\n      return cols.map(function (col) {\n        var _mapCellPallets$cellK;\n\n        var cellKey = \"\".concat(row, \"-\").concat(col);\n        var hasPallets = Boolean((_mapCellPallets$cellK = mapCellPallets[cellKey]) === null || _mapCellPallets$cellK === void 0 ? void 0 : _mapCellPallets$cellK.length);\n        return __jsx(\"button\", {\n          key: cellKey,\n          type: \"button\",\n          className: \"\".concat(styles.gridCell, \" \").concat(hasPallets ? \"\" : styles.gridCellDisabled),\n          onClick: function onClick() {\n            return hasPallets && handleSelectCell(row, col);\n          },\n          disabled: !hasPallets\n        }, __jsx(\"span\", null, row, col));\n      });\n    })));\n  }()), !mapLoading && mapStep === \"pallets\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Region \", mapRegion, \" - Section \", mapRow, mapCol, \": select a pallet\"), __jsx(\"div\", {\n    className: styles.palletGrid\n  }, (mapCellPallets[\"\".concat(mapRow, \"-\").concat(mapCol)] || []).map(function (pallet) {\n    var palletKey = \"\".concat(mapRow, \"-\").concat(mapCol, \"-P\").concat(pallet);\n    var bins = mapPalletBins[palletKey] || [];\n    return __jsx(\"button\", {\n      key: pallet,\n      type: \"button\",\n      className: styles.palletButton,\n      onClick: function onClick() {\n        if (bins.length === 0 && typeof onView === \"function\") {\n          var selection = {\n            region: mapRegion,\n            sectionLetter: mapRow,\n            sectionNumber: mapCol,\n            pallet: pallet === NO_PALLET ? \"\" : String(pallet),\n            bin: \"\"\n          };\n          notifySelectionChange(selection);\n          onView(selection);\n          return;\n        }\n\n        handleSelectPallet(pallet);\n      }\n    }, pallet === NO_PALLET ? \"No Pallet\" : \"Pallet \".concat(pallet));\n  }), !(mapCellPallets[\"\".concat(mapRow, \"-\").concat(mapCol)] || []).length && __jsx(\"div\", {\n    className: styles.mapEmpty\n  }, \"No pallets available here.\"))), !mapLoading && mapStep === \"bins\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Region \", mapRegion, \" - Section \", mapRow, mapCol, \" - Pallet \", mapPallet), __jsx(\"div\", {\n    className: styles.palletGrid\n  }, (mapPalletBins[\"\".concat(mapRow, \"-\").concat(mapCol, \"-P\").concat(mapPallet)] || []).map(function (bin) {\n    return __jsx(\"button\", {\n      key: bin,\n      type: \"button\",\n      className: \"\".concat(styles.palletButton, \" \").concat(styles.binButton),\n      onClick: function onClick() {\n        return handleSelectBin(bin);\n      }\n    }, \"Bin \", bin);\n  }), !(mapPalletBins[\"\".concat(mapRow, \"-\").concat(mapCol, \"-P\").concat(mapPallet)] || []).length && __jsx(\"div\", {\n    className: styles.mapEmpty\n  }, \"No bins available on this pallet.\")))), __jsx(Modal.Footer, {\n    className: styles.mapFooter\n  }, __jsx(Button, {\n    variant: \"outline-secondary\",\n    onClick: handleBack,\n    disabled: mapStep === \"regions\"\n  }, \"Back\"), __jsx(Button, {\n    variant: \"outline-primary\",\n    onClick: handleView\n  }, \"View\"), __jsx(Button, {\n    variant: \"secondary\",\n    onClick: onHide\n  }, \"Close\")));\n}","map":null,"metadata":{},"sourceType":"module"}