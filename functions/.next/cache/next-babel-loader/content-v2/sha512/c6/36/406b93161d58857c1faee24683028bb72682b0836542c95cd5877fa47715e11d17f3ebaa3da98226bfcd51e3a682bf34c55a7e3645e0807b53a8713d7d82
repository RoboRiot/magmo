{"ast":null,"code":"import firebase from \"../context/Firebase\";\nconst OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nconst MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nconst DEFAULT_OEM_FIELD = \"oems\";\n\nconst isPlainObject = value => value != null && typeof value === \"object\" && !Array.isArray(value) && !(value instanceof Date);\n\nconst normalizeArray = value => {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nconst normalizeList = values => {\n  const out = [];\n  (values || []).forEach(value => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst pickModelField = obj => {\n  if (!isPlainObject(obj)) return null;\n\n  for (const key of MODEL_FIELD_CANDIDATES) {\n    if (Array.isArray(obj[key])) return key;\n  }\n\n  const arrayKey = Object.keys(obj).find(key => Array.isArray(obj[key]));\n  return arrayKey || null;\n};\n\nconst extractModels = value => {\n  if (Array.isArray(value)) {\n    return {\n      models: normalizeList(value),\n      modelField: null\n    };\n  }\n\n  if (isPlainObject(value)) {\n    const modelField = pickModelField(value);\n    const models = modelField ? normalizeList(value[modelField]) : [];\n    return {\n      models,\n      modelField\n    };\n  }\n\n  if (value != null && value !== \"\") {\n    return {\n      models: normalizeList([value]),\n      modelField: null\n    };\n  }\n\n  return {\n    models: [],\n    modelField: null\n  };\n};\n\nconst extractOemMap = data => {\n  const oemMap = {};\n  const modelFieldByOem = {};\n  let oemField = null;\n\n  for (const key of OEM_FIELD_CANDIDATES) {\n    if (isPlainObject(data === null || data === void 0 ? void 0 : data[key])) {\n      oemField = key;\n      Object.entries(data[key]).forEach(([oem, value]) => {\n        const {\n          models,\n          modelField\n        } = extractModels(value);\n        oemMap[oem] = normalizeList([...(oemMap[oem] || []), ...models]);\n\n        if (modelField) {\n          modelFieldByOem[oem] = modelField;\n        }\n      });\n    }\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(([key, value]) => {\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n\n      if (isPlainObject(value) || Array.isArray(value)) {\n        const {\n          models,\n          modelField\n        } = extractModels(value);\n\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([...(oemMap[key] || []), ...models]);\n\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return {\n    oemMap,\n    oemField,\n    modelFieldByOem\n  };\n};\n\nexport async function fetchTrackerCatalog() {\n  const db = firebase.firestore();\n  const snap = await db.collection(\"Tracker\").get();\n  const modalities = [];\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n  const meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {}\n  };\n  snap.forEach(doc => {\n    const modality = doc.id;\n    const data = doc.data() || {};\n    const {\n      oemMap,\n      oemField,\n      modelFieldByOem\n    } = extractOemMap(data);\n    modalities.push(modality);\n    meta.oemFieldByModality[modality] = oemField;\n    meta.modelFieldByModalityOem[modality] = modelFieldByOem || {};\n    const oems = Object.keys(oemMap);\n    oemsByModality[modality] = oems;\n    modelsByModalityOem[modality] = {};\n    oems.forEach(oem => {\n      modelsByModalityOem[modality][oem] = normalizeList(oemMap[oem]);\n    });\n  });\n  return {\n    modalities: normalizeList(modalities),\n    oemsByModality,\n    modelsByModalityOem,\n    meta\n  };\n}\nexport function buildAllOems(catalog) {\n  const set = new Set();\n  Object.values((catalog === null || catalog === void 0 ? void 0 : catalog.oemsByModality) || {}).forEach(oems => {\n    (oems || []).forEach(oem => set.add(oem));\n  });\n  return Array.from(set);\n}\nexport function buildModelsForSelection(catalog, modalities = [], oems = []) {\n  const modelSet = new Set();\n  const modals = normalizeList(modalities);\n  const oemList = normalizeList(oems);\n  modals.forEach(modality => {\n    var _catalog$modelsByModa;\n\n    const oemMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa = catalog.modelsByModalityOem) === null || _catalog$modelsByModa === void 0 ? void 0 : _catalog$modelsByModa[modality]) || {};\n    oemList.forEach(oem => {\n      const models = (oemMap === null || oemMap === void 0 ? void 0 : oemMap[oem]) || [];\n      models.forEach(model => modelSet.add(model));\n    });\n  });\n  return Array.from(modelSet);\n}\nexport async function syncTrackerFromSelections({\n  selections,\n  catalog\n}) {\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const selectedModalities = normalizeList((selections === null || selections === void 0 ? void 0 : selections.modalities) || []);\n  const selectedOems = normalizeList((selections === null || selections === void 0 ? void 0 : selections.oems) || []);\n  const selectedModels = normalizeList((selections === null || selections === void 0 ? void 0 : selections.models) || []);\n  if (!selectedModalities.length) return false;\n  const ops = [];\n\n  for (const modality of selectedModalities) {\n    var _catalog$oemsByModali, _catalog$meta, _catalog$meta$oemFiel, _catalog$modalities, _catalog$modalities$i;\n\n    const docRef = trackerRef.doc(modality);\n    const existingOems = new Set((catalog === null || catalog === void 0 ? void 0 : (_catalog$oemsByModali = catalog.oemsByModality) === null || _catalog$oemsByModali === void 0 ? void 0 : _catalog$oemsByModali[modality]) || []);\n    const oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta = catalog.meta) === null || _catalog$meta === void 0 ? void 0 : (_catalog$meta$oemFiel = _catalog$meta.oemFieldByModality) === null || _catalog$meta$oemFiel === void 0 ? void 0 : _catalog$meta$oemFiel[modality]) || DEFAULT_OEM_FIELD;\n\n    if (!(catalog !== null && catalog !== void 0 && (_catalog$modalities = catalog.modalities) !== null && _catalog$modalities !== void 0 && (_catalog$modalities$i = _catalog$modalities.includes) !== null && _catalog$modalities$i !== void 0 && _catalog$modalities$i.call(_catalog$modalities, modality))) {\n      ops.push(docRef.set({\n        [DEFAULT_OEM_FIELD]: {}\n      }, {\n        merge: true\n      }));\n    }\n\n    for (const oem of selectedOems) {\n      if (!existingOems.has(oem)) {\n        ops.push(docRef.set({\n          [oemField]: {\n            [oem]: []\n          }\n        }, {\n          merge: true\n        }));\n      }\n    }\n\n    for (const oem of selectedOems) {\n      var _catalog$modelsByModa2, _catalog$modelsByModa3, _catalog$meta2, _catalog$meta2$modelF, _catalog$meta2$modelF2;\n\n      const knownModels = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa2 = catalog.modelsByModalityOem) === null || _catalog$modelsByModa2 === void 0 ? void 0 : (_catalog$modelsByModa3 = _catalog$modelsByModa2[modality]) === null || _catalog$modelsByModa3 === void 0 ? void 0 : _catalog$modelsByModa3[oem]) || [];\n      const knownSet = new Set(knownModels);\n      const modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta2 = catalog.meta) === null || _catalog$meta2 === void 0 ? void 0 : (_catalog$meta2$modelF = _catalog$meta2.modelFieldByModalityOem) === null || _catalog$meta2$modelF === void 0 ? void 0 : (_catalog$meta2$modelF2 = _catalog$meta2$modelF[modality]) === null || _catalog$meta2$modelF2 === void 0 ? void 0 : _catalog$meta2$modelF2[oem]) || null;\n\n      for (const model of selectedModels) {\n        if (knownSet.has(model)) continue;\n        const path = modelField ? `${oemField}.${oem}.${modelField}` : `${oemField}.${oem}`;\n        ops.push(docRef.update({\n          [path]: firebase.firestore.FieldValue.arrayUnion(model)\n        }));\n      }\n    }\n  }\n\n  if (ops.length) {\n    await Promise.allSettled(ops);\n    return true;\n  }\n\n  return false;\n}\nexport async function deleteTrackerOem({\n  oem,\n  catalog\n}) {\n  if (!oem) return;\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const modalities = (catalog === null || catalog === void 0 ? void 0 : catalog.modalities) || [];\n  const ops = modalities.map(modality => {\n    var _catalog$meta3, _catalog$meta3$oemFie, _catalog$meta4, _catalog$meta4$oemFie;\n\n    const oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta3 = catalog.meta) === null || _catalog$meta3 === void 0 ? void 0 : (_catalog$meta3$oemFie = _catalog$meta3.oemFieldByModality) === null || _catalog$meta3$oemFie === void 0 ? void 0 : _catalog$meta3$oemFie[modality]) || DEFAULT_OEM_FIELD;\n    const docRef = trackerRef.doc(modality);\n    const update = {\n      [`${oemField}.${oem}`]: firebase.firestore.FieldValue.delete()\n    };\n\n    if (!(catalog !== null && catalog !== void 0 && (_catalog$meta4 = catalog.meta) !== null && _catalog$meta4 !== void 0 && (_catalog$meta4$oemFie = _catalog$meta4.oemFieldByModality) !== null && _catalog$meta4$oemFie !== void 0 && _catalog$meta4$oemFie[modality])) {\n      update[oem] = firebase.firestore.FieldValue.delete();\n    }\n\n    return docRef.update(update).catch(() => null);\n  });\n  await Promise.allSettled(ops);\n}\nexport async function deleteTrackerModel({\n  modality,\n  oem,\n  model,\n  catalog\n}) {\n  var _catalog$meta5, _catalog$meta5$oemFie, _catalog$meta6, _catalog$meta6$modelF, _catalog$meta6$modelF2;\n\n  if (!modality || !oem || !model) return;\n  const db = firebase.firestore();\n  const docRef = db.collection(\"Tracker\").doc(modality);\n  const oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta5 = catalog.meta) === null || _catalog$meta5 === void 0 ? void 0 : (_catalog$meta5$oemFie = _catalog$meta5.oemFieldByModality) === null || _catalog$meta5$oemFie === void 0 ? void 0 : _catalog$meta5$oemFie[modality]) || DEFAULT_OEM_FIELD;\n  const modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta6 = catalog.meta) === null || _catalog$meta6 === void 0 ? void 0 : (_catalog$meta6$modelF = _catalog$meta6.modelFieldByModalityOem) === null || _catalog$meta6$modelF === void 0 ? void 0 : (_catalog$meta6$modelF2 = _catalog$meta6$modelF[modality]) === null || _catalog$meta6$modelF2 === void 0 ? void 0 : _catalog$meta6$modelF2[oem]) || null;\n  const path = modelField ? `${oemField}.${oem}.${modelField}` : `${oemField}.${oem}`;\n  await docRef.update({\n    [path]: firebase.firestore.FieldValue.arrayRemove(model)\n  });\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/utils/trackerCatalog.js"],"names":["firebase","OEM_FIELD_CANDIDATES","MODEL_FIELD_CANDIDATES","DEFAULT_OEM_FIELD","isPlainObject","value","Array","isArray","Date","normalizeArray","normalizeList","values","out","forEach","normalized","String","trim","push","from","Set","pickModelField","obj","key","arrayKey","Object","keys","find","extractModels","models","modelField","extractOemMap","data","oemMap","modelFieldByOem","oemField","entries","oem","startsWith","length","fetchTrackerCatalog","db","firestore","snap","collection","get","modalities","oemsByModality","modelsByModalityOem","meta","oemFieldByModality","modelFieldByModalityOem","doc","modality","id","oems","buildAllOems","catalog","set","add","buildModelsForSelection","modelSet","modals","oemList","model","syncTrackerFromSelections","selections","trackerRef","selectedModalities","selectedOems","selectedModels","ops","docRef","existingOems","includes","merge","has","knownModels","knownSet","path","update","FieldValue","arrayUnion","Promise","allSettled","deleteTrackerOem","map","delete","catch","deleteTrackerModel","arrayRemove"],"mappings":"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","sourcesContent":["import firebase from \"../context/Firebase\";\n\nconst OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nconst MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nconst DEFAULT_OEM_FIELD = \"oems\";\n\nconst isPlainObject = (value) =>\n  value != null &&\n  typeof value === \"object\" &&\n  !Array.isArray(value) &&\n  !(value instanceof Date);\n\nconst normalizeArray = (value) => {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nconst normalizeList = (values) => {\n  const out = [];\n  (values || []).forEach((value) => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst pickModelField = (obj) => {\n  if (!isPlainObject(obj)) return null;\n  for (const key of MODEL_FIELD_CANDIDATES) {\n    if (Array.isArray(obj[key])) return key;\n  }\n  const arrayKey = Object.keys(obj).find((key) => Array.isArray(obj[key]));\n  return arrayKey || null;\n};\n\nconst extractModels = (value) => {\n  if (Array.isArray(value)) {\n    return { models: normalizeList(value), modelField: null };\n  }\n  if (isPlainObject(value)) {\n    const modelField = pickModelField(value);\n    const models = modelField ? normalizeList(value[modelField]) : [];\n    return { models, modelField };\n  }\n  if (value != null && value !== \"\") {\n    return { models: normalizeList([value]), modelField: null };\n  }\n  return { models: [], modelField: null };\n};\n\nconst extractOemMap = (data) => {\n  const oemMap = {};\n  const modelFieldByOem = {};\n  let oemField = null;\n\n  for (const key of OEM_FIELD_CANDIDATES) {\n    if (isPlainObject(data?.[key])) {\n      oemField = key;\n      Object.entries(data[key]).forEach(([oem, value]) => {\n        const { models, modelField } = extractModels(value);\n        oemMap[oem] = normalizeList([...(oemMap[oem] || []), ...models]);\n        if (modelField) {\n          modelFieldByOem[oem] = modelField;\n        }\n      });\n    }\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(([key, value]) => {\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n      if (isPlainObject(value) || Array.isArray(value)) {\n        const { models, modelField } = extractModels(value);\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([...(oemMap[key] || []), ...models]);\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return { oemMap, oemField, modelFieldByOem };\n};\n\nexport async function fetchTrackerCatalog() {\n  const db = firebase.firestore();\n  const snap = await db.collection(\"Tracker\").get();\n\n  const modalities = [];\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n  const meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n  };\n\n  snap.forEach((doc) => {\n    const modality = doc.id;\n    const data = doc.data() || {};\n    const { oemMap, oemField, modelFieldByOem } = extractOemMap(data);\n\n    modalities.push(modality);\n    meta.oemFieldByModality[modality] = oemField;\n    meta.modelFieldByModalityOem[modality] = modelFieldByOem || {};\n\n    const oems = Object.keys(oemMap);\n    oemsByModality[modality] = oems;\n    modelsByModalityOem[modality] = {};\n    oems.forEach((oem) => {\n      modelsByModalityOem[modality][oem] = normalizeList(oemMap[oem]);\n    });\n  });\n\n  return {\n    modalities: normalizeList(modalities),\n    oemsByModality,\n    modelsByModalityOem,\n    meta,\n  };\n}\n\nexport function buildAllOems(catalog) {\n  const set = new Set();\n  Object.values(catalog?.oemsByModality || {}).forEach((oems) => {\n    (oems || []).forEach((oem) => set.add(oem));\n  });\n  return Array.from(set);\n}\n\nexport function buildModelsForSelection(catalog, modalities = [], oems = []) {\n  const modelSet = new Set();\n  const modals = normalizeList(modalities);\n  const oemList = normalizeList(oems);\n  modals.forEach((modality) => {\n    const oemMap = catalog?.modelsByModalityOem?.[modality] || {};\n    oemList.forEach((oem) => {\n      const models = oemMap?.[oem] || [];\n      models.forEach((model) => modelSet.add(model));\n    });\n  });\n  return Array.from(modelSet);\n}\n\nexport async function syncTrackerFromSelections({\n  selections,\n  catalog,\n}) {\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const selectedModalities = normalizeList(selections?.modalities || []);\n  const selectedOems = normalizeList(selections?.oems || []);\n  const selectedModels = normalizeList(selections?.models || []);\n\n  if (!selectedModalities.length) return false;\n\n  const ops = [];\n\n  for (const modality of selectedModalities) {\n    const docRef = trackerRef.doc(modality);\n    const existingOems = new Set(catalog?.oemsByModality?.[modality] || []);\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[modality] || DEFAULT_OEM_FIELD;\n\n    if (!catalog?.modalities?.includes?.(modality)) {\n      ops.push(docRef.set({ [DEFAULT_OEM_FIELD]: {} }, { merge: true }));\n    }\n\n    for (const oem of selectedOems) {\n      if (!existingOems.has(oem)) {\n        ops.push(\n          docRef.set({ [oemField]: { [oem]: [] } }, { merge: true })\n        );\n      }\n    }\n\n    for (const oem of selectedOems) {\n      const knownModels =\n        catalog?.modelsByModalityOem?.[modality]?.[oem] || [];\n      const knownSet = new Set(knownModels);\n      const modelField =\n        catalog?.meta?.modelFieldByModalityOem?.[modality]?.[oem] || null;\n      for (const model of selectedModels) {\n        if (knownSet.has(model)) continue;\n        const path = modelField\n          ? `${oemField}.${oem}.${modelField}`\n          : `${oemField}.${oem}`;\n        ops.push(\n          docRef.update({\n            [path]: firebase.firestore.FieldValue.arrayUnion(model),\n          })\n        );\n      }\n    }\n  }\n\n  if (ops.length) {\n    await Promise.allSettled(ops);\n    return true;\n  }\n  return false;\n}\n\nexport async function deleteTrackerOem({ oem, catalog }) {\n  if (!oem) return;\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const modalities = catalog?.modalities || [];\n  const ops = modalities.map((modality) => {\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[modality] || DEFAULT_OEM_FIELD;\n    const docRef = trackerRef.doc(modality);\n    const update = {\n      [`${oemField}.${oem}`]: firebase.firestore.FieldValue.delete(),\n    };\n    if (!catalog?.meta?.oemFieldByModality?.[modality]) {\n      update[oem] = firebase.firestore.FieldValue.delete();\n    }\n    return docRef.update(update).catch(() => null);\n  });\n  await Promise.allSettled(ops);\n}\n\nexport async function deleteTrackerModel({\n  modality,\n  oem,\n  model,\n  catalog,\n}) {\n  if (!modality || !oem || !model) return;\n  const db = firebase.firestore();\n  const docRef = db.collection(\"Tracker\").doc(modality);\n  const oemField =\n    catalog?.meta?.oemFieldByModality?.[modality] || DEFAULT_OEM_FIELD;\n  const modelField =\n    catalog?.meta?.modelFieldByModalityOem?.[modality]?.[oem] || null;\n  const path = modelField\n    ? `${oemField}.${oem}.${modelField}`\n    : `${oemField}.${oem}`;\n  await docRef.update({\n    [path]: firebase.firestore.FieldValue.arrayRemove(model),\n  });\n}\n"]},"metadata":{},"sourceType":"module"}