{"ast":null,"code":"import { adminDb } from \"../../../context/FirebaseAdmin\";\n\nconst normalizeList = values => {\n  const out = [];\n  (values || []).forEach(value => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst extractModelsFromDoc = (data, docId, options = {}) => {\n  const {\n    allowDocIdFallback = true\n  } = options;\n  if (!data) return allowDocIdFallback && docId ? [docId] : [];\n  if (Array.isArray(data.models)) return normalizeList(data.models);\n  if (Array.isArray(data.model)) return normalizeList(data.model);\n  if (Array.isArray(data.items)) return normalizeList(data.items);\n  if (typeof data.model === \"string\") return normalizeList([data.model]);\n  if (typeof data.name === \"string\") return normalizeList([data.name]);\n  if (allowDocIdFallback && docId) return normalizeList([docId]);\n  return [];\n};\n\nconst extractOemsFromFields = data => {\n  const out = {};\n  if (!data) return out;\n  const oemsField = data.oems || data.OEMs || data.oem || data.OEM;\n\n  if (Array.isArray(oemsField)) {\n    oemsField.forEach(entry => {\n      if (entry == null) return;\n\n      if (typeof entry === \"string\") {\n        out[entry] = out[entry] || [];\n        return;\n      }\n\n      if (typeof entry === \"object\") {\n        const name = entry.name || entry.oem || entry.OEM || entry.label || entry.value;\n        if (!name) return;\n        const models = extractModelsFromDoc(entry);\n        out[name] = normalizeList([...(out[name] || []), ...models]);\n      }\n    });\n    return out;\n  }\n\n  if (oemsField && typeof oemsField === \"object\") {\n    Object.entries(oemsField).forEach(([oem, value]) => {\n      if (value == null) return;\n\n      if (Array.isArray(value)) {\n        out[oem] = normalizeList(value);\n        return;\n      }\n\n      if (typeof value === \"object\") {\n        const models = extractModelsFromDoc(value);\n        out[oem] = normalizeList([...(out[oem] || []), ...models]);\n        return;\n      }\n\n      out[oem] = normalizeList([...(out[oem] || []), String(value).trim()]);\n    });\n  }\n\n  return out;\n};\n\nconst mergeModels = (modelsByOem, oem, incoming) => {\n  const current = modelsByOem[oem] || [];\n  modelsByOem[oem] = normalizeList([...(current || []), ...(incoming || [])]);\n};\n\nconst mergeModalityData = (targetOemsByModality, targetModelsByModalityOem, modality, modelsByOem) => {\n  if (!modality) return;\n  const oems = Object.keys(modelsByOem || {});\n\n  if (!targetModelsByModalityOem[modality]) {\n    targetModelsByModalityOem[modality] = {};\n  }\n\n  if (!targetOemsByModality[modality]) {\n    targetOemsByModality[modality] = [];\n  }\n\n  const nextOems = new Set(targetOemsByModality[modality] || []);\n  oems.forEach(oem => {\n    nextOems.add(oem);\n    mergeModels(targetModelsByModalityOem[modality], oem, modelsByOem[oem] || []);\n  });\n  targetOemsByModality[modality] = Array.from(nextOems);\n};\n\nconst readModelsFromOemSubcollection = async collectionRef => {\n  const modelSet = new Set();\n  const snap = await collectionRef.get();\n  snap.forEach(doc => {\n    const models = extractModelsFromDoc(doc.data(), doc.id);\n    models.forEach(model => modelSet.add(model));\n  });\n  return Array.from(modelSet);\n};\n\nconst readModalityFromDocumentRef = async docRef => {\n  const docSnap = await docRef.get();\n  const data = docSnap.exists ? docSnap.data() || {} : {};\n  const modelsByOem = {};\n  const fieldOems = extractOemsFromFields(data);\n  Object.entries(fieldOems).forEach(([oem, models]) => {\n    mergeModels(modelsByOem, oem, models || []);\n  });\n  const subcollections = await docRef.listCollections();\n\n  for (const sub of subcollections) {\n    const oem = sub.id;\n    const models = await readModelsFromOemSubcollection(sub);\n    mergeModels(modelsByOem, oem, models);\n  }\n\n  return {\n    modelsByOem,\n    subcollections\n  };\n};\n\nconst readModalityFromCollectionRef = async collectionRef => {\n  const modelsByOem = {};\n  const snap = await collectionRef.get();\n\n  for (const oemDoc of snap.docs) {\n    const oem = oemDoc.id;\n    const models = extractModelsFromDoc(oemDoc.data(), oemDoc.id, {\n      allowDocIdFallback: false\n    });\n    mergeModels(modelsByOem, oem, models);\n    const nested = await oemDoc.ref.listCollections();\n\n    for (const nestedCol of nested) {\n      const nestedModels = await readModelsFromOemSubcollection(nestedCol);\n      mergeModels(modelsByOem, oem, nestedModels);\n    }\n  }\n\n  return modelsByOem;\n};\n\nexport default async function handler(req, res) {\n  res.setHeader(\"Cache-Control\", \"no-store\");\n\n  if (!adminDb) {\n    res.status(503).json({\n      error: \"Firebase Admin not available.\"\n    });\n    return;\n  }\n\n  try {\n    const modalityRefs = await adminDb.collection(\"Tracker\").listDocuments();\n    const modalitySet = new Set();\n    const oemsByModality = {};\n    const modelsByModalityOem = {};\n    let usesSubcollections = false;\n\n    for (const ref of modalityRefs) {\n      const modality = ref.id;\n      const {\n        modelsByOem,\n        subcollections\n      } = await readModalityFromDocumentRef(ref);\n      if (subcollections.length) usesSubcollections = true;\n      modalitySet.add(modality);\n      mergeModalityData(oemsByModality, modelsByModalityOem, modality, modelsByOem); // Some datasets use a \"container\" document under Tracker, where each\n      // modality is stored as a subcollection of that doc.\n\n      const hasDirectModels = Object.keys(modelsByOem).length > 0;\n\n      if (!hasDirectModels && subcollections.length) {\n        for (const modalityCollection of subcollections) {\n          const nestedModality = modalityCollection.id;\n          const nestedModelsByOem = await readModalityFromCollectionRef(modalityCollection);\n          modalitySet.add(nestedModality);\n          mergeModalityData(oemsByModality, modelsByModalityOem, nestedModality, nestedModelsByOem);\n        }\n      }\n    }\n\n    const modalities = Array.from(modalitySet);\n    res.status(200).json({\n      modalities,\n      oemsByModality,\n      modelsByModalityOem,\n      usesSubcollections,\n      source: \"server\"\n    });\n  } catch (error) {\n    console.error(\"Tracker catalog API failed:\", error);\n    res.status(500).json({\n      error: \"Failed to build tracker catalog.\"\n    });\n  }\n}","map":null,"metadata":{},"sourceType":"module"}