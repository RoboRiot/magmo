{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\mack2\\\\Desktop\\\\code\\\\pages\\\\index.js\";\nvar __jsx = React.createElement;\n// pages/index.js\nimport Head from \"next/head\";\nimport React, { useState, useEffect, useRef } from \"react\";\nimport { Button, Alert } from \"react-bootstrap\";\nimport styles from \"../styles/Login.module.css\";\nimport { useRouter } from \"next/router\";\nimport firebase from \"../context/Firebase\"; // compat default export ONLY\n\nexport default function Home() {\n  const router = useRouter();\n  const {\n    0: error,\n    1: setError\n  } = useState(\"\");\n  const {\n    0: hasMounted,\n    1: setHasMounted\n  } = useState(false);\n  const {\n    0: authReady,\n    1: setAuthReady\n  } = useState(false);\n  const unsubRef = useRef(null);\n  const persistenceModeRef = useRef(\"unknown\");\n\n  const getDestination = () => {\n    var _router$query;\n\n    const q = router === null || router === void 0 ? void 0 : (_router$query = router.query) === null || _router$query === void 0 ? void 0 : _router$query.redirect;\n    return Array.isArray(q) ? q[0] || \"/NewSearch/mainSearch\" : q || \"/NewSearch/mainSearch\";\n  };\n\n  const isIosSafari = () => {\n    if (typeof navigator === \"undefined\") return false;\n    const ua = navigator.userAgent;\n    const isIOS = /iP(hone|ad|od)/i.test(ua);\n    const isSafari = /Safari/i.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/i.test(ua);\n    return isIOS && isSafari;\n  };\n\n  useEffect(() => setHasMounted(true), []);\n\n  const ensurePersistence = async () => {\n    try {\n      await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);\n      persistenceModeRef.current = \"local\";\n      return \"local\";\n    } catch (error) {\n      console.warn(\"[auth] LOCAL persistence failed, falling back to SESSION\", error);\n\n      try {\n        await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);\n        persistenceModeRef.current = \"session\";\n        return \"session\";\n      } catch (innerError) {\n        console.warn(\"[auth] SESSION persistence failed\", innerError);\n        persistenceModeRef.current = \"none\";\n        return \"none\";\n      }\n    }\n  }; // One-time auth listener\n\n\n  useEffect(() => {\n    if (!hasMounted) return;\n\n    (async () => {\n      try {\n        await ensurePersistence(); // simple storage probe to detect hostile environments\n\n        try {\n          localStorage.setItem(\"__magmo_probe\", \"1\");\n        } catch (e) {\n          console.warn(\"[auth] localStorage not available; redirects may fail\");\n        }\n\n        try {\n          const redirectResult = await firebase.auth().getRedirectResult();\n\n          if (redirectResult && redirectResult.user) {\n            const dest = getDestination();\n            router.replace(dest);\n            return;\n          }\n        } catch (redirectError) {\n          console.error(\"[auth] redirect result error:\", redirectError);\n          setError(\"Google sign-in failed. Please try again.\");\n        }\n\n        try {\n          const hadAttempt = localStorage.getItem(\"__magmo_signin_attempt\");\n\n          if (hadAttempt) {\n            localStorage.removeItem(\"__magmo_signin_attempt\");\n            setTimeout(() => {\n              const user = firebase.auth().currentUser;\n\n              if (!user) {\n                setError(\"Google sign-in did not complete in Safari. Please allow cookies or try again.\");\n              }\n            }, 1500);\n          }\n        } catch (_) {}\n\n        unsubRef.current = firebase.auth().onAuthStateChanged(user => {\n          console.log(\"[auth] onAuthStateChanged:\", user);\n          setAuthReady(true);\n\n          if (user) {\n            const dest = getDestination();\n            router.replace(dest);\n          }\n        });\n      } catch (e) {\n        console.error(\"[auth] persistence setup error:\", e);\n        setError(\"Authentication init failed.\");\n      } finally {\n        setAuthReady(true);\n      }\n    })();\n\n    return () => {\n      if (unsubRef.current) unsubRef.current();\n    };\n  }, [hasMounted, router]);\n  if (!hasMounted) return null;\n\n  const handleGoogleSignIn = async () => {\n    setError(\"\");\n\n    try {\n      await ensurePersistence();\n      const provider = new firebase.auth.GoogleAuthProvider();\n      provider.addScope(\"email\");\n      provider.addScope(\"profile\");\n      provider.setCustomParameters({\n        prompt: \"select_account\"\n      });\n      console.log(\"[auth] Using popup\");\n\n      try {\n        const result = await firebase.auth().signInWithPopup(provider);\n        console.log(\"[auth] popup result:\", result && result.user); // onAuthStateChanged will route; but we can route immediately too:\n\n        if (result && result.user) {\n          const dest = getDestination();\n          router.replace(dest);\n        }\n      } catch (popupError) {\n        if (isIosSafari() && ((popupError === null || popupError === void 0 ? void 0 : popupError.code) === \"auth/popup-blocked\" || (popupError === null || popupError === void 0 ? void 0 : popupError.code) === \"auth/popup-closed-by-user\" || (popupError === null || popupError === void 0 ? void 0 : popupError.code) === \"auth/operation-not-supported-in-this-environment\")) {\n          setError(\"Safari blocked the sign-in popup. Please allow popups and try again.\");\n          return;\n        }\n\n        throw popupError;\n      }\n    } catch (err) {\n      console.error(\"[auth] sign-in error:\", err);\n\n      if ((err === null || err === void 0 ? void 0 : err.code) === \"auth/unauthorized-domain\") {\n        setError(\"This domain is not authorized for Google sign-in. Add magmo.cloud in Firebase Auth > Settings > Authorized domains.\");\n      } else {\n        setError(\"Failed to log in with Google: \" + (err && err.message ? err.message : String(err)));\n      }\n    }\n  };\n\n  const handleTestLogin = async () => {\n    setError(\"\");\n    const password = prompt(\"Enter password:\");\n    if (!password) return;\n\n    try {\n      await firebase.auth().signInWithEmailAndPassword(\"test@test.com\", password);\n      router.replace(\"/NewSearch/searchTest\");\n    } catch (err) {\n      setError(\"Test login failed: \" + (err && err.message ? err.message : String(err)));\n    }\n  };\n\n  return __jsx(\"div\", {\n    className: styles.page,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 171,\n      columnNumber: 5\n    }\n  }, __jsx(Head, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 172,\n      columnNumber: 7\n    }\n  }, __jsx(\"title\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 173,\n      columnNumber: 9\n    }\n  }, \"magmo\"), __jsx(\"link\", {\n    rel: \"icon\",\n    href: \"/favicon.ico\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 174,\n      columnNumber: 9\n    }\n  }), __jsx(\"meta\", {\n    name: \"viewport\",\n    content: \"width=device-width, initial-scale=1.0\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 175,\n      columnNumber: 9\n    }\n  })), __jsx(\"div\", {\n    className: styles.shell,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 178,\n      columnNumber: 7\n    }\n  }, __jsx(\"div\", {\n    className: styles.card,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 179,\n      columnNumber: 9\n    }\n  }, __jsx(\"img\", {\n    src: \"/magmo.png\",\n    alt: \"Magmo Logo\",\n    className: styles.logo,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 180,\n      columnNumber: 11\n    }\n  }), __jsx(\"div\", {\n    className: styles.cardTitle,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 181,\n      columnNumber: 11\n    }\n  }, \"Welcome back\"), !authReady && __jsx(\"div\", {\n    className: styles.status,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 13\n    }\n  }, \"Initializing\\u2026\"), error && __jsx(Alert, {\n    variant: \"danger\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 186,\n      columnNumber: 21\n    }\n  }, error), __jsx(Button, {\n    variant: \"light\",\n    className: styles.googleButton,\n    onClick: handleGoogleSignIn,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 188,\n      columnNumber: 11\n    }\n  }, __jsx(\"span\", {\n    className: styles.googleIcon,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 193,\n      columnNumber: 13\n    }\n  }, __jsx(\"img\", {\n    src: \"https://www.svgrepo.com/show/355037/google.svg\",\n    alt: \"Google logo\",\n    width: \"20\",\n    height: \"20\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 194,\n      columnNumber: 15\n    }\n  })), \"Continue with Google\"), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: styles.testButton,\n    onClick: handleTestLogin,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 204,\n      columnNumber: 11\n    }\n  }, \"Test\"))));\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/pages/index.js"],"names":["Head","React","useState","useEffect","useRef","Button","Alert","styles","useRouter","firebase","Home","router","error","setError","hasMounted","setHasMounted","authReady","setAuthReady","unsubRef","persistenceModeRef","getDestination","q","query","redirect","Array","isArray","isIosSafari","navigator","ua","userAgent","isIOS","test","isSafari","ensurePersistence","auth","setPersistence","Auth","Persistence","LOCAL","current","console","warn","SESSION","innerError","localStorage","setItem","e","redirectResult","getRedirectResult","user","dest","replace","redirectError","hadAttempt","getItem","removeItem","setTimeout","currentUser","_","onAuthStateChanged","log","handleGoogleSignIn","provider","GoogleAuthProvider","addScope","setCustomParameters","prompt","result","signInWithPopup","popupError","code","err","message","String","handleTestLogin","password","signInWithEmailAndPassword","page","shell","card","logo","cardTitle","status","googleButton","googleIcon","testButton"],"mappings":"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","sourcesContent":["// pages/index.js\nimport Head from \"next/head\";\nimport React, { useState, useEffect, useRef } from \"react\";\nimport { Button, Alert } from \"react-bootstrap\";\nimport styles from \"../styles/Login.module.css\";\nimport { useRouter } from \"next/router\";\nimport firebase from \"../context/Firebase\"; // compat default export ONLY\n\nexport default function Home() {\n  const router = useRouter();\n  const [error, setError] = useState(\"\");\n  const [hasMounted, setHasMounted] = useState(false);\n  const [authReady, setAuthReady] = useState(false);\n  const unsubRef = useRef(null);\n  const persistenceModeRef = useRef(\"unknown\");\n\n  const getDestination = () => {\n    const q = router?.query?.redirect;\n    return Array.isArray(q) ? q[0] || \"/NewSearch/mainSearch\" : (q || \"/NewSearch/mainSearch\");\n  };\n\n  const isIosSafari = () => {\n    if (typeof navigator === \"undefined\") return false;\n    const ua = navigator.userAgent;\n    const isIOS = /iP(hone|ad|od)/i.test(ua);\n    const isSafari = /Safari/i.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/i.test(ua);\n    return isIOS && isSafari;\n  };\n\n  useEffect(() => setHasMounted(true), []);\n\n  const ensurePersistence = async () => {\n    try {\n      await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);\n      persistenceModeRef.current = \"local\";\n      return \"local\";\n    } catch (error) {\n      console.warn(\"[auth] LOCAL persistence failed, falling back to SESSION\", error);\n      try {\n        await firebase.auth().setPersistence(\n          firebase.auth.Auth.Persistence.SESSION\n        );\n        persistenceModeRef.current = \"session\";\n        return \"session\";\n      } catch (innerError) {\n        console.warn(\"[auth] SESSION persistence failed\", innerError);\n        persistenceModeRef.current = \"none\";\n        return \"none\";\n      }\n    }\n  };\n\n  // One-time auth listener\n  useEffect(() => {\n    if (!hasMounted) return;\n    (async () => {\n      try {\n        await ensurePersistence();\n        // simple storage probe to detect hostile environments\n        try {\n          localStorage.setItem(\"__magmo_probe\", \"1\");\n        } catch (e) {\n          console.warn(\"[auth] localStorage not available; redirects may fail\");\n        }\n\n        try {\n          const redirectResult = await firebase.auth().getRedirectResult();\n          if (redirectResult && redirectResult.user) {\n            const dest = getDestination();\n            router.replace(dest);\n            return;\n          }\n        } catch (redirectError) {\n          console.error(\"[auth] redirect result error:\", redirectError);\n          setError(\n            \"Google sign-in failed. Please try again.\"\n          );\n        }\n\n        try {\n          const hadAttempt = localStorage.getItem(\"__magmo_signin_attempt\");\n          if (hadAttempt) {\n            localStorage.removeItem(\"__magmo_signin_attempt\");\n            setTimeout(() => {\n              const user = firebase.auth().currentUser;\n              if (!user) {\n                setError(\n                  \"Google sign-in did not complete in Safari. Please allow cookies or try again.\"\n                );\n              }\n            }, 1500);\n          }\n        } catch (_) {}\n\n        unsubRef.current = firebase.auth().onAuthStateChanged((user) => {\n          console.log(\"[auth] onAuthStateChanged:\", user);\n          setAuthReady(true);\n          if (user) {\n            const dest = getDestination();\n            router.replace(dest);\n          }\n        });\n      } catch (e) {\n        console.error(\"[auth] persistence setup error:\", e);\n        setError(\"Authentication init failed.\");\n      } finally {\n        setAuthReady(true);\n      }\n    })();\n\n    return () => {\n      if (unsubRef.current) unsubRef.current();\n    };\n  }, [hasMounted, router]);\n\n  if (!hasMounted) return null;\n\n  const handleGoogleSignIn = async () => {\n    setError(\"\");\n    try {\n      await ensurePersistence();\n      const provider = new firebase.auth.GoogleAuthProvider();\n      provider.addScope(\"email\");\n      provider.addScope(\"profile\");\n      provider.setCustomParameters({ prompt: \"select_account\" });\n\n      console.log(\"[auth] Using popup\");\n      try {\n        const result = await firebase.auth().signInWithPopup(provider);\n        console.log(\"[auth] popup result:\", result && result.user);\n        // onAuthStateChanged will route; but we can route immediately too:\n        if (result && result.user) {\n          const dest = getDestination();\n          router.replace(dest);\n        }\n      } catch (popupError) {\n        if (\n          isIosSafari() &&\n          (popupError?.code === \"auth/popup-blocked\" ||\n            popupError?.code === \"auth/popup-closed-by-user\" ||\n            popupError?.code === \"auth/operation-not-supported-in-this-environment\")\n        ) {\n          setError(\"Safari blocked the sign-in popup. Please allow popups and try again.\");\n          return;\n        }\n        throw popupError;\n      }\n    } catch (err) {\n      console.error(\"[auth] sign-in error:\", err);\n      if (err?.code === \"auth/unauthorized-domain\") {\n        setError(\"This domain is not authorized for Google sign-in. Add magmo.cloud in Firebase Auth > Settings > Authorized domains.\");\n      } else {\n        setError(\"Failed to log in with Google: \" + (err && err.message ? err.message : String(err)));\n      }\n    }\n  };\n\n  const handleTestLogin = async () => {\n    setError(\"\");\n    const password = prompt(\"Enter password:\");\n    if (!password) return;\n    try {\n      await firebase.auth().signInWithEmailAndPassword(\"test@test.com\", password);\n      router.replace(\"/NewSearch/searchTest\");\n    } catch (err) {\n      setError(\"Test login failed: \" + (err && err.message ? err.message : String(err)));\n    }\n  };\n\n  return (\n    <div className={styles.page}>\n      <Head>\n        <title>magmo</title>\n        <link rel=\"icon\" href=\"/favicon.ico\" />\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n      </Head>\n\n      <div className={styles.shell}>\n        <div className={styles.card}>\n          <img src=\"/magmo.png\" alt=\"Magmo Logo\" className={styles.logo} />\n          <div className={styles.cardTitle}>Welcome back</div>\n\n          {!authReady && (\n            <div className={styles.status}>Initializingâ€¦</div>\n          )}\n          {error && <Alert variant=\"danger\">{error}</Alert>}\n\n          <Button\n            variant=\"light\"\n            className={styles.googleButton}\n            onClick={handleGoogleSignIn}\n          >\n            <span className={styles.googleIcon}>\n              <img\n                src=\"https://www.svgrepo.com/show/355037/google.svg\"\n                alt=\"Google logo\"\n                width=\"20\"\n                height=\"20\"\n              />\n            </span>\n            Continue with Google\n          </Button>\n\n          <Button\n            variant=\"outline-secondary\"\n            className={styles.testButton}\n            onClick={handleTestLogin}\n          >\n            Test\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\r\n"]},"metadata":{},"sourceType":"module"}