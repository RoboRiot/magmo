{"ast":null,"code":"import { adminDb } from \"../../../context/FirebaseAdmin\";\n\nconst normalizeKey = value => {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nconst normalizeList = values => {\n  const out = [];\n  (values || []).forEach(value => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst extractModelsFromDoc = (data, docId) => {\n  if (!data) return docId ? [docId] : [];\n  if (Array.isArray(data.models)) return normalizeList(data.models);\n  if (Array.isArray(data.model)) return normalizeList(data.model);\n  if (Array.isArray(data.items)) return normalizeList(data.items);\n  if (typeof data.model === \"string\") return normalizeList([data.model]);\n  if (typeof data.name === \"string\") return normalizeList([data.name]);\n  if (docId) return normalizeList([docId]);\n  return [];\n};\n\nconst extractOemsFromFields = data => {\n  const out = {};\n  if (!data) return out;\n  const oemsField = data.oems || data.OEMs || data.oem || data.OEM;\n\n  if (Array.isArray(oemsField)) {\n    oemsField.forEach(entry => {\n      if (entry == null) return;\n\n      if (typeof entry === \"string\") {\n        out[entry] = out[entry] || [];\n        return;\n      }\n\n      if (typeof entry === \"object\") {\n        const name = entry.name || entry.oem || entry.OEM || entry.label || entry.value;\n        if (!name) return;\n        const models = extractModelsFromDoc(entry);\n        out[name] = normalizeList([...(out[name] || []), ...models]);\n      }\n    });\n    return out;\n  }\n\n  if (oemsField && typeof oemsField === \"object\") {\n    Object.entries(oemsField).forEach(([oem, value]) => {\n      if (value == null) return;\n\n      if (Array.isArray(value)) {\n        out[oem] = normalizeList(value);\n        return;\n      }\n\n      if (typeof value === \"object\") {\n        const models = extractModelsFromDoc(value);\n        out[oem] = normalizeList([...(out[oem] || []), ...models]);\n        return;\n      }\n\n      out[oem] = normalizeList([...(out[oem] || []), String(value).trim()]);\n    });\n  }\n\n  return out;\n};\n\nexport default async function handler(req, res) {\n  res.setHeader(\"Cache-Control\", \"no-store\");\n\n  if (!adminDb) {\n    res.status(503).json({\n      error: \"Firebase Admin not available.\"\n    });\n    return;\n  }\n\n  try {\n    const modalityRefs = await adminDb.collection(\"Tracker\").listDocuments();\n    const modalities = modalityRefs.map(ref => ref.id);\n    const oemsByModality = {};\n    const modelsByModalityOem = {};\n    let usesSubcollections = false;\n\n    for (const ref of modalityRefs) {\n      const modality = ref.id;\n      const docSnap = await ref.get();\n      const data = docSnap.exists ? docSnap.data() || {} : {};\n      const oems = new Set();\n      const modelsByOem = {};\n      const fieldOems = extractOemsFromFields(data);\n      Object.entries(fieldOems).forEach(([oem, models]) => {\n        oems.add(oem);\n        modelsByOem[oem] = normalizeList([...(modelsByOem[oem] || []), ...models]);\n      });\n      const subcollections = await ref.listCollections();\n      if (subcollections.length) usesSubcollections = true;\n\n      for (const sub of subcollections) {\n        const oem = sub.id;\n        oems.add(oem);\n        const modelSet = new Set(modelsByOem[oem] || []);\n        const subSnap = await sub.get();\n        subSnap.forEach(subDoc => {\n          const models = extractModelsFromDoc(subDoc.data(), subDoc.id);\n          models.forEach(model => modelSet.add(model));\n        });\n        modelsByOem[oem] = Array.from(modelSet);\n      }\n\n      oemsByModality[modality] = Array.from(oems);\n      modelsByModalityOem[modality] = modelsByOem;\n    }\n\n    res.status(200).json({\n      modalities,\n      oemsByModality,\n      modelsByModalityOem,\n      usesSubcollections,\n      source: \"server\"\n    });\n  } catch (error) {\n    console.error(\"Tracker catalog API failed:\", error);\n    res.status(500).json({\n      error: \"Failed to build tracker catalog.\"\n    });\n  }\n}","map":{"version":3,"sources":["C:/Users/isavc/OneDrive/Documents/AIS/Apps/magmo/pages/api/tracker/catalog.js"],"names":["adminDb","normalizeKey","value","String","trim","toLowerCase","normalizeList","values","out","forEach","normalized","push","Array","from","Set","extractModelsFromDoc","data","docId","isArray","models","model","items","name","extractOemsFromFields","oemsField","oems","OEMs","oem","OEM","entry","label","Object","entries","handler","req","res","setHeader","status","json","error","modalityRefs","collection","listDocuments","modalities","map","ref","id","oemsByModality","modelsByModalityOem","usesSubcollections","modality","docSnap","get","exists","modelsByOem","fieldOems","add","subcollections","listCollections","length","sub","modelSet","subSnap","subDoc","source","console"],"mappings":"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","sourcesContent":["import { adminDb } from \"../../../context/FirebaseAdmin\";\r\n\r\nconst normalizeKey = (value) => {\r\n  if (value == null) return \"\";\r\n  return String(value).trim().toLowerCase();\r\n};\r\n\r\nconst normalizeList = (values) => {\r\n  const out = [];\r\n  (values || []).forEach((value) => {\r\n    if (value == null) return;\r\n    const normalized = String(value).trim();\r\n    if (!normalized) return;\r\n    out.push(normalized);\r\n  });\r\n  return Array.from(new Set(out));\r\n};\r\n\r\nconst extractModelsFromDoc = (data, docId) => {\r\n  if (!data) return docId ? [docId] : [];\r\n  if (Array.isArray(data.models)) return normalizeList(data.models);\r\n  if (Array.isArray(data.model)) return normalizeList(data.model);\r\n  if (Array.isArray(data.items)) return normalizeList(data.items);\r\n  if (typeof data.model === \"string\") return normalizeList([data.model]);\r\n  if (typeof data.name === \"string\") return normalizeList([data.name]);\r\n  if (docId) return normalizeList([docId]);\r\n  return [];\r\n};\r\n\r\nconst extractOemsFromFields = (data) => {\r\n  const out = {};\r\n  if (!data) return out;\r\n  const oemsField = data.oems || data.OEMs || data.oem || data.OEM;\r\n\r\n  if (Array.isArray(oemsField)) {\r\n    oemsField.forEach((entry) => {\r\n      if (entry == null) return;\r\n      if (typeof entry === \"string\") {\r\n        out[entry] = out[entry] || [];\r\n        return;\r\n      }\r\n      if (typeof entry === \"object\") {\r\n        const name =\r\n          entry.name ||\r\n          entry.oem ||\r\n          entry.OEM ||\r\n          entry.label ||\r\n          entry.value;\r\n        if (!name) return;\r\n        const models = extractModelsFromDoc(entry);\r\n        out[name] = normalizeList([...(out[name] || []), ...models]);\r\n      }\r\n    });\r\n    return out;\r\n  }\r\n\r\n  if (oemsField && typeof oemsField === \"object\") {\r\n    Object.entries(oemsField).forEach(([oem, value]) => {\r\n      if (value == null) return;\r\n      if (Array.isArray(value)) {\r\n        out[oem] = normalizeList(value);\r\n        return;\r\n      }\r\n      if (typeof value === \"object\") {\r\n        const models = extractModelsFromDoc(value);\r\n        out[oem] = normalizeList([...(out[oem] || []), ...models]);\r\n        return;\r\n      }\r\n      out[oem] = normalizeList([...(out[oem] || []), String(value).trim()]);\r\n    });\r\n  }\r\n\r\n  return out;\r\n};\r\n\r\nexport default async function handler(req, res) {\r\n  res.setHeader(\"Cache-Control\", \"no-store\");\r\n  if (!adminDb) {\r\n    res.status(503).json({ error: \"Firebase Admin not available.\" });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const modalityRefs = await adminDb.collection(\"Tracker\").listDocuments();\r\n    const modalities = modalityRefs.map((ref) => ref.id);\r\n    const oemsByModality = {};\r\n    const modelsByModalityOem = {};\r\n    let usesSubcollections = false;\r\n\r\n    for (const ref of modalityRefs) {\r\n      const modality = ref.id;\r\n      const docSnap = await ref.get();\r\n      const data = docSnap.exists ? docSnap.data() || {} : {};\r\n\r\n      const oems = new Set();\r\n      const modelsByOem = {};\r\n\r\n      const fieldOems = extractOemsFromFields(data);\r\n      Object.entries(fieldOems).forEach(([oem, models]) => {\r\n        oems.add(oem);\r\n        modelsByOem[oem] = normalizeList([\r\n          ...(modelsByOem[oem] || []),\r\n          ...models,\r\n        ]);\r\n      });\r\n\r\n      const subcollections = await ref.listCollections();\r\n      if (subcollections.length) usesSubcollections = true;\r\n      for (const sub of subcollections) {\r\n        const oem = sub.id;\r\n        oems.add(oem);\r\n        const modelSet = new Set(modelsByOem[oem] || []);\r\n        const subSnap = await sub.get();\r\n        subSnap.forEach((subDoc) => {\r\n          const models = extractModelsFromDoc(subDoc.data(), subDoc.id);\r\n          models.forEach((model) => modelSet.add(model));\r\n        });\r\n        modelsByOem[oem] = Array.from(modelSet);\r\n      }\r\n\r\n      oemsByModality[modality] = Array.from(oems);\r\n      modelsByModalityOem[modality] = modelsByOem;\r\n    }\r\n\r\n    res.status(200).json({\r\n      modalities,\r\n      oemsByModality,\r\n      modelsByModalityOem,\r\n      usesSubcollections,\r\n      source: \"server\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Tracker catalog API failed:\", error);\r\n    res.status(500).json({ error: \"Failed to build tracker catalog.\" });\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}