{"ast":null,"code":"var __jsx = React.createElement;\nimport React, { useCallback, useEffect, useRef, useState } from \"react\";\nimport { Modal, Button, Spinner } from \"react-bootstrap\";\nimport firebase from \"../context/Firebase\";\nimport styles from \"./WarehouseMapModal.module.css\";\nconst REGION_ORDER = [\"E\", \"F\", \"G\", \"H\", \"I\", \"A\", \"D\", \"C\", \"B\"];\nconst NO_PALLET = \"NoPallet\";\nconst LETTERS = Array.from({\n  length: 26\n}, (_, i) => String.fromCharCode(65 + i));\nconst NUMBERS = Array.from({\n  length: 50\n}, (_, i) => i + 1);\nexport default function WarehouseMapModal({\n  show = false,\n  onHide = () => {},\n  onView,\n  onSelectionChange,\n  initialSelection = {}\n}) {\n  const {\n    0: regionOptions,\n    1: setRegionOptions\n  } = useState([]);\n  const {\n    0: sectionMap,\n    1: setSectionMap\n  } = useState({});\n  const {\n    0: mapStep,\n    1: setMapStep\n  } = useState(\"regions\");\n  const {\n    0: mapRegion,\n    1: setMapRegion\n  } = useState(\"\");\n  const {\n    0: mapRow,\n    1: setMapRow\n  } = useState(\"\");\n  const {\n    0: mapCol,\n    1: setMapCol\n  } = useState(\"\");\n  const {\n    0: mapPallet,\n    1: setMapPallet\n  } = useState(\"\");\n  const {\n    0: mapBin,\n    1: setMapBin\n  } = useState(\"\");\n  const {\n    0: mapCellPallets,\n    1: setMapCellPallets\n  } = useState({});\n  const {\n    0: mapPalletBins,\n    1: setMapPalletBins\n  } = useState({});\n  const {\n    0: mapLoading,\n    1: setMapLoading\n  } = useState(false);\n  const {\n    0: mapError,\n    1: setMapError\n  } = useState(\"\");\n  const {\n    0: directoryLoaded,\n    1: setDirectoryLoaded\n  } = useState(false);\n  const lastShowRef = useRef(false);\n  const notifySelectionChange = useCallback(selection => {\n    if (typeof onSelectionChange === \"function\") {\n      onSelectionChange(selection);\n    }\n  }, [onSelectionChange]);\n  const loadDirectory = useCallback(async () => {\n    if (directoryLoaded) return;\n\n    try {\n      const doc = await firebase.firestore().collection(\"Warehouse\").doc(\"directory\").get();\n      const data = doc.data() || {};\n      setRegionOptions(data.Region || []);\n      setSectionMap(data.Section || {});\n      setDirectoryLoaded(true);\n    } catch (error) {\n      console.error(\"Failed to load map directory\", error);\n      setMapError(\"Failed to load warehouse directory.\");\n    }\n  }, [directoryLoaded]);\n  const loadRegionInventory = useCallback(async regionId => {\n    if (!regionId) return;\n    setMapLoading(true);\n    setMapError(\"\");\n\n    try {\n      const snap = await firebase.firestore().collection(\"Test\").where(\"newLocalCurrent.region\", \"==\", regionId).get();\n      const cellPallets = {};\n      const palletBins = {};\n      snap.forEach(doc => {\n        var _doc$data, _loc$section, _loc$section2;\n\n        const loc = ((_doc$data = doc.data()) === null || _doc$data === void 0 ? void 0 : _doc$data.newLocalCurrent) || {};\n        let row = (_loc$section = loc.section) === null || _loc$section === void 0 ? void 0 : _loc$section.letter;\n        let col = (_loc$section2 = loc.section) === null || _loc$section2 === void 0 ? void 0 : _loc$section2.number;\n\n        if ((!row || !col) && typeof loc.section === \"string\") {\n          const trimmed = loc.section.trim();\n          row = trimmed.slice(0, 1);\n          col = trimmed.slice(1);\n        }\n\n        if (col !== undefined && col !== null) {\n          col = String(col);\n        }\n\n        const pallet = loc.pallet;\n        const bin = loc.bin;\n        if (!row || !col) return;\n        const cellKey = `${row}-${col}`;\n        const hasBin = bin !== undefined && bin !== null && `${bin}` !== \"\";\n        const hasPallet = pallet !== undefined && pallet !== null && `${pallet}` !== \"\";\n        if (!hasPallet && !hasBin) return;\n        const palletId = hasPallet ? String(pallet) : NO_PALLET;\n        if (!cellPallets[cellKey]) cellPallets[cellKey] = new Set();\n        cellPallets[cellKey].add(palletId);\n\n        if (hasBin) {\n          const palletKey = `${cellKey}-P${palletId}`;\n          if (!palletBins[palletKey]) palletBins[palletKey] = new Set();\n          palletBins[palletKey].add(String(bin));\n        }\n      });\n      const cellObj = {};\n      Object.keys(cellPallets).forEach(key => {\n        cellObj[key] = Array.from(cellPallets[key]).sort((a, b) => {\n          if (a === NO_PALLET) return 1;\n          if (b === NO_PALLET) return -1;\n          const na = Number(a);\n          const nb = Number(b);\n          if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;\n          return String(a).localeCompare(String(b));\n        });\n      });\n      const palletObj = {};\n      Object.keys(palletBins).forEach(key => {\n        palletObj[key] = Array.from(palletBins[key]).sort((a, b) => Number(a) - Number(b));\n      });\n      setMapCellPallets(cellObj);\n      setMapPalletBins(palletObj);\n    } catch (error) {\n      console.error(\"Failed to load map inventory\", error);\n      setMapError(\"Failed to load map inventory.\");\n    } finally {\n      setMapLoading(false);\n    }\n  }, []);\n  const getRegionDimensions = useCallback(regionId => {\n    const entry = sectionMap === null || sectionMap === void 0 ? void 0 : sectionMap[regionId];\n\n    if (Array.isArray(entry) && entry.length >= 2) {\n      const cols = parseInt(entry[0], 10);\n      const rows = parseInt(entry[1], 10);\n      return {\n        cols: Number.isFinite(cols) ? cols : 0,\n        rows: Number.isFinite(rows) ? rows : 0\n      };\n    }\n\n    return {\n      cols: 0,\n      rows: 0\n    };\n  }, [sectionMap]);\n  useEffect(() => {\n    const wasOpen = lastShowRef.current;\n    lastShowRef.current = show;\n    if (!show || wasOpen) return;\n    loadDirectory();\n    setMapError(\"\");\n    const {\n      region,\n      sectionLetter,\n      sectionNumber,\n      pallet,\n      bin\n    } = initialSelection || {};\n    setMapRegion(region || \"\");\n    setMapRow(sectionLetter || \"\");\n    setMapCol(sectionNumber ? String(sectionNumber) : \"\");\n    setMapPallet(pallet ? String(pallet) : \"\");\n    setMapBin(bin ? String(bin) : \"\");\n    setMapStep(region ? \"grid\" : \"regions\");\n    if (region) loadRegionInventory(region);\n  }, [show, initialSelection, loadDirectory, loadRegionInventory]);\n\n  const handleSelectRegion = regionId => {\n    const selection = {\n      region: regionId,\n      sectionLetter: \"\",\n      sectionNumber: \"\",\n      pallet: \"\",\n      bin: \"\"\n    };\n    setMapRegion(regionId);\n    setMapRow(\"\");\n    setMapCol(\"\");\n    setMapPallet(\"\");\n    setMapBin(\"\");\n    setMapStep(\"grid\");\n    notifySelectionChange(selection);\n    loadRegionInventory(regionId);\n  };\n\n  const handleSelectCell = (rowLetter, colNumber) => {\n    const colValue = String(colNumber);\n    const selection = {\n      region: mapRegion,\n      sectionLetter: rowLetter,\n      sectionNumber: colValue,\n      pallet: \"\",\n      bin: \"\"\n    };\n    setMapRow(rowLetter);\n    setMapCol(colValue);\n    setMapPallet(\"\");\n    setMapBin(\"\");\n    setMapStep(\"pallets\");\n    notifySelectionChange(selection);\n  };\n\n  const handleSelectPallet = palletId => {\n    const palletValue = String(palletId);\n    const normalizedPallet = palletValue === NO_PALLET ? \"\" : palletValue;\n    const selection = {\n      region: mapRegion,\n      sectionLetter: mapRow,\n      sectionNumber: mapCol,\n      pallet: normalizedPallet,\n      bin: \"\"\n    };\n    setMapPallet(palletValue);\n    setMapBin(\"\");\n    setMapStep(\"bins\");\n    notifySelectionChange(selection);\n  };\n\n  const handleSelectBin = binId => {\n    const binValue = String(binId);\n    const normalizedPallet = mapPallet === NO_PALLET ? \"\" : mapPallet;\n    const selection = {\n      region: mapRegion,\n      sectionLetter: mapRow,\n      sectionNumber: mapCol,\n      pallet: normalizedPallet,\n      bin: binValue\n    };\n    setMapBin(binValue);\n    notifySelectionChange(selection);\n  };\n\n  const handleBack = () => {\n    if (mapStep === \"bins\") setMapStep(\"pallets\");else if (mapStep === \"pallets\") setMapStep(\"grid\");else if (mapStep === \"grid\") setMapStep(\"regions\");\n  };\n\n  const handleView = () => {\n    if (typeof onView !== \"function\") return;\n    const normalizedPallet = mapPallet === NO_PALLET ? \"\" : mapPallet;\n    onView({\n      region: mapRegion,\n      sectionLetter: mapRow,\n      sectionNumber: mapCol,\n      pallet: normalizedPallet,\n      bin: mapBin\n    });\n  };\n\n  return __jsx(Modal, {\n    show: show,\n    onHide: onHide,\n    centered: true,\n    size: \"lg\"\n  }, __jsx(Modal.Header, {\n    closeButton: true\n  }, __jsx(Modal.Title, null, \"Warehouse Map\")), __jsx(Modal.Body, null, mapLoading && __jsx(\"div\", {\n    className: styles.mapLoading\n  }, __jsx(Spinner, {\n    animation: \"border\"\n  }), __jsx(\"span\", null, \"Loading map data...\")), mapError && __jsx(\"div\", {\n    className: styles.mapError\n  }, mapError), !mapLoading && mapStep === \"regions\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Select a region\"), __jsx(\"div\", {\n    className: styles.mapCanvas\n  }, REGION_ORDER.map(regionId => __jsx(\"button\", {\n    key: regionId,\n    type: \"button\",\n    className: `${styles.regionBlock} ${styles[`region${regionId}`]}`,\n    onClick: () => handleSelectRegion(regionId),\n    disabled: Array.isArray(regionOptions) && regionOptions.length > 0 && !regionOptions.includes(regionId)\n  }, regionId)))), !mapLoading && mapStep === \"grid\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Region \", mapRegion, \": choose a row and column\"), (() => {\n    const dims = getRegionDimensions(mapRegion);\n    const rows = LETTERS.slice(0, dims.rows || 0).reverse();\n    const cols = NUMBERS.slice(0, dims.cols || 0);\n\n    if (!rows.length || !cols.length) {\n      const sectionKeys = Object.keys(mapCellPallets || {}).filter(Boolean).map(key => {\n        const [row, col] = key.split(\"-\");\n        return {\n          key,\n          row,\n          col\n        };\n      }).sort((a, b) => {\n        if (a.row === b.row) {\n          return Number(a.col) - Number(b.col);\n        }\n\n        return b.row.localeCompare(a.row);\n      });\n\n      if (!sectionKeys.length) {\n        return __jsx(\"div\", {\n          className: styles.mapEmpty\n        }, \"No grid data for this region.\");\n      }\n\n      return __jsx(\"div\", {\n        className: styles.gridWrapper\n      }, __jsx(\"div\", {\n        className: styles.mapHint\n      }, \"Grid not available. Select an available section below.\"), __jsx(\"div\", {\n        className: styles.palletGrid\n      }, sectionKeys.map(({\n        key,\n        row,\n        col\n      }) => __jsx(\"button\", {\n        key: key,\n        type: \"button\",\n        className: styles.palletButton,\n        onClick: () => handleSelectCell(row, col)\n      }, row, col))));\n    }\n\n    return __jsx(\"div\", {\n      className: styles.gridWrapper\n    }, __jsx(\"div\", {\n      className: styles.grid,\n      style: {\n        \"--grid-cols\": cols.length\n      }\n    }, rows.map(row => cols.map(col => {\n      var _mapCellPallets$cellK;\n\n      const cellKey = `${row}-${col}`;\n      const hasPallets = Boolean((_mapCellPallets$cellK = mapCellPallets[cellKey]) === null || _mapCellPallets$cellK === void 0 ? void 0 : _mapCellPallets$cellK.length);\n      return __jsx(\"button\", {\n        key: cellKey,\n        type: \"button\",\n        className: `${styles.gridCell} ${hasPallets ? \"\" : styles.gridCellDisabled}`,\n        onClick: () => hasPallets && handleSelectCell(row, col),\n        disabled: !hasPallets\n      }, __jsx(\"span\", null, row, col));\n    }))));\n  })()), !mapLoading && mapStep === \"pallets\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Region \", mapRegion, \" - Section \", mapRow, mapCol, \": select a pallet\"), __jsx(\"div\", {\n    className: styles.palletGrid\n  }, (mapCellPallets[`${mapRow}-${mapCol}`] || []).map(pallet => {\n    const palletKey = `${mapRow}-${mapCol}-P${pallet}`;\n    const bins = mapPalletBins[palletKey] || [];\n    return __jsx(\"button\", {\n      key: pallet,\n      type: \"button\",\n      className: styles.palletButton,\n      onClick: () => {\n        if (bins.length === 0 && typeof onView === \"function\") {\n          const selection = {\n            region: mapRegion,\n            sectionLetter: mapRow,\n            sectionNumber: mapCol,\n            pallet: pallet === NO_PALLET ? \"\" : String(pallet),\n            bin: \"\"\n          };\n          notifySelectionChange(selection);\n          onView(selection);\n          return;\n        }\n\n        handleSelectPallet(pallet);\n      }\n    }, pallet === NO_PALLET ? \"No Pallet\" : `Pallet ${pallet}`);\n  }), !(mapCellPallets[`${mapRow}-${mapCol}`] || []).length && __jsx(\"div\", {\n    className: styles.mapEmpty\n  }, \"No pallets available here.\"))), !mapLoading && mapStep === \"bins\" && __jsx(\"div\", {\n    className: styles.mapStage\n  }, __jsx(\"div\", {\n    className: styles.mapHint\n  }, \"Region \", mapRegion, \" - Section \", mapRow, mapCol, \" - Pallet \", mapPallet), __jsx(\"div\", {\n    className: styles.palletGrid\n  }, (mapPalletBins[`${mapRow}-${mapCol}-P${mapPallet}`] || []).map(bin => __jsx(\"button\", {\n    key: bin,\n    type: \"button\",\n    className: `${styles.palletButton} ${styles.binButton}`,\n    onClick: () => handleSelectBin(bin)\n  }, \"Bin \", bin)), !(mapPalletBins[`${mapRow}-${mapCol}-P${mapPallet}`] || []).length && __jsx(\"div\", {\n    className: styles.mapEmpty\n  }, \"No bins available on this pallet.\")))), __jsx(Modal.Footer, {\n    className: styles.mapFooter\n  }, __jsx(Button, {\n    variant: \"outline-secondary\",\n    onClick: handleBack,\n    disabled: mapStep === \"regions\"\n  }, \"Back\"), __jsx(Button, {\n    variant: \"outline-primary\",\n    onClick: handleView\n  }, \"View\"), __jsx(Button, {\n    variant: \"secondary\",\n    onClick: onHide\n  }, \"Close\")));\n}","map":null,"metadata":{},"sourceType":"module"}