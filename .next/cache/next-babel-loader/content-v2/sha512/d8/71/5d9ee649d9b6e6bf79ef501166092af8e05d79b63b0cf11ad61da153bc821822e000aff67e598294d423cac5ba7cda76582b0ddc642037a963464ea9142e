{"ast":null,"code":"import _regeneratorRuntime from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nvar __jsx = React.createElement;\n// pages/index.js\nimport Head from \"next/head\";\nimport React, { useState, useEffect, useRef } from \"react\";\nimport { Button, Alert } from \"react-bootstrap\";\nimport styles from \"../styles/Login.module.css\";\nimport { useRouter } from \"next/router\";\nimport firebase from \"../context/Firebase\"; // compat default export ONLY\n\nexport default function Home() {\n  var router = useRouter();\n\n  var _useState = useState(\"\"),\n      error = _useState[0],\n      setError = _useState[1];\n\n  var _useState2 = useState(false),\n      hasMounted = _useState2[0],\n      setHasMounted = _useState2[1];\n\n  var _useState3 = useState(false),\n      authReady = _useState3[0],\n      setAuthReady = _useState3[1];\n\n  var unsubRef = useRef(null);\n\n  var getDestination = function getDestination() {\n    var _router$query;\n\n    var q = router === null || router === void 0 ? void 0 : (_router$query = router.query) === null || _router$query === void 0 ? void 0 : _router$query.redirect;\n    return Array.isArray(q) ? q[0] || \"/NewSearch/mainSearch\" : q || \"/NewSearch/mainSearch\";\n  };\n\n  var isIosSafari = function isIosSafari() {\n    if (typeof navigator === \"undefined\") return false;\n    var ua = navigator.userAgent;\n    var isIOS = /iP(hone|ad|od)/i.test(ua);\n    var isSafari = /Safari/i.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/i.test(ua);\n    return isIOS && isSafari;\n  };\n\n  useEffect(function () {\n    return setHasMounted(true);\n  }, []);\n\n  var ensurePersistence = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.prev = 0;\n              _context.next = 3;\n              return firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);\n\n            case 3:\n              return _context.abrupt(\"return\", \"local\");\n\n            case 6:\n              _context.prev = 6;\n              _context.t0 = _context[\"catch\"](0);\n              console.warn(\"[auth] LOCAL persistence failed, falling back to SESSION\", _context.t0);\n              _context.prev = 9;\n              _context.next = 12;\n              return firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);\n\n            case 12:\n              return _context.abrupt(\"return\", \"session\");\n\n            case 15:\n              _context.prev = 15;\n              _context.t1 = _context[\"catch\"](9);\n              console.warn(\"[auth] SESSION persistence failed\", _context.t1);\n              return _context.abrupt(\"return\", \"none\");\n\n            case 19:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[0, 6], [9, 15]]);\n    }));\n\n    return function ensurePersistence() {\n      return _ref.apply(this, arguments);\n    };\n  }(); // One-time auth listener\n\n\n  useEffect(function () {\n    if (!hasMounted) return;\n\n    _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var redirectResult, dest;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              _context2.next = 3;\n              return ensurePersistence();\n\n            case 3:\n              // simple storage probe to detect hostile environments\n              try {\n                localStorage.setItem(\"__magmo_probe\", \"1\");\n              } catch (e) {\n                console.warn(\"[auth] localStorage not available; redirects may fail\");\n              }\n\n              _context2.prev = 4;\n              _context2.next = 7;\n              return firebase.auth().getRedirectResult();\n\n            case 7:\n              redirectResult = _context2.sent;\n\n              if (!(redirectResult && redirectResult.user)) {\n                _context2.next = 12;\n                break;\n              }\n\n              dest = getDestination();\n              router.replace(dest);\n              return _context2.abrupt(\"return\");\n\n            case 12:\n              _context2.next = 18;\n              break;\n\n            case 14:\n              _context2.prev = 14;\n              _context2.t0 = _context2[\"catch\"](4);\n              console.error(\"[auth] redirect result error:\", _context2.t0);\n              setError(\"Google sign-in failed. Please try again.\");\n\n            case 18:\n              unsubRef.current = firebase.auth().onAuthStateChanged(function (user) {\n                console.log(\"[auth] onAuthStateChanged:\", user);\n                setAuthReady(true);\n\n                if (user) {\n                  var _dest = getDestination();\n\n                  router.replace(_dest);\n                }\n              });\n              _context2.next = 25;\n              break;\n\n            case 21:\n              _context2.prev = 21;\n              _context2.t1 = _context2[\"catch\"](0);\n              console.error(\"[auth] persistence setup error:\", _context2.t1);\n              setError(\"Authentication init failed.\");\n\n            case 25:\n              _context2.prev = 25;\n              setAuthReady(true);\n              return _context2.finish(25);\n\n            case 28:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 21, 25, 28], [4, 14]]);\n    }))();\n\n    return function () {\n      if (unsubRef.current) unsubRef.current();\n    };\n  }, [hasMounted, router]);\n  if (!hasMounted) return null;\n\n  var handleGoogleSignIn = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var provider, result, dest;\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              setError(\"\");\n              _context3.prev = 1;\n              _context3.next = 4;\n              return ensurePersistence();\n\n            case 4:\n              provider = new firebase.auth.GoogleAuthProvider();\n              provider.addScope(\"email\");\n              provider.addScope(\"profile\");\n              provider.setCustomParameters({\n                prompt: \"select_account\"\n              }); // prefer popup (no redirect state), fallback to redirect only where needed\n\n              if (!isIosSafari()) {\n                _context3.next = 15;\n                break;\n              }\n\n              console.log(\"[auth] Using redirect (iOS Safari)\"); // mark that we attempted sign-in (to detect storage loss)\n\n              try {\n                localStorage.setItem(\"__magmo_signin_attempt\", Date.now().toString());\n              } catch (_) {}\n\n              _context3.next = 13;\n              return firebase.auth().signInWithRedirect(provider);\n\n            case 13:\n              _context3.next = 21;\n              break;\n\n            case 15:\n              console.log(\"[auth] Using popup\");\n              _context3.next = 18;\n              return firebase.auth().signInWithPopup(provider);\n\n            case 18:\n              result = _context3.sent;\n              console.log(\"[auth] popup result:\", result && result.user); // onAuthStateChanged will route; but we can route immediately too:\n\n              if (result && result.user) {\n                dest = getDestination();\n                router.replace(dest);\n              }\n\n            case 21:\n              _context3.next = 27;\n              break;\n\n            case 23:\n              _context3.prev = 23;\n              _context3.t0 = _context3[\"catch\"](1);\n              console.error(\"[auth] sign-in error:\", _context3.t0);\n              setError(\"Failed to log in with Google: \" + (_context3.t0 && _context3.t0.message ? _context3.t0.message : String(_context3.t0)));\n\n            case 27:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3, null, [[1, 23]]);\n    }));\n\n    return function handleGoogleSignIn() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var handleTestLogin = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n      var password;\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              setError(\"\");\n              password = prompt(\"Enter password:\");\n\n              if (password) {\n                _context4.next = 4;\n                break;\n              }\n\n              return _context4.abrupt(\"return\");\n\n            case 4:\n              _context4.prev = 4;\n              _context4.next = 7;\n              return firebase.auth().signInWithEmailAndPassword(\"test@test.com\", password);\n\n            case 7:\n              router.replace(\"/NewSearch/searchTest\");\n              _context4.next = 13;\n              break;\n\n            case 10:\n              _context4.prev = 10;\n              _context4.t0 = _context4[\"catch\"](4);\n              setError(\"Test login failed: \" + (_context4.t0 && _context4.t0.message ? _context4.t0.message : String(_context4.t0)));\n\n            case 13:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4, null, [[4, 10]]);\n    }));\n\n    return function handleTestLogin() {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  return __jsx(\"div\", {\n    className: styles.page\n  }, __jsx(Head, null, __jsx(\"title\", null, \"magmo\"), __jsx(\"link\", {\n    rel: \"icon\",\n    href: \"/favicon.ico\"\n  }), __jsx(\"meta\", {\n    name: \"viewport\",\n    content: \"width=device-width, initial-scale=1.0\"\n  })), __jsx(\"div\", {\n    className: styles.shell\n  }, __jsx(\"div\", {\n    className: styles.brandPanel\n  }, __jsx(\"img\", {\n    src: \"/magmo.png\",\n    alt: \"Magmo Logo\",\n    className: styles.logo\n  }), __jsx(\"div\", {\n    className: styles.brandCopy\n  }, __jsx(\"h1\", {\n    className: styles.brandTitle\n  }, \"Magmo\"), __jsx(\"p\", {\n    className: styles.brandSubtitle\n  }, \"Inventory search and item management, anywhere.\"))), __jsx(\"div\", {\n    className: styles.card\n  }, __jsx(\"div\", {\n    className: styles.cardHeader\n  }, __jsx(\"div\", {\n    className: styles.cardTitle\n  }, \"Welcome back\"), __jsx(\"div\", {\n    className: styles.cardSubtitle\n  }, \"Sign in to continue.\")), !authReady && __jsx(\"div\", {\n    className: styles.status\n  }, \"Initializing\\u2026\"), error && __jsx(Alert, {\n    variant: \"danger\"\n  }, error), __jsx(Button, {\n    variant: \"light\",\n    className: styles.googleButton,\n    onClick: handleGoogleSignIn\n  }, __jsx(\"span\", {\n    className: styles.googleIcon\n  }, __jsx(\"img\", {\n    src: \"https://www.svgrepo.com/show/355037/google.svg\",\n    alt: \"Google logo\",\n    width: \"20\",\n    height: \"20\"\n  })), \"Continue with Google\"), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: styles.testButton,\n    onClick: handleTestLogin\n  }, \"Test\"))));\n}","map":null,"metadata":{},"sourceType":"module"}