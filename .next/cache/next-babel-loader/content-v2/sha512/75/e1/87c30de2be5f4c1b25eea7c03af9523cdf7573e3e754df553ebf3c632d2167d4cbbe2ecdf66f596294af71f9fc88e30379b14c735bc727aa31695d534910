{"ast":null,"code":"import _regeneratorRuntime from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _toConsumableArray from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _slicedToArray from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _defineProperty from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/defineProperty\";\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it[\"return\"] != null) it[\"return\"](); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport firebase from \"../context/Firebase\";\nvar OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nvar MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nvar DEFAULT_OEM_FIELD = \"oems\";\nvar CATALOG_CACHE_KEY = \"trackerCatalogCache.v5\";\nvar API_FAIL_KEY = \"trackerCatalogApiFail.v1\";\nvar CACHE_TTL_MS = 6 * 60 * 60 * 1000;\nvar API_FAIL_TTL_MS = 60 * 1000;\nvar MIN_MODALITIES_FOR_CACHE = 3;\nvar MIN_OEMS_FOR_CACHE = 3;\n\nvar isPlainObject = function isPlainObject(value) {\n  return value != null && typeof value === \"object\" && !Array.isArray(value) && !(value instanceof Date);\n};\n\nvar normalizeKey = function normalizeKey(value) {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nvar hasUpper = function hasUpper(value) {\n  return /[A-Z]/.test(String(value || \"\"));\n};\n\nvar pickPreferredCase = function pickPreferredCase(current, incoming) {\n  if (!current) return incoming;\n  if (!incoming) return current;\n  var currentUpper = hasUpper(current);\n  var incomingUpper = hasUpper(incoming);\n  if (incomingUpper && !currentUpper) return incoming;\n  if (currentUpper && !incomingUpper) return current;\n  return current;\n};\n\nvar normalizeArray = function normalizeArray(value) {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nvar normalizeList = function normalizeList(values) {\n  var out = [];\n  (values || []).forEach(function (value) {\n    if (value == null) return;\n    var normalized = String(value).trim();\n    if (!normalized) return;\n    if (normalizeKey(normalized) === \"nan\") return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nvar normalizeListCaseInsensitive = function normalizeListCaseInsensitive(values) {\n  var map = new Map();\n  (values || []).forEach(function (value) {\n    if (value == null) return;\n    var normalized = String(value).trim();\n    if (!normalized) return;\n    var key = normalizeKey(normalized);\n    if (!key || key === \"nan\") return;\n    var current = map.get(key);\n    map.set(key, pickPreferredCase(current, normalized));\n  });\n  return Array.from(map.values());\n};\n\nvar readCatalogCache = function readCatalogCache() {\n  if (false) return null;\n\n  try {\n    var raw = window.localStorage.getItem(CATALOG_CACHE_KEY);\n    if (!raw) return null;\n    var parsed = JSON.parse(raw);\n    if (!(parsed !== null && parsed !== void 0 && parsed.savedAt)) return null;\n    if (Date.now() - parsed.savedAt > CACHE_TTL_MS) return null;\n    return parsed;\n  } catch (error) {\n    return null;\n  }\n};\n\nvar writeCatalogCache = function writeCatalogCache(payload) {\n  if (false) return;\n\n  try {\n    window.localStorage.setItem(CATALOG_CACHE_KEY, JSON.stringify(_objectSpread(_objectSpread({}, payload), {}, {\n      savedAt: Date.now()\n    })));\n  } catch (error) {// ignore cache failures\n  }\n};\n\nvar noteApiFailure = function noteApiFailure() {\n  if (false) return;\n\n  try {\n    window.localStorage.setItem(API_FAIL_KEY, String(Date.now()));\n  } catch (error) {// ignore\n  }\n};\n\nvar shouldSkipApi = function shouldSkipApi() {\n  if (false) return false;\n\n  try {\n    var raw = window.localStorage.getItem(API_FAIL_KEY);\n    if (!raw) return false;\n    var last = Number(raw);\n    if (!last) return false;\n    return Date.now() - last < API_FAIL_TTL_MS;\n  } catch (error) {\n    return false;\n  }\n};\n\nvar pickModelField = function pickModelField(obj) {\n  if (!isPlainObject(obj)) return null;\n\n  var _iterator = _createForOfIteratorHelper(MODEL_FIELD_CANDIDATES),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var key = _step.value;\n      if (Array.isArray(obj[key])) return key;\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  var arrayKey = Object.keys(obj).find(function (key) {\n    return Array.isArray(obj[key]);\n  });\n  return arrayKey || null;\n};\n\nvar extractModels = function extractModels(value) {\n  if (Array.isArray(value)) {\n    return {\n      models: normalizeList(value),\n      modelField: null\n    };\n  }\n\n  if (isPlainObject(value)) {\n    var modelField = pickModelField(value);\n    var models = modelField ? normalizeList(value[modelField]) : [];\n    return {\n      models: models,\n      modelField: modelField\n    };\n  }\n\n  if (value != null && value !== \"\") {\n    return {\n      models: normalizeList([value]),\n      modelField: null\n    };\n  }\n\n  return {\n    models: [],\n    modelField: null\n  };\n};\n\nvar extractOemMap = function extractOemMap(data) {\n  var oemMap = {};\n  var modelFieldByOem = {};\n  var oemField = null;\n\n  var _iterator2 = _createForOfIteratorHelper(OEM_FIELD_CANDIDATES),\n      _step2;\n\n  try {\n    for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n      var key = _step2.value;\n\n      if (Array.isArray(data === null || data === void 0 ? void 0 : data[key])) {\n        oemField = key;\n        data[key].forEach(function (entry) {\n          if (entry == null) return;\n\n          if (isPlainObject(entry)) {\n            var name = entry.name || entry.oem || entry.OEM || entry.label || entry.value;\n            if (!name) return;\n            var normalizedName = String(name).trim();\n            if (!normalizedName) return;\n\n            var _extractModels2 = extractModels(entry.models || entry.list || entry.items),\n                models = _extractModels2.models;\n\n            oemMap[normalizedName] = normalizeList([].concat(_toConsumableArray(oemMap[normalizedName] || []), _toConsumableArray(models)));\n            return;\n          }\n\n          var normalized = String(entry || \"\").trim();\n          if (!normalized) return;\n          oemMap[normalized] = normalizeList(_toConsumableArray(oemMap[normalized] || []));\n        });\n      } else if (isPlainObject(data === null || data === void 0 ? void 0 : data[key])) {\n        oemField = key;\n        Object.entries(data[key]).forEach(function (_ref3) {\n          var _ref4 = _slicedToArray(_ref3, 2),\n              oem = _ref4[0],\n              value = _ref4[1];\n\n          var _extractModels3 = extractModels(value),\n              models = _extractModels3.models,\n              modelField = _extractModels3.modelField;\n\n          oemMap[oem] = normalizeList([].concat(_toConsumableArray(oemMap[oem] || []), _toConsumableArray(models)));\n\n          if (modelField) {\n            modelFieldByOem[oem] = modelField;\n          }\n        });\n      }\n    }\n  } catch (err) {\n    _iterator2.e(err);\n  } finally {\n    _iterator2.f();\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(function (_ref) {\n      var _ref2 = _slicedToArray(_ref, 2),\n          key = _ref2[0],\n          value = _ref2[1];\n\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n\n      if (isPlainObject(value) || Array.isArray(value)) {\n        var _extractModels = extractModels(value),\n            models = _extractModels.models,\n            modelField = _extractModels.modelField;\n\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([].concat(_toConsumableArray(oemMap[key] || []), _toConsumableArray(models)));\n\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return {\n    oemMap: oemMap,\n    oemField: oemField,\n    modelFieldByOem: modelFieldByOem\n  };\n};\n\nvar buildCatalogFromMachines = /*#__PURE__*/function () {\n  var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n    var db, snap, modalityMap, oemMapByModality, modelMapByModalityOem, ensureDisplay, modalities, oemsByModality, modelsByModalityOem;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            db = firebase.firestore();\n            _context.next = 3;\n            return db.collection(\"Machine\").get();\n\n          case 3:\n            snap = _context.sent;\n            modalityMap = new Map();\n            oemMapByModality = new Map();\n            modelMapByModalityOem = new Map();\n\n            ensureDisplay = function ensureDisplay(map, value) {\n              var key = normalizeKey(value);\n              if (!key) return null;\n              var current = map.get(key);\n              var display = pickPreferredCase(current, String(value).trim());\n              map.set(key, display);\n              return display;\n            };\n\n            snap.forEach(function (doc) {\n              var data = doc.data() || {};\n              var modalityRaw = data.Modality || data.modality;\n              var oemRaw = data.OEM || data.oem;\n              if (!modalityRaw || !oemRaw) return;\n              var modality = ensureDisplay(modalityMap, modalityRaw);\n              if (!modality) return;\n              var modalityLower = normalizeKey(modality);\n              var oemKeyMap = oemMapByModality.get(modalityLower) || new Map();\n              oemMapByModality.set(modalityLower, oemKeyMap);\n              var oem = ensureDisplay(oemKeyMap, oemRaw);\n              if (!oem) return;\n              var modelRaw = data.Model || data.model;\n              if (!modelRaw) return;\n              var modelKey = modelMapByModalityOem.get(modalityLower) || new Map();\n              modelMapByModalityOem.set(modalityLower, modelKey);\n              var oemLower = normalizeKey(oem);\n              var modelMap = modelKey.get(oemLower) || new Map();\n              modelKey.set(oemLower, modelMap);\n              ensureDisplay(modelMap, modelRaw);\n            });\n            modalities = Array.from(modalityMap.values());\n            oemsByModality = {};\n            modelsByModalityOem = {};\n            modalities.forEach(function (modality) {\n              var modalityLower = normalizeKey(modality);\n              var oemMap = oemMapByModality.get(modalityLower) || new Map();\n              var oems = Array.from(oemMap.values());\n              oemsByModality[modality] = oems;\n              var modelMap = modelMapByModalityOem.get(modalityLower) || new Map();\n              var modelByOem = {};\n              oems.forEach(function (oem) {\n                var oemLower = normalizeKey(oem);\n                var models = Array.from((modelMap.get(oemLower) || new Map()).values());\n                if (models.length) modelByOem[oem] = models;\n              });\n              modelsByModalityOem[modality] = modelByOem;\n            });\n            return _context.abrupt(\"return\", buildCatalogMetaFromMaps({\n              modalities: modalities,\n              oemsByModality: oemsByModality,\n              modelsByModalityOem: modelsByModalityOem,\n              usesSubcollections: true,\n              syncDisabled: false,\n              source: \"machine\"\n            }));\n\n          case 14:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function buildCatalogFromMachines() {\n    return _ref5.apply(this, arguments);\n  };\n}();\n\nvar buildCatalogFromTestItems = /*#__PURE__*/function () {\n  var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n    var db, snap, modalityMap, oemMapByModality, modelMapByModalityOem, ensureDisplay, modalities, oemsByModality, modelsByModalityOem;\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            db = firebase.firestore();\n            _context2.next = 3;\n            return db.collection(\"Test\").get();\n\n          case 3:\n            snap = _context2.sent;\n            modalityMap = new Map();\n            oemMapByModality = new Map();\n            modelMapByModalityOem = new Map();\n\n            ensureDisplay = function ensureDisplay(map, value) {\n              var key = normalizeKey(value);\n              if (!key) return null;\n              var current = map.get(key);\n              var display = pickPreferredCase(current, String(value).trim());\n              map.set(key, display);\n              return display;\n            };\n\n            snap.forEach(function (doc) {\n              var data = doc.data() || {};\n              var machine = data.TheMachine || {};\n              var modalityRaw = machine.Modality || machine.modality || data.Modality || data.modality;\n              var oemRaw = machine.OEM || machine.oem || data.OEM || data.oem;\n              if (!modalityRaw || !oemRaw) return;\n              var modality = ensureDisplay(modalityMap, modalityRaw);\n              if (!modality) return;\n              var modalityLower = normalizeKey(modality);\n              var oemKeyMap = oemMapByModality.get(modalityLower) || new Map();\n              oemMapByModality.set(modalityLower, oemKeyMap);\n              var oem = ensureDisplay(oemKeyMap, oemRaw);\n              if (!oem) return;\n              var modelRaw = machine.Model || machine.model || data.Model || data.model;\n              if (!modelRaw) return;\n              var modelKey = modelMapByModalityOem.get(modalityLower) || new Map();\n              modelMapByModalityOem.set(modalityLower, modelKey);\n              var oemLower = normalizeKey(oem);\n              var modelMap = modelKey.get(oemLower) || new Map();\n              modelKey.set(oemLower, modelMap);\n              ensureDisplay(modelMap, modelRaw);\n            });\n            modalities = Array.from(modalityMap.values());\n            oemsByModality = {};\n            modelsByModalityOem = {};\n            modalities.forEach(function (modality) {\n              var modalityLower = normalizeKey(modality);\n              var oemMap = oemMapByModality.get(modalityLower) || new Map();\n              var oems = Array.from(oemMap.values());\n              oemsByModality[modality] = oems;\n              var modelMap = modelMapByModalityOem.get(modalityLower) || new Map();\n              var modelByOem = {};\n              oems.forEach(function (oem) {\n                var oemLower = normalizeKey(oem);\n                var models = Array.from((modelMap.get(oemLower) || new Map()).values());\n                if (models.length) modelByOem[oem] = models;\n              });\n              modelsByModalityOem[modality] = modelByOem;\n            });\n            return _context2.abrupt(\"return\", buildCatalogMetaFromMaps({\n              modalities: modalities,\n              oemsByModality: oemsByModality,\n              modelsByModalityOem: modelsByModalityOem,\n              usesSubcollections: true,\n              syncDisabled: false,\n              source: \"test\"\n            }));\n\n          case 14:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n\n  return function buildCatalogFromTestItems() {\n    return _ref6.apply(this, arguments);\n  };\n}();\n\nvar resolveModalitiesInTracker = /*#__PURE__*/function () {\n  var _ref7 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(db) {\n    var candidates,\n        confirmed,\n        seen,\n        _iterator3,\n        _step3,\n        candidate,\n        raw,\n        lower,\n        upper,\n        ids,\n        found,\n        _i,\n        _ids,\n        id,\n        doc,\n        key,\n        _args3 = arguments;\n\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            candidates = _args3.length > 1 && _args3[1] !== undefined ? _args3[1] : [];\n            confirmed = [];\n            seen = new Set();\n            _iterator3 = _createForOfIteratorHelper(candidates);\n            _context3.prev = 4;\n\n            _iterator3.s();\n\n          case 6:\n            if ((_step3 = _iterator3.n()).done) {\n              _context3.next = 37;\n              break;\n            }\n\n            candidate = _step3.value;\n            raw = String(candidate || \"\").trim();\n\n            if (raw) {\n              _context3.next = 11;\n              break;\n            }\n\n            return _context3.abrupt(\"continue\", 35);\n\n          case 11:\n            lower = normalizeKey(raw);\n            upper = raw.toUpperCase();\n            ids = Array.from(new Set([raw, lower, upper].filter(function (value) {\n              return value;\n            })));\n            found = null;\n            _i = 0, _ids = ids;\n\n          case 16:\n            if (!(_i < _ids.length)) {\n              _context3.next = 34;\n              break;\n            }\n\n            id = _ids[_i];\n\n            if (!seen.has(id)) {\n              _context3.next = 20;\n              break;\n            }\n\n            return _context3.abrupt(\"continue\", 31);\n\n          case 20:\n            _context3.prev = 20;\n            _context3.next = 23;\n            return db.collection(\"Tracker\").doc(id).get();\n\n          case 23:\n            doc = _context3.sent;\n\n            if (!doc.exists) {\n              _context3.next = 27;\n              break;\n            }\n\n            found = doc.id;\n            return _context3.abrupt(\"break\", 34);\n\n          case 27:\n            _context3.next = 31;\n            break;\n\n          case 29:\n            _context3.prev = 29;\n            _context3.t0 = _context3[\"catch\"](20);\n\n          case 31:\n            _i++;\n            _context3.next = 16;\n            break;\n\n          case 34:\n            if (found) {\n              key = normalizeKey(found);\n\n              if (!seen.has(key)) {\n                seen.add(key);\n                confirmed.push(found);\n              }\n            }\n\n          case 35:\n            _context3.next = 6;\n            break;\n\n          case 37:\n            _context3.next = 42;\n            break;\n\n          case 39:\n            _context3.prev = 39;\n            _context3.t1 = _context3[\"catch\"](4);\n\n            _iterator3.e(_context3.t1);\n\n          case 42:\n            _context3.prev = 42;\n\n            _iterator3.f();\n\n            return _context3.finish(42);\n\n          case 45:\n            return _context3.abrupt(\"return\", normalizeListCaseInsensitive(confirmed));\n\n          case 46:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3, null, [[4, 39, 42, 45], [20, 29]]);\n  }));\n\n  return function resolveModalitiesInTracker(_x) {\n    return _ref7.apply(this, arguments);\n  };\n}();\n\nvar mergeCatalogs = function mergeCatalogs(baseCatalog, extraCatalog, source) {\n  var baseModalities = (baseCatalog === null || baseCatalog === void 0 ? void 0 : baseCatalog.modalities) || [];\n  var baseMeta = (baseCatalog === null || baseCatalog === void 0 ? void 0 : baseCatalog.meta) || {};\n  var allowedSet = baseModalities.length ? new Set(baseModalities.map(function (value) {\n    return normalizeKey(value);\n  })) : null;\n  var modalities = allowedSet ? baseModalities : normalizeListCaseInsensitive([].concat(_toConsumableArray(baseModalities), _toConsumableArray((extraCatalog === null || extraCatalog === void 0 ? void 0 : extraCatalog.modalities) || [])));\n\n  var oemsByModality = _objectSpread({}, (baseCatalog === null || baseCatalog === void 0 ? void 0 : baseCatalog.oemsByModality) || {});\n\n  var modelsByModalityOem = _objectSpread({}, (baseCatalog === null || baseCatalog === void 0 ? void 0 : baseCatalog.modelsByModalityOem) || {});\n\n  Object.entries((extraCatalog === null || extraCatalog === void 0 ? void 0 : extraCatalog.oemsByModality) || {}).forEach(function (_ref8) {\n    var _baseMeta$modalityKey, _extraCatalog$modelsB;\n\n    var _ref9 = _slicedToArray(_ref8, 2),\n        modality = _ref9[0],\n        oems = _ref9[1];\n\n    var modalityKey = normalizeKey(modality);\n    if (allowedSet && !allowedSet.has(modalityKey)) return;\n    var canonicalModality = (baseMeta === null || baseMeta === void 0 ? void 0 : (_baseMeta$modalityKey = baseMeta.modalityKeyByLower) === null || _baseMeta$modalityKey === void 0 ? void 0 : _baseMeta$modalityKey[modalityKey]) || modalities.find(function (value) {\n      return normalizeKey(value) === modalityKey;\n    }) || modality;\n    var mergedOems = normalizeListCaseInsensitive([].concat(_toConsumableArray(oemsByModality[canonicalModality] || []), _toConsumableArray(oems || [])));\n    oemsByModality[canonicalModality] = mergedOems;\n    var extraModels = (extraCatalog === null || extraCatalog === void 0 ? void 0 : (_extraCatalog$modelsB = extraCatalog.modelsByModalityOem) === null || _extraCatalog$modelsB === void 0 ? void 0 : _extraCatalog$modelsB[modality]) || {};\n    var destModels = modelsByModalityOem[canonicalModality] || {};\n    Object.entries(extraModels).forEach(function (_ref10) {\n      var _ref11 = _slicedToArray(_ref10, 2),\n          oem = _ref11[0],\n          models = _ref11[1];\n\n      destModels[oem] = normalizeListCaseInsensitive([].concat(_toConsumableArray(destModels[oem] || []), _toConsumableArray(models || [])));\n    });\n    modelsByModalityOem[canonicalModality] = destModels;\n  });\n  return buildCatalogMetaFromMaps({\n    modalities: modalities,\n    oemsByModality: oemsByModality,\n    modelsByModalityOem: modelsByModalityOem,\n    usesSubcollections: true,\n    syncDisabled: false,\n    source: source\n  });\n};\n\nvar buildCatalogMetaFromMaps = function buildCatalogMetaFromMaps(_ref12) {\n  var _ref12$modalities = _ref12.modalities,\n      modalities = _ref12$modalities === void 0 ? [] : _ref12$modalities,\n      _ref12$oemsByModality = _ref12.oemsByModality,\n      oemsByModality = _ref12$oemsByModality === void 0 ? {} : _ref12$oemsByModality,\n      _ref12$modelsByModali = _ref12.modelsByModalityOem,\n      modelsByModalityOem = _ref12$modelsByModali === void 0 ? {} : _ref12$modelsByModali,\n      _ref12$usesSubcollect = _ref12.usesSubcollections,\n      usesSubcollections = _ref12$usesSubcollect === void 0 ? false : _ref12$usesSubcollect,\n      _ref12$syncDisabled = _ref12.syncDisabled,\n      syncDisabled = _ref12$syncDisabled === void 0 ? false : _ref12$syncDisabled,\n      _ref12$source = _ref12.source,\n      source = _ref12$source === void 0 ? \"client\" : _ref12$source;\n  var meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n    modalityKeyByLower: {},\n    oemKeyByModalityLower: {},\n    modelKeyByModalityOemLower: {},\n    usesSubcollections: usesSubcollections,\n    syncDisabled: syncDisabled,\n    source: source\n  };\n  var normalizedModalities = normalizeListCaseInsensitive(modalities);\n  normalizedModalities.forEach(function (modality) {\n    var modalityLower = normalizeKey(modality);\n    meta.modalityKeyByLower[modalityLower] = pickPreferredCase(meta.modalityKeyByLower[modalityLower], modality);\n    var oems = (oemsByModality === null || oemsByModality === void 0 ? void 0 : oemsByModality[modality]) || [];\n    var oemLowerMap = meta.oemKeyByModalityLower[modalityLower] || {};\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n    var modelLowerMap = meta.modelKeyByModalityOemLower[modalityLower] || {};\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n    oems.forEach(function (oem) {\n      var _modelsByModalityOem$;\n\n      var oemLower = normalizeKey(oem);\n      oemLowerMap[oemLower] = pickPreferredCase(oemLowerMap[oemLower], oem);\n      var models = (modelsByModalityOem === null || modelsByModalityOem === void 0 ? void 0 : (_modelsByModalityOem$ = modelsByModalityOem[modality]) === null || _modelsByModalityOem$ === void 0 ? void 0 : _modelsByModalityOem$[oem]) || [];\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n      models.forEach(function (model) {\n        var modelLower = normalizeKey(model);\n        if (!modelLower) return;\n        modelLowerMap[oemLower][modelLower] = pickPreferredCase(modelLowerMap[oemLower][modelLower], model);\n      });\n    });\n  });\n  return {\n    modalities: normalizedModalities,\n    oemsByModality: oemsByModality,\n    modelsByModalityOem: modelsByModalityOem,\n    meta: meta\n  };\n};\n\nexport function fetchTrackerCatalog() {\n  return _fetchTrackerCatalog.apply(this, arguments);\n}\n\nfunction _fetchTrackerCatalog() {\n  _fetchTrackerCatalog = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n    var _builtFromTracker$met3, _builtFromTracker$met4, _builtFromTracker$met5;\n\n    var cached, builtCached, cachedOems, response, payload, _built$meta, _built$meta2, _built$meta3, built, db, snap, modalities, oemsByModality, modelsByModalityOem, meta, builtFromTracker, allOems, _builtFromMachines, _builtFromTest, _merged, _merged$modalities, builtFromMachines, builtFromTest, candidateModalities, expandedBase, confirmed, _builtFromTracker$met, _builtFromTracker$met2, merged, _merged$meta, _merged$meta2, _merged$meta3;\n\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            if (!true) {\n              _context4.next = 8;\n              break;\n            }\n\n            cached = readCatalogCache();\n\n            if (!(cached !== null && cached !== void 0 && cached.modalities)) {\n              _context4.next = 8;\n              break;\n            }\n\n            builtCached = buildCatalogMetaFromMaps({\n              modalities: cached.modalities || [],\n              oemsByModality: cached.oemsByModality || {},\n              modelsByModalityOem: cached.modelsByModalityOem || {},\n              usesSubcollections: Boolean(cached.usesSubcollections),\n              syncDisabled: Boolean(cached.syncDisabled),\n              source: cached.source || \"cache\"\n            });\n            cachedOems = buildAllOems(builtCached);\n\n            if (!(builtCached.modalities.length >= MIN_MODALITIES_FOR_CACHE && cachedOems.length >= MIN_OEMS_FOR_CACHE)) {\n              _context4.next = 7;\n              break;\n            }\n\n            return _context4.abrupt(\"return\", builtCached);\n\n          case 7:\n            try {\n              window.localStorage.removeItem(CATALOG_CACHE_KEY);\n            } catch (error) {// ignore\n            }\n\n          case 8:\n            if (!(true && !shouldSkipApi())) {\n              _context4.next = 32;\n              break;\n            }\n\n            _context4.prev = 9;\n            _context4.next = 12;\n            return fetch(\"/api/tracker/catalog\");\n\n          case 12:\n            response = _context4.sent;\n\n            if (!response.ok) {\n              _context4.next = 23;\n              break;\n            }\n\n            _context4.next = 16;\n            return response.json();\n\n          case 16:\n            payload = _context4.sent;\n\n            if (!(payload !== null && payload !== void 0 && payload.modalities)) {\n              _context4.next = 21;\n              break;\n            }\n\n            built = buildCatalogMetaFromMaps({\n              modalities: payload.modalities || [],\n              oemsByModality: payload.oemsByModality || {},\n              modelsByModalityOem: payload.modelsByModalityOem || {},\n              usesSubcollections: Boolean(payload.usesSubcollections),\n              syncDisabled: false,\n              source: \"server\"\n            });\n            writeCatalogCache({\n              modalities: built.modalities,\n              oemsByModality: built.oemsByModality,\n              modelsByModalityOem: built.modelsByModalityOem,\n              usesSubcollections: (_built$meta = built.meta) === null || _built$meta === void 0 ? void 0 : _built$meta.usesSubcollections,\n              syncDisabled: (_built$meta2 = built.meta) === null || _built$meta2 === void 0 ? void 0 : _built$meta2.syncDisabled,\n              source: (_built$meta3 = built.meta) === null || _built$meta3 === void 0 ? void 0 : _built$meta3.source\n            });\n            return _context4.abrupt(\"return\", built);\n\n          case 21:\n            _context4.next = 24;\n            break;\n\n          case 23:\n            noteApiFailure();\n\n          case 24:\n            _context4.next = 30;\n            break;\n\n          case 26:\n            _context4.prev = 26;\n            _context4.t0 = _context4[\"catch\"](9);\n            console.warn(\"Tracker catalog API fallback:\", _context4.t0);\n            noteApiFailure();\n\n          case 30:\n            _context4.next = 33;\n            break;\n\n          case 32:\n            if (true) {\n              noteApiFailure();\n            }\n\n          case 33:\n            db = firebase.firestore();\n            _context4.next = 36;\n            return db.collection(\"Tracker\").get();\n\n          case 36:\n            snap = _context4.sent;\n            modalities = [];\n            oemsByModality = {};\n            modelsByModalityOem = {};\n            meta = {\n              oemFieldByModality: {},\n              modelFieldByModalityOem: {},\n              modalityKeyByLower: {},\n              oemKeyByModalityLower: {},\n              modelKeyByModalityOemLower: {}\n            };\n            snap.forEach(function (doc) {\n              var modality = doc.id;\n              var modalityLower = normalizeKey(modality);\n              var existingModality = meta.modalityKeyByLower[modalityLower];\n              var canonicalModality = pickPreferredCase(existingModality, modality);\n              meta.modalityKeyByLower[modalityLower] = canonicalModality;\n              var data = doc.data() || {};\n\n              var _extractOemMap = extractOemMap(data),\n                  oemMap = _extractOemMap.oemMap,\n                  oemField = _extractOemMap.oemField,\n                  modelFieldByOem = _extractOemMap.modelFieldByOem;\n\n              if (existingModality && existingModality !== canonicalModality) {\n                oemsByModality[canonicalModality] = normalizeListCaseInsensitive([].concat(_toConsumableArray(oemsByModality[existingModality] || []), _toConsumableArray(oemsByModality[canonicalModality] || [])));\n                modelsByModalityOem[canonicalModality] = _objectSpread(_objectSpread({}, modelsByModalityOem[existingModality] || {}), modelsByModalityOem[canonicalModality] || {});\n                meta.modelFieldByModalityOem[canonicalModality] = _objectSpread(_objectSpread({}, meta.modelFieldByModalityOem[existingModality] || {}), meta.modelFieldByModalityOem[canonicalModality] || {});\n\n                if (!meta.oemFieldByModality[canonicalModality]) {\n                  meta.oemFieldByModality[canonicalModality] = meta.oemFieldByModality[existingModality] || oemField;\n                }\n\n                delete oemsByModality[existingModality];\n                delete modelsByModalityOem[existingModality];\n                delete meta.oemFieldByModality[existingModality];\n                delete meta.modelFieldByModalityOem[existingModality];\n              }\n\n              modalities.push(canonicalModality);\n\n              if (!meta.oemFieldByModality[canonicalModality]) {\n                meta.oemFieldByModality[canonicalModality] = oemField;\n              }\n\n              meta.modelFieldByModalityOem[canonicalModality] = _objectSpread(_objectSpread({}, meta.modelFieldByModalityOem[canonicalModality] || {}), modelFieldByOem || {});\n              var oems = Object.keys(oemMap);\n              var mergedOems = normalizeListCaseInsensitive([].concat(_toConsumableArray(oemsByModality[canonicalModality] || []), _toConsumableArray(oems)));\n              oemsByModality[canonicalModality] = mergedOems;\n              modelsByModalityOem[canonicalModality] = modelsByModalityOem[canonicalModality] || {};\n              var oemLowerMap = meta.oemKeyByModalityLower[modalityLower] || {};\n              meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n              var modelLowerMap = meta.modelKeyByModalityOemLower[modalityLower] || {};\n              meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n              oems.forEach(function (oem) {\n                var oemLower = normalizeKey(oem);\n                var existingOem = oemLowerMap[oemLower];\n                var canonicalOem = pickPreferredCase(existingOem, oem);\n                oemLowerMap[oemLower] = canonicalOem;\n\n                if (existingOem && existingOem !== canonicalOem) {\n                  modelsByModalityOem[canonicalModality][canonicalOem] = normalizeListCaseInsensitive([].concat(_toConsumableArray(modelsByModalityOem[canonicalModality][existingOem] || []), _toConsumableArray(modelsByModalityOem[canonicalModality][canonicalOem] || [])));\n                  delete modelsByModalityOem[canonicalModality][existingOem];\n                }\n\n                var existingModels = modelsByModalityOem[canonicalModality][canonicalOem] || [];\n                var mergedModels = normalizeListCaseInsensitive([].concat(_toConsumableArray(existingModels), _toConsumableArray(oemMap[oem] || [])));\n                modelsByModalityOem[canonicalModality][canonicalOem] = mergedModels;\n                modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n                mergedModels.forEach(function (model) {\n                  modelLowerMap[oemLower][normalizeKey(model)] = model;\n                });\n              });\n            });\n            builtFromTracker = buildCatalogMetaFromMaps({\n              modalities: modalities,\n              oemsByModality: oemsByModality,\n              modelsByModalityOem: modelsByModalityOem,\n              usesSubcollections: true,\n              syncDisabled: true,\n              source: \"client\"\n            });\n            allOems = buildAllOems(builtFromTracker);\n\n            if (!(builtFromTracker.modalities.length < MIN_MODALITIES_FOR_CACHE || allOems.length < MIN_OEMS_FOR_CACHE)) {\n              _context4.next = 83;\n              break;\n            }\n\n            builtFromMachines = null;\n            builtFromTest = null;\n            _context4.prev = 47;\n            _context4.next = 50;\n            return buildCatalogFromMachines();\n\n          case 50:\n            builtFromMachines = _context4.sent;\n            _context4.next = 56;\n            break;\n\n          case 53:\n            _context4.prev = 53;\n            _context4.t1 = _context4[\"catch\"](47);\n            console.warn(\"Tracker catalog machine fallback failed:\", _context4.t1);\n\n          case 56:\n            _context4.prev = 56;\n            _context4.next = 59;\n            return buildCatalogFromTestItems();\n\n          case 59:\n            builtFromTest = _context4.sent;\n            _context4.next = 65;\n            break;\n\n          case 62:\n            _context4.prev = 62;\n            _context4.t2 = _context4[\"catch\"](56);\n            console.warn(\"Tracker catalog test fallback failed:\", _context4.t2);\n\n          case 65:\n            candidateModalities = normalizeListCaseInsensitive([].concat(_toConsumableArray(((_builtFromMachines = builtFromMachines) === null || _builtFromMachines === void 0 ? void 0 : _builtFromMachines.modalities) || []), _toConsumableArray(((_builtFromTest = builtFromTest) === null || _builtFromTest === void 0 ? void 0 : _builtFromTest.modalities) || [])));\n            expandedBase = builtFromTracker;\n\n            if (!candidateModalities.length) {\n              _context4.next = 77;\n              break;\n            }\n\n            _context4.prev = 68;\n            _context4.next = 71;\n            return resolveModalitiesInTracker(db, candidateModalities);\n\n          case 71:\n            confirmed = _context4.sent;\n\n            if (confirmed.length) {\n              expandedBase = buildCatalogMetaFromMaps({\n                modalities: normalizeListCaseInsensitive([].concat(_toConsumableArray(builtFromTracker.modalities), _toConsumableArray(confirmed))),\n                oemsByModality: builtFromTracker.oemsByModality,\n                modelsByModalityOem: builtFromTracker.modelsByModalityOem,\n                usesSubcollections: true,\n                syncDisabled: (_builtFromTracker$met = builtFromTracker.meta) === null || _builtFromTracker$met === void 0 ? void 0 : _builtFromTracker$met.syncDisabled,\n                source: (_builtFromTracker$met2 = builtFromTracker.meta) === null || _builtFromTracker$met2 === void 0 ? void 0 : _builtFromTracker$met2.source\n              });\n            }\n\n            _context4.next = 77;\n            break;\n\n          case 75:\n            _context4.prev = 75;\n            _context4.t3 = _context4[\"catch\"](68);\n\n          case 77:\n            merged = expandedBase;\n\n            if (builtFromMachines) {\n              merged = mergeCatalogs(merged, builtFromMachines, \"machine+tracker\");\n            }\n\n            if (builtFromTest) {\n              merged = mergeCatalogs(merged, builtFromTest, \"test+tracker\");\n            }\n\n            if (!((_merged = merged) !== null && _merged !== void 0 && (_merged$modalities = _merged.modalities) !== null && _merged$modalities !== void 0 && _merged$modalities.length)) {\n              _context4.next = 83;\n              break;\n            }\n\n            writeCatalogCache({\n              modalities: merged.modalities,\n              oemsByModality: merged.oemsByModality,\n              modelsByModalityOem: merged.modelsByModalityOem,\n              usesSubcollections: (_merged$meta = merged.meta) === null || _merged$meta === void 0 ? void 0 : _merged$meta.usesSubcollections,\n              syncDisabled: (_merged$meta2 = merged.meta) === null || _merged$meta2 === void 0 ? void 0 : _merged$meta2.syncDisabled,\n              source: (_merged$meta3 = merged.meta) === null || _merged$meta3 === void 0 ? void 0 : _merged$meta3.source\n            });\n            return _context4.abrupt(\"return\", merged);\n\n          case 83:\n            writeCatalogCache({\n              modalities: builtFromTracker.modalities,\n              oemsByModality: builtFromTracker.oemsByModality,\n              modelsByModalityOem: builtFromTracker.modelsByModalityOem,\n              usesSubcollections: (_builtFromTracker$met3 = builtFromTracker.meta) === null || _builtFromTracker$met3 === void 0 ? void 0 : _builtFromTracker$met3.usesSubcollections,\n              syncDisabled: (_builtFromTracker$met4 = builtFromTracker.meta) === null || _builtFromTracker$met4 === void 0 ? void 0 : _builtFromTracker$met4.syncDisabled,\n              source: (_builtFromTracker$met5 = builtFromTracker.meta) === null || _builtFromTracker$met5 === void 0 ? void 0 : _builtFromTracker$met5.source\n            });\n            return _context4.abrupt(\"return\", builtFromTracker);\n\n          case 85:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4, null, [[9, 26], [47, 53], [56, 62], [68, 75]]);\n  }));\n  return _fetchTrackerCatalog.apply(this, arguments);\n}\n\nexport function buildAllOems(catalog) {\n  var map = new Map();\n  Object.values((catalog === null || catalog === void 0 ? void 0 : catalog.oemsByModality) || {}).forEach(function (oems) {\n    (oems || []).forEach(function (oem) {\n      var key = normalizeKey(oem);\n      if (!key) return;\n      var current = map.get(key);\n      map.set(key, pickPreferredCase(current, oem));\n    });\n  });\n  return Array.from(map.values());\n}\nexport function buildModelsForSelection(catalog) {\n  var modalities = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n  var oems = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  var modelSet = new Set();\n  var modals = normalizeList(modalities);\n  var oemList = normalizeList(oems);\n  modals.forEach(function (modality) {\n    var _catalog$meta, _catalog$meta$modalit, _catalog$modelsByModa;\n\n    var modalityLower = normalizeKey(modality);\n    var canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta = catalog.meta) === null || _catalog$meta === void 0 ? void 0 : (_catalog$meta$modalit = _catalog$meta.modalityKeyByLower) === null || _catalog$meta$modalit === void 0 ? void 0 : _catalog$meta$modalit[modalityLower]) || modality;\n    var oemMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa = catalog.modelsByModalityOem) === null || _catalog$modelsByModa === void 0 ? void 0 : _catalog$modelsByModa[canonicalModality]) || {};\n    oemList.forEach(function (oem) {\n      var _catalog$meta2, _catalog$meta2$oemKey, _catalog$meta2$oemKey2;\n\n      var oemLower = normalizeKey(oem);\n      var canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta2 = catalog.meta) === null || _catalog$meta2 === void 0 ? void 0 : (_catalog$meta2$oemKey = _catalog$meta2.oemKeyByModalityLower) === null || _catalog$meta2$oemKey === void 0 ? void 0 : (_catalog$meta2$oemKey2 = _catalog$meta2$oemKey[modalityLower]) === null || _catalog$meta2$oemKey2 === void 0 ? void 0 : _catalog$meta2$oemKey2[oemLower]) || oem;\n      var models = (oemMap === null || oemMap === void 0 ? void 0 : oemMap[canonicalOem]) || [];\n      models.forEach(function (model) {\n        return modelSet.add(model);\n      });\n    });\n  });\n  return Array.from(modelSet);\n}\nexport function syncTrackerFromSelections(_x2) {\n  return _syncTrackerFromSelections.apply(this, arguments);\n}\n\nfunction _syncTrackerFromSelections() {\n  _syncTrackerFromSelections = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(_ref13) {\n    var _catalog$meta3, _catalog$meta4;\n\n    var selections, catalog, db, trackerRef, selectedModalities, selectedOems, selectedModels, ops, usesSubcollections, _iterator4, _step4, _loop, _ret;\n\n    return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            selections = _ref13.selections, catalog = _ref13.catalog;\n            db = firebase.firestore();\n            trackerRef = db.collection(\"Tracker\");\n            selectedModalities = normalizeList((selections === null || selections === void 0 ? void 0 : selections.modalities) || []);\n            selectedOems = normalizeList((selections === null || selections === void 0 ? void 0 : selections.oems) || []);\n            selectedModels = normalizeList((selections === null || selections === void 0 ? void 0 : selections.models) || []);\n\n            if (selectedModalities.length) {\n              _context5.next = 8;\n              break;\n            }\n\n            return _context5.abrupt(\"return\", false);\n\n          case 8:\n            if (!(catalog !== null && catalog !== void 0 && (_catalog$meta3 = catalog.meta) !== null && _catalog$meta3 !== void 0 && _catalog$meta3.syncDisabled)) {\n              _context5.next = 10;\n              break;\n            }\n\n            return _context5.abrupt(\"return\", false);\n\n          case 10:\n            ops = [];\n            usesSubcollections = Boolean(catalog === null || catalog === void 0 ? void 0 : (_catalog$meta4 = catalog.meta) === null || _catalog$meta4 === void 0 ? void 0 : _catalog$meta4.usesSubcollections);\n            _iterator4 = _createForOfIteratorHelper(selectedModalities);\n            _context5.prev = 13;\n\n            _loop = function _loop() {\n              var _catalog$meta5, _catalog$meta5$modali, _catalog$oemsByModali, _catalog$meta8, _catalog$meta8$oemFie, _catalog$modalities2;\n\n              var modality = _step4.value;\n              var modalityLower = normalizeKey(modality);\n              var canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta5 = catalog.meta) === null || _catalog$meta5 === void 0 ? void 0 : (_catalog$meta5$modali = _catalog$meta5.modalityKeyByLower) === null || _catalog$meta5$modali === void 0 ? void 0 : _catalog$meta5$modali[modalityLower]) || modalityLower;\n              var docRef = trackerRef.doc(canonicalModality);\n              var existingOemsRaw = (catalog === null || catalog === void 0 ? void 0 : (_catalog$oemsByModali = catalog.oemsByModality) === null || _catalog$oemsByModali === void 0 ? void 0 : _catalog$oemsByModali[canonicalModality]) || [];\n              var existingOemsLower = new Set(existingOemsRaw.map(function (value) {\n                return normalizeKey(value);\n              }));\n\n              if (usesSubcollections) {\n                var _catalog$modalities;\n\n                if (!(catalog !== null && catalog !== void 0 && (_catalog$modalities = catalog.modalities) !== null && _catalog$modalities !== void 0 && _catalog$modalities.some(function (existing) {\n                  return normalizeKey(existing) === modalityLower;\n                }))) {\n                  ops.push(docRef.set({\n                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()\n                  }, {\n                    merge: true\n                  }));\n                }\n\n                var _iterator5 = _createForOfIteratorHelper(selectedOems),\n                    _step5;\n\n                try {\n                  for (_iterator5.s(); !(_step5 = _iterator5.n()).done;) {\n                    var _catalog$meta6, _catalog$meta6$oemKey, _catalog$meta6$oemKey2, _catalog$modelsByModa2, _catalog$modelsByModa3, _catalog$meta7, _catalog$meta7$modelK, _catalog$meta7$modelK2;\n\n                    var oem = _step5.value;\n                    var oemLower = normalizeKey(oem);\n                    var canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta6 = catalog.meta) === null || _catalog$meta6 === void 0 ? void 0 : (_catalog$meta6$oemKey = _catalog$meta6.oemKeyByModalityLower) === null || _catalog$meta6$oemKey === void 0 ? void 0 : (_catalog$meta6$oemKey2 = _catalog$meta6$oemKey[modalityLower]) === null || _catalog$meta6$oemKey2 === void 0 ? void 0 : _catalog$meta6$oemKey2[oemLower]) || oemLower;\n                    var oemRef = docRef.collection(canonicalOem);\n                    if (!selectedModels.length) continue;\n                    var knownModels = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa2 = catalog.modelsByModalityOem) === null || _catalog$modelsByModa2 === void 0 ? void 0 : (_catalog$modelsByModa3 = _catalog$modelsByModa2[canonicalModality]) === null || _catalog$modelsByModa3 === void 0 ? void 0 : _catalog$modelsByModa3[canonicalOem]) || [];\n                    var knownLower = new Set(knownModels.map(function (value) {\n                      return normalizeKey(value);\n                    }));\n                    var modelCaseMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta7 = catalog.meta) === null || _catalog$meta7 === void 0 ? void 0 : (_catalog$meta7$modelK = _catalog$meta7.modelKeyByModalityOemLower) === null || _catalog$meta7$modelK === void 0 ? void 0 : (_catalog$meta7$modelK2 = _catalog$meta7$modelK[modalityLower]) === null || _catalog$meta7$modelK2 === void 0 ? void 0 : _catalog$meta7$modelK2[oemLower]) || {};\n\n                    var _iterator6 = _createForOfIteratorHelper(selectedModels),\n                        _step6;\n\n                    try {\n                      for (_iterator6.s(); !(_step6 = _iterator6.n()).done;) {\n                        var model = _step6.value;\n                        var modelLower = normalizeKey(model);\n                        if (!modelLower || knownLower.has(modelLower)) continue;\n                        var canonicalModel = modelCaseMap[modelLower] || model;\n                        ops.push(oemRef.doc(modelLower).set({\n                          name: canonicalModel\n                        }, {\n                          merge: true\n                        }));\n                      }\n                    } catch (err) {\n                      _iterator6.e(err);\n                    } finally {\n                      _iterator6.f();\n                    }\n                  }\n                } catch (err) {\n                  _iterator5.e(err);\n                } finally {\n                  _iterator5.f();\n                }\n\n                return \"continue\";\n              }\n\n              var oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta8 = catalog.meta) === null || _catalog$meta8 === void 0 ? void 0 : (_catalog$meta8$oemFie = _catalog$meta8.oemFieldByModality) === null || _catalog$meta8$oemFie === void 0 ? void 0 : _catalog$meta8$oemFie[canonicalModality]) || DEFAULT_OEM_FIELD;\n\n              if (!(catalog !== null && catalog !== void 0 && (_catalog$modalities2 = catalog.modalities) !== null && _catalog$modalities2 !== void 0 && _catalog$modalities2.some(function (existing) {\n                return normalizeKey(existing) === modalityLower;\n              }))) {\n                ops.push(docRef.set(_defineProperty({}, DEFAULT_OEM_FIELD, {}), {\n                  merge: true\n                }));\n              }\n\n              var _iterator7 = _createForOfIteratorHelper(selectedOems),\n                  _step7;\n\n              try {\n                for (_iterator7.s(); !(_step7 = _iterator7.n()).done;) {\n                  var _catalog$meta9, _catalog$meta9$oemKey, _catalog$meta9$oemKey2;\n\n                  var _oem = _step7.value;\n\n                  var _oemLower = normalizeKey(_oem);\n\n                  var _canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta9 = catalog.meta) === null || _catalog$meta9 === void 0 ? void 0 : (_catalog$meta9$oemKey = _catalog$meta9.oemKeyByModalityLower) === null || _catalog$meta9$oemKey === void 0 ? void 0 : (_catalog$meta9$oemKey2 = _catalog$meta9$oemKey[modalityLower]) === null || _catalog$meta9$oemKey2 === void 0 ? void 0 : _catalog$meta9$oemKey2[_oemLower]) || _oemLower;\n\n                  if (!existingOemsLower.has(_oemLower)) {\n                    ops.push(docRef.set(_defineProperty({}, oemField, _defineProperty({}, _canonicalOem, [])), {\n                      merge: true\n                    }));\n                  }\n                }\n              } catch (err) {\n                _iterator7.e(err);\n              } finally {\n                _iterator7.f();\n              }\n\n              var _iterator8 = _createForOfIteratorHelper(selectedOems),\n                  _step8;\n\n              try {\n                for (_iterator8.s(); !(_step8 = _iterator8.n()).done;) {\n                  var _catalog$meta10, _catalog$meta10$oemKe, _catalog$meta10$oemKe2, _catalog$modelsByModa4, _catalog$modelsByModa5, _catalog$meta11, _catalog$meta11$model, _catalog$meta11$model2, _catalog$meta12, _catalog$meta12$model, _catalog$meta12$model2;\n\n                  var _oem2 = _step8.value;\n\n                  var _oemLower2 = normalizeKey(_oem2);\n\n                  var _canonicalOem2 = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta10 = catalog.meta) === null || _catalog$meta10 === void 0 ? void 0 : (_catalog$meta10$oemKe = _catalog$meta10.oemKeyByModalityLower) === null || _catalog$meta10$oemKe === void 0 ? void 0 : (_catalog$meta10$oemKe2 = _catalog$meta10$oemKe[modalityLower]) === null || _catalog$meta10$oemKe2 === void 0 ? void 0 : _catalog$meta10$oemKe2[_oemLower2]) || _oemLower2;\n\n                  var _knownModels = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa4 = catalog.modelsByModalityOem) === null || _catalog$modelsByModa4 === void 0 ? void 0 : (_catalog$modelsByModa5 = _catalog$modelsByModa4[canonicalModality]) === null || _catalog$modelsByModa5 === void 0 ? void 0 : _catalog$modelsByModa5[_canonicalOem2]) || [];\n\n                  var _knownLower = new Set(_knownModels.map(function (value) {\n                    return normalizeKey(value);\n                  }));\n\n                  var _modelCaseMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta11 = catalog.meta) === null || _catalog$meta11 === void 0 ? void 0 : (_catalog$meta11$model = _catalog$meta11.modelKeyByModalityOemLower) === null || _catalog$meta11$model === void 0 ? void 0 : (_catalog$meta11$model2 = _catalog$meta11$model[modalityLower]) === null || _catalog$meta11$model2 === void 0 ? void 0 : _catalog$meta11$model2[_oemLower2]) || {};\n\n                  var modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta12 = catalog.meta) === null || _catalog$meta12 === void 0 ? void 0 : (_catalog$meta12$model = _catalog$meta12.modelFieldByModalityOem) === null || _catalog$meta12$model === void 0 ? void 0 : (_catalog$meta12$model2 = _catalog$meta12$model[canonicalModality]) === null || _catalog$meta12$model2 === void 0 ? void 0 : _catalog$meta12$model2[_canonicalOem2]) || null;\n\n                  var _iterator9 = _createForOfIteratorHelper(selectedModels),\n                      _step9;\n\n                  try {\n                    for (_iterator9.s(); !(_step9 = _iterator9.n()).done;) {\n                      var _model = _step9.value;\n\n                      var _modelLower = normalizeKey(_model);\n\n                      if (!_modelLower || _knownLower.has(_modelLower)) continue;\n\n                      var _canonicalModel = _modelCaseMap[_modelLower] || _model;\n\n                      var path = modelField ? \"\".concat(oemField, \".\").concat(_canonicalOem2, \".\").concat(modelField) : \"\".concat(oemField, \".\").concat(_canonicalOem2);\n                      ops.push(docRef.update(_defineProperty({}, path, firebase.firestore.FieldValue.arrayUnion(_canonicalModel))));\n                    }\n                  } catch (err) {\n                    _iterator9.e(err);\n                  } finally {\n                    _iterator9.f();\n                  }\n                }\n              } catch (err) {\n                _iterator8.e(err);\n              } finally {\n                _iterator8.f();\n              }\n            };\n\n            _iterator4.s();\n\n          case 16:\n            if ((_step4 = _iterator4.n()).done) {\n              _context5.next = 22;\n              break;\n            }\n\n            _ret = _loop();\n\n            if (!(_ret === \"continue\")) {\n              _context5.next = 20;\n              break;\n            }\n\n            return _context5.abrupt(\"continue\", 20);\n\n          case 20:\n            _context5.next = 16;\n            break;\n\n          case 22:\n            _context5.next = 27;\n            break;\n\n          case 24:\n            _context5.prev = 24;\n            _context5.t0 = _context5[\"catch\"](13);\n\n            _iterator4.e(_context5.t0);\n\n          case 27:\n            _context5.prev = 27;\n\n            _iterator4.f();\n\n            return _context5.finish(27);\n\n          case 30:\n            if (!ops.length) {\n              _context5.next = 34;\n              break;\n            }\n\n            _context5.next = 33;\n            return Promise.allSettled(ops);\n\n          case 33:\n            return _context5.abrupt(\"return\", true);\n\n          case 34:\n            return _context5.abrupt(\"return\", false);\n\n          case 35:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5, null, [[13, 24, 27, 30]]);\n  }));\n  return _syncTrackerFromSelections.apply(this, arguments);\n}\n\nexport function deleteTrackerOem(_x3) {\n  return _deleteTrackerOem.apply(this, arguments);\n}\n\nfunction _deleteTrackerOem() {\n  _deleteTrackerOem = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(_ref14) {\n    var _catalog$meta13;\n\n    var oem, catalog, db, trackerRef, modalities, usesSubcollections, ops;\n    return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            oem = _ref14.oem, catalog = _ref14.catalog;\n\n            if (oem) {\n              _context6.next = 3;\n              break;\n            }\n\n            return _context6.abrupt(\"return\");\n\n          case 3:\n            db = firebase.firestore();\n            trackerRef = db.collection(\"Tracker\");\n            modalities = (catalog === null || catalog === void 0 ? void 0 : catalog.modalities) || [];\n            usesSubcollections = Boolean(catalog === null || catalog === void 0 ? void 0 : (_catalog$meta13 = catalog.meta) === null || _catalog$meta13 === void 0 ? void 0 : _catalog$meta13.usesSubcollections);\n            ops = modalities.map(function (modality) {\n              var _catalog$meta14, _catalog$meta14$modal, _catalog$meta15, _catalog$meta15$oemKe, _catalog$meta15$oemKe2, _catalog$meta16, _catalog$meta16$oemFi, _catalog$meta17, _catalog$meta17$oemFi;\n\n              var modalityLower = normalizeKey(modality);\n              var canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta14 = catalog.meta) === null || _catalog$meta14 === void 0 ? void 0 : (_catalog$meta14$modal = _catalog$meta14.modalityKeyByLower) === null || _catalog$meta14$modal === void 0 ? void 0 : _catalog$meta14$modal[modalityLower]) || modality;\n              var docRef = trackerRef.doc(canonicalModality);\n              var canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta15 = catalog.meta) === null || _catalog$meta15 === void 0 ? void 0 : (_catalog$meta15$oemKe = _catalog$meta15.oemKeyByModalityLower) === null || _catalog$meta15$oemKe === void 0 ? void 0 : (_catalog$meta15$oemKe2 = _catalog$meta15$oemKe[modalityLower]) === null || _catalog$meta15$oemKe2 === void 0 ? void 0 : _catalog$meta15$oemKe2[normalizeKey(oem)]) || oem;\n\n              if (usesSubcollections) {\n                return docRef.collection(canonicalOem).get().then(function (snap) {\n                  var deletions = [];\n                  snap.forEach(function (doc) {\n                    deletions.push(doc.ref[\"delete\"]());\n                  });\n                  return Promise.allSettled(deletions);\n                })[\"catch\"](function () {\n                  return null;\n                });\n              }\n\n              var oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta16 = catalog.meta) === null || _catalog$meta16 === void 0 ? void 0 : (_catalog$meta16$oemFi = _catalog$meta16.oemFieldByModality) === null || _catalog$meta16$oemFi === void 0 ? void 0 : _catalog$meta16$oemFi[canonicalModality]) || DEFAULT_OEM_FIELD;\n\n              var update = _defineProperty({}, \"\".concat(oemField, \".\").concat(canonicalOem), firebase.firestore.FieldValue[\"delete\"]());\n\n              if (!(catalog !== null && catalog !== void 0 && (_catalog$meta17 = catalog.meta) !== null && _catalog$meta17 !== void 0 && (_catalog$meta17$oemFi = _catalog$meta17.oemFieldByModality) !== null && _catalog$meta17$oemFi !== void 0 && _catalog$meta17$oemFi[canonicalModality])) {\n                update[canonicalOem] = firebase.firestore.FieldValue[\"delete\"]();\n              }\n\n              return docRef.update(update)[\"catch\"](function () {\n                return null;\n              });\n            });\n            _context6.next = 10;\n            return Promise.allSettled(ops);\n\n          case 10:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  }));\n  return _deleteTrackerOem.apply(this, arguments);\n}\n\nexport function deleteTrackerModel(_x4) {\n  return _deleteTrackerModel.apply(this, arguments);\n}\n\nfunction _deleteTrackerModel() {\n  _deleteTrackerModel = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(_ref15) {\n    var _catalog$meta18, _catalog$meta18$modal, _catalog$meta19, _catalog$meta19$oemKe, _catalog$meta19$oemKe2, _catalog$meta20, _catalog$meta21, _catalog$meta21$oemFi, _catalog$meta22, _catalog$meta22$model, _catalog$meta22$model2;\n\n    var modality, oem, model, catalog, db, modalityLower, canonicalModality, docRef, canonicalOem, modelKey, oemField, modelField, path;\n    return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n      while (1) {\n        switch (_context7.prev = _context7.next) {\n          case 0:\n            modality = _ref15.modality, oem = _ref15.oem, model = _ref15.model, catalog = _ref15.catalog;\n\n            if (!(!modality || !oem || !model)) {\n              _context7.next = 3;\n              break;\n            }\n\n            return _context7.abrupt(\"return\");\n\n          case 3:\n            db = firebase.firestore();\n            modalityLower = normalizeKey(modality);\n            canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta18 = catalog.meta) === null || _catalog$meta18 === void 0 ? void 0 : (_catalog$meta18$modal = _catalog$meta18.modalityKeyByLower) === null || _catalog$meta18$modal === void 0 ? void 0 : _catalog$meta18$modal[modalityLower]) || modality;\n            docRef = db.collection(\"Tracker\").doc(canonicalModality);\n            canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta19 = catalog.meta) === null || _catalog$meta19 === void 0 ? void 0 : (_catalog$meta19$oemKe = _catalog$meta19.oemKeyByModalityLower) === null || _catalog$meta19$oemKe === void 0 ? void 0 : (_catalog$meta19$oemKe2 = _catalog$meta19$oemKe[modalityLower]) === null || _catalog$meta19$oemKe2 === void 0 ? void 0 : _catalog$meta19$oemKe2[normalizeKey(oem)]) || oem;\n\n            if (!(catalog !== null && catalog !== void 0 && (_catalog$meta20 = catalog.meta) !== null && _catalog$meta20 !== void 0 && _catalog$meta20.usesSubcollections)) {\n              _context7.next = 13;\n              break;\n            }\n\n            modelKey = normalizeKey(model);\n            _context7.next = 12;\n            return docRef.collection(canonicalOem).doc(modelKey)[\"delete\"]()[\"catch\"](function () {\n              return null;\n            });\n\n          case 12:\n            return _context7.abrupt(\"return\");\n\n          case 13:\n            oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta21 = catalog.meta) === null || _catalog$meta21 === void 0 ? void 0 : (_catalog$meta21$oemFi = _catalog$meta21.oemFieldByModality) === null || _catalog$meta21$oemFi === void 0 ? void 0 : _catalog$meta21$oemFi[canonicalModality]) || DEFAULT_OEM_FIELD;\n            modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta22 = catalog.meta) === null || _catalog$meta22 === void 0 ? void 0 : (_catalog$meta22$model = _catalog$meta22.modelFieldByModalityOem) === null || _catalog$meta22$model === void 0 ? void 0 : (_catalog$meta22$model2 = _catalog$meta22$model[canonicalModality]) === null || _catalog$meta22$model2 === void 0 ? void 0 : _catalog$meta22$model2[canonicalOem]) || null;\n            path = modelField ? \"\".concat(oemField, \".\").concat(canonicalOem, \".\").concat(modelField) : \"\".concat(oemField, \".\").concat(canonicalOem);\n            _context7.next = 18;\n            return docRef.update(_defineProperty({}, path, firebase.firestore.FieldValue.arrayRemove(model)));\n\n          case 18:\n          case \"end\":\n            return _context7.stop();\n        }\n      }\n    }, _callee7);\n  }));\n  return _deleteTrackerModel.apply(this, arguments);\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/utils/trackerCatalog.js"],"names":["firebase","OEM_FIELD_CANDIDATES","MODEL_FIELD_CANDIDATES","DEFAULT_OEM_FIELD","CATALOG_CACHE_KEY","API_FAIL_KEY","CACHE_TTL_MS","API_FAIL_TTL_MS","MIN_MODALITIES_FOR_CACHE","MIN_OEMS_FOR_CACHE","isPlainObject","value","Array","isArray","Date","normalizeKey","String","trim","toLowerCase","hasUpper","test","pickPreferredCase","current","incoming","currentUpper","incomingUpper","normalizeArray","normalizeList","values","out","forEach","normalized","push","from","Set","normalizeListCaseInsensitive","map","Map","key","get","set","readCatalogCache","raw","window","localStorage","getItem","parsed","JSON","parse","savedAt","now","error","writeCatalogCache","payload","setItem","stringify","noteApiFailure","shouldSkipApi","last","Number","pickModelField","obj","arrayKey","Object","keys","find","extractModels","models","modelField","extractOemMap","data","oemMap","modelFieldByOem","oemField","entry","name","oem","OEM","label","normalizedName","list","items","entries","startsWith","length","buildCatalogFromMachines","db","firestore","collection","snap","modalityMap","oemMapByModality","modelMapByModalityOem","ensureDisplay","display","doc","modalityRaw","Modality","modality","oemRaw","modalityLower","oemKeyMap","modelRaw","Model","model","modelKey","oemLower","modelMap","modalities","oemsByModality","modelsByModalityOem","oems","modelByOem","buildCatalogMetaFromMaps","usesSubcollections","syncDisabled","source","buildCatalogFromTestItems","machine","TheMachine","resolveModalitiesInTracker","candidates","confirmed","seen","candidate","lower","upper","toUpperCase","ids","filter","found","id","has","exists","add","mergeCatalogs","baseCatalog","extraCatalog","baseModalities","baseMeta","meta","allowedSet","modalityKey","canonicalModality","modalityKeyByLower","mergedOems","extraModels","destModels","oemFieldByModality","modelFieldByModalityOem","oemKeyByModalityLower","modelKeyByModalityOemLower","normalizedModalities","oemLowerMap","modelLowerMap","modelLower","fetchTrackerCatalog","cached","builtCached","Boolean","cachedOems","buildAllOems","removeItem","fetch","response","ok","json","built","console","warn","existingModality","existingOem","canonicalOem","existingModels","mergedModels","builtFromTracker","allOems","builtFromMachines","builtFromTest","candidateModalities","expandedBase","merged","catalog","buildModelsForSelection","modelSet","modals","oemList","syncTrackerFromSelections","selections","trackerRef","selectedModalities","selectedOems","selectedModels","ops","docRef","existingOemsRaw","existingOemsLower","some","existing","updatedAt","FieldValue","serverTimestamp","merge","oemRef","knownModels","knownLower","modelCaseMap","canonicalModel","path","update","arrayUnion","Promise","allSettled","deleteTrackerOem","then","deletions","ref","deleteTrackerModel","arrayRemove"],"mappings":"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","sourcesContent":["import firebase from \"../context/Firebase\";\n\nconst OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nconst MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nconst DEFAULT_OEM_FIELD = \"oems\";\nconst CATALOG_CACHE_KEY = \"trackerCatalogCache.v5\";\nconst API_FAIL_KEY = \"trackerCatalogApiFail.v1\";\nconst CACHE_TTL_MS = 6 * 60 * 60 * 1000;\nconst API_FAIL_TTL_MS = 60 * 1000;\nconst MIN_MODALITIES_FOR_CACHE = 3;\nconst MIN_OEMS_FOR_CACHE = 3;\n\nconst isPlainObject = (value) =>\n  value != null &&\n  typeof value === \"object\" &&\n  !Array.isArray(value) &&\n  !(value instanceof Date);\n\nconst normalizeKey = (value) => {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nconst hasUpper = (value) => /[A-Z]/.test(String(value || \"\"));\n\nconst pickPreferredCase = (current, incoming) => {\n  if (!current) return incoming;\n  if (!incoming) return current;\n  const currentUpper = hasUpper(current);\n  const incomingUpper = hasUpper(incoming);\n  if (incomingUpper && !currentUpper) return incoming;\n  if (currentUpper && !incomingUpper) return current;\n  return current;\n};\n\nconst normalizeArray = (value) => {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nconst normalizeList = (values) => {\n  const out = [];\n  (values || []).forEach((value) => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    if (normalizeKey(normalized) === \"nan\") return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst normalizeListCaseInsensitive = (values) => {\n  const map = new Map();\n  (values || []).forEach((value) => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    const key = normalizeKey(normalized);\n    if (!key || key === \"nan\") return;\n    const current = map.get(key);\n    map.set(key, pickPreferredCase(current, normalized));\n  });\n  return Array.from(map.values());\n};\n\nconst readCatalogCache = () => {\n  if (typeof window === \"undefined\") return null;\n  try {\n    const raw = window.localStorage.getItem(CATALOG_CACHE_KEY);\n    if (!raw) return null;\n    const parsed = JSON.parse(raw);\n    if (!parsed?.savedAt) return null;\n    if (Date.now() - parsed.savedAt > CACHE_TTL_MS) return null;\n    return parsed;\n  } catch (error) {\n    return null;\n  }\n};\n\nconst writeCatalogCache = (payload) => {\n  if (typeof window === \"undefined\") return;\n  try {\n    window.localStorage.setItem(\n      CATALOG_CACHE_KEY,\n      JSON.stringify({ ...payload, savedAt: Date.now() })\n    );\n  } catch (error) {\n    // ignore cache failures\n  }\n};\n\nconst noteApiFailure = () => {\n  if (typeof window === \"undefined\") return;\n  try {\n    window.localStorage.setItem(API_FAIL_KEY, String(Date.now()));\n  } catch (error) {\n    // ignore\n  }\n};\n\nconst shouldSkipApi = () => {\n  if (typeof window === \"undefined\") return false;\n  try {\n    const raw = window.localStorage.getItem(API_FAIL_KEY);\n    if (!raw) return false;\n    const last = Number(raw);\n    if (!last) return false;\n    return Date.now() - last < API_FAIL_TTL_MS;\n  } catch (error) {\n    return false;\n  }\n};\n\nconst pickModelField = (obj) => {\n  if (!isPlainObject(obj)) return null;\n  for (const key of MODEL_FIELD_CANDIDATES) {\n    if (Array.isArray(obj[key])) return key;\n  }\n  const arrayKey = Object.keys(obj).find((key) => Array.isArray(obj[key]));\n  return arrayKey || null;\n};\n\nconst extractModels = (value) => {\n  if (Array.isArray(value)) {\n    return { models: normalizeList(value), modelField: null };\n  }\n  if (isPlainObject(value)) {\n    const modelField = pickModelField(value);\n    const models = modelField ? normalizeList(value[modelField]) : [];\n    return { models, modelField };\n  }\n  if (value != null && value !== \"\") {\n    return { models: normalizeList([value]), modelField: null };\n  }\n  return { models: [], modelField: null };\n};\n\nconst extractOemMap = (data) => {\n  const oemMap = {};\n  const modelFieldByOem = {};\n  let oemField = null;\n\n  for (const key of OEM_FIELD_CANDIDATES) {\n    if (Array.isArray(data?.[key])) {\n      oemField = key;\n      data[key].forEach((entry) => {\n        if (entry == null) return;\n        if (isPlainObject(entry)) {\n          const name =\n            entry.name ||\n            entry.oem ||\n            entry.OEM ||\n            entry.label ||\n            entry.value;\n          if (!name) return;\n          const normalizedName = String(name).trim();\n          if (!normalizedName) return;\n          const { models } = extractModels(entry.models || entry.list || entry.items);\n          oemMap[normalizedName] = normalizeList([\n            ...(oemMap[normalizedName] || []),\n            ...models,\n          ]);\n          return;\n        }\n        const normalized = String(entry || \"\").trim();\n        if (!normalized) return;\n        oemMap[normalized] = normalizeList([...(oemMap[normalized] || [])]);\n      });\n    } else if (isPlainObject(data?.[key])) {\n      oemField = key;\n      Object.entries(data[key]).forEach(([oem, value]) => {\n        const { models, modelField } = extractModels(value);\n        oemMap[oem] = normalizeList([...(oemMap[oem] || []), ...models]);\n        if (modelField) {\n          modelFieldByOem[oem] = modelField;\n        }\n      });\n    }\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(([key, value]) => {\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n      if (isPlainObject(value) || Array.isArray(value)) {\n        const { models, modelField } = extractModels(value);\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([...(oemMap[key] || []), ...models]);\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return { oemMap, oemField, modelFieldByOem };\n};\n\nconst buildCatalogFromMachines = async () => {\n  const db = firebase.firestore();\n  const snap = await db\n    .collection(\"Machine\")\n    .get();\n\n  const modalityMap = new Map();\n  const oemMapByModality = new Map();\n  const modelMapByModalityOem = new Map();\n\n  const ensureDisplay = (map, value) => {\n    const key = normalizeKey(value);\n    if (!key) return null;\n    const current = map.get(key);\n    const display = pickPreferredCase(current, String(value).trim());\n    map.set(key, display);\n    return display;\n  };\n\n  snap.forEach((doc) => {\n    const data = doc.data() || {};\n    const modalityRaw = data.Modality || data.modality;\n    const oemRaw = data.OEM || data.oem;\n    if (!modalityRaw || !oemRaw) return;\n    const modality = ensureDisplay(modalityMap, modalityRaw);\n    if (!modality) return;\n    const modalityLower = normalizeKey(modality);\n    const oemKeyMap =\n      oemMapByModality.get(modalityLower) || new Map();\n    oemMapByModality.set(modalityLower, oemKeyMap);\n    const oem = ensureDisplay(oemKeyMap, oemRaw);\n    if (!oem) return;\n    const modelRaw = data.Model || data.model;\n    if (!modelRaw) return;\n    const modelKey =\n      modelMapByModalityOem.get(modalityLower) || new Map();\n    modelMapByModalityOem.set(modalityLower, modelKey);\n    const oemLower = normalizeKey(oem);\n    const modelMap = modelKey.get(oemLower) || new Map();\n    modelKey.set(oemLower, modelMap);\n    ensureDisplay(modelMap, modelRaw);\n  });\n\n  const modalities = Array.from(modalityMap.values());\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n\n  modalities.forEach((modality) => {\n    const modalityLower = normalizeKey(modality);\n    const oemMap = oemMapByModality.get(modalityLower) || new Map();\n    const oems = Array.from(oemMap.values());\n    oemsByModality[modality] = oems;\n    const modelMap = modelMapByModalityOem.get(modalityLower) || new Map();\n    const modelByOem = {};\n    oems.forEach((oem) => {\n      const oemLower = normalizeKey(oem);\n      const models = Array.from(\n        (modelMap.get(oemLower) || new Map()).values()\n      );\n      if (models.length) modelByOem[oem] = models;\n    });\n    modelsByModalityOem[modality] = modelByOem;\n  });\n\n  return buildCatalogMetaFromMaps({\n    modalities,\n    oemsByModality,\n    modelsByModalityOem,\n    usesSubcollections: true,\n    syncDisabled: false,\n    source: \"machine\",\n  });\n};\n\nconst buildCatalogFromTestItems = async () => {\n  const db = firebase.firestore();\n  const snap = await db\n    .collection(\"Test\")\n    .get();\n\n  const modalityMap = new Map();\n  const oemMapByModality = new Map();\n  const modelMapByModalityOem = new Map();\n\n  const ensureDisplay = (map, value) => {\n    const key = normalizeKey(value);\n    if (!key) return null;\n    const current = map.get(key);\n    const display = pickPreferredCase(current, String(value).trim());\n    map.set(key, display);\n    return display;\n  };\n\n  snap.forEach((doc) => {\n    const data = doc.data() || {};\n    const machine = data.TheMachine || {};\n    const modalityRaw =\n      machine.Modality || machine.modality || data.Modality || data.modality;\n    const oemRaw =\n      machine.OEM || machine.oem || data.OEM || data.oem;\n    if (!modalityRaw || !oemRaw) return;\n    const modality = ensureDisplay(modalityMap, modalityRaw);\n    if (!modality) return;\n    const modalityLower = normalizeKey(modality);\n    const oemKeyMap =\n      oemMapByModality.get(modalityLower) || new Map();\n    oemMapByModality.set(modalityLower, oemKeyMap);\n    const oem = ensureDisplay(oemKeyMap, oemRaw);\n    if (!oem) return;\n    const modelRaw =\n      machine.Model || machine.model || data.Model || data.model;\n    if (!modelRaw) return;\n    const modelKey =\n      modelMapByModalityOem.get(modalityLower) || new Map();\n    modelMapByModalityOem.set(modalityLower, modelKey);\n    const oemLower = normalizeKey(oem);\n    const modelMap = modelKey.get(oemLower) || new Map();\n    modelKey.set(oemLower, modelMap);\n    ensureDisplay(modelMap, modelRaw);\n  });\n\n  const modalities = Array.from(modalityMap.values());\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n\n  modalities.forEach((modality) => {\n    const modalityLower = normalizeKey(modality);\n    const oemMap = oemMapByModality.get(modalityLower) || new Map();\n    const oems = Array.from(oemMap.values());\n    oemsByModality[modality] = oems;\n    const modelMap = modelMapByModalityOem.get(modalityLower) || new Map();\n    const modelByOem = {};\n    oems.forEach((oem) => {\n      const oemLower = normalizeKey(oem);\n      const models = Array.from(\n        (modelMap.get(oemLower) || new Map()).values()\n      );\n      if (models.length) modelByOem[oem] = models;\n    });\n    modelsByModalityOem[modality] = modelByOem;\n  });\n\n  return buildCatalogMetaFromMaps({\n    modalities,\n    oemsByModality,\n    modelsByModalityOem,\n    usesSubcollections: true,\n    syncDisabled: false,\n    source: \"test\",\n  });\n};\n\nconst resolveModalitiesInTracker = async (db, candidates = []) => {\n  const confirmed = [];\n  const seen = new Set();\n  for (const candidate of candidates) {\n    const raw = String(candidate || \"\").trim();\n    if (!raw) continue;\n    const lower = normalizeKey(raw);\n    const upper = raw.toUpperCase();\n    const ids = Array.from(\n      new Set([raw, lower, upper].filter((value) => value))\n    );\n    let found = null;\n    for (const id of ids) {\n      if (seen.has(id)) continue;\n      try {\n        const doc = await db.collection(\"Tracker\").doc(id).get();\n        if (doc.exists) {\n          found = doc.id;\n          break;\n        }\n      } catch (error) {\n        // ignore permission/other errors\n      }\n    }\n    if (found) {\n      const key = normalizeKey(found);\n      if (!seen.has(key)) {\n        seen.add(key);\n        confirmed.push(found);\n      }\n    }\n  }\n  return normalizeListCaseInsensitive(confirmed);\n};\n\nconst mergeCatalogs = (baseCatalog, extraCatalog, source) => {\n  const baseModalities = baseCatalog?.modalities || [];\n  const baseMeta = baseCatalog?.meta || {};\n  const allowedSet = baseModalities.length\n    ? new Set(baseModalities.map((value) => normalizeKey(value)))\n    : null;\n\n  const modalities = allowedSet\n    ? baseModalities\n    : normalizeListCaseInsensitive([\n        ...baseModalities,\n        ...(extraCatalog?.modalities || []),\n      ]);\n\n  const oemsByModality = { ...(baseCatalog?.oemsByModality || {}) };\n  const modelsByModalityOem = {\n    ...(baseCatalog?.modelsByModalityOem || {}),\n  };\n\n  Object.entries(extraCatalog?.oemsByModality || {}).forEach(\n    ([modality, oems]) => {\n      const modalityKey = normalizeKey(modality);\n      if (allowedSet && !allowedSet.has(modalityKey)) return;\n      const canonicalModality =\n        baseMeta?.modalityKeyByLower?.[modalityKey] ||\n        modalities.find((value) => normalizeKey(value) === modalityKey) ||\n        modality;\n      const mergedOems = normalizeListCaseInsensitive([\n        ...(oemsByModality[canonicalModality] || []),\n        ...(oems || []),\n      ]);\n      oemsByModality[canonicalModality] = mergedOems;\n\n      const extraModels =\n        extraCatalog?.modelsByModalityOem?.[modality] || {};\n      const destModels =\n        modelsByModalityOem[canonicalModality] || {};\n      Object.entries(extraModels).forEach(([oem, models]) => {\n        destModels[oem] = normalizeListCaseInsensitive([\n          ...(destModels[oem] || []),\n          ...(models || []),\n        ]);\n      });\n      modelsByModalityOem[canonicalModality] = destModels;\n    }\n  );\n\n  return buildCatalogMetaFromMaps({\n    modalities,\n    oemsByModality,\n    modelsByModalityOem,\n    usesSubcollections: true,\n    syncDisabled: false,\n    source,\n  });\n};\n\nconst buildCatalogMetaFromMaps = ({\n  modalities = [],\n  oemsByModality = {},\n  modelsByModalityOem = {},\n  usesSubcollections = false,\n  syncDisabled = false,\n  source = \"client\",\n}) => {\n  const meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n    modalityKeyByLower: {},\n    oemKeyByModalityLower: {},\n    modelKeyByModalityOemLower: {},\n    usesSubcollections,\n    syncDisabled,\n    source,\n  };\n\n  const normalizedModalities = normalizeListCaseInsensitive(modalities);\n  normalizedModalities.forEach((modality) => {\n    const modalityLower = normalizeKey(modality);\n    meta.modalityKeyByLower[modalityLower] = pickPreferredCase(\n      meta.modalityKeyByLower[modalityLower],\n      modality\n    );\n    const oems = oemsByModality?.[modality] || [];\n    const oemLowerMap =\n      meta.oemKeyByModalityLower[modalityLower] || {};\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n    const modelLowerMap =\n      meta.modelKeyByModalityOemLower[modalityLower] || {};\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n\n    oems.forEach((oem) => {\n      const oemLower = normalizeKey(oem);\n      oemLowerMap[oemLower] = pickPreferredCase(oemLowerMap[oemLower], oem);\n      const models = modelsByModalityOem?.[modality]?.[oem] || [];\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n      models.forEach((model) => {\n        const modelLower = normalizeKey(model);\n        if (!modelLower) return;\n        modelLowerMap[oemLower][modelLower] = pickPreferredCase(\n          modelLowerMap[oemLower][modelLower],\n          model\n        );\n      });\n    });\n  });\n\n  return {\n    modalities: normalizedModalities,\n    oemsByModality,\n    modelsByModalityOem,\n    meta,\n  };\n};\n\nexport async function fetchTrackerCatalog() {\n  if (typeof window !== \"undefined\") {\n    const cached = readCatalogCache();\n    if (cached?.modalities) {\n      const builtCached = buildCatalogMetaFromMaps({\n        modalities: cached.modalities || [],\n        oemsByModality: cached.oemsByModality || {},\n        modelsByModalityOem: cached.modelsByModalityOem || {},\n        usesSubcollections: Boolean(cached.usesSubcollections),\n        syncDisabled: Boolean(cached.syncDisabled),\n        source: cached.source || \"cache\",\n      });\n      const cachedOems = buildAllOems(builtCached);\n      if (\n        builtCached.modalities.length >= MIN_MODALITIES_FOR_CACHE &&\n        cachedOems.length >= MIN_OEMS_FOR_CACHE\n      ) {\n        return builtCached;\n      }\n      try {\n        window.localStorage.removeItem(CATALOG_CACHE_KEY);\n      } catch (error) {\n        // ignore\n      }\n    }\n  }\n\n  if (typeof window !== \"undefined\" && !shouldSkipApi()) {\n    try {\n      const response = await fetch(\"/api/tracker/catalog\");\n      if (response.ok) {\n        const payload = await response.json();\n        if (payload?.modalities) {\n          const built = buildCatalogMetaFromMaps({\n            modalities: payload.modalities || [],\n            oemsByModality: payload.oemsByModality || {},\n            modelsByModalityOem: payload.modelsByModalityOem || {},\n            usesSubcollections: Boolean(payload.usesSubcollections),\n            syncDisabled: false,\n            source: \"server\",\n          });\n          writeCatalogCache({\n            modalities: built.modalities,\n            oemsByModality: built.oemsByModality,\n            modelsByModalityOem: built.modelsByModalityOem,\n            usesSubcollections: built.meta?.usesSubcollections,\n            syncDisabled: built.meta?.syncDisabled,\n            source: built.meta?.source,\n          });\n          return built;\n        }\n      } else {\n        noteApiFailure();\n      }\n    } catch (error) {\n      console.warn(\"Tracker catalog API fallback:\", error);\n      noteApiFailure();\n    }\n  } else if (typeof window !== \"undefined\") {\n    noteApiFailure();\n  }\n\n  const db = firebase.firestore();\n  const snap = await db.collection(\"Tracker\").get();\n\n  const modalities = [];\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n  const meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n    modalityKeyByLower: {},\n    oemKeyByModalityLower: {},\n    modelKeyByModalityOemLower: {},\n  };\n\n  snap.forEach((doc) => {\n    const modality = doc.id;\n    const modalityLower = normalizeKey(modality);\n    const existingModality = meta.modalityKeyByLower[modalityLower];\n    const canonicalModality = pickPreferredCase(existingModality, modality);\n    meta.modalityKeyByLower[modalityLower] = canonicalModality;\n    const data = doc.data() || {};\n    const { oemMap, oemField, modelFieldByOem } = extractOemMap(data);\n\n    if (existingModality && existingModality !== canonicalModality) {\n      oemsByModality[canonicalModality] = normalizeListCaseInsensitive([\n        ...(oemsByModality[existingModality] || []),\n        ...(oemsByModality[canonicalModality] || []),\n      ]);\n      modelsByModalityOem[canonicalModality] = {\n        ...(modelsByModalityOem[existingModality] || {}),\n        ...(modelsByModalityOem[canonicalModality] || {}),\n      };\n      meta.modelFieldByModalityOem[canonicalModality] = {\n        ...(meta.modelFieldByModalityOem[existingModality] || {}),\n        ...(meta.modelFieldByModalityOem[canonicalModality] || {}),\n      };\n      if (!meta.oemFieldByModality[canonicalModality]) {\n        meta.oemFieldByModality[canonicalModality] =\n          meta.oemFieldByModality[existingModality] || oemField;\n      }\n      delete oemsByModality[existingModality];\n      delete modelsByModalityOem[existingModality];\n      delete meta.oemFieldByModality[existingModality];\n      delete meta.modelFieldByModalityOem[existingModality];\n    }\n\n    modalities.push(canonicalModality);\n    if (!meta.oemFieldByModality[canonicalModality]) {\n      meta.oemFieldByModality[canonicalModality] = oemField;\n    }\n    meta.modelFieldByModalityOem[canonicalModality] = {\n      ...(meta.modelFieldByModalityOem[canonicalModality] || {}),\n      ...(modelFieldByOem || {}),\n    };\n\n    const oems = Object.keys(oemMap);\n    const mergedOems = normalizeListCaseInsensitive([\n      ...(oemsByModality[canonicalModality] || []),\n      ...oems,\n    ]);\n    oemsByModality[canonicalModality] = mergedOems;\n    modelsByModalityOem[canonicalModality] =\n      modelsByModalityOem[canonicalModality] || {};\n    const oemLowerMap =\n      meta.oemKeyByModalityLower[modalityLower] || {};\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n    const modelLowerMap =\n      meta.modelKeyByModalityOemLower[modalityLower] || {};\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n    oems.forEach((oem) => {\n      const oemLower = normalizeKey(oem);\n      const existingOem = oemLowerMap[oemLower];\n      const canonicalOem = pickPreferredCase(existingOem, oem);\n      oemLowerMap[oemLower] = canonicalOem;\n      if (existingOem && existingOem !== canonicalOem) {\n        modelsByModalityOem[canonicalModality][canonicalOem] = normalizeListCaseInsensitive([\n          ...(modelsByModalityOem[canonicalModality][existingOem] || []),\n          ...(modelsByModalityOem[canonicalModality][canonicalOem] || []),\n        ]);\n        delete modelsByModalityOem[canonicalModality][existingOem];\n      }\n      const existingModels =\n        modelsByModalityOem[canonicalModality][canonicalOem] || [];\n      const mergedModels = normalizeListCaseInsensitive([\n        ...existingModels,\n        ...(oemMap[oem] || []),\n      ]);\n      modelsByModalityOem[canonicalModality][canonicalOem] = mergedModels;\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n      mergedModels.forEach((model) => {\n        modelLowerMap[oemLower][normalizeKey(model)] = model;\n      });\n    });\n  });\n\n  const builtFromTracker = buildCatalogMetaFromMaps({\n    modalities,\n    oemsByModality,\n    modelsByModalityOem,\n    usesSubcollections: true,\n    syncDisabled: true,\n    source: \"client\",\n  });\n\n  const allOems = buildAllOems(builtFromTracker);\n  if (\n    builtFromTracker.modalities.length < MIN_MODALITIES_FOR_CACHE ||\n    allOems.length < MIN_OEMS_FOR_CACHE\n  ) {\n    let builtFromMachines = null;\n    let builtFromTest = null;\n\n    try {\n      builtFromMachines = await buildCatalogFromMachines();\n    } catch (error) {\n      console.warn(\"Tracker catalog machine fallback failed:\", error);\n    }\n\n    try {\n      builtFromTest = await buildCatalogFromTestItems();\n    } catch (error) {\n      console.warn(\"Tracker catalog test fallback failed:\", error);\n    }\n\n    const candidateModalities = normalizeListCaseInsensitive([\n      ...(builtFromMachines?.modalities || []),\n      ...(builtFromTest?.modalities || []),\n    ]);\n\n    let expandedBase = builtFromTracker;\n    if (candidateModalities.length) {\n      try {\n        const confirmed = await resolveModalitiesInTracker(\n          db,\n          candidateModalities\n        );\n        if (confirmed.length) {\n          expandedBase = buildCatalogMetaFromMaps({\n            modalities: normalizeListCaseInsensitive([\n              ...builtFromTracker.modalities,\n              ...confirmed,\n            ]),\n            oemsByModality: builtFromTracker.oemsByModality,\n            modelsByModalityOem: builtFromTracker.modelsByModalityOem,\n            usesSubcollections: true,\n            syncDisabled: builtFromTracker.meta?.syncDisabled,\n            source: builtFromTracker.meta?.source,\n          });\n        }\n      } catch (error) {\n        // ignore\n      }\n    }\n\n    let merged = expandedBase;\n    if (builtFromMachines) {\n      merged = mergeCatalogs(merged, builtFromMachines, \"machine+tracker\");\n    }\n    if (builtFromTest) {\n      merged = mergeCatalogs(merged, builtFromTest, \"test+tracker\");\n    }\n\n    if (merged?.modalities?.length) {\n      writeCatalogCache({\n        modalities: merged.modalities,\n        oemsByModality: merged.oemsByModality,\n        modelsByModalityOem: merged.modelsByModalityOem,\n        usesSubcollections: merged.meta?.usesSubcollections,\n        syncDisabled: merged.meta?.syncDisabled,\n        source: merged.meta?.source,\n      });\n      return merged;\n    }\n  }\n\n  writeCatalogCache({\n    modalities: builtFromTracker.modalities,\n    oemsByModality: builtFromTracker.oemsByModality,\n    modelsByModalityOem: builtFromTracker.modelsByModalityOem,\n    usesSubcollections: builtFromTracker.meta?.usesSubcollections,\n    syncDisabled: builtFromTracker.meta?.syncDisabled,\n    source: builtFromTracker.meta?.source,\n  });\n\n  return builtFromTracker;\n}\n\nexport function buildAllOems(catalog) {\n  const map = new Map();\n  Object.values(catalog?.oemsByModality || {}).forEach((oems) => {\n    (oems || []).forEach((oem) => {\n      const key = normalizeKey(oem);\n      if (!key) return;\n      const current = map.get(key);\n      map.set(key, pickPreferredCase(current, oem));\n    });\n  });\n  return Array.from(map.values());\n}\n\nexport function buildModelsForSelection(catalog, modalities = [], oems = []) {\n  const modelSet = new Set();\n  const modals = normalizeList(modalities);\n  const oemList = normalizeList(oems);\n  modals.forEach((modality) => {\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality =\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\n    const oemMap = catalog?.modelsByModalityOem?.[canonicalModality] || {};\n    oemList.forEach((oem) => {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem =\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] || oem;\n      const models = oemMap?.[canonicalOem] || [];\n      models.forEach((model) => modelSet.add(model));\n    });\n  });\n  return Array.from(modelSet);\n}\n\nexport async function syncTrackerFromSelections({\n  selections,\n  catalog,\n}) {\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const selectedModalities = normalizeList(selections?.modalities || []);\n  const selectedOems = normalizeList(selections?.oems || []);\n  const selectedModels = normalizeList(selections?.models || []);\n\n  if (!selectedModalities.length) return false;\n  if (catalog?.meta?.syncDisabled) return false;\n\n  const ops = [];\n  const usesSubcollections = Boolean(catalog?.meta?.usesSubcollections);\n\n  for (const modality of selectedModalities) {\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality =\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modalityLower;\n    const docRef = trackerRef.doc(canonicalModality);\n    const existingOemsRaw = catalog?.oemsByModality?.[canonicalModality] || [];\n    const existingOemsLower = new Set(\n      existingOemsRaw.map((value) => normalizeKey(value))\n    );\n\n    if (usesSubcollections) {\n      if (\n        !catalog?.modalities?.some(\n          (existing) => normalizeKey(existing) === modalityLower\n        )\n      ) {\n        ops.push(docRef.set({ updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }));\n      }\n\n      for (const oem of selectedOems) {\n        const oemLower = normalizeKey(oem);\n        const canonicalOem =\n          catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] ||\n          oemLower;\n        const oemRef = docRef.collection(canonicalOem);\n\n        if (!selectedModels.length) continue;\n        const knownModels =\n          catalog?.modelsByModalityOem?.[canonicalModality]?.[canonicalOem] || [];\n        const knownLower = new Set(\n          knownModels.map((value) => normalizeKey(value))\n        );\n        const modelCaseMap =\n          catalog?.meta?.modelKeyByModalityOemLower?.[modalityLower]?.[oemLower] ||\n          {};\n\n        for (const model of selectedModels) {\n          const modelLower = normalizeKey(model);\n          if (!modelLower || knownLower.has(modelLower)) continue;\n          const canonicalModel = modelCaseMap[modelLower] || model;\n          ops.push(\n            oemRef.doc(modelLower).set(\n              { name: canonicalModel },\n              { merge: true }\n            )\n          );\n        }\n      }\n      continue;\n    }\n\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\n      DEFAULT_OEM_FIELD;\n\n    if (\n      !catalog?.modalities?.some(\n        (existing) => normalizeKey(existing) === modalityLower\n      )\n    ) {\n      ops.push(docRef.set({ [DEFAULT_OEM_FIELD]: {} }, { merge: true }));\n    }\n\n    for (const oem of selectedOems) {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem =\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] ||\n        oemLower;\n      if (!existingOemsLower.has(oemLower)) {\n        ops.push(\n          docRef.set({ [oemField]: { [canonicalOem]: [] } }, { merge: true })\n        );\n      }\n    }\n\n    for (const oem of selectedOems) {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem =\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] ||\n        oemLower;\n      const knownModels =\n        catalog?.modelsByModalityOem?.[canonicalModality]?.[canonicalOem] || [];\n      const knownLower = new Set(\n        knownModels.map((value) => normalizeKey(value))\n      );\n      const modelCaseMap =\n        catalog?.meta?.modelKeyByModalityOemLower?.[modalityLower]?.[oemLower] ||\n        {};\n      const modelField =\n        catalog?.meta?.modelFieldByModalityOem?.[canonicalModality]?.[\n          canonicalOem\n        ] || null;\n      for (const model of selectedModels) {\n        const modelLower = normalizeKey(model);\n        if (!modelLower || knownLower.has(modelLower)) continue;\n        const canonicalModel = modelCaseMap[modelLower] || model;\n        const path = modelField\n          ? `${oemField}.${canonicalOem}.${modelField}`\n          : `${oemField}.${canonicalOem}`;\n        ops.push(\n          docRef.update({\n            [path]: firebase.firestore.FieldValue.arrayUnion(canonicalModel),\n          })\n        );\n      }\n    }\n  }\n\n  if (ops.length) {\n    await Promise.allSettled(ops);\n    return true;\n  }\n  return false;\n}\n\nexport async function deleteTrackerOem({ oem, catalog }) {\n  if (!oem) return;\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const modalities = catalog?.modalities || [];\n  const usesSubcollections = Boolean(catalog?.meta?.usesSubcollections);\n  const ops = modalities.map((modality) => {\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality =\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\n    const docRef = trackerRef.doc(canonicalModality);\n    const canonicalOem =\n      catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[\n        normalizeKey(oem)\n      ] || oem;\n    if (usesSubcollections) {\n      return docRef\n        .collection(canonicalOem)\n        .get()\n        .then((snap) => {\n          const deletions = [];\n          snap.forEach((doc) => {\n            deletions.push(doc.ref.delete());\n          });\n          return Promise.allSettled(deletions);\n        })\n        .catch(() => null);\n    }\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\n      DEFAULT_OEM_FIELD;\n    const update = {\n      [`${oemField}.${canonicalOem}`]: firebase.firestore.FieldValue.delete(),\n    };\n    if (!catalog?.meta?.oemFieldByModality?.[canonicalModality]) {\n      update[canonicalOem] = firebase.firestore.FieldValue.delete();\n    }\n    return docRef.update(update).catch(() => null);\n  });\n  await Promise.allSettled(ops);\n}\n\nexport async function deleteTrackerModel({\n  modality,\n  oem,\n  model,\n  catalog,\n}) {\n  if (!modality || !oem || !model) return;\n  const db = firebase.firestore();\n  const modalityLower = normalizeKey(modality);\n  const canonicalModality =\n    catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\n  const docRef = db.collection(\"Tracker\").doc(canonicalModality);\n  const canonicalOem =\n    catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[\n      normalizeKey(oem)\n    ] || oem;\n  if (catalog?.meta?.usesSubcollections) {\n    const modelKey = normalizeKey(model);\n    await docRef\n      .collection(canonicalOem)\n      .doc(modelKey)\n      .delete()\n      .catch(() => null);\n    return;\n  }\n  const oemField =\n    catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\n    DEFAULT_OEM_FIELD;\n  const modelField =\n    catalog?.meta?.modelFieldByModalityOem?.[canonicalModality]?.[\n      canonicalOem\n    ] || null;\n  const path = modelField\n    ? `${oemField}.${canonicalOem}.${modelField}`\n    : `${oemField}.${canonicalOem}`;\n  await docRef.update({\n    [path]: firebase.firestore.FieldValue.arrayRemove(model),\n  });\n}\n"]},"metadata":{},"sourceType":"module"}