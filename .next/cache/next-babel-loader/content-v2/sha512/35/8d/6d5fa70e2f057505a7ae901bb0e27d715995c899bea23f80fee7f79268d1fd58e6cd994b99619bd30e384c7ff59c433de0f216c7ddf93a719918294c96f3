{"ast":null,"code":"import _defineProperty from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _slicedToArray from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _toConsumableArray from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _regeneratorRuntime from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"C:/Users/mack2/Desktop/code/node_modules/next/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it[\"return\"] != null) it[\"return\"](); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nimport React from 'react';\nimport firebase from \"../context/Firebase\";\nexport function fetchPartsWithMachineData() {\n  return _fetchPartsWithMachineData.apply(this, arguments);\n} // Paginated version for faster list views (e.g., mainSearch).\n// Uses documentId order for stable pagination.\n\nfunction _fetchPartsWithMachineData() {\n  _fetchPartsWithMachineData = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n    var db, partsSnapshot, parts;\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            db = firebase.firestore();\n            _context3.next = 3;\n            return db.collection(\"Test\").get();\n\n          case 3:\n            partsSnapshot = _context3.sent;\n            _context3.next = 6;\n            return Promise.all(partsSnapshot.docs.map( /*#__PURE__*/function () {\n              var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(partDoc) {\n                var _ref3, _getRefId, _ref4, _getRefId2;\n\n                var partData, getRefId, fetchMachineData, machineRef, currentMachineRef, machineData, clientRef, clientId, clientDoc, currentMachineData, _clientRef, _clientId, _clientDoc;\n\n                return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n                  while (1) {\n                    switch (_context2.prev = _context2.next) {\n                      case 0:\n                        partData = partDoc.data();\n                        partData.id = partDoc.id; // Add document ID here\n\n                        getRefId = function getRefId(ref) {\n                          if (!ref) return null;\n                          if (typeof ref === \"string\") return ref;\n                          if (ref instanceof firebase.firestore.DocumentReference) return ref.id;\n                          if (ref.id) return ref.id;\n                          return null;\n                        };\n\n                        partData.clientFromId = (_ref3 = (_getRefId = getRefId(partData === null || partData === void 0 ? void 0 : partData.ClientFrom)) !== null && _getRefId !== void 0 ? _getRefId : partData === null || partData === void 0 ? void 0 : partData.clientFromId) !== null && _ref3 !== void 0 ? _ref3 : null;\n                        partData.clientCurrentId = (_ref4 = (_getRefId2 = getRefId(partData === null || partData === void 0 ? void 0 : partData.ClientCurrent)) !== null && _getRefId2 !== void 0 ? _getRefId2 : partData === null || partData === void 0 ? void 0 : partData.clientCurrentId) !== null && _ref4 !== void 0 ? _ref4 : null; // console.log(partData);\n\n                        fetchMachineData = /*#__PURE__*/function () {\n                          var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ref) {\n                            var doc, _doc, _doc2;\n\n                            return _regeneratorRuntime.wrap(function _callee$(_context) {\n                              while (1) {\n                                switch (_context.prev = _context.next) {\n                                  case 0:\n                                    if (ref) {\n                                      _context.next = 2;\n                                      break;\n                                    }\n\n                                    return _context.abrupt(\"return\", null);\n\n                                  case 2:\n                                    if (!(typeof ref.get === \"function\")) {\n                                      _context.next = 7;\n                                      break;\n                                    }\n\n                                    _context.next = 5;\n                                    return ref.get();\n\n                                  case 5:\n                                    doc = _context.sent;\n                                    return _context.abrupt(\"return\", doc.exists ? doc.data() : null);\n\n                                  case 7:\n                                    if (!(typeof ref === \"string\")) {\n                                      _context.next = 12;\n                                      break;\n                                    }\n\n                                    _context.next = 10;\n                                    return db.collection(\"Machine\").doc(ref).get();\n\n                                  case 10:\n                                    _doc = _context.sent;\n                                    return _context.abrupt(\"return\", _doc.exists ? _doc.data() : null);\n\n                                  case 12:\n                                    if (!(ref !== null && ref !== void 0 && ref.id)) {\n                                      _context.next = 17;\n                                      break;\n                                    }\n\n                                    _context.next = 15;\n                                    return db.collection(\"Machine\").doc(ref.id).get();\n\n                                  case 15:\n                                    _doc2 = _context.sent;\n                                    return _context.abrupt(\"return\", _doc2.exists ? _doc2.data() : null);\n\n                                  case 17:\n                                    return _context.abrupt(\"return\", null);\n\n                                  case 18:\n                                  case \"end\":\n                                    return _context.stop();\n                                }\n                              }\n                            }, _callee);\n                          }));\n\n                          return function fetchMachineData(_x7) {\n                            return _ref5.apply(this, arguments);\n                          };\n                        }();\n\n                        machineRef = partData.Machine || partData.MachineFrom;\n                        currentMachineRef = partData.CurrentMachine || partData.MachineCurrent;\n                        _context2.next = 10;\n                        return fetchMachineData(machineRef);\n\n                      case 10:\n                        machineData = _context2.sent;\n                        partData.machineData = machineData || {};\n\n                        if (!(machineData !== null && machineData !== void 0 && machineData.client)) {\n                          _context2.next = 21;\n                          break;\n                        }\n\n                        clientRef = machineData.client;\n                        clientId = getRefId(clientRef);\n\n                        if (clientId && !partData.clientFromId) {\n                          partData.clientFromId = clientId;\n                        }\n\n                        if (!(typeof (clientRef === null || clientRef === void 0 ? void 0 : clientRef.get) === \"function\")) {\n                          _context2.next = 21;\n                          break;\n                        }\n\n                        _context2.next = 19;\n                        return clientRef.get();\n\n                      case 19:\n                        clientDoc = _context2.sent;\n                        partData.machineData.Client = clientDoc.exists ? clientDoc.data().name : \"\";\n\n                      case 21:\n                        _context2.next = 23;\n                        return fetchMachineData(currentMachineRef);\n\n                      case 23:\n                        currentMachineData = _context2.sent;\n                        partData.currentMachineData = currentMachineData || {};\n\n                        if (!(currentMachineData !== null && currentMachineData !== void 0 && currentMachineData.client)) {\n                          _context2.next = 34;\n                          break;\n                        }\n\n                        _clientRef = currentMachineData.client;\n                        _clientId = getRefId(_clientRef);\n\n                        if (_clientId && !partData.clientCurrentId) {\n                          partData.clientCurrentId = _clientId;\n                        }\n\n                        if (!(typeof (_clientRef === null || _clientRef === void 0 ? void 0 : _clientRef.get) === \"function\")) {\n                          _context2.next = 34;\n                          break;\n                        }\n\n                        _context2.next = 32;\n                        return _clientRef.get();\n\n                      case 32:\n                        _clientDoc = _context2.sent;\n                        partData.currentMachineData.Client = _clientDoc.exists ? _clientDoc.data().name : \"\";\n\n                      case 34:\n                        return _context2.abrupt(\"return\", partData);\n\n                      case 35:\n                      case \"end\":\n                        return _context2.stop();\n                    }\n                  }\n                }, _callee2);\n              }));\n\n              return function (_x6) {\n                return _ref2.apply(this, arguments);\n              };\n            }()));\n\n          case 6:\n            parts = _context3.sent;\n            return _context3.abrupt(\"return\", parts);\n\n          case 8:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3);\n  }));\n  return _fetchPartsWithMachineData.apply(this, arguments);\n}\n\nexport function fetchPartsWithMachineDataPage() {\n  return _fetchPartsWithMachineDataPage.apply(this, arguments);\n}\n\nfunction _fetchPartsWithMachineDataPage() {\n  _fetchPartsWithMachineDataPage = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6() {\n    var _ref,\n        _ref$pageSize,\n        pageSize,\n        _ref$startAfterDoc,\n        startAfterDoc,\n        _ref$visibleOnly,\n        visibleOnly,\n        _ref$filterFn,\n        filterFn,\n        _ref$needsMachineData,\n        needsMachineData,\n        _ref$search,\n        search,\n        db,\n        limit,\n        getRefId,\n        MACHINE_SELECT_FIELDS,\n        withMachineSelect,\n        buildPart,\n        searchRaw,\n        searchLower,\n        searchType,\n        hasSearch,\n        toTitleCase,\n        buildSearchQuery,\n        _buildSearchQuery,\n        searchMode,\n        searchQuery,\n        searchFallback,\n        docs,\n        rawUpper,\n        doc,\n        localValues,\n        localSnap,\n        machineMap,\n        currentMachineMap,\n        machineIds,\n        currentMachineIds,\n        _iterator,\n        _step,\n        docSnap,\n        raw,\n        machineId,\n        currentMachineId,\n        fetchMachineMap,\n        _yield$Promise$all,\n        _yield$Promise$all2,\n        built,\n        parts,\n        cursor,\n        lastDoc,\n        pageLastDoc,\n        hasNextPage,\n        filled,\n        usedFallback,\n        scanBaseQuery,\n        query,\n        snap,\n        batchDocs,\n        _machineMap,\n        _currentMachineMap,\n        _machineIds,\n        _currentMachineIds,\n        _iterator2,\n        _step2,\n        _doc3,\n        _raw,\n        _machineId,\n        _currentMachineId,\n        _fetchMachineMap,\n        _yield$Promise$all3,\n        _yield$Promise$all4,\n        i,\n        _doc4,\n        _raw2,\n        _built,\n        _args6 = arguments;\n\n    return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            _ref = _args6.length > 0 && _args6[0] !== undefined ? _args6[0] : {}, _ref$pageSize = _ref.pageSize, pageSize = _ref$pageSize === void 0 ? 25 : _ref$pageSize, _ref$startAfterDoc = _ref.startAfterDoc, startAfterDoc = _ref$startAfterDoc === void 0 ? null : _ref$startAfterDoc, _ref$visibleOnly = _ref.visibleOnly, visibleOnly = _ref$visibleOnly === void 0 ? false : _ref$visibleOnly, _ref$filterFn = _ref.filterFn, filterFn = _ref$filterFn === void 0 ? null : _ref$filterFn, _ref$needsMachineData = _ref.needsMachineData, needsMachineData = _ref$needsMachineData === void 0 ? true : _ref$needsMachineData, _ref$search = _ref.search, search = _ref$search === void 0 ? null : _ref$search;\n            db = firebase.firestore();\n            limit = pageSize + 1;\n\n            getRefId = function getRefId(ref) {\n              if (!ref) return null;\n              if (typeof ref === \"string\") return ref;\n              if (ref instanceof firebase.firestore.DocumentReference) return ref.id;\n              if (ref.id) return ref.id;\n              return null;\n            };\n\n            MACHINE_SELECT_FIELDS = [\"OEM\", \"Modality\", \"Model\", \"client\", \"name\"];\n\n            withMachineSelect = function withMachineSelect(query) {\n              return typeof query.select === \"function\" ? query.select.apply(query, MACHINE_SELECT_FIELDS) : query;\n            };\n\n            buildPart = function buildPart(partDoc, machineMap, currentMachineMap) {\n              var _ref6, _getRefId3, _ref7, _getRefId4;\n\n              var partData = partDoc.data();\n              partData.id = partDoc.id; // Add document ID here\n\n              partData.clientFromId = (_ref6 = (_getRefId3 = getRefId(partData === null || partData === void 0 ? void 0 : partData.ClientFrom)) !== null && _getRefId3 !== void 0 ? _getRefId3 : partData === null || partData === void 0 ? void 0 : partData.clientFromId) !== null && _ref6 !== void 0 ? _ref6 : null;\n              partData.clientCurrentId = (_ref7 = (_getRefId4 = getRefId(partData === null || partData === void 0 ? void 0 : partData.ClientCurrent)) !== null && _getRefId4 !== void 0 ? _getRefId4 : partData === null || partData === void 0 ? void 0 : partData.clientCurrentId) !== null && _ref7 !== void 0 ? _ref7 : null;\n              var machineRef = partData.Machine || partData.MachineFrom;\n              var currentMachineRef = partData.CurrentMachine || partData.MachineCurrent;\n              var machineId = getRefId(machineRef);\n              var currentMachineId = getRefId(currentMachineRef);\n              var machineData = machineId ? machineMap[machineId] : null;\n              var currentMachineData = currentMachineId ? currentMachineMap[currentMachineId] : null;\n              partData.machineData = machineData || {};\n              partData.currentMachineData = currentMachineData || {};\n\n              if (!partData.clientFromId && machineData !== null && machineData !== void 0 && machineData.client) {\n                partData.clientFromId = getRefId(machineData.client);\n              }\n\n              if (!partData.clientCurrentId && currentMachineData !== null && currentMachineData !== void 0 && currentMachineData.client) {\n                partData.clientCurrentId = getRefId(currentMachineData.client);\n              }\n\n              return partData;\n            };\n\n            searchRaw = ((search === null || search === void 0 ? void 0 : search.raw) || \"\").toString().trim();\n            searchLower = ((search === null || search === void 0 ? void 0 : search.lower) || \"\").toString().trim();\n            searchType = (search === null || search === void 0 ? void 0 : search.type) || null;\n            hasSearch = Boolean(searchRaw);\n\n            toTitleCase = function toTitleCase(text) {\n              return text.split(\" \").filter(Boolean).map(function (word) {\n                return word.charAt(0).toUpperCase() + word.slice(1);\n              }).join(\" \");\n            };\n\n            buildSearchQuery = function buildSearchQuery() {\n              if (!hasSearch || !searchType) return {\n                mode: \"scan\",\n                query: null\n              };\n              var col = db.collection(\"Test\");\n\n              switch (searchType) {\n                case \"SKU\":\n                  return {\n                    mode: \"sku\",\n                    query: null\n                  };\n\n                case \"Name\":\n                  {\n                    var titleFallback = searchRaw && searchRaw === searchRaw.toLowerCase() ? toTitleCase(searchRaw) : null;\n                    var terms = searchLower ? searchLower.split(/\\s+/).filter(Boolean) : [];\n\n                    var tokens = _toConsumableArray(terms);\n\n                    if (searchLower && !tokens.includes(searchLower)) tokens.push(searchLower);\n                    if (!tokens.length) return {\n                      mode: \"scan\",\n                      query: null\n                    };\n\n                    var prefixQuery = function prefixQuery(value) {\n                      return col.orderBy(\"name\").startAt(value).endAt(\"\".concat(value, \"\\uF8FF\"));\n                    };\n\n                    return {\n                      mode: \"query\",\n                      query: tokens.length === 1 ? col.where(\"nameTokens\", \"array-contains\", tokens[0]) : col.where(\"nameTokens\", \"array-contains-any\", tokens.slice(0, 10)),\n                      fallback: titleFallback ? function () {\n                        return prefixQuery(titleFallback);\n                      } : function () {\n                        return prefixQuery(searchRaw);\n                      }\n                    };\n                  }\n\n                case \"Product Number\":\n                  return {\n                    mode: \"query\",\n                    query: col.where(\"pn\", \"array-contains\", searchRaw),\n                    fallback: function fallback() {\n                      return col.where(\"pn\", \"==\", searchRaw);\n                    }\n                  };\n\n                case \"Serial Number\":\n                  return {\n                    mode: \"query\",\n                    query: col.where(\"sn\", \"array-contains\", searchRaw),\n                    fallback: function fallback() {\n                      return col.where(\"sn\", \"==\", searchRaw);\n                    }\n                  };\n\n                case \"Date\":\n                  {\n                    var asDate = function () {\n                      try {\n                        var d = new Date(searchRaw);\n                        return isNaN(d.getTime()) ? null : d;\n                      } catch (_unused) {\n                        return null;\n                      }\n                    }();\n\n                    return {\n                      mode: \"query\",\n                      query: col.where(\"date\", \"==\", searchRaw),\n                      fallback: asDate ? function () {\n                        return col.where(\"date\", \"==\", asDate);\n                      } : null\n                    };\n                  }\n\n                default:\n                  return {\n                    mode: \"scan\",\n                    query: null\n                  };\n              }\n            };\n\n            _buildSearchQuery = buildSearchQuery(), searchMode = _buildSearchQuery.mode, searchQuery = _buildSearchQuery.query, searchFallback = _buildSearchQuery.fallback;\n\n            if (!(searchMode === \"sku\" && hasSearch)) {\n              _context6.next = 46;\n              break;\n            }\n\n            docs = [];\n            rawUpper = searchRaw.toUpperCase();\n            _context6.next = 19;\n            return db.collection(\"Test\").doc(searchRaw).get();\n\n          case 19:\n            doc = _context6.sent;\n\n            if (!(!doc.exists && rawUpper !== searchRaw)) {\n              _context6.next = 24;\n              break;\n            }\n\n            _context6.next = 23;\n            return db.collection(\"Test\").doc(rawUpper).get();\n\n          case 23:\n            doc = _context6.sent;\n\n          case 24:\n            if (doc.exists) docs.push(doc);\n            localValues = rawUpper !== searchRaw ? [searchRaw, rawUpper] : [searchRaw];\n            _context6.next = 28;\n            return db.collection(\"Test\").where(\"localSN\", \"in\", localValues).limit(limit).get();\n\n          case 28:\n            localSnap = _context6.sent;\n            localSnap.forEach(function (d) {\n              if (!docs.find(function (existing) {\n                return existing.id === d.id;\n              })) {\n                docs.push(d);\n              }\n            });\n            machineMap = {};\n            currentMachineMap = {};\n\n            if (!(needsMachineData && docs.length)) {\n              _context6.next = 44;\n              break;\n            }\n\n            machineIds = new Set();\n            currentMachineIds = new Set();\n            _iterator = _createForOfIteratorHelper(docs);\n\n            try {\n              for (_iterator.s(); !(_step = _iterator.n()).done;) {\n                docSnap = _step.value;\n                raw = docSnap.data();\n                machineId = getRefId(raw.Machine || raw.MachineFrom);\n                currentMachineId = getRefId(raw.CurrentMachine || raw.MachineCurrent);\n                if (machineId) machineIds.add(machineId);\n                if (currentMachineId) currentMachineIds.add(currentMachineId);\n              }\n            } catch (err) {\n              _iterator.e(err);\n            } finally {\n              _iterator.f();\n            }\n\n            fetchMachineMap = /*#__PURE__*/function () {\n              var _ref8 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(ids) {\n                var out, chunks, i, _i, _chunks, chunk, snap;\n\n                return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n                  while (1) {\n                    switch (_context4.prev = _context4.next) {\n                      case 0:\n                        if (ids.length) {\n                          _context4.next = 2;\n                          break;\n                        }\n\n                        return _context4.abrupt(\"return\", {});\n\n                      case 2:\n                        out = {};\n                        chunks = [];\n\n                        for (i = 0; i < ids.length; i += 10) {\n                          chunks.push(ids.slice(i, i + 10));\n                        }\n\n                        _i = 0, _chunks = chunks;\n\n                      case 6:\n                        if (!(_i < _chunks.length)) {\n                          _context4.next = 15;\n                          break;\n                        }\n\n                        chunk = _chunks[_i];\n                        _context4.next = 10;\n                        return withMachineSelect(db.collection(\"Machine\").where(firebase.firestore.FieldPath.documentId(), \"in\", chunk)).get();\n\n                      case 10:\n                        snap = _context4.sent;\n                        snap.forEach(function (docSnap) {\n                          out[docSnap.id] = docSnap.data() || {};\n                        });\n\n                      case 12:\n                        _i++;\n                        _context4.next = 6;\n                        break;\n\n                      case 15:\n                        return _context4.abrupt(\"return\", out);\n\n                      case 16:\n                      case \"end\":\n                        return _context4.stop();\n                    }\n                  }\n                }, _callee4);\n              }));\n\n              return function fetchMachineMap(_x8) {\n                return _ref8.apply(this, arguments);\n              };\n            }();\n\n            _context6.next = 40;\n            return Promise.all([fetchMachineMap(_toConsumableArray(machineIds)), fetchMachineMap(_toConsumableArray(currentMachineIds))]);\n\n          case 40:\n            _yield$Promise$all = _context6.sent;\n            _yield$Promise$all2 = _slicedToArray(_yield$Promise$all, 2);\n            machineMap = _yield$Promise$all2[0];\n            currentMachineMap = _yield$Promise$all2[1];\n\n          case 44:\n            built = docs.map(function (docSnap) {\n              return buildPart(docSnap, machineMap, currentMachineMap);\n            }).filter(function (item) {\n              return !visibleOnly || (item === null || item === void 0 ? void 0 : item.visible) !== false;\n            }).filter(function (item) {\n              return filterFn ? filterFn(item) : true;\n            }).slice(0, pageSize);\n            return _context6.abrupt(\"return\", {\n              parts: built,\n              lastDoc: built.length ? docs[built.length - 1] : null,\n              hasNextPage: false\n            });\n\n          case 46:\n            parts = [];\n            cursor = startAfterDoc || null;\n            lastDoc = null;\n            pageLastDoc = null;\n            hasNextPage = false;\n            filled = false;\n            usedFallback = false;\n            scanBaseQuery = db.collection(\"Test\").orderBy(firebase.firestore.FieldPath.documentId());\n\n          case 54:\n            if (!true) {\n              _context6.next = 128;\n              break;\n            }\n\n            query = searchQuery || scanBaseQuery;\n\n            if (searchMode === \"query\" && usedFallback && searchFallback) {\n              query = searchFallback();\n            }\n\n            if (cursor) query = query.startAfter(cursor);\n            query = query.limit(limit);\n            _context6.next = 61;\n            return query.get();\n\n          case 61:\n            snap = _context6.sent;\n\n            if (!snap.empty) {\n              _context6.next = 68;\n              break;\n            }\n\n            if (!(searchMode === \"query\" && searchFallback && !cursor && !usedFallback)) {\n              _context6.next = 66;\n              break;\n            }\n\n            usedFallback = true;\n            return _context6.abrupt(\"continue\", 54);\n\n          case 66:\n            hasNextPage = false;\n            return _context6.abrupt(\"break\", 128);\n\n          case 68:\n            batchDocs = snap.docs;\n            _machineMap = {};\n            _currentMachineMap = {};\n\n            if (!needsMachineData) {\n              _context6.next = 103;\n              break;\n            }\n\n            _machineIds = new Set();\n            _currentMachineIds = new Set();\n            _iterator2 = _createForOfIteratorHelper(batchDocs);\n            _context6.prev = 75;\n\n            _iterator2.s();\n\n          case 77:\n            if ((_step2 = _iterator2.n()).done) {\n              _context6.next = 88;\n              break;\n            }\n\n            _doc3 = _step2.value;\n            _raw = _doc3.data();\n\n            if (!(visibleOnly && _raw.visible === false)) {\n              _context6.next = 82;\n              break;\n            }\n\n            return _context6.abrupt(\"continue\", 86);\n\n          case 82:\n            _machineId = getRefId(_raw.Machine || _raw.MachineFrom);\n            _currentMachineId = getRefId(_raw.CurrentMachine || _raw.MachineCurrent);\n            if (_machineId) _machineIds.add(_machineId);\n            if (_currentMachineId) _currentMachineIds.add(_currentMachineId);\n\n          case 86:\n            _context6.next = 77;\n            break;\n\n          case 88:\n            _context6.next = 93;\n            break;\n\n          case 90:\n            _context6.prev = 90;\n            _context6.t0 = _context6[\"catch\"](75);\n\n            _iterator2.e(_context6.t0);\n\n          case 93:\n            _context6.prev = 93;\n\n            _iterator2.f();\n\n            return _context6.finish(93);\n\n          case 96:\n            _fetchMachineMap = /*#__PURE__*/function () {\n              var _ref9 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(ids) {\n                var out, chunks, i, _i2, _chunks2, chunk, _snap;\n\n                return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n                  while (1) {\n                    switch (_context5.prev = _context5.next) {\n                      case 0:\n                        if (ids.length) {\n                          _context5.next = 2;\n                          break;\n                        }\n\n                        return _context5.abrupt(\"return\", {});\n\n                      case 2:\n                        out = {};\n                        chunks = [];\n\n                        for (i = 0; i < ids.length; i += 10) {\n                          chunks.push(ids.slice(i, i + 10));\n                        }\n\n                        _i2 = 0, _chunks2 = chunks;\n\n                      case 6:\n                        if (!(_i2 < _chunks2.length)) {\n                          _context5.next = 15;\n                          break;\n                        }\n\n                        chunk = _chunks2[_i2];\n                        _context5.next = 10;\n                        return withMachineSelect(db.collection(\"Machine\").where(firebase.firestore.FieldPath.documentId(), \"in\", chunk)).get();\n\n                      case 10:\n                        _snap = _context5.sent;\n\n                        _snap.forEach(function (doc) {\n                          out[doc.id] = doc.data() || {};\n                        });\n\n                      case 12:\n                        _i2++;\n                        _context5.next = 6;\n                        break;\n\n                      case 15:\n                        return _context5.abrupt(\"return\", out);\n\n                      case 16:\n                      case \"end\":\n                        return _context5.stop();\n                    }\n                  }\n                }, _callee5);\n              }));\n\n              return function _fetchMachineMap(_x9) {\n                return _ref9.apply(this, arguments);\n              };\n            }();\n\n            _context6.next = 99;\n            return Promise.all([_fetchMachineMap(_toConsumableArray(_machineIds)), _fetchMachineMap(_toConsumableArray(_currentMachineIds))]);\n\n          case 99:\n            _yield$Promise$all3 = _context6.sent;\n            _yield$Promise$all4 = _slicedToArray(_yield$Promise$all3, 2);\n            _machineMap = _yield$Promise$all4[0];\n            _currentMachineMap = _yield$Promise$all4[1];\n\n          case 103:\n            i = 0;\n\n          case 104:\n            if (!(i < snap.docs.length)) {\n              _context6.next = 122;\n              break;\n            }\n\n            _doc4 = batchDocs[i];\n            cursor = _doc4;\n            _raw2 = _doc4.data();\n\n            if (!(visibleOnly && _raw2.visible === false)) {\n              _context6.next = 110;\n              break;\n            }\n\n            return _context6.abrupt(\"continue\", 119);\n\n          case 110:\n            _built = buildPart(_doc4, _machineMap, _currentMachineMap);\n\n            if (!(filterFn && !filterFn(_built))) {\n              _context6.next = 113;\n              break;\n            }\n\n            return _context6.abrupt(\"continue\", 119);\n\n          case 113:\n            if (filled) {\n              _context6.next = 117;\n              break;\n            }\n\n            parts.push(_built);\n\n            if (parts.length === pageSize) {\n              filled = true;\n              pageLastDoc = _doc4;\n            }\n\n            return _context6.abrupt(\"continue\", 119);\n\n          case 117:\n            // We already filled the page and found an extra matching item.\n            hasNextPage = true;\n            return _context6.abrupt(\"return\", {\n              parts: parts,\n              lastDoc: pageLastDoc,\n              hasNextPage: hasNextPage\n            });\n\n          case 119:\n            i++;\n            _context6.next = 104;\n            break;\n\n          case 122:\n            if (!(snap.size < limit)) {\n              _context6.next = 125;\n              break;\n            }\n\n            hasNextPage = false;\n            return _context6.abrupt(\"break\", 128);\n\n          case 125:\n            // There might be more docs; continue scanning for visible items.\n            hasNextPage = true;\n            _context6.next = 54;\n            break;\n\n          case 128:\n            lastDoc = pageLastDoc || (parts.length ? cursor : null);\n            return _context6.abrupt(\"return\", {\n              parts: parts,\n              lastDoc: lastDoc,\n              hasNextPage: filled ? hasNextPage : false\n            });\n\n          case 130:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6, null, [[75, 90, 93, 96]]);\n  }));\n  return _fetchPartsWithMachineDataPage.apply(this, arguments);\n}\n\nexport function fetchClients(_x, _x2) {\n  return _fetchClients.apply(this, arguments);\n}\n\nfunction _fetchClients() {\n  _fetchClients = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(selectedOEM, selectedModality) {\n    var normalizeText, fieldMatchesSelection, db, clientsSnapshot, clients, filteredClients, _iterator3, _step3, client, match, _iterator4, _step4, _machineData$OEM, _machineData$Modality, machineRef, machineDoc, machineData;\n\n    return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n      while (1) {\n        switch (_context7.prev = _context7.next) {\n          case 0:\n            normalizeText = function normalizeText(value) {\n              if (value == null) return \"\";\n              return String(value).toLowerCase().trim();\n            };\n\n            fieldMatchesSelection = function fieldMatchesSelection(value, selected) {\n              if (!selected) return false;\n\n              if (Array.isArray(value)) {\n                return value.some(function (entry) {\n                  return fieldMatchesSelection(entry, selected);\n                });\n              }\n\n              return normalizeText(value) === normalizeText(selected);\n            };\n\n            db = firebase.firestore();\n            _context7.next = 5;\n            return db.collection(\"Client\").get();\n\n          case 5:\n            clientsSnapshot = _context7.sent;\n            clients = clientsSnapshot.docs.map(function (doc) {\n              return _objectSpread({\n                id: doc.id\n              }, doc.data());\n            }); // Filter clients based on OEM and Modality if selected\n\n            if (!(selectedOEM || selectedModality)) {\n              _context7.next = 53;\n              break;\n            }\n\n            filteredClients = [];\n            _iterator3 = _createForOfIteratorHelper(clients);\n            _context7.prev = 10;\n\n            _iterator3.s();\n\n          case 12:\n            if ((_step3 = _iterator3.n()).done) {\n              _context7.next = 44;\n              break;\n            }\n\n            client = _step3.value;\n            match = true;\n\n            if (!(selectedOEM || selectedModality)) {\n              _context7.next = 41;\n              break;\n            }\n\n            _iterator4 = _createForOfIteratorHelper(client.machines);\n            _context7.prev = 17;\n\n            _iterator4.s();\n\n          case 19:\n            if ((_step4 = _iterator4.n()).done) {\n              _context7.next = 33;\n              break;\n            }\n\n            machineRef = _step4.value;\n            _context7.next = 23;\n            return machineRef.get();\n\n          case 23:\n            machineDoc = _context7.sent;\n            machineData = machineDoc.data();\n\n            if (!(selectedOEM && fieldMatchesSelection((_machineData$OEM = machineData.OEM) !== null && _machineData$OEM !== void 0 ? _machineData$OEM : machineData.oem, selectedOEM) || selectedModality && fieldMatchesSelection((_machineData$Modality = machineData.Modality) !== null && _machineData$Modality !== void 0 ? _machineData$Modality : machineData.modality, selectedModality))) {\n              _context7.next = 30;\n              break;\n            }\n\n            match = true;\n            return _context7.abrupt(\"break\", 33);\n\n          case 30:\n            match = false;\n\n          case 31:\n            _context7.next = 19;\n            break;\n\n          case 33:\n            _context7.next = 38;\n            break;\n\n          case 35:\n            _context7.prev = 35;\n            _context7.t0 = _context7[\"catch\"](17);\n\n            _iterator4.e(_context7.t0);\n\n          case 38:\n            _context7.prev = 38;\n\n            _iterator4.f();\n\n            return _context7.finish(38);\n\n          case 41:\n            if (match) {\n              filteredClients.push(client);\n            }\n\n          case 42:\n            _context7.next = 12;\n            break;\n\n          case 44:\n            _context7.next = 49;\n            break;\n\n          case 46:\n            _context7.prev = 46;\n            _context7.t1 = _context7[\"catch\"](10);\n\n            _iterator3.e(_context7.t1);\n\n          case 49:\n            _context7.prev = 49;\n\n            _iterator3.f();\n\n            return _context7.finish(49);\n\n          case 52:\n            return _context7.abrupt(\"return\", filteredClients);\n\n          case 53:\n            return _context7.abrupt(\"return\", clients);\n\n          case 54:\n          case \"end\":\n            return _context7.stop();\n        }\n      }\n    }, _callee7, null, [[10, 46, 49, 52], [17, 35, 38, 41]]);\n  }));\n  return _fetchClients.apply(this, arguments);\n}\n\nexport function fetchModels(_x3, _x4, _x5) {\n  return _fetchModels.apply(this, arguments);\n}\n\nfunction _fetchModels() {\n  _fetchModels = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9(selectedOEM, selectedModality, selectedClient) {\n    var normalizeText, fieldMatchesSelection, db, machinesSnapshot, models;\n    return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n      while (1) {\n        switch (_context9.prev = _context9.next) {\n          case 0:\n            normalizeText = function normalizeText(value) {\n              if (value == null) return \"\";\n              return String(value).toLowerCase().trim();\n            };\n\n            fieldMatchesSelection = function fieldMatchesSelection(value, selected) {\n              if (!selected) return true;\n\n              if (Array.isArray(value)) {\n                return value.some(function (entry) {\n                  return fieldMatchesSelection(entry, selected);\n                });\n              }\n\n              return normalizeText(value) === normalizeText(selected);\n            };\n\n            db = firebase.firestore();\n            _context9.next = 5;\n            return db.collection(\"Machine\").get();\n\n          case 5:\n            machinesSnapshot = _context9.sent;\n            models = new Set();\n            _context9.next = 9;\n            return Promise.all(machinesSnapshot.docs.map( /*#__PURE__*/function () {\n              var _ref10 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8(machineDoc) {\n                var _machineData$OEM2, _machineData$Modality2;\n\n                var machineData, isValid, _machineData$client, clientDoc, clientName, clientId, _machineData$Model, modelValue;\n\n                return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n                  while (1) {\n                    switch (_context8.prev = _context8.next) {\n                      case 0:\n                        machineData = machineDoc.data();\n                        isValid = true;\n                        if (!fieldMatchesSelection((_machineData$OEM2 = machineData.OEM) !== null && _machineData$OEM2 !== void 0 ? _machineData$OEM2 : machineData.oem, selectedOEM)) isValid = false;\n                        if (!fieldMatchesSelection((_machineData$Modality2 = machineData.Modality) !== null && _machineData$Modality2 !== void 0 ? _machineData$Modality2 : machineData.modality, selectedModality)) isValid = false;\n\n                        if (!(selectedClient && machineData.client)) {\n                          _context8.next = 17;\n                          break;\n                        }\n\n                        clientDoc = null;\n\n                        if (!(typeof ((_machineData$client = machineData.client) === null || _machineData$client === void 0 ? void 0 : _machineData$client.get) === \"function\")) {\n                          _context8.next = 12;\n                          break;\n                        }\n\n                        _context8.next = 9;\n                        return machineData.client.get();\n\n                      case 9:\n                        clientDoc = _context8.sent;\n                        _context8.next = 16;\n                        break;\n\n                      case 12:\n                        if (!(typeof machineData.client === \"string\")) {\n                          _context8.next = 16;\n                          break;\n                        }\n\n                        _context8.next = 15;\n                        return db.collection(\"Client\").doc(machineData.client).get();\n\n                      case 15:\n                        clientDoc = _context8.sent;\n\n                      case 16:\n                        if (!clientDoc || !clientDoc.exists) {\n                          isValid = false;\n                        } else {\n                          clientName = clientDoc.data().name;\n                          clientId = clientDoc.id;\n\n                          if (selectedClient !== clientName && selectedClient !== clientId) {\n                            isValid = false;\n                          }\n                        }\n\n                      case 17:\n                        if (isValid) {\n                          modelValue = (_machineData$Model = machineData.Model) !== null && _machineData$Model !== void 0 ? _machineData$Model : machineData.model;\n\n                          if (Array.isArray(modelValue)) {\n                            modelValue.forEach(function (entry) {\n                              return entry && models.add(entry);\n                            });\n                          } else if (modelValue) {\n                            models.add(modelValue);\n                          }\n                        }\n\n                      case 18:\n                      case \"end\":\n                        return _context8.stop();\n                    }\n                  }\n                }, _callee8);\n              }));\n\n              return function (_x10) {\n                return _ref10.apply(this, arguments);\n              };\n            }()));\n\n          case 9:\n            return _context9.abrupt(\"return\", Array.from(models));\n\n          case 10:\n          case \"end\":\n            return _context9.stop();\n        }\n      }\n    }, _callee9);\n  }));\n  return _fetchModels.apply(this, arguments);\n}\n\nexport function formatDate(timestamp) {\n  if (!timestamp) return \"\";\n  var date;\n\n  if (timestamp.toDate) {\n    date = timestamp.toDate();\n  } else if (typeof timestamp === \"string\" || typeof timestamp === \"number\") {\n    date = new Date(timestamp);\n  } else {\n    return \"\"; // handle unexpected formats\n  }\n\n  var day = String(date.getDate()).padStart(2, \"0\");\n  var month = String(date.getMonth() + 1).padStart(2, \"0\");\n  var year = date.getFullYear();\n  return \"\".concat(month, \"/\").concat(day, \"/\").concat(year);\n}","map":null,"metadata":{},"sourceType":"module"}