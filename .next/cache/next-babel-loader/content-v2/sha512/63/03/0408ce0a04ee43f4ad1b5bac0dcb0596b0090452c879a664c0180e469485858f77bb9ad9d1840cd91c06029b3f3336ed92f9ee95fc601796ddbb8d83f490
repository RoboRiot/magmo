{"ast":null,"code":"var __jsx = React.createElement;\n// pages/index.js\nimport Head from \"next/head\";\nimport React, { useState, useEffect, useRef } from \"react\";\nimport { Button, Alert } from \"react-bootstrap\";\nimport styles from \"../styles/Login.module.css\";\nimport { useRouter } from \"next/router\";\nimport firebase from \"../context/Firebase\"; // compat default export ONLY\n\nexport default function Home() {\n  const router = useRouter();\n  const {\n    0: error,\n    1: setError\n  } = useState(\"\");\n  const {\n    0: hasMounted,\n    1: setHasMounted\n  } = useState(false);\n  const {\n    0: authReady,\n    1: setAuthReady\n  } = useState(false);\n  const unsubRef = useRef(null);\n  const persistenceModeRef = useRef(\"unknown\");\n\n  const getDestination = () => {\n    var _router$query;\n\n    const q = router === null || router === void 0 ? void 0 : (_router$query = router.query) === null || _router$query === void 0 ? void 0 : _router$query.redirect;\n    return Array.isArray(q) ? q[0] || \"/NewSearch/mainSearch\" : q || \"/NewSearch/mainSearch\";\n  };\n\n  const isIosSafari = () => {\n    if (typeof navigator === \"undefined\") return false;\n    const ua = navigator.userAgent;\n    const isIOS = /iP(hone|ad|od)/i.test(ua);\n    const isSafari = /Safari/i.test(ua) && !/Chrome|CriOS|FxiOS|EdgiOS/i.test(ua);\n    return isIOS && isSafari;\n  };\n\n  useEffect(() => setHasMounted(true), []);\n\n  const ensurePersistence = async () => {\n    try {\n      await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);\n      persistenceModeRef.current = \"local\";\n      return \"local\";\n    } catch (error) {\n      console.warn(\"[auth] LOCAL persistence failed, falling back to SESSION\", error);\n\n      try {\n        await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);\n        persistenceModeRef.current = \"session\";\n        return \"session\";\n      } catch (innerError) {\n        console.warn(\"[auth] SESSION persistence failed\", innerError);\n        persistenceModeRef.current = \"none\";\n        return \"none\";\n      }\n    }\n  }; // One-time auth listener\n\n\n  useEffect(() => {\n    if (!hasMounted) return;\n\n    (async () => {\n      try {\n        await ensurePersistence(); // simple storage probe to detect hostile environments\n\n        try {\n          localStorage.setItem(\"__magmo_probe\", \"1\");\n        } catch (e) {\n          console.warn(\"[auth] localStorage not available; redirects may fail\");\n        }\n\n        try {\n          const redirectResult = await firebase.auth().getRedirectResult();\n\n          if (redirectResult && redirectResult.user) {\n            const dest = getDestination();\n            router.replace(dest);\n            return;\n          }\n        } catch (redirectError) {\n          console.error(\"[auth] redirect result error:\", redirectError);\n          setError(\"Google sign-in failed. Please try again.\");\n        }\n\n        try {\n          const hadAttempt = localStorage.getItem(\"__magmo_signin_attempt\");\n\n          if (hadAttempt) {\n            localStorage.removeItem(\"__magmo_signin_attempt\");\n            setTimeout(() => {\n              const user = firebase.auth().currentUser;\n\n              if (!user) {\n                setError(\"Google sign-in did not complete in Safari. Please allow cookies or try again.\");\n              }\n            }, 1500);\n          }\n        } catch (_) {}\n\n        unsubRef.current = firebase.auth().onAuthStateChanged(user => {\n          console.log(\"[auth] onAuthStateChanged:\", user);\n          setAuthReady(true);\n\n          if (user) {\n            const dest = getDestination();\n            router.replace(dest);\n          }\n        });\n      } catch (e) {\n        console.error(\"[auth] persistence setup error:\", e);\n        setError(\"Authentication init failed.\");\n      } finally {\n        setAuthReady(true);\n      }\n    })();\n\n    return () => {\n      if (unsubRef.current) unsubRef.current();\n    };\n  }, [hasMounted, router]);\n  if (!hasMounted) return null;\n\n  const handleGoogleSignIn = async () => {\n    setError(\"\");\n\n    try {\n      const persistenceMode = await ensurePersistence();\n      const provider = new firebase.auth.GoogleAuthProvider();\n      provider.addScope(\"email\");\n      provider.addScope(\"profile\");\n      provider.setCustomParameters({\n        prompt: \"select_account\"\n      }); // prefer popup (no redirect state), fallback to redirect only where needed\n\n      if (isIosSafari() && persistenceMode !== \"none\") {\n        console.log(\"[auth] Using redirect (iOS Safari)\"); // mark that we attempted sign-in (to detect storage loss)\n\n        try {\n          localStorage.setItem(\"__magmo_signin_attempt\", Date.now().toString());\n        } catch (_) {}\n\n        await firebase.auth().signInWithRedirect(provider);\n      } else {\n        console.log(\"[auth] Using popup\");\n\n        try {\n          const result = await firebase.auth().signInWithPopup(provider);\n          console.log(\"[auth] popup result:\", result && result.user); // onAuthStateChanged will route; but we can route immediately too:\n\n          if (result && result.user) {\n            const dest = getDestination();\n            router.replace(dest);\n          }\n        } catch (popupError) {\n          if (isIosSafari() && ((popupError === null || popupError === void 0 ? void 0 : popupError.code) === \"auth/popup-blocked\" || (popupError === null || popupError === void 0 ? void 0 : popupError.code) === \"auth/popup-closed-by-user\" || (popupError === null || popupError === void 0 ? void 0 : popupError.code) === \"auth/operation-not-supported-in-this-environment\")) {\n            console.warn(\"[auth] popup blocked, falling back to redirect\");\n\n            try {\n              localStorage.setItem(\"__magmo_signin_attempt\", Date.now().toString());\n            } catch (_) {}\n\n            await firebase.auth().signInWithRedirect(provider);\n            return;\n          }\n\n          throw popupError;\n        }\n      }\n    } catch (err) {\n      console.error(\"[auth] sign-in error:\", err);\n\n      if ((err === null || err === void 0 ? void 0 : err.code) === \"auth/unauthorized-domain\") {\n        setError(\"This domain is not authorized for Google sign-in. Add magmo.cloud in Firebase Auth > Settings > Authorized domains.\");\n      } else {\n        setError(\"Failed to log in with Google: \" + (err && err.message ? err.message : String(err)));\n      }\n    }\n  };\n\n  const handleTestLogin = async () => {\n    setError(\"\");\n    const password = prompt(\"Enter password:\");\n    if (!password) return;\n\n    try {\n      await firebase.auth().signInWithEmailAndPassword(\"test@test.com\", password);\n      router.replace(\"/NewSearch/searchTest\");\n    } catch (err) {\n      setError(\"Test login failed: \" + (err && err.message ? err.message : String(err)));\n    }\n  };\n\n  return __jsx(\"div\", {\n    className: styles.page\n  }, __jsx(Head, null, __jsx(\"title\", null, \"magmo\"), __jsx(\"link\", {\n    rel: \"icon\",\n    href: \"/favicon.ico\"\n  }), __jsx(\"meta\", {\n    name: \"viewport\",\n    content: \"width=device-width, initial-scale=1.0\"\n  })), __jsx(\"div\", {\n    className: styles.shell\n  }, __jsx(\"div\", {\n    className: styles.card\n  }, __jsx(\"img\", {\n    src: \"/magmo.png\",\n    alt: \"Magmo Logo\",\n    className: styles.logo\n  }), __jsx(\"div\", {\n    className: styles.cardTitle\n  }, \"Welcome back\"), !authReady && __jsx(\"div\", {\n    className: styles.status\n  }, \"Initializing\\u2026\"), error && __jsx(Alert, {\n    variant: \"danger\"\n  }, error), __jsx(Button, {\n    variant: \"light\",\n    className: styles.googleButton,\n    onClick: handleGoogleSignIn\n  }, __jsx(\"span\", {\n    className: styles.googleIcon\n  }, __jsx(\"img\", {\n    src: \"https://www.svgrepo.com/show/355037/google.svg\",\n    alt: \"Google logo\",\n    width: \"20\",\n    height: \"20\"\n  })), \"Continue with Google\"), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: styles.testButton,\n    onClick: handleTestLogin\n  }, \"Test\"))));\n}","map":null,"metadata":{},"sourceType":"module"}