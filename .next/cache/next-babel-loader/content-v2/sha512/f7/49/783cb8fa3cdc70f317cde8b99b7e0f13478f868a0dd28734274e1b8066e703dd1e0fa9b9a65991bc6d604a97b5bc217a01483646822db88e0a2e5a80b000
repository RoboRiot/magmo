{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport firebase from \"../context/Firebase\";\nconst OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nconst MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nconst DEFAULT_OEM_FIELD = \"oems\";\n\nconst isPlainObject = value => value != null && typeof value === \"object\" && !Array.isArray(value) && !(value instanceof Date);\n\nconst normalizeKey = value => {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nconst hasUpper = value => /[A-Z]/.test(String(value || \"\"));\n\nconst pickPreferredCase = (current, incoming) => {\n  if (!current) return incoming;\n  if (!incoming) return current;\n  const currentUpper = hasUpper(current);\n  const incomingUpper = hasUpper(incoming);\n  if (incomingUpper && !currentUpper) return incoming;\n  if (currentUpper && !incomingUpper) return current;\n  return current;\n};\n\nconst normalizeArray = value => {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nconst normalizeList = values => {\n  const out = [];\n  (values || []).forEach(value => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst normalizeListCaseInsensitive = values => {\n  const map = new Map();\n  (values || []).forEach(value => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    const key = normalizeKey(normalized);\n    if (!key) return;\n    const current = map.get(key);\n    map.set(key, pickPreferredCase(current, normalized));\n  });\n  return Array.from(map.values());\n};\n\nconst pickModelField = obj => {\n  if (!isPlainObject(obj)) return null;\n\n  for (const key of MODEL_FIELD_CANDIDATES) {\n    if (Array.isArray(obj[key])) return key;\n  }\n\n  const arrayKey = Object.keys(obj).find(key => Array.isArray(obj[key]));\n  return arrayKey || null;\n};\n\nconst extractModels = value => {\n  if (Array.isArray(value)) {\n    return {\n      models: normalizeList(value),\n      modelField: null\n    };\n  }\n\n  if (isPlainObject(value)) {\n    const modelField = pickModelField(value);\n    const models = modelField ? normalizeList(value[modelField]) : [];\n    return {\n      models,\n      modelField\n    };\n  }\n\n  if (value != null && value !== \"\") {\n    return {\n      models: normalizeList([value]),\n      modelField: null\n    };\n  }\n\n  return {\n    models: [],\n    modelField: null\n  };\n};\n\nconst extractOemMap = data => {\n  const oemMap = {};\n  const modelFieldByOem = {};\n  let oemField = null;\n\n  for (const key of OEM_FIELD_CANDIDATES) {\n    if (isPlainObject(data === null || data === void 0 ? void 0 : data[key])) {\n      oemField = key;\n      Object.entries(data[key]).forEach(([oem, value]) => {\n        const {\n          models,\n          modelField\n        } = extractModels(value);\n        oemMap[oem] = normalizeList([...(oemMap[oem] || []), ...models]);\n\n        if (modelField) {\n          modelFieldByOem[oem] = modelField;\n        }\n      });\n    }\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(([key, value]) => {\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n\n      if (isPlainObject(value) || Array.isArray(value)) {\n        const {\n          models,\n          modelField\n        } = extractModels(value);\n\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([...(oemMap[key] || []), ...models]);\n\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return {\n    oemMap,\n    oemField,\n    modelFieldByOem\n  };\n};\n\nexport async function fetchTrackerCatalog() {\n  const db = firebase.firestore();\n  const snap = await db.collection(\"Tracker\").get();\n  const modalities = [];\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n  const meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n    modalityKeyByLower: {},\n    oemKeyByModalityLower: {},\n    modelKeyByModalityOemLower: {}\n  };\n  snap.forEach(doc => {\n    const modality = doc.id;\n    const modalityLower = normalizeKey(modality);\n    const existingModality = meta.modalityKeyByLower[modalityLower];\n    const canonicalModality = pickPreferredCase(existingModality, modality);\n    meta.modalityKeyByLower[modalityLower] = canonicalModality;\n    const data = doc.data() || {};\n    const {\n      oemMap,\n      oemField,\n      modelFieldByOem\n    } = extractOemMap(data);\n    modalities.push(canonicalModality);\n\n    if (!meta.oemFieldByModality[canonicalModality]) {\n      meta.oemFieldByModality[canonicalModality] = oemField;\n    }\n\n    meta.modelFieldByModalityOem[canonicalModality] = _objectSpread(_objectSpread({}, meta.modelFieldByModalityOem[canonicalModality] || {}), modelFieldByOem || {});\n    const oems = Object.keys(oemMap);\n    const mergedOems = normalizeListCaseInsensitive([...(oemsByModality[canonicalModality] || []), ...oems]);\n    oemsByModality[canonicalModality] = mergedOems;\n    modelsByModalityOem[canonicalModality] = modelsByModalityOem[canonicalModality] || {};\n    const oemLowerMap = meta.oemKeyByModalityLower[modalityLower] || {};\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n    const modelLowerMap = meta.modelKeyByModalityOemLower[modalityLower] || {};\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n    oems.forEach(oem => {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem = pickPreferredCase(oemLowerMap[oemLower], oem);\n      oemLowerMap[oemLower] = canonicalOem;\n      const existingModels = modelsByModalityOem[canonicalModality][canonicalOem] || [];\n      const mergedModels = normalizeListCaseInsensitive([...existingModels, ...(oemMap[oem] || [])]);\n      modelsByModalityOem[canonicalModality][canonicalOem] = mergedModels;\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n      mergedModels.forEach(model => {\n        modelLowerMap[oemLower][normalizeKey(model)] = model;\n      });\n    });\n  });\n  return {\n    modalities: normalizeListCaseInsensitive(modalities),\n    oemsByModality,\n    modelsByModalityOem,\n    meta\n  };\n}\nexport function buildAllOems(catalog) {\n  const map = new Map();\n  Object.values((catalog === null || catalog === void 0 ? void 0 : catalog.oemsByModality) || {}).forEach(oems => {\n    (oems || []).forEach(oem => {\n      const key = normalizeKey(oem);\n      if (!key) return;\n      const current = map.get(key);\n      map.set(key, pickPreferredCase(current, oem));\n    });\n  });\n  return Array.from(map.values());\n}\nexport function buildModelsForSelection(catalog, modalities = [], oems = []) {\n  const modelSet = new Set();\n  const modals = normalizeList(modalities);\n  const oemList = normalizeList(oems);\n  modals.forEach(modality => {\n    var _catalog$meta, _catalog$meta$modalit, _catalog$modelsByModa;\n\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta = catalog.meta) === null || _catalog$meta === void 0 ? void 0 : (_catalog$meta$modalit = _catalog$meta.modalityKeyByLower) === null || _catalog$meta$modalit === void 0 ? void 0 : _catalog$meta$modalit[modalityLower]) || modality;\n    const oemMap = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa = catalog.modelsByModalityOem) === null || _catalog$modelsByModa === void 0 ? void 0 : _catalog$modelsByModa[canonicalModality]) || {};\n    oemList.forEach(oem => {\n      var _catalog$meta2, _catalog$meta2$oemKey, _catalog$meta2$oemKey2;\n\n      const oemLower = normalizeKey(oem);\n      const canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta2 = catalog.meta) === null || _catalog$meta2 === void 0 ? void 0 : (_catalog$meta2$oemKey = _catalog$meta2.oemKeyByModalityLower) === null || _catalog$meta2$oemKey === void 0 ? void 0 : (_catalog$meta2$oemKey2 = _catalog$meta2$oemKey[modalityLower]) === null || _catalog$meta2$oemKey2 === void 0 ? void 0 : _catalog$meta2$oemKey2[oemLower]) || oem;\n      const models = (oemMap === null || oemMap === void 0 ? void 0 : oemMap[canonicalOem]) || [];\n      models.forEach(model => modelSet.add(model));\n    });\n  });\n  return Array.from(modelSet);\n}\nexport async function syncTrackerFromSelections({\n  selections,\n  catalog\n}) {\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const selectedModalities = normalizeList((selections === null || selections === void 0 ? void 0 : selections.modalities) || []);\n  const selectedOems = normalizeList((selections === null || selections === void 0 ? void 0 : selections.oems) || []);\n  const selectedModels = normalizeList((selections === null || selections === void 0 ? void 0 : selections.models) || []);\n  if (!selectedModalities.length) return false;\n  const ops = [];\n\n  for (const modality of selectedModalities) {\n    var _catalog$meta3, _catalog$meta3$modali, _catalog$oemsByModali, _catalog$meta4, _catalog$meta4$oemFie, _catalog$modalities;\n\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta3 = catalog.meta) === null || _catalog$meta3 === void 0 ? void 0 : (_catalog$meta3$modali = _catalog$meta3.modalityKeyByLower) === null || _catalog$meta3$modali === void 0 ? void 0 : _catalog$meta3$modali[modalityLower]) || modality;\n    const docRef = trackerRef.doc(canonicalModality);\n    const existingOemsRaw = (catalog === null || catalog === void 0 ? void 0 : (_catalog$oemsByModali = catalog.oemsByModality) === null || _catalog$oemsByModali === void 0 ? void 0 : _catalog$oemsByModali[canonicalModality]) || [];\n    const existingOemsLower = new Set(existingOemsRaw.map(value => normalizeKey(value)));\n    const oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta4 = catalog.meta) === null || _catalog$meta4 === void 0 ? void 0 : (_catalog$meta4$oemFie = _catalog$meta4.oemFieldByModality) === null || _catalog$meta4$oemFie === void 0 ? void 0 : _catalog$meta4$oemFie[canonicalModality]) || DEFAULT_OEM_FIELD;\n\n    if (!(catalog !== null && catalog !== void 0 && (_catalog$modalities = catalog.modalities) !== null && _catalog$modalities !== void 0 && _catalog$modalities.some(existing => normalizeKey(existing) === modalityLower))) {\n      ops.push(docRef.set({\n        [DEFAULT_OEM_FIELD]: {}\n      }, {\n        merge: true\n      }));\n    }\n\n    for (const oem of selectedOems) {\n      var _catalog$meta5, _catalog$meta5$oemKey, _catalog$meta5$oemKey2;\n\n      const oemLower = normalizeKey(oem);\n      const canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta5 = catalog.meta) === null || _catalog$meta5 === void 0 ? void 0 : (_catalog$meta5$oemKey = _catalog$meta5.oemKeyByModalityLower) === null || _catalog$meta5$oemKey === void 0 ? void 0 : (_catalog$meta5$oemKey2 = _catalog$meta5$oemKey[modalityLower]) === null || _catalog$meta5$oemKey2 === void 0 ? void 0 : _catalog$meta5$oemKey2[oemLower]) || oem;\n\n      if (!existingOemsLower.has(oemLower)) {\n        ops.push(docRef.set({\n          [oemField]: {\n            [canonicalOem]: []\n          }\n        }, {\n          merge: true\n        }));\n      }\n    }\n\n    for (const oem of selectedOems) {\n      var _catalog$meta6, _catalog$meta6$oemKey, _catalog$meta6$oemKey2, _catalog$modelsByModa2, _catalog$modelsByModa3, _catalog$meta7, _catalog$meta7$modelF, _catalog$meta7$modelF2;\n\n      const oemLower = normalizeKey(oem);\n      const canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta6 = catalog.meta) === null || _catalog$meta6 === void 0 ? void 0 : (_catalog$meta6$oemKey = _catalog$meta6.oemKeyByModalityLower) === null || _catalog$meta6$oemKey === void 0 ? void 0 : (_catalog$meta6$oemKey2 = _catalog$meta6$oemKey[modalityLower]) === null || _catalog$meta6$oemKey2 === void 0 ? void 0 : _catalog$meta6$oemKey2[oemLower]) || oem;\n      const knownModels = (catalog === null || catalog === void 0 ? void 0 : (_catalog$modelsByModa2 = catalog.modelsByModalityOem) === null || _catalog$modelsByModa2 === void 0 ? void 0 : (_catalog$modelsByModa3 = _catalog$modelsByModa2[canonicalModality]) === null || _catalog$modelsByModa3 === void 0 ? void 0 : _catalog$modelsByModa3[canonicalOem]) || [];\n      const knownLower = new Set(knownModels.map(value => normalizeKey(value)));\n      const modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta7 = catalog.meta) === null || _catalog$meta7 === void 0 ? void 0 : (_catalog$meta7$modelF = _catalog$meta7.modelFieldByModalityOem) === null || _catalog$meta7$modelF === void 0 ? void 0 : (_catalog$meta7$modelF2 = _catalog$meta7$modelF[canonicalModality]) === null || _catalog$meta7$modelF2 === void 0 ? void 0 : _catalog$meta7$modelF2[canonicalOem]) || null;\n\n      for (const model of selectedModels) {\n        const modelLower = normalizeKey(model);\n        if (!modelLower || knownLower.has(modelLower)) continue;\n        const path = modelField ? `${oemField}.${canonicalOem}.${modelField}` : `${oemField}.${canonicalOem}`;\n        ops.push(docRef.update({\n          [path]: firebase.firestore.FieldValue.arrayUnion(model)\n        }));\n      }\n    }\n  }\n\n  if (ops.length) {\n    await Promise.allSettled(ops);\n    return true;\n  }\n\n  return false;\n}\nexport async function deleteTrackerOem({\n  oem,\n  catalog\n}) {\n  if (!oem) return;\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const modalities = (catalog === null || catalog === void 0 ? void 0 : catalog.modalities) || [];\n  const ops = modalities.map(modality => {\n    var _catalog$meta8, _catalog$meta8$modali, _catalog$meta9, _catalog$meta9$oemFie, _catalog$meta10, _catalog$meta10$oemKe, _catalog$meta10$oemKe2, _catalog$meta11, _catalog$meta11$oemFi;\n\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta8 = catalog.meta) === null || _catalog$meta8 === void 0 ? void 0 : (_catalog$meta8$modali = _catalog$meta8.modalityKeyByLower) === null || _catalog$meta8$modali === void 0 ? void 0 : _catalog$meta8$modali[modalityLower]) || modality;\n    const oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta9 = catalog.meta) === null || _catalog$meta9 === void 0 ? void 0 : (_catalog$meta9$oemFie = _catalog$meta9.oemFieldByModality) === null || _catalog$meta9$oemFie === void 0 ? void 0 : _catalog$meta9$oemFie[canonicalModality]) || DEFAULT_OEM_FIELD;\n    const docRef = trackerRef.doc(canonicalModality);\n    const canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta10 = catalog.meta) === null || _catalog$meta10 === void 0 ? void 0 : (_catalog$meta10$oemKe = _catalog$meta10.oemKeyByModalityLower) === null || _catalog$meta10$oemKe === void 0 ? void 0 : (_catalog$meta10$oemKe2 = _catalog$meta10$oemKe[modalityLower]) === null || _catalog$meta10$oemKe2 === void 0 ? void 0 : _catalog$meta10$oemKe2[normalizeKey(oem)]) || oem;\n    const update = {\n      [`${oemField}.${canonicalOem}`]: firebase.firestore.FieldValue.delete()\n    };\n\n    if (!(catalog !== null && catalog !== void 0 && (_catalog$meta11 = catalog.meta) !== null && _catalog$meta11 !== void 0 && (_catalog$meta11$oemFi = _catalog$meta11.oemFieldByModality) !== null && _catalog$meta11$oemFi !== void 0 && _catalog$meta11$oemFi[canonicalModality])) {\n      update[canonicalOem] = firebase.firestore.FieldValue.delete();\n    }\n\n    return docRef.update(update).catch(() => null);\n  });\n  await Promise.allSettled(ops);\n}\nexport async function deleteTrackerModel({\n  modality,\n  oem,\n  model,\n  catalog\n}) {\n  var _catalog$meta12, _catalog$meta12$modal, _catalog$meta13, _catalog$meta13$oemFi, _catalog$meta14, _catalog$meta14$oemKe, _catalog$meta14$oemKe2, _catalog$meta15, _catalog$meta15$model, _catalog$meta15$model2;\n\n  if (!modality || !oem || !model) return;\n  const db = firebase.firestore();\n  const modalityLower = normalizeKey(modality);\n  const canonicalModality = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta12 = catalog.meta) === null || _catalog$meta12 === void 0 ? void 0 : (_catalog$meta12$modal = _catalog$meta12.modalityKeyByLower) === null || _catalog$meta12$modal === void 0 ? void 0 : _catalog$meta12$modal[modalityLower]) || modality;\n  const docRef = db.collection(\"Tracker\").doc(canonicalModality);\n  const oemField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta13 = catalog.meta) === null || _catalog$meta13 === void 0 ? void 0 : (_catalog$meta13$oemFi = _catalog$meta13.oemFieldByModality) === null || _catalog$meta13$oemFi === void 0 ? void 0 : _catalog$meta13$oemFi[canonicalModality]) || DEFAULT_OEM_FIELD;\n  const canonicalOem = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta14 = catalog.meta) === null || _catalog$meta14 === void 0 ? void 0 : (_catalog$meta14$oemKe = _catalog$meta14.oemKeyByModalityLower) === null || _catalog$meta14$oemKe === void 0 ? void 0 : (_catalog$meta14$oemKe2 = _catalog$meta14$oemKe[modalityLower]) === null || _catalog$meta14$oemKe2 === void 0 ? void 0 : _catalog$meta14$oemKe2[normalizeKey(oem)]) || oem;\n  const modelField = (catalog === null || catalog === void 0 ? void 0 : (_catalog$meta15 = catalog.meta) === null || _catalog$meta15 === void 0 ? void 0 : (_catalog$meta15$model = _catalog$meta15.modelFieldByModalityOem) === null || _catalog$meta15$model === void 0 ? void 0 : (_catalog$meta15$model2 = _catalog$meta15$model[canonicalModality]) === null || _catalog$meta15$model2 === void 0 ? void 0 : _catalog$meta15$model2[canonicalOem]) || null;\n  const path = modelField ? `${oemField}.${canonicalOem}.${modelField}` : `${oemField}.${canonicalOem}`;\n  await docRef.update({\n    [path]: firebase.firestore.FieldValue.arrayRemove(model)\n  });\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/utils/trackerCatalog.js"],"names":["firebase","OEM_FIELD_CANDIDATES","MODEL_FIELD_CANDIDATES","DEFAULT_OEM_FIELD","isPlainObject","value","Array","isArray","Date","normalizeKey","String","trim","toLowerCase","hasUpper","test","pickPreferredCase","current","incoming","currentUpper","incomingUpper","normalizeArray","normalizeList","values","out","forEach","normalized","push","from","Set","normalizeListCaseInsensitive","map","Map","key","get","set","pickModelField","obj","arrayKey","Object","keys","find","extractModels","models","modelField","extractOemMap","data","oemMap","modelFieldByOem","oemField","entries","oem","startsWith","length","fetchTrackerCatalog","db","firestore","snap","collection","modalities","oemsByModality","modelsByModalityOem","meta","oemFieldByModality","modelFieldByModalityOem","modalityKeyByLower","oemKeyByModalityLower","modelKeyByModalityOemLower","doc","modality","id","modalityLower","existingModality","canonicalModality","oems","mergedOems","oemLowerMap","modelLowerMap","oemLower","canonicalOem","existingModels","mergedModels","model","buildAllOems","catalog","buildModelsForSelection","modelSet","modals","oemList","add","syncTrackerFromSelections","selections","trackerRef","selectedModalities","selectedOems","selectedModels","ops","docRef","existingOemsRaw","existingOemsLower","some","existing","merge","has","knownModels","knownLower","modelLower","path","update","FieldValue","arrayUnion","Promise","allSettled","deleteTrackerOem","delete","catch","deleteTrackerModel","arrayRemove"],"mappings":"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","sourcesContent":["import firebase from \"../context/Firebase\";\n\nconst OEM_FIELD_CANDIDATES = [\"oems\", \"OEMs\", \"oem\", \"OEM\"];\nconst MODEL_FIELD_CANDIDATES = [\"models\", \"Models\", \"model\", \"Model\", \"list\", \"items\"];\nconst DEFAULT_OEM_FIELD = \"oems\";\n\nconst isPlainObject = (value) =>\n  value != null &&\n  typeof value === \"object\" &&\n  !Array.isArray(value) &&\n  !(value instanceof Date);\n\nconst normalizeKey = (value) => {\n  if (value == null) return \"\";\n  return String(value).trim().toLowerCase();\n};\n\nconst hasUpper = (value) => /[A-Z]/.test(String(value || \"\"));\n\nconst pickPreferredCase = (current, incoming) => {\n  if (!current) return incoming;\n  if (!incoming) return current;\n  const currentUpper = hasUpper(current);\n  const incomingUpper = hasUpper(incoming);\n  if (incomingUpper && !currentUpper) return incoming;\n  if (currentUpper && !incomingUpper) return current;\n  return current;\n};\n\nconst normalizeArray = (value) => {\n  if (Array.isArray(value)) return value;\n  if (value == null || value === \"\") return [];\n  return [value];\n};\n\nconst normalizeList = (values) => {\n  const out = [];\n  (values || []).forEach((value) => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    out.push(normalized);\n  });\n  return Array.from(new Set(out));\n};\n\nconst normalizeListCaseInsensitive = (values) => {\n  const map = new Map();\n  (values || []).forEach((value) => {\n    if (value == null) return;\n    const normalized = String(value).trim();\n    if (!normalized) return;\n    const key = normalizeKey(normalized);\n    if (!key) return;\n    const current = map.get(key);\n    map.set(key, pickPreferredCase(current, normalized));\n  });\n  return Array.from(map.values());\n};\n\nconst pickModelField = (obj) => {\n  if (!isPlainObject(obj)) return null;\n  for (const key of MODEL_FIELD_CANDIDATES) {\n    if (Array.isArray(obj[key])) return key;\n  }\n  const arrayKey = Object.keys(obj).find((key) => Array.isArray(obj[key]));\n  return arrayKey || null;\n};\n\nconst extractModels = (value) => {\n  if (Array.isArray(value)) {\n    return { models: normalizeList(value), modelField: null };\n  }\n  if (isPlainObject(value)) {\n    const modelField = pickModelField(value);\n    const models = modelField ? normalizeList(value[modelField]) : [];\n    return { models, modelField };\n  }\n  if (value != null && value !== \"\") {\n    return { models: normalizeList([value]), modelField: null };\n  }\n  return { models: [], modelField: null };\n};\n\nconst extractOemMap = (data) => {\n  const oemMap = {};\n  const modelFieldByOem = {};\n  let oemField = null;\n\n  for (const key of OEM_FIELD_CANDIDATES) {\n    if (isPlainObject(data?.[key])) {\n      oemField = key;\n      Object.entries(data[key]).forEach(([oem, value]) => {\n        const { models, modelField } = extractModels(value);\n        oemMap[oem] = normalizeList([...(oemMap[oem] || []), ...models]);\n        if (modelField) {\n          modelFieldByOem[oem] = modelField;\n        }\n      });\n    }\n  }\n\n  if (!oemField) {\n    Object.entries(data || {}).forEach(([key, value]) => {\n      if (!value) return;\n      if (key.startsWith(\"_\")) return;\n      if (isPlainObject(value) || Array.isArray(value)) {\n        const { models, modelField } = extractModels(value);\n        if (models.length || modelField) {\n          oemMap[key] = normalizeList([...(oemMap[key] || []), ...models]);\n          if (modelField) {\n            modelFieldByOem[key] = modelField;\n          }\n        }\n      }\n    });\n  }\n\n  return { oemMap, oemField, modelFieldByOem };\n};\n\nexport async function fetchTrackerCatalog() {\n  const db = firebase.firestore();\n  const snap = await db.collection(\"Tracker\").get();\n\n  const modalities = [];\n  const oemsByModality = {};\n  const modelsByModalityOem = {};\n  const meta = {\n    oemFieldByModality: {},\n    modelFieldByModalityOem: {},\n    modalityKeyByLower: {},\n    oemKeyByModalityLower: {},\n    modelKeyByModalityOemLower: {},\n  };\n\n  snap.forEach((doc) => {\n    const modality = doc.id;\n    const modalityLower = normalizeKey(modality);\n    const existingModality = meta.modalityKeyByLower[modalityLower];\n    const canonicalModality = pickPreferredCase(existingModality, modality);\n    meta.modalityKeyByLower[modalityLower] = canonicalModality;\n    const data = doc.data() || {};\n    const { oemMap, oemField, modelFieldByOem } = extractOemMap(data);\n\n    modalities.push(canonicalModality);\n    if (!meta.oemFieldByModality[canonicalModality]) {\n      meta.oemFieldByModality[canonicalModality] = oemField;\n    }\n    meta.modelFieldByModalityOem[canonicalModality] = {\n      ...(meta.modelFieldByModalityOem[canonicalModality] || {}),\n      ...(modelFieldByOem || {}),\n    };\n\n    const oems = Object.keys(oemMap);\n    const mergedOems = normalizeListCaseInsensitive([\n      ...(oemsByModality[canonicalModality] || []),\n      ...oems,\n    ]);\n    oemsByModality[canonicalModality] = mergedOems;\n    modelsByModalityOem[canonicalModality] =\n      modelsByModalityOem[canonicalModality] || {};\n    const oemLowerMap =\n      meta.oemKeyByModalityLower[modalityLower] || {};\n    meta.oemKeyByModalityLower[modalityLower] = oemLowerMap;\n    const modelLowerMap =\n      meta.modelKeyByModalityOemLower[modalityLower] || {};\n    meta.modelKeyByModalityOemLower[modalityLower] = modelLowerMap;\n    oems.forEach((oem) => {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem = pickPreferredCase(oemLowerMap[oemLower], oem);\n      oemLowerMap[oemLower] = canonicalOem;\n      const existingModels =\n        modelsByModalityOem[canonicalModality][canonicalOem] || [];\n      const mergedModels = normalizeListCaseInsensitive([\n        ...existingModels,\n        ...(oemMap[oem] || []),\n      ]);\n      modelsByModalityOem[canonicalModality][canonicalOem] = mergedModels;\n      modelLowerMap[oemLower] = modelLowerMap[oemLower] || {};\n      mergedModels.forEach((model) => {\n        modelLowerMap[oemLower][normalizeKey(model)] = model;\n      });\n    });\n  });\n\n  return {\n    modalities: normalizeListCaseInsensitive(modalities),\n    oemsByModality,\n    modelsByModalityOem,\n    meta,\n  };\n}\n\nexport function buildAllOems(catalog) {\n  const map = new Map();\n  Object.values(catalog?.oemsByModality || {}).forEach((oems) => {\n    (oems || []).forEach((oem) => {\n      const key = normalizeKey(oem);\n      if (!key) return;\n      const current = map.get(key);\n      map.set(key, pickPreferredCase(current, oem));\n    });\n  });\n  return Array.from(map.values());\n}\n\nexport function buildModelsForSelection(catalog, modalities = [], oems = []) {\n  const modelSet = new Set();\n  const modals = normalizeList(modalities);\n  const oemList = normalizeList(oems);\n  modals.forEach((modality) => {\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality =\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\n    const oemMap = catalog?.modelsByModalityOem?.[canonicalModality] || {};\n    oemList.forEach((oem) => {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem =\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] || oem;\n      const models = oemMap?.[canonicalOem] || [];\n      models.forEach((model) => modelSet.add(model));\n    });\n  });\n  return Array.from(modelSet);\n}\n\nexport async function syncTrackerFromSelections({\n  selections,\n  catalog,\n}) {\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const selectedModalities = normalizeList(selections?.modalities || []);\n  const selectedOems = normalizeList(selections?.oems || []);\n  const selectedModels = normalizeList(selections?.models || []);\n\n  if (!selectedModalities.length) return false;\n\n  const ops = [];\n\n  for (const modality of selectedModalities) {\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality =\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\n    const docRef = trackerRef.doc(canonicalModality);\n    const existingOemsRaw = catalog?.oemsByModality?.[canonicalModality] || [];\n    const existingOemsLower = new Set(\n      existingOemsRaw.map((value) => normalizeKey(value))\n    );\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\n      DEFAULT_OEM_FIELD;\n\n    if (\n      !catalog?.modalities?.some(\n        (existing) => normalizeKey(existing) === modalityLower\n      )\n    ) {\n      ops.push(docRef.set({ [DEFAULT_OEM_FIELD]: {} }, { merge: true }));\n    }\n\n    for (const oem of selectedOems) {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem =\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] ||\n        oem;\n      if (!existingOemsLower.has(oemLower)) {\n        ops.push(\n          docRef.set({ [oemField]: { [canonicalOem]: [] } }, { merge: true })\n        );\n      }\n    }\n\n    for (const oem of selectedOems) {\n      const oemLower = normalizeKey(oem);\n      const canonicalOem =\n        catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[oemLower] ||\n        oem;\n      const knownModels =\n        catalog?.modelsByModalityOem?.[canonicalModality]?.[canonicalOem] || [];\n      const knownLower = new Set(\n        knownModels.map((value) => normalizeKey(value))\n      );\n      const modelField =\n        catalog?.meta?.modelFieldByModalityOem?.[canonicalModality]?.[\n          canonicalOem\n        ] || null;\n      for (const model of selectedModels) {\n        const modelLower = normalizeKey(model);\n        if (!modelLower || knownLower.has(modelLower)) continue;\n        const path = modelField\n          ? `${oemField}.${canonicalOem}.${modelField}`\n          : `${oemField}.${canonicalOem}`;\n        ops.push(\n          docRef.update({\n            [path]: firebase.firestore.FieldValue.arrayUnion(model),\n          })\n        );\n      }\n    }\n  }\n\n  if (ops.length) {\n    await Promise.allSettled(ops);\n    return true;\n  }\n  return false;\n}\n\nexport async function deleteTrackerOem({ oem, catalog }) {\n  if (!oem) return;\n  const db = firebase.firestore();\n  const trackerRef = db.collection(\"Tracker\");\n  const modalities = catalog?.modalities || [];\n  const ops = modalities.map((modality) => {\n    const modalityLower = normalizeKey(modality);\n    const canonicalModality =\n      catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\n    const oemField =\n      catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\n      DEFAULT_OEM_FIELD;\n    const docRef = trackerRef.doc(canonicalModality);\n    const canonicalOem =\n      catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[\n        normalizeKey(oem)\n      ] || oem;\n    const update = {\n      [`${oemField}.${canonicalOem}`]: firebase.firestore.FieldValue.delete(),\n    };\n    if (!catalog?.meta?.oemFieldByModality?.[canonicalModality]) {\n      update[canonicalOem] = firebase.firestore.FieldValue.delete();\n    }\n    return docRef.update(update).catch(() => null);\n  });\n  await Promise.allSettled(ops);\n}\n\nexport async function deleteTrackerModel({\n  modality,\n  oem,\n  model,\n  catalog,\n}) {\n  if (!modality || !oem || !model) return;\n  const db = firebase.firestore();\n  const modalityLower = normalizeKey(modality);\n  const canonicalModality =\n    catalog?.meta?.modalityKeyByLower?.[modalityLower] || modality;\n  const docRef = db.collection(\"Tracker\").doc(canonicalModality);\n  const oemField =\n    catalog?.meta?.oemFieldByModality?.[canonicalModality] ||\n    DEFAULT_OEM_FIELD;\n  const canonicalOem =\n    catalog?.meta?.oemKeyByModalityLower?.[modalityLower]?.[\n      normalizeKey(oem)\n    ] || oem;\n  const modelField =\n    catalog?.meta?.modelFieldByModalityOem?.[canonicalModality]?.[\n      canonicalOem\n    ] || null;\n  const path = modelField\n    ? `${oemField}.${canonicalOem}.${modelField}`\n    : `${oemField}.${canonicalOem}`;\n  await docRef.update({\n    [path]: firebase.firestore.FieldValue.arrayRemove(model),\n  });\n}\n"]},"metadata":{},"sourceType":"module"}