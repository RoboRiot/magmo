{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\mack2\\\\Desktop\\\\code\\\\pages\\\\NewSearch\\\\machine\\\\[id]\\\\index.js\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/router\";\nimport { Table, Button, Alert, Modal } from \"react-bootstrap\";\nimport firebase from \"../../../../context/Firebase\";\nimport styles from \"../Machine.module.css\"; // Import for SSR\n\nimport { adminDb } from \"../../../../context/FirebaseAdmin\";\n\nconst Machine = ({\n  initialMachine,\n  initialAssociatedParts,\n  error: initialError\n}) => {\n  const router = useRouter();\n  const {\n    0: selectedMachine,\n    1: setSelectedMachine\n  } = useState(initialMachine || null);\n  const {\n    0: associatedParts,\n    1: setAssociatedParts\n  } = useState(Array.isArray(initialAssociatedParts) ? initialAssociatedParts : []);\n  const {\n    0: error,\n    1: setError\n  } = useState(initialError || null);\n  const {\n    0: dragIndex,\n    1: setDragIndex\n  } = useState(null);\n  const {\n    0: dragOverIndex,\n    1: setDragOverIndex\n  } = useState(null);\n  const {\n    0: isPrinting,\n    1: setIsPrinting\n  } = useState(false);\n  const {\n    0: showPrintSuccess,\n    1: setShowPrintSuccess\n  } = useState(false);\n  useEffect(() => {\n    if (router.isReady) {\n      const {\n        id\n      } = router.query;\n\n      if (!id) {\n        const pathSegments = router.asPath.split(\"/\");\n        const machineIdFromPath = pathSegments[pathSegments.length - 1];\n        console.log(`Machine ID extracted from URL path: ${machineIdFromPath}`);\n        fetchMachineData(machineIdFromPath);\n      } else {\n        console.log(`Machine ID from router query: ${id}`); // If SSR already hydrated, avoid re-fetching unless we truly need to.\n\n        if (!selectedMachine) {\n          fetchMachineData(id);\n        }\n      }\n    }\n  }, [router.isReady, selectedMachine]);\n\n  const fetchMachineData = async machineId => {\n    try {\n      console.log(`Attempting to fetch machine data for ID: ${machineId}`);\n      const db = firebase.firestore();\n      const machineDoc = await db.collection(\"Machine\").doc(machineId).get();\n\n      if (machineDoc.exists) {\n        const machineData = machineDoc.data();\n        setSelectedMachine(machineData);\n        setError(null);\n        console.log(\"Machine data:\", machineData); // Fetch associated parts\n\n        if (machineData.associatedParts) {\n          fetchAssociatedParts(machineData.associatedParts);\n        }\n      } else {\n        console.error(\"Machine not found\");\n        setError(\"Machine not found\");\n      }\n    } catch (error) {\n      console.error(\"Error fetching machine data:\", error);\n      setError(\"Error fetching machine data\");\n    }\n  };\n\n  const fetchAssociatedParts = async associatedPartsRefs => {\n    try {\n      const db = firebase.firestore();\n      const partsDocs = await Promise.all(associatedPartsRefs.map(ref => ref.get()));\n      const partsData = await Promise.all(partsDocs.map(async doc => {\n        var _data$ClientFrom;\n\n        if (!doc.exists) {\n          // skip or return an empty object\n          return null;\n        }\n\n        const data = doc.data() || {};\n        let clientName = \"\";\n\n        if ((_data$ClientFrom = data.ClientFrom) !== null && _data$ClientFrom !== void 0 && _data$ClientFrom.get) {\n          const clientDoc = await data.ClientFrom.get();\n          clientName = clientDoc.exists ? clientDoc.data().name : \"\";\n        }\n\n        return _objectSpread(_objectSpread({\n          id: doc.id\n        }, data), {}, {\n          clientName\n        });\n      }));\n      setAssociatedParts(partsData.filter(p => p));\n      setError(null);\n      console.log(\"Associated parts data:\", partsData);\n    } catch (error) {\n      console.error(\"Error fetching associated parts:\", error);\n      setError(\"Error fetching associated parts\");\n    }\n  };\n\n  const handlePrintMulti = async () => {\n    setIsPrinting(true); // Create your payload with the mapped items.\n    // Replace 'associatedParts' with your actual variable containing the list.\n\n    const payload = {\n      items: associatedParts.map(part => ({\n        name: part.name,\n        arrival_date: part.arrival_date,\n        // Ensure your part has a 'date' field.\n        poNumber: part.poNumber || \"\",\n        OEM: part.TheMachine ? part.TheMachine.oem || \"\" : \"\",\n        modality: part.TheMachine ? part.TheMachine.modality || \"\" : \"\",\n        model: part.TheMachine ? part.TheMachine.model || \"\" : \"\",\n        local_sn: part.id,\n        // Using document id as the local serial number.\n        client: part.clientName || \"\",\n        description: part.description || (part.descriptions && part.descriptions.length > 0 ? part.descriptions[0].description : \"\")\n      })),\n      test_print: true,\n      // Hard-coded here if you want to test printing one item\n      index: 1 // Hard-coded index (1-based)\n\n    };\n\n    try {\n      const response = await fetch(\"https://9d70-174-76-22-138.ngrok-free.app/print_multi\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(payload)\n      });\n      const result = await response.json();\n      console.log(\"Print multi result:\", result.status);\n\n      if (!response.ok || (result === null || result === void 0 ? void 0 : result.status) === \"error\") {\n        throw new Error((result === null || result === void 0 ? void 0 : result.message) || \"Print failed.\");\n      }\n\n      setShowPrintSuccess(true);\n    } catch (error) {\n      console.error(\"Error printing multiple labels:\", error);\n      setError((error === null || error === void 0 ? void 0 : error.message) || \"Error printing multiple labels\");\n    } finally {\n      setIsPrinting(false);\n    }\n  };\n\n  const handleSelectPart = (id, name) => {\n    console.log(`Selected part ID: ${id}, Name: ${name}`);\n    router.push(\"../item/\" + id);\n  };\n\n  const handleDragStart = index => event => {\n    var _associatedParts$inde;\n\n    if (event.target.closest(\"button\")) {\n      event.preventDefault();\n      return;\n    }\n\n    setDragIndex(index);\n    event.dataTransfer.effectAllowed = \"move\";\n    event.dataTransfer.setData(\"text/plain\", ((_associatedParts$inde = associatedParts[index]) === null || _associatedParts$inde === void 0 ? void 0 : _associatedParts$inde.id) || String(index));\n  };\n\n  const handleDragOver = index => event => {\n    event.preventDefault();\n    if (dragOverIndex !== index) setDragOverIndex(index);\n    event.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDrop = index => event => {\n    event.preventDefault();\n\n    if (dragIndex == null || dragIndex === index) {\n      setDragIndex(null);\n      setDragOverIndex(null);\n      return;\n    }\n\n    setAssociatedParts(prev => {\n      const next = [...prev];\n      const [moved] = next.splice(dragIndex, 1);\n      next.splice(index, 0, moved);\n      return next;\n    });\n    setDragIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const handleDragEnd = () => {\n    setDragIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const formatDate = input => {\n    let date;\n\n    if (input && input.seconds) {\n      // Handle timestamp object with 'seconds' property\n      date = new Date(input.seconds * 1000);\n    } else if (typeof input === \"string\") {\n      // Handle date string\n      date = new Date(input);\n    } else {\n      return \"N/A\";\n    }\n\n    if (isNaN(date.getTime())) {\n      // Invalid date string\n      return \"Invalid Date\";\n    }\n\n    return date.toLocaleDateString();\n  };\n\n  return __jsx(\"div\", {\n    className: styles.page,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 219,\n      columnNumber: 5\n    }\n  }, isPrinting && __jsx(\"div\", {\n    className: styles.loadingOverlay,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 221,\n      columnNumber: 9\n    }\n  }, __jsx(\"img\", {\n    src: \"/magmo-logo.png\",\n    alt: \"Printing\",\n    className: styles.loadingLogo,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 222,\n      columnNumber: 11\n    }\n  })), __jsx(\"div\", {\n    className: styles.shell,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 229,\n      columnNumber: 7\n    }\n  }, __jsx(\"header\", {\n    className: styles.header,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 230,\n      columnNumber: 9\n    }\n  }, __jsx(\"div\", {\n    className: styles.brand,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 231,\n      columnNumber: 11\n    }\n  }, __jsx(\"img\", {\n    src: \"/magmo-logo.png\",\n    alt: \"Magmo\",\n    className: styles.brandLogo,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 232,\n      columnNumber: 13\n    }\n  }), __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 233,\n      columnNumber: 13\n    }\n  }, __jsx(\"div\", {\n    className: styles.brandName,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 234,\n      columnNumber: 15\n    }\n  }, \"Magmo\"), __jsx(\"div\", {\n    className: styles.brandSub,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 235,\n      columnNumber: 15\n    }\n  }, \"Machine Detail\"))), __jsx(Button, {\n    variant: \"outline-secondary\",\n    className: styles.backButton,\n    onClick: () => router.back(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 238,\n      columnNumber: 11\n    }\n  }, \"Back\")), __jsx(\"div\", {\n    className: styles.card,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 247,\n      columnNumber: 9\n    }\n  }, __jsx(Modal, {\n    show: showPrintSuccess,\n    onHide: () => setShowPrintSuccess(false),\n    centered: true,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 248,\n      columnNumber: 11\n    }\n  }, __jsx(Modal.Header, {\n    closeButton: true,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 253,\n      columnNumber: 13\n    }\n  }, __jsx(Modal.Title, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 254,\n      columnNumber: 15\n    }\n  }, \"Print Complete\")), __jsx(Modal.Body, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 256,\n      columnNumber: 13\n    }\n  }, \"All items were sent to the printer successfully.\"), __jsx(Modal.Footer, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 259,\n      columnNumber: 13\n    }\n  }, __jsx(Button, {\n    variant: \"primary\",\n    onClick: () => setShowPrintSuccess(false),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 260,\n      columnNumber: 15\n    }\n  }, \"Ok\"))), __jsx(\"div\", {\n    className: styles.cardHeader,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 268,\n      columnNumber: 11\n    }\n  }, __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 269,\n      columnNumber: 13\n    }\n  }, __jsx(\"div\", {\n    className: styles.cardTitle,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270,\n      columnNumber: 15\n    }\n  }, \"Machine Details\"), __jsx(\"div\", {\n    className: styles.cardSubtitle,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 271,\n      columnNumber: 15\n    }\n  }, \"Drag and drop parts to reorder this list.\")), __jsx(\"div\", {\n    className: styles.cardMeta,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 275,\n      columnNumber: 13\n    }\n  }, associatedParts.length, \" parts\")), __jsx(\"div\", {\n    className: styles.cardBody,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 279,\n      columnNumber: 11\n    }\n  }, error && !selectedMachine && __jsx(Alert, {\n    variant: \"danger\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 281,\n      columnNumber: 15\n    }\n  }, error), selectedMachine ? __jsx(React.Fragment, null, __jsx(\"div\", {\n    className: styles.machineGrid,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 285,\n      columnNumber: 17\n    }\n  }, __jsx(\"div\", {\n    className: styles.machineInfo,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 286,\n      columnNumber: 19\n    }\n  }, __jsx(\"div\", {\n    className: styles.machineName,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 287,\n      columnNumber: 21\n    }\n  }, selectedMachine.name || \"Unnamed Machine\"), __jsx(\"div\", {\n    className: styles.machineMetaRow,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 290,\n      columnNumber: 21\n    }\n  }, __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 291,\n      columnNumber: 23\n    }\n  }, \"OEM: \", selectedMachine.OEM || \"N/A\"), __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 292,\n      columnNumber: 23\n    }\n  }, \"Modality: \", selectedMachine.Modality || \"N/A\"), __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 293,\n      columnNumber: 23\n    }\n  }, \"Model: \", selectedMachine.Model || \"N/A\"))), __jsx(\"div\", {\n    className: styles.machineDates,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 296,\n      columnNumber: 19\n    }\n  }, __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 297,\n      columnNumber: 21\n    }\n  }, __jsx(\"span\", {\n    className: styles.dateLabel,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 298,\n      columnNumber: 23\n    }\n  }, \"Last PM\"), __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 299,\n      columnNumber: 23\n    }\n  }, formatDate(selectedMachine.lastPM))), __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 301,\n      columnNumber: 21\n    }\n  }, __jsx(\"span\", {\n    className: styles.dateLabel,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 302,\n      columnNumber: 23\n    }\n  }, \"Next PM\"), __jsx(\"span\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 303,\n      columnNumber: 23\n    }\n  }, formatDate(selectedMachine.nextPM))))), __jsx(\"div\", {\n    className: styles.tableCard,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 308,\n      columnNumber: 17\n    }\n  }, __jsx(\"div\", {\n    className: styles.tableHeader,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 309,\n      columnNumber: 19\n    }\n  }, \"Associated Parts\", __jsx(\"span\", {\n    className: styles.tableHint,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 311,\n      columnNumber: 21\n    }\n  }, \"Click + hold to move\")), __jsx(\"div\", {\n    className: styles.tableWrap,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 315,\n      columnNumber: 19\n    }\n  }, __jsx(Table, {\n    striped: true,\n    bordered: true,\n    hover: true,\n    size: \"sm\",\n    className: styles.table,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 316,\n      columnNumber: 21\n    }\n  }, __jsx(\"thead\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 323,\n      columnNumber: 23\n    }\n  }, __jsx(\"tr\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 324,\n      columnNumber: 25\n    }\n  }, __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 325,\n      columnNumber: 27\n    }\n  }, \"Name\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 326,\n      columnNumber: 27\n    }\n  }, \"ID\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 327,\n      columnNumber: 27\n    }\n  }, \"Part Number\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 328,\n      columnNumber: 27\n    }\n  }, \"Serial Number\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 329,\n      columnNumber: 27\n    }\n  }, \"Date\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 330,\n      columnNumber: 27\n    }\n  }, \"Select\"))), __jsx(\"tbody\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 333,\n      columnNumber: 23\n    }\n  }, associatedParts.length === 0 && __jsx(\"tr\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 335,\n      columnNumber: 27\n    }\n  }, __jsx(\"td\", {\n    colSpan: 6,\n    className: styles.emptyState,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 336,\n      columnNumber: 29\n    }\n  }, \"No associated parts found.\")), associatedParts.map((part, index) => __jsx(\"tr\", {\n    key: part.id,\n    draggable: true,\n    onDragStart: handleDragStart(index),\n    onDragOver: handleDragOver(index),\n    onDrop: handleDrop(index),\n    onDragEnd: handleDragEnd,\n    className: `${styles.draggableRow} ${dragIndex === index ? styles.dragging : \"\"} ${dragOverIndex === index && dragIndex !== index ? styles.dropTarget : \"\"}`,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 342,\n      columnNumber: 27\n    }\n  }, __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 357,\n      columnNumber: 29\n    }\n  }, part.name), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 358,\n      columnNumber: 29\n    }\n  }, part.id), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 359,\n      columnNumber: 29\n    }\n  }, part.pn), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 360,\n      columnNumber: 29\n    }\n  }, part.sn), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 361,\n      columnNumber: 29\n    }\n  }, formatDate(part.date || part.arrival_date)), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 362,\n      columnNumber: 29\n    }\n  }, __jsx(Button, {\n    variant: \"primary\",\n    size: \"sm\",\n    onClick: () => handleSelectPart(part.id, part.name),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 363,\n      columnNumber: 31\n    }\n  }, \"Select\"))))))), __jsx(\"div\", {\n    className: styles.tableActions,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 378,\n      columnNumber: 19\n    }\n  }, __jsx(Button, {\n    variant: \"secondary\",\n    className: styles.actionButton,\n    onClick: handlePrintMulti,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 379,\n      columnNumber: 21\n    }\n  }, \"Print All Items\")))) : !error && __jsx(\"p\", {\n    className: styles.loadingText,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 390,\n      columnNumber: 25\n    }\n  }, \"Loading machine data...\")))));\n};\n\nexport default Machine; // Server-side rendering function\n\nexport async function getServerSideProps(context) {\n  const {\n    id\n  } = context.params;\n\n  try {\n    // Fetch machine data from Firestore using Admin SDK\n    const machineDoc = await adminDb.collection(\"Machine\").doc(id).get();\n\n    if (!machineDoc.exists) {\n      return {\n        notFound: true // This will show a 404 page\n\n      };\n    }\n\n    const machineData = machineDoc.data(); // Fetch associated parts if they exist\n\n    let associatedParts = [];\n\n    if (machineData.associatedParts && Array.isArray(machineData.associatedParts)) {\n      try {\n        const partsPromises = machineData.associatedParts.map(partRef => {\n          if (partRef.path) {\n            return adminDb.doc(partRef.path).get();\n          }\n\n          return null;\n        }).filter(Boolean);\n        const partsDocs = await Promise.all(partsPromises);\n        associatedParts = await Promise.all(partsDocs.map(async doc => {\n          if (!doc.exists) {\n            return null;\n          }\n\n          const data = doc.data() || {};\n          let clientName = \"\"; // Fetch client name if ClientFrom reference exists\n\n          if (data.ClientFrom && data.ClientFrom.path) {\n            try {\n              const clientDoc = await adminDb.doc(data.ClientFrom.path).get();\n              clientName = clientDoc.exists ? clientDoc.data().name : \"\";\n            } catch (error) {\n              console.error(\"Error fetching client data:\", error);\n            }\n          }\n\n          return _objectSpread(_objectSpread({\n            id: doc.id\n          }, data), {}, {\n            clientName\n          });\n        })); // Filter out null values\n\n        associatedParts = associatedParts.filter(part => part !== null);\n      } catch (error) {\n        console.error(\"Error fetching associated parts:\", error);\n      }\n    } // Serialize the machine data, removing any non-serializable fields\n\n\n    const serializedMachine = {\n      id,\n      name: machineData.name || \"\",\n      Model: machineData.Model || \"\",\n      OEM: machineData.OEM || \"\",\n      Modality: machineData.Modality || \"\",\n      lastPM: machineData.lastPM || null,\n      nextPM: machineData.nextPM || null // Add other machine fields as needed, but ensure they're serializable\n\n    };\n    return {\n      props: {\n        initialMachine: serializedMachine,\n        initialAssociatedParts: associatedParts\n      }\n    };\n  } catch (error) {\n    console.error(\"Error in getServerSideProps:\", error);\n    return {\n      props: {\n        error: \"Failed to load machine data\"\n      }\n    };\n  }\n}","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/pages/NewSearch/machine/[id]/index.js"],"names":["React","useEffect","useState","useRouter","Table","Button","Alert","Modal","firebase","styles","adminDb","Machine","initialMachine","initialAssociatedParts","error","initialError","router","selectedMachine","setSelectedMachine","associatedParts","setAssociatedParts","Array","isArray","setError","dragIndex","setDragIndex","dragOverIndex","setDragOverIndex","isPrinting","setIsPrinting","showPrintSuccess","setShowPrintSuccess","isReady","id","query","pathSegments","asPath","split","machineIdFromPath","length","console","log","fetchMachineData","machineId","db","firestore","machineDoc","collection","doc","get","exists","machineData","data","fetchAssociatedParts","associatedPartsRefs","partsDocs","Promise","all","map","ref","partsData","clientName","ClientFrom","clientDoc","name","filter","p","handlePrintMulti","payload","items","part","arrival_date","poNumber","OEM","TheMachine","oem","modality","model","local_sn","client","description","descriptions","test_print","index","response","fetch","method","headers","body","JSON","stringify","result","json","status","ok","Error","message","handleSelectPart","push","handleDragStart","event","target","closest","preventDefault","dataTransfer","effectAllowed","setData","String","handleDragOver","dropEffect","handleDrop","prev","next","moved","splice","handleDragEnd","formatDate","input","date","seconds","Date","isNaN","getTime","toLocaleDateString","page","loadingOverlay","loadingLogo","shell","header","brand","brandLogo","brandName","brandSub","backButton","back","card","cardHeader","cardTitle","cardSubtitle","cardMeta","cardBody","machineGrid","machineInfo","machineName","machineMetaRow","Modality","Model","machineDates","dateLabel","lastPM","nextPM","tableCard","tableHeader","tableHint","tableWrap","table","emptyState","draggableRow","dragging","dropTarget","pn","sn","tableActions","actionButton","loadingText","getServerSideProps","context","params","notFound","partsPromises","partRef","path","Boolean","serializedMachine","props"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/router\";\nimport {\n  Table,\n  Button,\n  Alert,\n  Modal,\n} from \"react-bootstrap\";\nimport firebase from \"../../../../context/Firebase\";\nimport styles from \"../Machine.module.css\";\n\n// Import for SSR\nimport { adminDb } from \"../../../../context/FirebaseAdmin\";\n\nconst Machine = ({ initialMachine, initialAssociatedParts, error: initialError }) => {\n  const router = useRouter();\n  const [selectedMachine, setSelectedMachine] = useState(\n    initialMachine || null\n  );\n  const [associatedParts, setAssociatedParts] = useState(\n    Array.isArray(initialAssociatedParts) ? initialAssociatedParts : []\n  );\n  const [error, setError] = useState(initialError || null);\n  const [dragIndex, setDragIndex] = useState(null);\n  const [dragOverIndex, setDragOverIndex] = useState(null);\n  const [isPrinting, setIsPrinting] = useState(false);\n  const [showPrintSuccess, setShowPrintSuccess] = useState(false);\n\n  useEffect(() => {\n    if (router.isReady) {\n      const { id } = router.query;\n      if (!id) {\n        const pathSegments = router.asPath.split(\"/\");\n        const machineIdFromPath = pathSegments[pathSegments.length - 1];\n        console.log(`Machine ID extracted from URL path: ${machineIdFromPath}`);\n        fetchMachineData(machineIdFromPath);\n      } else {\n        console.log(`Machine ID from router query: ${id}`);\n        // If SSR already hydrated, avoid re-fetching unless we truly need to.\n        if (!selectedMachine) {\n          fetchMachineData(id);\n        }\n      }\n    }\n  }, [router.isReady, selectedMachine]);\n\n  const fetchMachineData = async (machineId) => {\n    try {\n      console.log(`Attempting to fetch machine data for ID: ${machineId}`);\n      const db = firebase.firestore();\n      const machineDoc = await db.collection(\"Machine\").doc(machineId).get();\n      if (machineDoc.exists) {\n        const machineData = machineDoc.data();\n        setSelectedMachine(machineData);\n        setError(null);\n        console.log(\"Machine data:\", machineData);\n\n        // Fetch associated parts\n        if (machineData.associatedParts) {\n          fetchAssociatedParts(machineData.associatedParts);\n        }\n      } else {\n        console.error(\"Machine not found\");\n        setError(\"Machine not found\");\n      }\n    } catch (error) {\n      console.error(\"Error fetching machine data:\", error);\n      setError(\"Error fetching machine data\");\n    }\n  };\n\n  const fetchAssociatedParts = async (associatedPartsRefs) => {\n    try {\n      const db = firebase.firestore();\n      const partsDocs = await Promise.all(\n        associatedPartsRefs.map((ref) => ref.get())\n      );\n\n      const partsData = await Promise.all(\n        partsDocs.map(async (doc) => {\n          if (!doc.exists) {\n            // skip or return an empty object\n            return null;\n          }\n          const data = doc.data() || {};\n          let clientName = \"\";\n          if (data.ClientFrom?.get) {\n            const clientDoc = await data.ClientFrom.get();\n            clientName = clientDoc.exists ? clientDoc.data().name : \"\";\n          }\n          return { id: doc.id, ...data, clientName };\n        })\n      );\n\n      setAssociatedParts(partsData.filter((p) => p));\n      setError(null);\n      console.log(\"Associated parts data:\", partsData);\n    } catch (error) {\n      console.error(\"Error fetching associated parts:\", error);\n      setError(\"Error fetching associated parts\");\n    }\n  };\n\n  const handlePrintMulti = async () => {\n    setIsPrinting(true);\n    // Create your payload with the mapped items.\n    // Replace 'associatedParts' with your actual variable containing the list.\n    const payload = {\n      items: associatedParts.map((part) => ({\n        name: part.name,\n        arrival_date: part.arrival_date, // Ensure your part has a 'date' field.\n        poNumber: part.poNumber || \"\",\n        OEM: part.TheMachine ? part.TheMachine.oem || \"\" : \"\",\n        modality: part.TheMachine ? part.TheMachine.modality || \"\" : \"\",\n        model: part.TheMachine ? part.TheMachine.model || \"\" : \"\",\n        local_sn: part.id, // Using document id as the local serial number.\n        client: part.clientName || \"\",\n        description:\n          part.description ||\n          (part.descriptions && part.descriptions.length > 0\n            ? part.descriptions[0].description\n            : \"\"),\n      })),\n      test_print: true, // Hard-coded here if you want to test printing one item\n      index: 1, // Hard-coded index (1-based)\n    };\n\n    try {\n      const response = await fetch(\n        \"https://9d70-174-76-22-138.ngrok-free.app/print_multi\",\n        {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(payload),\n        }\n      );\n      const result = await response.json();\n      console.log(\"Print multi result:\", result.status);\n      if (!response.ok || result?.status === \"error\") {\n        throw new Error(result?.message || \"Print failed.\");\n      }\n      setShowPrintSuccess(true);\n    } catch (error) {\n      console.error(\"Error printing multiple labels:\", error);\n      setError(error?.message || \"Error printing multiple labels\");\n    } finally {\n      setIsPrinting(false);\n    }\n  };\n\n  const handleSelectPart = (id, name) => {\n    console.log(`Selected part ID: ${id}, Name: ${name}`);\n    router.push(\"../item/\" + id);\n  };\n\n  const handleDragStart = (index) => (event) => {\n    if (event.target.closest(\"button\")) {\n      event.preventDefault();\n      return;\n    }\n    setDragIndex(index);\n    event.dataTransfer.effectAllowed = \"move\";\n    event.dataTransfer.setData(\n      \"text/plain\",\n      associatedParts[index]?.id || String(index)\n    );\n  };\n\n  const handleDragOver = (index) => (event) => {\n    event.preventDefault();\n    if (dragOverIndex !== index) setDragOverIndex(index);\n    event.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDrop = (index) => (event) => {\n    event.preventDefault();\n    if (dragIndex == null || dragIndex === index) {\n      setDragIndex(null);\n      setDragOverIndex(null);\n      return;\n    }\n    setAssociatedParts((prev) => {\n      const next = [...prev];\n      const [moved] = next.splice(dragIndex, 1);\n      next.splice(index, 0, moved);\n      return next;\n    });\n    setDragIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const handleDragEnd = () => {\n    setDragIndex(null);\n    setDragOverIndex(null);\n  };\n\n  const formatDate = (input) => {\n    let date;\n\n    if (input && input.seconds) {\n      // Handle timestamp object with 'seconds' property\n      date = new Date(input.seconds * 1000);\n    } else if (typeof input === \"string\") {\n      // Handle date string\n      date = new Date(input);\n    } else {\n      return \"N/A\";\n    }\n\n    if (isNaN(date.getTime())) {\n      // Invalid date string\n      return \"Invalid Date\";\n    }\n\n    return date.toLocaleDateString();\n  };\n\n  return (\n    <div className={styles.page}>\n      {isPrinting && (\n        <div className={styles.loadingOverlay}>\n          <img\n            src=\"/magmo-logo.png\"\n            alt=\"Printing\"\n            className={styles.loadingLogo}\n          />\n        </div>\n      )}\n      <div className={styles.shell}>\n        <header className={styles.header}>\n          <div className={styles.brand}>\n            <img src=\"/magmo-logo.png\" alt=\"Magmo\" className={styles.brandLogo} />\n            <div>\n              <div className={styles.brandName}>Magmo</div>\n              <div className={styles.brandSub}>Machine Detail</div>\n            </div>\n          </div>\n          <Button\n            variant=\"outline-secondary\"\n            className={styles.backButton}\n            onClick={() => router.back()}\n          >\n            Back\n          </Button>\n        </header>\n\n        <div className={styles.card}>\n          <Modal\n            show={showPrintSuccess}\n            onHide={() => setShowPrintSuccess(false)}\n            centered\n          >\n            <Modal.Header closeButton>\n              <Modal.Title>Print Complete</Modal.Title>\n            </Modal.Header>\n            <Modal.Body>\n              All items were sent to the printer successfully.\n            </Modal.Body>\n            <Modal.Footer>\n              <Button\n                variant=\"primary\"\n                onClick={() => setShowPrintSuccess(false)}\n              >\n                Ok\n              </Button>\n            </Modal.Footer>\n          </Modal>\n          <div className={styles.cardHeader}>\n            <div>\n              <div className={styles.cardTitle}>Machine Details</div>\n              <div className={styles.cardSubtitle}>\n                Drag and drop parts to reorder this list.\n              </div>\n            </div>\n            <div className={styles.cardMeta}>\n              {associatedParts.length} parts\n            </div>\n          </div>\n          <div className={styles.cardBody}>\n            {error && !selectedMachine && (\n              <Alert variant=\"danger\">{error}</Alert>\n            )}\n            {selectedMachine ? (\n              <>\n                <div className={styles.machineGrid}>\n                  <div className={styles.machineInfo}>\n                    <div className={styles.machineName}>\n                      {selectedMachine.name || \"Unnamed Machine\"}\n                    </div>\n                    <div className={styles.machineMetaRow}>\n                      <span>OEM: {selectedMachine.OEM || \"N/A\"}</span>\n                      <span>Modality: {selectedMachine.Modality || \"N/A\"}</span>\n                      <span>Model: {selectedMachine.Model || \"N/A\"}</span>\n                    </div>\n                  </div>\n                  <div className={styles.machineDates}>\n                    <div>\n                      <span className={styles.dateLabel}>Last PM</span>\n                      <span>{formatDate(selectedMachine.lastPM)}</span>\n                    </div>\n                    <div>\n                      <span className={styles.dateLabel}>Next PM</span>\n                      <span>{formatDate(selectedMachine.nextPM)}</span>\n                    </div>\n                  </div>\n                </div>\n\n                <div className={styles.tableCard}>\n                  <div className={styles.tableHeader}>\n                    Associated Parts\n                    <span className={styles.tableHint}>\n                      Click + hold to move\n                    </span>\n                  </div>\n                  <div className={styles.tableWrap}>\n                    <Table\n                      striped\n                      bordered\n                      hover\n                      size=\"sm\"\n                      className={styles.table}\n                    >\n                      <thead>\n                        <tr>\n                          <th>Name</th>\n                          <th>ID</th>\n                          <th>Part Number</th>\n                          <th>Serial Number</th>\n                          <th>Date</th>\n                          <th>Select</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {associatedParts.length === 0 && (\n                          <tr>\n                            <td colSpan={6} className={styles.emptyState}>\n                              No associated parts found.\n                            </td>\n                          </tr>\n                        )}\n                        {associatedParts.map((part, index) => (\n                          <tr\n                            key={part.id}\n                            draggable\n                            onDragStart={handleDragStart(index)}\n                            onDragOver={handleDragOver(index)}\n                            onDrop={handleDrop(index)}\n                            onDragEnd={handleDragEnd}\n                            className={`${styles.draggableRow} ${\n                              dragIndex === index ? styles.dragging : \"\"\n                            } ${\n                              dragOverIndex === index && dragIndex !== index\n                                ? styles.dropTarget\n                                : \"\"\n                            }`}\n                          >\n                            <td>{part.name}</td>\n                            <td>{part.id}</td>\n                            <td>{part.pn}</td>\n                            <td>{part.sn}</td>\n                            <td>{formatDate(part.date || part.arrival_date)}</td>\n                            <td>\n                              <Button\n                                variant=\"primary\"\n                                size=\"sm\"\n                                onClick={() =>\n                                  handleSelectPart(part.id, part.name)\n                                }\n                              >\n                                Select\n                              </Button>\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </Table>\n                  </div>\n                  <div className={styles.tableActions}>\n                    <Button\n                      variant=\"secondary\"\n                      className={styles.actionButton}\n                      onClick={handlePrintMulti}\n                    >\n                      Print All Items\n                    </Button>\n                  </div>\n                </div>\n              </>\n            ) : (\n              !error && <p className={styles.loadingText}>Loading machine data...</p>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default Machine;\n\n// Server-side rendering function\nexport async function getServerSideProps(context) {\n  const { id } = context.params;\n\n  try {\n    // Fetch machine data from Firestore using Admin SDK\n    const machineDoc = await adminDb.collection(\"Machine\").doc(id).get();\n\n    if (!machineDoc.exists) {\n      return {\n        notFound: true, // This will show a 404 page\n      };\n    }\n\n    const machineData = machineDoc.data();\n\n    // Fetch associated parts if they exist\n    let associatedParts = [];\n    if (\n      machineData.associatedParts &&\n      Array.isArray(machineData.associatedParts)\n    ) {\n      try {\n        const partsPromises = machineData.associatedParts\n          .map((partRef) => {\n            if (partRef.path) {\n              return adminDb.doc(partRef.path).get();\n            }\n            return null;\n          })\n          .filter(Boolean);\n\n        const partsDocs = await Promise.all(partsPromises);\n        associatedParts = await Promise.all(\n          partsDocs.map(async (doc) => {\n            if (!doc.exists) {\n              return null;\n            }\n            const data = doc.data() || {};\n            let clientName = \"\";\n\n            // Fetch client name if ClientFrom reference exists\n            if (data.ClientFrom && data.ClientFrom.path) {\n              try {\n                const clientDoc = await adminDb.doc(data.ClientFrom.path).get();\n                clientName = clientDoc.exists ? clientDoc.data().name : \"\";\n              } catch (error) {\n                console.error(\"Error fetching client data:\", error);\n              }\n            }\n\n            return {\n              id: doc.id,\n              ...data,\n              clientName,\n            };\n          })\n        );\n\n        // Filter out null values\n        associatedParts = associatedParts.filter((part) => part !== null);\n      } catch (error) {\n        console.error(\"Error fetching associated parts:\", error);\n      }\n    }\n\n    // Serialize the machine data, removing any non-serializable fields\n    const serializedMachine = {\n      id,\n      name: machineData.name || \"\",\n      Model: machineData.Model || \"\",\n      OEM: machineData.OEM || \"\",\n      Modality: machineData.Modality || \"\",\n      lastPM: machineData.lastPM || null,\n      nextPM: machineData.nextPM || null,\n      // Add other machine fields as needed, but ensure they're serializable\n    };\n\n    return {\n      props: {\n        initialMachine: serializedMachine,\n        initialAssociatedParts: associatedParts,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error in getServerSideProps:\", error);\n    return {\n      props: {\n        error: \"Failed to load machine data\",\n      },\n    };\n  }\n}\n"]},"metadata":{},"sourceType":"module"}