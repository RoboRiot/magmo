{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\mack2\\\\Desktop\\\\code\\\\pages\\\\NewSearch\\\\client\\\\[id]\\\\addClient.js\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { useState, useEffect } from \"react\";\nimport \"bootstrap/dist/css/bootstrap.min.css\";\nimport { Form, Button, Card, Container, Row, Col, Modal, Table } from \"react-bootstrap\";\nimport { useRouter } from \"next/router\";\nimport firebase from \"../../../../context/Firebase\";\nimport ClientInfoModal from \"../../ClientInfoModal\";\nimport MachineCreationModal from \"../../MachineCreationModal\";\n\nconst AddClient = () => {\n  const router = useRouter();\n  const {\n    0: clientId,\n    1: setClientId\n  } = useState(null);\n  const {\n    0: client,\n    1: setClient\n  } = useState({\n    name: \"\",\n    location: \"\"\n  });\n  const {\n    0: addedMachines,\n    1: setAddedMachines\n  } = useState([]);\n  const {\n    0: showClientInfoModal,\n    1: setShowClientInfoModal\n  } = useState(false);\n  const {\n    0: showMachineCreationModal,\n    1: setShowMachineCreationModal\n  } = useState(false);\n  const {\n    0: machineOptions,\n    1: setMachineOptions\n  } = useState([]);\n  const {\n    0: error,\n    1: setError\n  } = useState(null);\n  useEffect(() => {\n    const handleClientId = () => {\n      const {\n        id\n      } = router.query;\n\n      if (id) {\n        setClientId(id);\n        fetchClientData(id);\n      }\n    };\n\n    if (router.isReady) {\n      handleClientId();\n    }\n  }, [router.isReady, router.query]);\n\n  const fetchClientData = async id => {\n    const db = firebase.firestore();\n\n    try {\n      const doc = await db.collection(\"Client\").doc(id).get();\n\n      if (doc.exists) {\n        const data = doc.data();\n        setClient({\n          name: data.name || \"\",\n          location: data.local || \"\"\n        });\n        const machineRefs = data.machines || [];\n        const machines = await Promise.all(machineRefs.map(ref => ref.get().then(doc => _objectSpread({\n          id: doc.id\n        }, doc.data()))));\n        setAddedMachines(machines);\n      }\n    } catch (error) {\n      console.error(\"Error fetching client data:\", error);\n      setError(\"Failed to fetch client data.\");\n    }\n  };\n\n  const fetchAvailableMachines = async () => {\n    const db = firebase.firestore();\n\n    try {\n      const snapshot = await db.collection(\"Machine\").where(\"client\", \"==\", null).get();\n      const machines = snapshot.docs.map(doc => _objectSpread({\n        id: doc.id\n      }, doc.data()));\n      setMachineOptions(machines);\n    } catch (error) {\n      console.error(\"Error fetching machines:\", error);\n      setError(\"Failed to fetch machines.\");\n    }\n  };\n\n  const handleChange = field => event => {\n    const value = event.target.value;\n    setClient(prev => _objectSpread(_objectSpread({}, prev), {}, {\n      [field]: value\n    }));\n  };\n\n  const handleAddMachine = machine => {\n    setAddedMachines(prev => [...prev, machine]);\n    setShowClientInfoModal(false);\n  }; // When creating a new machine, if a client exists (edit mode) use set with merge\n  // so that if the client document doesn't exist yet it gets created.\n\n\n  const handleCreateMachine = async newMachine => {\n    const db = firebase.firestore();\n    const machineId = `AIS${Math.floor(10000 + Math.random() * 90000)}`;\n\n    try {\n      const machineWithId = _objectSpread(_objectSpread({}, newMachine), {}, {\n        id: machineId,\n        // Only set the client if clientId exists; otherwise, leave it null.\n        client: clientId ? db.collection(\"Client\").doc(clientId) : null\n      });\n\n      await db.collection(\"Machine\").doc(machineId).set(machineWithId); // If editing an existing client, update its machines array using set with merge.\n\n      if (clientId) {\n        const clientRef = db.collection(\"Client\").doc(clientId);\n        await clientRef.set({\n          machines: firebase.firestore.FieldValue.arrayUnion(db.collection(\"Machine\").doc(machineId))\n        }, {\n          merge: true\n        });\n      }\n\n      setShowMachineCreationModal(false);\n      setAddedMachines(prev => [...prev, _objectSpread({\n        id: machineId\n      }, newMachine)]);\n    } catch (error) {\n      console.error(\"Error creating and adding machine:\", error);\n      setError(\"Failed to create and add machine.\");\n    }\n  };\n\n  const handleRemoveMachine = index => {\n    setAddedMachines(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const handleSubmit = async () => {\n    const db = firebase.firestore();\n\n    try {\n      if (clientId) {\n        // Update existing client\n        await db.collection(\"Client\").doc(clientId).set(_objectSpread(_objectSpread({}, client), {}, {\n          machines: addedMachines.map(machine => db.collection(\"Machine\").doc(machine.id))\n        }), {\n          merge: true\n        });\n      } else {\n        // Create new client\n        const newClientId = `AIS${Math.floor(10000 + Math.random() * 90000)}`;\n        await db.collection(\"Client\").doc(newClientId).set(_objectSpread(_objectSpread({}, client), {}, {\n          machines: addedMachines.map(machine => db.collection(\"Machine\").doc(machine.id))\n        })); // (Update machines with the new client reference as needed.)\n\n        clientId = newClientId;\n      }\n\n      alert(\"Client and machines saved successfully.\"); // Check if we came from an item; if so, route back to that item page.\n\n      if (router.query.from === \"item\" && router.query.itemId) {\n        router.push(`/NewSearch/item/${router.query.itemId}`);\n      } else if (router.query.from === \"addItem\" && router.query.itemId) {\n        router.push(\"AddItem/NewItem\");\n      } else {\n        router.push(\"../../clientSearch\");\n      }\n    } catch (error) {\n      console.error(\"Error saving client:\", error);\n      setError(\"Failed to save client.\");\n    }\n  };\n\n  return __jsx(Container, {\n    className: \"mt-5\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 180,\n      columnNumber: 5\n    }\n  }, __jsx(Row, {\n    className: \"justify-content-md-center\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 181,\n      columnNumber: 7\n    }\n  }, __jsx(Col, {\n    md: \"8\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 182,\n      columnNumber: 9\n    }\n  }, __jsx(Card, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 183,\n      columnNumber: 11\n    }\n  }, __jsx(Card.Header, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 13\n    }\n  }, __jsx(\"h4\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 185,\n      columnNumber: 15\n    }\n  }, clientId ? \"Edit Client\" : \"Add New Client\")), __jsx(Card.Body, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 187,\n      columnNumber: 13\n    }\n  }, error && __jsx(\"p\", {\n    className: \"text-danger\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 188,\n      columnNumber: 25\n    }\n  }, error), __jsx(Form, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 189,\n      columnNumber: 15\n    }\n  }, __jsx(Row, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 190,\n      columnNumber: 17\n    }\n  }, __jsx(Col, {\n    md: 6,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 191,\n      columnNumber: 19\n    }\n  }, __jsx(Form.Group, {\n    controlId: \"clientName\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 192,\n      columnNumber: 21\n    }\n  }, __jsx(Form.Label, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 193,\n      columnNumber: 23\n    }\n  }, \"Client Name\"), __jsx(Form.Control, {\n    type: \"text\",\n    placeholder: \"Enter client name\",\n    value: client.name,\n    onChange: handleChange(\"name\"),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 194,\n      columnNumber: 23\n    }\n  }))), __jsx(Col, {\n    md: 6,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 202,\n      columnNumber: 19\n    }\n  }, __jsx(Form.Group, {\n    controlId: \"clientLocation\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 203,\n      columnNumber: 21\n    }\n  }, __jsx(Form.Label, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 204,\n      columnNumber: 23\n    }\n  }, \"Location\"), __jsx(Form.Control, {\n    type: \"text\",\n    placeholder: \"Enter location\",\n    value: client.location,\n    onChange: handleChange(\"location\"),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 205,\n      columnNumber: 23\n    }\n  })))), __jsx(Row, {\n    className: \"mt-3\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 214,\n      columnNumber: 17\n    }\n  }, __jsx(Col, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 215,\n      columnNumber: 19\n    }\n  }, __jsx(Button, {\n    variant: \"primary\",\n    onClick: () => setShowClientInfoModal(true),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 216,\n      columnNumber: 21\n    }\n  }, \"Add Machine\"), __jsx(Button, {\n    variant: \"secondary\",\n    className: \"ms-2\",\n    onClick: () => setShowMachineCreationModal(true),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 222,\n      columnNumber: 21\n    }\n  }, \"Create Machine\"))), __jsx(Row, {\n    className: \"mt-3\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 231,\n      columnNumber: 17\n    }\n  }, __jsx(Col, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 232,\n      columnNumber: 19\n    }\n  }, __jsx(Table, {\n    striped: true,\n    bordered: true,\n    hover: true,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 233,\n      columnNumber: 21\n    }\n  }, __jsx(\"thead\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 234,\n      columnNumber: 23\n    }\n  }, __jsx(\"tr\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 235,\n      columnNumber: 25\n    }\n  }, __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 236,\n      columnNumber: 27\n    }\n  }, \"Machine Name\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 237,\n      columnNumber: 27\n    }\n  }, \"Location\"), __jsx(\"th\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 238,\n      columnNumber: 27\n    }\n  }, \"Actions\"))), __jsx(\"tbody\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 241,\n      columnNumber: 23\n    }\n  }, addedMachines.map((machine, index) => __jsx(\"tr\", {\n    key: index,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 243,\n      columnNumber: 27\n    }\n  }, __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 244,\n      columnNumber: 29\n    }\n  }, machine.name), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 245,\n      columnNumber: 29\n    }\n  }, machine.local), __jsx(\"td\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 246,\n      columnNumber: 29\n    }\n  }, __jsx(Button, {\n    variant: \"danger\",\n    size: \"sm\",\n    onClick: () => handleRemoveMachine(index),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 247,\n      columnNumber: 31\n    }\n  }, \"Remove\")))))))), __jsx(Row, {\n    className: \"mt-4\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 261,\n      columnNumber: 17\n    }\n  }, __jsx(Col, {\n    md: 6,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 262,\n      columnNumber: 19\n    }\n  }, __jsx(Button, {\n    variant: \"success\",\n    onClick: handleSubmit,\n    className: \"w-100\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 263,\n      columnNumber: 21\n    }\n  }, \"Submit\")), __jsx(Col, {\n    md: 6,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 271,\n      columnNumber: 19\n    }\n  }, __jsx(Button, {\n    variant: \"primary\",\n    onClick: () => router.back(),\n    className: \"w-100\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 272,\n      columnNumber: 21\n    }\n  }, \"Back\")))))))), __jsx(ClientInfoModal, {\n    show: showClientInfoModal,\n    handleClose: () => setShowClientInfoModal(false),\n    machineOptions: machineOptions,\n    setSelectedMachine: handleAddMachine,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 288,\n      columnNumber: 7\n    }\n  }), __jsx(MachineCreationModal, {\n    show: showMachineCreationModal,\n    handleClose: () => setShowMachineCreationModal(false),\n    onCreateMachine: handleCreateMachine,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 296,\n      columnNumber: 7\n    }\n  }));\n};\n\nexport default AddClient;","map":{"version":3,"sources":["C:/Users/mack2/Desktop/code/pages/NewSearch/client/[id]/addClient.js"],"names":["React","useState","useEffect","Form","Button","Card","Container","Row","Col","Modal","Table","useRouter","firebase","ClientInfoModal","MachineCreationModal","AddClient","router","clientId","setClientId","client","setClient","name","location","addedMachines","setAddedMachines","showClientInfoModal","setShowClientInfoModal","showMachineCreationModal","setShowMachineCreationModal","machineOptions","setMachineOptions","error","setError","handleClientId","id","query","fetchClientData","isReady","db","firestore","doc","collection","get","exists","data","local","machineRefs","machines","Promise","all","map","ref","then","console","fetchAvailableMachines","snapshot","where","docs","handleChange","field","event","value","target","prev","handleAddMachine","machine","handleCreateMachine","newMachine","machineId","Math","floor","random","machineWithId","set","clientRef","FieldValue","arrayUnion","merge","handleRemoveMachine","index","filter","_","i","handleSubmit","newClientId","alert","from","itemId","push","back"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport \"bootstrap/dist/css/bootstrap.min.css\";\nimport {\n  Form,\n  Button,\n  Card,\n  Container,\n  Row,\n  Col,\n  Modal,\n  Table,\n} from \"react-bootstrap\";\nimport { useRouter } from \"next/router\";\nimport firebase from \"../../../../context/Firebase\";\nimport ClientInfoModal from \"../../ClientInfoModal\";\nimport MachineCreationModal from \"../../MachineCreationModal\";\n\nconst AddClient = () => {\n  const router = useRouter();\n  const [clientId, setClientId] = useState(null);\n  const [client, setClient] = useState({\n    name: \"\",\n    location: \"\",\n  });\n  const [addedMachines, setAddedMachines] = useState([]);\n  const [showClientInfoModal, setShowClientInfoModal] = useState(false);\n  const [showMachineCreationModal, setShowMachineCreationModal] = useState(false);\n  const [machineOptions, setMachineOptions] = useState([]);\n  const [error, setError] = useState(null);\n\n  useEffect(() => {\n    const handleClientId = () => {\n      const { id } = router.query;\n      if (id) {\n        setClientId(id);\n        fetchClientData(id);\n      }\n    };\n\n    if (router.isReady) {\n      handleClientId();\n    }\n  }, [router.isReady, router.query]);\n\n  const fetchClientData = async (id) => {\n    const db = firebase.firestore();\n    try {\n      const doc = await db.collection(\"Client\").doc(id).get();\n      if (doc.exists) {\n        const data = doc.data();\n        setClient({\n          name: data.name || \"\",\n          location: data.local || \"\",\n        });\n        const machineRefs = data.machines || [];\n        const machines = await Promise.all(\n          machineRefs.map((ref) =>\n            ref.get().then((doc) => ({ id: doc.id, ...doc.data() }))\n          )\n        );\n        setAddedMachines(machines);\n      }\n    } catch (error) {\n      console.error(\"Error fetching client data:\", error);\n      setError(\"Failed to fetch client data.\");\n    }\n  };\n\n  const fetchAvailableMachines = async () => {\n    const db = firebase.firestore();\n    try {\n      const snapshot = await db\n        .collection(\"Machine\")\n        .where(\"client\", \"==\", null)\n        .get();\n      const machines = snapshot.docs.map((doc) => ({\n        id: doc.id,\n        ...doc.data(),\n      }));\n      setMachineOptions(machines);\n    } catch (error) {\n      console.error(\"Error fetching machines:\", error);\n      setError(\"Failed to fetch machines.\");\n    }\n  };\n\n  const handleChange = (field) => (event) => {\n    const value = event.target.value;\n    setClient((prev) => ({ ...prev, [field]: value }));\n  };\n\n  const handleAddMachine = (machine) => {\n    setAddedMachines((prev) => [...prev, machine]);\n    setShowClientInfoModal(false);\n  };\n\n  // When creating a new machine, if a client exists (edit mode) use set with merge\n  // so that if the client document doesn't exist yet it gets created.\n  const handleCreateMachine = async (newMachine) => {\n    const db = firebase.firestore();\n    const machineId = `AIS${Math.floor(10000 + Math.random() * 90000)}`;\n    try {\n      const machineWithId = {\n        ...newMachine,\n        id: machineId,\n        // Only set the client if clientId exists; otherwise, leave it null.\n        client: clientId ? db.collection(\"Client\").doc(clientId) : null,\n      };\n      await db.collection(\"Machine\").doc(machineId).set(machineWithId);\n\n      // If editing an existing client, update its machines array using set with merge.\n      if (clientId) {\n        const clientRef = db.collection(\"Client\").doc(clientId);\n        await clientRef.set(\n          {\n            machines: firebase.firestore.FieldValue.arrayUnion(\n              db.collection(\"Machine\").doc(machineId)\n            ),\n          },\n          { merge: true }\n        );\n      }\n\n      setShowMachineCreationModal(false);\n      setAddedMachines((prev) => [...prev, { id: machineId, ...newMachine }]);\n    } catch (error) {\n      console.error(\"Error creating and adding machine:\", error);\n      setError(\"Failed to create and add machine.\");\n    }\n  };\n\n  const handleRemoveMachine = (index) => {\n    setAddedMachines((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const handleSubmit = async () => {\n    const db = firebase.firestore();\n    try {\n      if (clientId) {\n        // Update existing client\n        await db.collection(\"Client\").doc(clientId).set(\n          {\n            ...client,\n            machines: addedMachines.map((machine) =>\n              db.collection(\"Machine\").doc(machine.id)\n            ),\n          },\n          { merge: true }\n        );\n      } else {\n        // Create new client\n        const newClientId = `AIS${Math.floor(10000 + Math.random() * 90000)}`;\n        await db.collection(\"Client\").doc(newClientId).set({\n          ...client,\n          machines: addedMachines.map((machine) =>\n            db.collection(\"Machine\").doc(machine.id)\n          ),\n        });\n        // (Update machines with the new client reference as needed.)\n        clientId = newClientId;\n      }\n      alert(\"Client and machines saved successfully.\");\n\n      // Check if we came from an item; if so, route back to that item page.\n      if (router.query.from === \"item\" && router.query.itemId) {\n        router.push(`/NewSearch/item/${router.query.itemId}`);\n      } else if(router.query.from === \"addItem\" && router.query.itemId){\n        router.push(\"AddItem/NewItem\");\n      } else {\n        router.push(\"../../clientSearch\");\n      }\n    } catch (error) {\n      console.error(\"Error saving client:\", error);\n      setError(\"Failed to save client.\");\n    }\n  };\n\n\n  return (\n    <Container className=\"mt-5\">\n      <Row className=\"justify-content-md-center\">\n        <Col md=\"8\">\n          <Card>\n            <Card.Header>\n              <h4>{clientId ? \"Edit Client\" : \"Add New Client\"}</h4>\n            </Card.Header>\n            <Card.Body>\n              {error && <p className=\"text-danger\">{error}</p>}\n              <Form>\n                <Row>\n                  <Col md={6}>\n                    <Form.Group controlId=\"clientName\">\n                      <Form.Label>Client Name</Form.Label>\n                      <Form.Control\n                        type=\"text\"\n                        placeholder=\"Enter client name\"\n                        value={client.name}\n                        onChange={handleChange(\"name\")}\n                      />\n                    </Form.Group>\n                  </Col>\n                  <Col md={6}>\n                    <Form.Group controlId=\"clientLocation\">\n                      <Form.Label>Location</Form.Label>\n                      <Form.Control\n                        type=\"text\"\n                        placeholder=\"Enter location\"\n                        value={client.location}\n                        onChange={handleChange(\"location\")}\n                      />\n                    </Form.Group>\n                  </Col>\n                </Row>\n                <Row className=\"mt-3\">\n                  <Col>\n                    <Button\n                      variant=\"primary\"\n                      onClick={() => setShowClientInfoModal(true)}\n                    >\n                      Add Machine\n                    </Button>\n                    <Button\n                      variant=\"secondary\"\n                      className=\"ms-2\"\n                      onClick={() => setShowMachineCreationModal(true)}\n                    >\n                      Create Machine\n                    </Button>\n                  </Col>\n                </Row>\n                <Row className=\"mt-3\">\n                  <Col>\n                    <Table striped bordered hover>\n                      <thead>\n                        <tr>\n                          <th>Machine Name</th>\n                          <th>Location</th>\n                          <th>Actions</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {addedMachines.map((machine, index) => (\n                          <tr key={index}>\n                            <td>{machine.name}</td>\n                            <td>{machine.local}</td>\n                            <td>\n                              <Button\n                                variant=\"danger\"\n                                size=\"sm\"\n                                onClick={() => handleRemoveMachine(index)}\n                              >\n                                Remove\n                              </Button>\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </Table>\n                  </Col>\n                </Row>\n                <Row className=\"mt-4\">\n                  <Col md={6}>\n                    <Button\n                      variant=\"success\"\n                      onClick={handleSubmit}\n                      className=\"w-100\"\n                    >\n                      Submit\n                    </Button>\n                  </Col>\n                  <Col md={6}>\n                    <Button\n                      variant=\"primary\"\n                      onClick={() => router.back()}\n                      className=\"w-100\"\n                    >\n                      Back\n                    </Button>\n                  </Col>\n                </Row>\n              </Form>\n            </Card.Body>\n          </Card>\n        </Col>\n      </Row>\n\n      {/* Modal to add an existing machine */}\n      <ClientInfoModal\n        show={showClientInfoModal}\n        handleClose={() => setShowClientInfoModal(false)}\n        machineOptions={machineOptions}\n        setSelectedMachine={handleAddMachine}\n      />\n\n      {/* Modal to create a new machine */}\n      <MachineCreationModal\n        show={showMachineCreationModal}\n        handleClose={() => setShowMachineCreationModal(false)}\n        onCreateMachine={handleCreateMachine}\n      />\n    </Container>\n  );\n};\n\nexport default AddClient;\n"]},"metadata":{},"sourceType":"module"}